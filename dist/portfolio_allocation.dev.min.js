/*! portfolio-allocation - v0.0.8 (2020-04-16), Roman Rubsamen <roman.rubsamen@gmail.com> */
var PortfolioAllocation=PortfolioAllocation||{};PortfolioAllocation=function(O){function z(t){var r={getCorrelationMatrix:function(t){for(var r=V(this.nbRows,this.nbColumns,t),n=0;n<r.nbRows;++n){for(var o=Math.sqrt(this.data[n*this.nbColumns+n]),i=0;i<n;++i)r.data[n*r.nbColumns+i]=r.data[i*this.nbColumns+n];for(i=n;i<r.nbColumns;++i){var e=Math.sqrt(this.data[i*this.nbColumns+i]);r.data[n*r.nbColumns+i]=this.data[n*this.nbColumns+i]/(o*e)}}return r},getVariances:function(t){return this.diagonal(t)},getStandardDeviations:function(t){return this.diagonal(t).elemMap(function(t,r,n){return Math.sqrt(n)},t)},standardizedGeneralizedVariance:function(){var t=this.determinant();if(t<0)throw new Error("covariance matrix is not positive semi-definite");return Math.pow(t,1/this.nbRows)}};for(var n in r)t[n]=r[n]}function it(t){if(!(this instanceof it))return new it(t);var o=this;if(t instanceof Array&&t[0]instanceof Array)return function(t){o=V(t.length,t[0].length);for(var r=0;r<o.nbRows;++r){if(!(t[r]instanceof Array))throw new Error("unsupported input type");if(t[r].length!==o.nbColumns)throw new Error("unsupported input type");for(var n=0;n<o.nbColumns;++n)o.data[r*o.nbColumns+n]=t[r][n]}return o}(t);if(t instanceof Array||"function"==typeof Float64Array&&t instanceof Float64Array)return function(t){o=V(t.length,1);for(var r=0;r<o.nbRows;++r)o.data[r*o.nbColumns]=t[r];return o}(t);if(t instanceof it)return o=it.copy(t);throw new Error("unsupported input type")}function V(t,r,n){var o;if(void 0===n)(o=Object.create(it.prototype)).nbRows=t,o.nbColumns=r,o.data="function"==typeof Float64Array?new Float64Array(o.nbRows*o.nbColumns):new Array(o.nbRows*o.nbColumns);else{if(!(n instanceof it))throw new Error("provided output must be a matrix");if(n.nbRows!==t||n.nbColumns!==r)throw new Error("provided output matrix size does not match expected matrix size: ("+n.nbRows+","+n.nbColumns+") v.s. ("+t+","+r+")");o=n}return o}function tt(t){if(!(this instanceof tt))return new tt;this.WORD_LENGTH=32,this.WORD_LOG=5,this.words="function"==typeof Uint32Array?new Uint32Array(0):new Array(0);var n=this;(t instanceof Array||"function"==typeof Uint32Array&&t instanceof Uint32Array)&&function(t){for(var r=0;r<t.length;++r)n.set(t[r])}(t),this.iterator=function(){for(this.w_idx=-1,this.w=0;this.w_idx<n.words.length&&0==this.w;)++this.w_idx,this.w=n.words[this.w_idx];this.next=function(){if(this.w_idx==n.words.length)return 0;var t=this.w&-this.w,r=(this.w_idx<<n.WORD_LOG)+tt.populationCount(t-1|0);for(this.w^=t;this.w_idx<n.words.length&&0==this.w;)++this.w_idx,this.w=n.words[this.w_idx];return r}}}function N(t){this.prob="function"==typeof Float64Array?new Float64Array(t.length):new Array(t.length),this.alias="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length);for(var r=1/t.length,n="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length),o=0,i="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length),e=0,a=0;a<t.length;++a)t[a]>r?(i[e]=a,++e):(n[o]=a,++o);for(t=t.slice(0);0<o&&0<e;){a=n[--o];var s=i[--e];this.prob[a]=t.length*t[a],t[this.alias[a]=s]=t[s]+(t[a]-r),t[s]>r?(i[e]=s,++e):(n[o]=s,++o)}for(;0<o;)--o,this.prob[n[o]]=1;for(;0<e;)--e,this.prob[i[e]]=1;this.sample=function(){var t=Math.random()*this.prob.length,r=Math.floor(t);return t-r<=this.prob[r]?r:this.alias[r]}}function o(t,r,n){this.n=t,this.k=r,this.reuseOutputArray=n,this.firstcall=!0,this.mtc=!1,this.r="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.t=this.n,this.h=0,this.next=function(){if(!this.firstcall&&!this.mtc)return-1;if(this.firstcall){this.firstcall=!1,this.r[0]=this.n;for(var t=1;t<=this.k-1;++t)this.r[t]=0}else 1<this.t&&(this.h=0),++this.h,this.t=this.r[this.h-1],this.r[this.h-1]=0,this.r[0]=this.t-1,++this.r[this.h];return this.mtc=this.r[this.k-1]!=this.n,this.reuseOutputArray?this.r:this.r.slice(0)}}function h(t,r,n){if(void 0===r){this.r="function"==typeof Uint32Array?new Uint32Array(t):new Array(t);for(var o=0;o<t;++o)this.r[o]=o+1}else this.r=r;function i(){for(var t=Math.random();0===t;)t=Math.random();return t}this.rrlen=this.r.length,this.reuseOutputArray=n,this.next=function(){if(this.reuseOutputArray)var t=this.r;else t=this.r.slice(0);for(var r=1;r<=this.rrlen;++r){var n=r+Math.floor(i()*(this.rrlen+1-r)),o=t[n-1];t[n-1]=t[r-1],t[r-1]=o}return t}}function k(t,r,n){this.n=t,this.k=r,this.useArrayCopy=n,this.a="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.firstcall=!0,this.mtc=!1,this.m2=0,this.h=this.k,this.endval=this.n-this.k+1,this.next=function(){if(!(this.firstcall||this.mtc&&0!==this.k))return-1;this.firstcall?this.firstcall=!1:(this.m2<this.n-this.h&&(this.h=0),++this.h,this.m2=this.a[this.k-this.h]);for(var t=1;t<=this.h;++t)this.a[this.k+t-this.h-1]=this.m2+t;return this.mtc=this.a[0]!=this.endval,this.useArrayCopy?this.a.slice(0):this.a}}function x(t,r,n){function m(){for(var t=Math.random();0===t;)t=Math.random();return t}this.n=t,this.k=r,this.useArrayCopy=n,this.a="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.N,this.nn,this.idx_a,this.selected_record,this.method_a=function(){for(var t=this.N-this.nn;2<=this.nn;){for(var r=m(),n=0,o=t/this.N;r<o;)++n,--t,--this.N,o=o*t/this.N;this.selected_record+=n+1,this.a[this.idx_a++]=this.selected_record,--this.N,--this.nn}(n=Math.floor(this.N*m()))===this.N&&(n=this.N-1),this.selected_record+=n+1,this.a[this.idx_a++]=this.selected_record},this.method_d=function(){for(var t=1/this.nn,r=Math.pow(m(),t),n=1-this.nn+this.N,o=13*this.nn;1<this.nn&&o<this.N;){for(var i,e,a=1/(-1+this.nn);;){for(;i=this.N*(1-r),!((e=Math.floor(i))<n);)r=Math.pow(m(),t);var s=m(),u=Math.pow(s*this.N/n,a);if((r=u*(-i/this.N+1)*(n/(-e+n)))<=1)break;var h,f,l=1,c=-1+this.N;f=-1+this.nn>e?(h=-this.nn+this.N,-e+this.N):(h=-1-e+this.N,n);for(var d=-1+this.N;f<=d;--d)l=l*c/h,--c,--h;if(this.N/(-i+this.N)>=u*Math.pow(l,a)){r=Math.pow(m(),a);break}r=Math.pow(m(),t)}this.selected_record+=e+1,this.a[this.idx_a++]=this.selected_record,this.N=-e+(-1+this.N),--this.nn,t=a,n=-e+n,o+=-13}1<this.nn?this.method_a():((e=Math.floor(this.N*r))===this.N&&(e=this.N-1),this.selected_record+=e+1,this.a[this.idx_a++]=this.selected_record)},this.next=function(){for(var t=0;t<this.k;++t)this.a[t]=0;return this.N=this.n,this.nn=this.k,this.idx_a=0,this.selected_record=0,this.method_d(),this.useArrayCopy?this.a.slice(0):this.a}}function v(t){this.n=t,this.firstcall=!0,this.mtc=!1,this.iin="function"==typeof Uint32Array?new Uint32Array(t):new Array(t),this.ncard=0,this.next=function(){var t=[];if(!this.firstcall&&!this.mtc)return-1;if(this.firstcall){this.firstcall=!1;for(var r=0;r<=this.n-1;++r)this.iin[r]=0;this.mtc=!0}else{var n=0;if(this.ncard%2!=0)for(++n;0==this.iin[n-1];)++n;this.iin[n]=1-this.iin[n],this.ncard=this.ncard+2*this.iin[n]-1,t="function"==typeof Uint32Array?new Uint32Array(this.ncard):new Array(this.ncard);var o=0;for(r=0;r<=this.n-1;++r)1==this.iin[r]&&(t[o++]=r+1);this.mtc=this.ncard!=this.iin[this.n-1]}return t}}function y(t,r){if(t<0)throw new Error("n must be a positive integer");if(r<0)throw new Error("k must be a positive integer");if(t<r)throw new Error("k must be less than or equal to n");for(var n=1,o=1;o<=r;++o)n*=t+1-o,n/=o;return n}function g(t){for(var r=t.length,n=t[0].nbRows,o=it.zeros(n,1),i=1;i<=n;++i){for(var e=0,a=0;a<r;++a)e+=t[a].getValue(i,1);var s=e/r,u=0;for(a=0;a<r;++a)u+=t[a].getValue(i,1)-s;o.setValue(i,1,(e+u)/r)}return o}function A(e){function t(t){for(var r=0,n=0;n<a;++n){r+=c(it.xmy(t,e[n],u).vectorNorm("two"),h)}return r}function r(t){for(var r=it.zeros(s,1),n=0;n<a;++n){var o=it.xmy(t,e[n],u),i=o.vectorNorm("two");r=it.axpby(1,r,1/c(i,h),o,r)}return r}function n(t){return 0}function o(t,r){return t}var a=e.length,s=e[0].nbRows,u=it.zeros(s,1),i=g(e),h=1/a,f=U(t,r,n,o,i,{eps:1e-4,maxIter:-1,maxLine:-1});return h=.1/a,f=U(t,r,n,o,f[0],{eps:1e-4,maxIter:-1,maxLine:-1}),h=.01/a,(f=U(t,r,n,o,f[0],{eps:1e-4,maxIter:-1,maxLine:-1}))[0]}function l(t,r,n){t=new it(t),r=new it(r),n=new it(n);if(r.nbRows!=t.nbRows||n.nbRows!=t.nbRows)throw new Error("incompatible dimensions: "+t.nbRows+", "+r.nbRows+", "+n.nbRows);var o=it.xmy(n,r),i=it.xmy(t,r),e=o.vectorNorm("two");if(e<=1e-8)return r.toArray();var a=Math.max(0,Math.min(1,it.vectorDotProduct(o,i)/(e*e)));return it.axpby(1,r,a,o).toArray()}function p(t,r,n){var o=t;n||(o=t.slice(0).sort(function(t,r){return t-r}));var i=r*(t.length-1),e=Math.floor(i);return e==i?o[e]:o[e]+(o[e+1]-o[e])*(i-e)}function C(t,r,n,o){if(this.n=t,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.reuseOutputArray=o,this.l=r,!this.l){this.l="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(var i=0;i<this.n;++i)this.l[i]=0}if(this.u=n,!this.u){this.u="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(i=0;i<this.n;++i)this.u[i]=1}for(i=0;i<this.n;++i)if(this.l[i]>this.u[i])throw new Error("empty box detected: lower bound strictly greater than upper bound");this.sample=function(){for(var t=0;t<this.n;++t)this.x[t]=Math.random()*(this.u[t]-this.l[t])+this.l[t];return this.reuseOutputArray?this.x:this.x.slice(0)}}function W(t,r){r=r||function(t,r){return t-r};for(var n=t.length,o=t[0],i=0,e=1;e<n;++e)0<r(t[e],o)&&(o=t[e],i=e);return[o,i]}function q(t,r,n){n=n||function(t,r){return t-r};var o=t.length,i="function"==typeof UInt32Array?new UInt32Array(10):new Array(10),e="function"==typeof UInt32Array?new UInt32Array(10):new Array(10),a=0,s=0,u=o-1;for(r=r-1;;)if(600<u-s&&a<10){var h=u-s+1,f=r-s+1,l=h,c=Math.log(l),d=Math.floor(.5*Math.exp(2*c/3)+.5),m=l/2<=f?1:-1,w=.5*Math.sqrt(c*d*(1-d/l))*m+.5;w=-1<w&&w<1?0:1<=w?Math.floor(w):Math.ceil(w),f==h/2&&(w=0),i[a]=s,e[a]=u,a++;var v=r-f*(d/l)+w;s<v&&(s=Math.floor(v+.5)),v+d<u&&(u=Math.floor(v+d+.5))}else{if(u<=s){if(0==a)return t[r];s=i[--a],u=e[a]}var b=t[r];for(f=s,j=u,t[r]=t[s],n(t[s]=b,t[u])<0&&(t[s]=t[u],t[u]=b);f<j;){var p=t[j];for(t[j]=t[f],t[f]=p,++f,--j;n(t[f],b)<0;)++f;for(;0<n(t[j],b);)--j}if(0==n(t[s],b)){p=t[s];t[s]=t[j],t[j]=p}else{++j;p=t[j];t[j]=t[u],t[u]=p}j<=r&&(s=j+1),r<=j&&(u=j-1)}}function b(t){var r=Math.pow(2,-52),n=(2-r)*Math.pow(2,1023),o=Math.pow(2,-1022);if(t!=t)return t;if(t===-1/0)return-n;if(t===1/0)return 1/0;if(t===+n)return 1/0;var i=t*(t<0?1-r/2:1+r);i===t&&(i=0<o*r?t+o*r:t+o),i===1/0&&(i=+n);var e=t+(i-t)/2;t<e&&e<i&&(i=e);var a=(i+t)/2;return t<a&&a<i&&(i=a),0===i?-0:i}function c(t,r){var n=0,o=Math.abs(t),i=Math.abs(r);return n=i<o?(n=r/t,o*Math.sqrt(1+n*n)):0!=r?(n=t/r,i*Math.sqrt(1+n*n)):0}function m(t,r){for(var n=new Array(t.length),o=0;o<t.length;++o)n[o]=[t[o],o];0==r?n.sort(function(t,r){return t[0]>r[0]?-1:1}):1==r&&n.sort(function(t,r){return t[0]<r[0]?-1:1});var i=new Array(t.length);for(o=i[n[0][1]]=1;o<t.length;++o)n[o][0]==n[o-1][0]?i[n[o][1]]=i[n[o-1][1]]:i[n[o][1]]=o+1;return i}function M(t,r){void 0===(r=r)&&(r=.5);for(var n=[],o=(t=new it(t)).nbRows,i=new Array(o),e=0;e<i.length;++e)i[e]=e+1;for(;0!=i.length;){if(1===i.length){var a=[i[0]];i[0]=null,n.push(a)}else{var s=t.submatrix(i,i).toRowArray(function(t,r,n){return t!=r}),u=new Array(i);for(e=0;e<i.length;++e)u[e]=F(s[e]);var h=0,f=-1,l=-1,c=0,d=-1,m=1;for(e=0;e<i.length;++e)u[e]>=l&&(h=i[e],l=u[f=e]),u[e]<=m&&(c=i[e],m=u[d=e]);if(t.getValueAt(h,c)>r){var w=h===c?[h]:[h,c];i[f]=null,i[d]=null;for(e=0;e<i.length;++e){if(null!==i[e])r<(t.getValueAt(i[e],h)+t.getValueAt(i[e],c))/2&&(w.push(i[e]),i[e]=null)}n.push(w)}else{var v=[h];i[f]=null;for(e=0;e<i.length;++e)null!==i[e]&&t.getValueAt(i[e],h)>r&&(v.push(i[e]),i[e]=null);if(n.push(v),h!==c){var b=[c];i[d]=null;for(e=0;e<i.length;++e)null!==i[e]&&t.getValueAt(i[e],c)>r&&(b.push(i[e]),i[e]=null);n.push(b)}}}var p=[];for(e=0;e<i.length;++e)null!==i[e]&&p.push(i[e]);i=p}return n}function F(t){for(var r,n=t.length,o=0,i=0;i<n;++i)o+=t[i];r=o/n;var e=0;for(i=0;i<n;++i)e+=t[i]-r;return(o+e)/n}function n(t){for(var r=t.length,n=F(t),o=0,i=0,e=0;e<r;++e){var a=t[e]-n;o+=a*a,i+=a}return(o-i*i/r)/r}function w(t){return Math.sqrt(function(t){var r=t.length;return n(t)*r/(r-1)}(t))}function R(t){var r=t,n=0,o=t,i=t*t,e=1;if(t<-8)return 0;if(8<t)return 1;for(;r!=n;)r=(n=r)+(o*=i/(e+=2));return.5+r*Math.exp(-.5*i-.9189385332046728)}function f(t,r){t||(t=0),r||(r=1);for(var n=Math.random();0===n;)n=Math.random();return t+r*d(n)}function i(t,r){null==t&&(t=0),null==r&&(r=1);for(var n,o=r*r,i=1.136717791056118,e=(1-i*i)/i*r,a=r*Math.sqrt(Math.PI/2);;){var s;if(t<e){var u=(-t+Math.sqrt(t*t+4*o))/2/o;n=-Math.log(1-Math.random())/u,s=Math.exp(-(n-t)*(n-t)/2/o-u*(t-n+u*o/2))}else if(t<=0)s=0<=(n=Math.abs(f())*r+t)?1:0;else if(t<a){var h=Math.random()<t/(t+Math.sqrt(Math.PI/2)*r)?1:0;n=h*(Math.random()*t)+(1-h)*(Math.abs(f()*r)+t),s=h*Math.exp(-(n-t)*(n-t)/2/o)+(1-h)}else s=0<=(n=f()*r+t)?1:0;if(Math.random()<=s)break}return n}function d(t){if(t<=0||1<=t){if(0==t)return-1/0;if(1==t)return 1/0;throw"The probality p must be bigger than 0 and smaller than 1"}var r,n=t-.5;if(Math.abs(n)<=.425){r=n*(((((((2509.0809287301227*(o=.180625-n*n)+33430.57558358813)*o+67265.7709270087)*o+45921.95393154987)*o+13731.69376550946)*o+1971.5909503065513)*o+133.14166789178438)*o+3.3871328727963665)/(((((((5226.495278852854*o+28729.085735721943)*o+39307.89580009271)*o+21213.794301586597)*o+5394.196021424751)*o+687.1870074920579)*o+42.31333070160091)*o+1)}else{var o;if(o=n<0?t:1-t,(o=Math.sqrt(-Math.log(o)))<=5)r=(((((((.0007745450142783414*(o-=1.6)+.022723844989269184)*o+.2417807251774506)*o+1.2704582524523684)*o+3.6478483247632045)*o+5.769497221460691)*o+4.630337846156546)*o+1.4234371107496835)/(((((((1.0507500716444169e-9*o+.0005475938084995345)*o+.015198666563616457)*o+.14810397642748008)*o+.6897673349851)*o+1.6763848301838038)*o+2.053191626637759)*o+1);else r=(((((((2.0103343992922881e-7*(o-=5)+27115555687434876e-21)*o+.0012426609473880784)*o+.026532189526576124)*o+.29656057182850487)*o+1.7848265399172913)*o+5.463784911164114)*o+6.657904643501103)/(((((((20442631033899397e-31*o+1.421511758316446e-7)*o+18463183175100548e-21)*o+.0007868691311456133)*o+.014875361290850615)*o+.1369298809227358)*o+.599832206555888)*o+1);n<0&&(r=-r)}return r}function S(t,r){this.n=t,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.reuseOutputArray=r,this.sample=function(){for(var t=0,r=1,n=0;n<this.n;++n){var o=f();this.x[n]=o;var i=Math.abs(o);0!=i&&(t<i?(r=1+r*(t/o)*(t/o),t=i):r+=o/t*(o/t))}var e=t*Math.sqrt(r);for(n=0;n<this.n;++n)this.x[n]=this.x[n]/e;return this.reuseOutputArray?this.x:this.x.slice(0)}}function I(t,r){for(var n=t.length,o=F(t),i=F(r),e=0,a=0,s=0,u=0;u<n;++u){var h=t[u]-o,f=r[u]-i;e+=h*f,a+=h,s+=f}return(e-a*s/n)/n}function P(t,r){var n=t.length;return I(t,r)*n/(n-1)}function D(t,r,n){r.nbRows;void 0===n&&(n={});var o=n.nRounds;void 0===o&&(o=10);var i=n.nSteps;void 0===i&&(i=5e3);var e=n.nDeltas;void 0===e&&(e=i);var l=n.neighbourGenerator,a=n.neighbourGeneratorParameters;void 0===l&&(l=function(t,r){for(var n=r.alpha,o=r.lowerBounds,i=r.upperBounds,e=t.length,a=t.slice(),s=t.slice(),u=0;u<e;++u)a[u]=t[u]-n/2,s[u]=t[u]+n/2,o&&(a[u]=Math.max(a[u],o[u])),i&&(s[u]=Math.min(s[u],i[u]));return new C(e,a,s).sample()},void 0!==a&&void 0!==a.alpha||(a={alpha:.001}));for(var s,u=function(t,r,n,o,i){for(var e=t(r),a="function"==typeof Float64Array?new Float64Array(o):new Array(o),s=0;s<o;++s){var u=l(r,n),h=t(u);a[s]=Math.abs(e-h),r=u,e=h}a.sort(function(t,r){return t-r});var f="function"==typeof Float64Array?new Float64Array(i):new Array(i);for(s=0;s<i;++s)f[s]=p(a,(i-(s+1))/i,!0);return f[i-1]=0,f}(t,s=r.slice(),a,e,o),h=r.slice(),f=t(h),c=t(s=r.slice()),d=0;d<o;++d)for(var m=0;m<i;++m){var w=s.slice(),v=l(s,a),b=t(v);b-c<u[d]?(s=v.slice(),c=b):s=w,b<f&&(f=b,h=v.slice())}return[h,f]}function E(t,r,n,o){void 0===o&&(o={});var i=o.maxIter;void 0===i&&(i=45);var e=o.eps;void 0===e&&(e=1e-6);var a,s,u=t(r),h=t(n);if(s=u<=0?n-(a=r):r-(a=n),n<=r)throw new Error("bracketing interval lower bound "+r+" greater than bracketing interval upper bound "+n);if(0==u)return r;if(0==h)return n;if(0<u*h)throw new Error("interval ["+r+","+n+"] is not a bracketing interval");for(var f=0;;){if(-1!==i&&i<f)throw new Error("maximum number of iterations reached: "+i);++f;var l=a+(s/=2),c=t(l);if(c<=0&&(a=l),0==c)return a;if(Math.abs(s)<=e)return a}}function U(r,t,n,i,o,e){function a(t){return r(t)+n(t)}function s(t,r,n){var o=it.axpby(1,r,-t,n);return[o,it.copy(i(o,t))]}void 0===e&&(e={});for(var u,h,f,l,c,d,m,w,v,b,p,y,g,x,A,C,M=e.eps||1e-4,R=e.maxIter||1e4,E=e.maxLine||100,_=e.beta||.5,z=e.alphaMin||1e-10,V=e.alphaMax||1e10,F=e.restartPeriod||1e3,I=o.nbRows,P=1e-12,O=.5,k=z,S=it.zeros(I,1),D=it.zeros(I,1),N=it.zeros(I,1),U=it.zeros(I,1),W=it.zeros(I,1),q=!0,B=0;;){if(-1!==R&&R<B)throw new Error("maximum number of iterations reached: "+R);++B%F==0&&(o=c,q=!0),!0===q&&(u=0,f=h=1,l=null,c=it.copy(o),d=it.copy(c),it.copy(d),m=it.zeros(I,1),S=it.copy(t(c),S),D=it.copy(S,D),N=it.copy(D,N),w=it.zeros(I,1),U=it.copy(c,U),W=it.copy(S,W),q=!1);for(var L=k,G=s(L,U,W),T=G[0],j=G[1],H=0;a(j)>(v=L,b=j,y=W,x=void 0,g=r(p=U),x=it.xmy(b,p),A=x.vectorNorm("two"),C=n(b),g+it.vectorDotProduct(x,y)+1/(2*v)*A*A+C+P);){if(-1!==E&&E<H)throw new Error("maximum number of line searches reached: "+E+" at iteration: "+B);++H,L*=_,f/=_,h=(1+Math.sqrt(1+4*f*u*u))/2,T=(G=s(L,U=it.axpby(1,d,(u-1)/h,m,U),W=it.axpby(1,D,(u-1)/h,w,W)))[0],j=G[1]}S=it.copy(t(c=j),S);var Y=it.xmy(c,d),K=it.xmy(S,D),X=it.vectorDotProduct(Y,Y),Z=Math.max(it.vectorDotProduct(K,K),P),J=it.vectorDotProduct(Y,K);if(J<=P)mu_kp_0=V;else{var Q=Math.max(z,Math.min(X/J,V)),$=Math.max(z,Math.min(J/Z,V));$/Q<=O?(mu_kp_0=$,O*=.9):(mu_kp_0=Q,O*=1.1)}l=L/mu_kp_0;var tt=(1+Math.sqrt(1+4*l*h*h))/2,rt=it.axpby(1,c,(h-1)/tt,Y),nt=it.axpby(1,S,(h-1)/tt,K),ot=it.axpby(1/L,T,-1/L,c);if(it.xpy(S,ot).vectorNorm("infinity")<=M)break;P<=it.vectorDotProduct(it.xmy(U,c),Y)&&(o=c,q=!0),k=mu_kp_0,d,d=c,m=Y,N=it.copy(D,N),D=it.copy(S,D),w=K,U=it.copy(rt,U),W=it.copy(nt,W),f=l,u=h,h=tt}return[c,a(c)]}function B(a,s,u,t,h,f,r){function n(t,r){return t instanceof Array?(t.length=r,t):t instanceof Float64Array||t instanceof Int32Array?t.subarray(0,r):void 0}function o(t){for(var r=b-t*p+y,n=new v.iterator,o=n.next();0!=o;){var i,e=o-1;t<=w[e]?i=f.data[e]:w[e]<=t&&t<=m[e]?i=(s.data[e]-t*u.data[e])/a.data[e]:m[e]<=t&&(i=h.data[e]),r+=u.data[e]*i,o=n.next()}return r}void 0===r&&(r={});var i=r.eps||1e-16,e=r.outputLagrangeMultiplier;if(!(a instanceof it&&a.isVector()))throw new Error("first input must be a vector");if(!(s instanceof it&&s.isVector()))throw new Error("second input must be a vector");if(!(u instanceof it&&u.isVector()))throw new Error("third input must be a vector");if(!(h instanceof it&&h.isVector()))throw new Error("fifth input must be a vector");if(!(f instanceof it&&f.isVector()))throw new Error("sixth input must be a vector");if(a.nbRows!==s.nbRows)throw new Error("first and second inputs number of rows do not match: "+a.nbRows+"-"+s.nbRows);if(a.nbRows!==u.nbRows)throw new Error("first and third inputs number of rows do not match: "+a.nbRows+"-"+u.nbRows);if(a.nbRows!==h.nbRows)throw new Error("first and fifth inputs number of rows do not match: "+a.nbRows+"-"+h.nbRows);if(a.nbRows!==f.nbRows)throw new Error("first and sixth inputs number of rows do not match: "+a.nbRows+"-"+f.nbRows);for(var l=u.nbRows,c=Math.abs(t),d="function"==typeof Float64Array?new Float64Array(2*l):new Array(2*l),m="function"==typeof Float64Array?new Float64Array(l):new Array(l),w="function"==typeof Float64Array?new Float64Array(l):new Array(l),v=(new tt).setRange(1,l),b=0,p=0,y=0,g=1/0,x=-1/0,A=0,C=0;A<l;++A){if(h.data[A]>f.data[A])throw new Error("infeasible problem detected");if(u.data[A]<=0)throw new Error("negative element detected in b");if(a.data[A]<=0)throw new Error("negative element detected in d");var M=(s.data[A]-h.data[A]*a.data[A])/u.data[A];m[A]=M,d[C++]=M;var R=(s.data[A]-f.data[A]*a.data[A])/u.data[A];w[A]=R,x<M&&(x=M),(d[C++]=R)<g&&(g=R)}var E=o(g),_=o(x);if(E<t||t<_)throw new Error("infeasible problem detected");var z=null;if(Math.abs(E-t)<=i*c)z=g;else if(Math.abs(E-t)<=i*c)z=x;else{for(var V=g,F=x;0!=d.length;){var I=Math.ceil(d.length/2),P=q(d,I),O=o(P);if(Math.abs(O-t)<=i*c){z=P;break}if(t<O){V=P;for(C=0,A=I;A<d.length;++A)d[C++]=d[A];d=n(d,C)}else O<t&&(F=P,d=n(d,I-1));for(var k=new v.iterator,S=k.next();0!=S;){var D=!1;if(m[A=S-1]<=V&&(y+=u.data[A]*h.data[A],D=!0),F<=w[A]&&(y+=u.data[A]*f.data[A],D=!0),w[A]<=V&&F<=m[A]){var N=u.data[A]/a.data[A];b+=s.data[A]*N,p+=u.data[A]*N,D=!0}!0===D&&v.unset(A+1),S=k.next()}}0==d.length&&(z=(b+y-t)/p)}var U=function(){for(var t=it.zeros(l,1),r=0;r<l;++r){var n;z<=w[r]?n=f.data[r]:w[r]<=z&&z<=m[r]?n=(s.data[r]-z*u.data[r])/a.data[r]:m[r]<=z&&(n=h.data[r]),t.data[r]=n}return t}(),W=.5*it.vectorDotProduct(U,it.elementwiseProduct(U,a))-it.vectorDotProduct(s,U);return!0===e?[U,W,z]:[U,W]}function _(t,r,n,o,i,e,s){void 0===s&&(s={});var u=s.eps||1e-4,h=s.maxIter||1e4;if(!(t instanceof it&&t.isSquare()))throw new Error("first input must be a square matrix");if(!(r instanceof it&&r.isVector()))throw new Error("second input must be a vector");if(!(n instanceof it&&n.isVector()))throw new Error("third input must be a vector");if(!(i instanceof it&&i.isVector()))throw new Error("fifth input must be a vector");if(!(e instanceof it&&e.isVector()))throw new Error("sixth input must be a vector");if(t.nbRows!==r.nbRows)throw new Error("first and second inputs number of rows do not match: "+t.nbRows+"-"+a.nbRows);if(t.nbRows!==n.nbRows)throw new Error("first and third inputs number of rows do not match: "+t.nbRows+"-"+n.nbRows);if(t.nbRows!==i.nbRows)throw new Error("first and fifth inputs number of rows do not match: "+t.nbRows+"-"+i.nbRows);if(t.nbRows!==e.nbRows)throw new Error("first and sixth inputs number of rows do not match: "+t.nbRows+"-"+e.nbRows);for(var f=t.nbRows,l=it.fill(f,1,function(t,r){return o/f*1/n.data[t-1]}),c=B(it.ones(f,1),l,n,o,i,e)[0],d=it.xpy(it.xy(t,c),r),m=0;;){if(-1!==h&&h<=m)throw new Error("maximum number of iterations reached: "+h);++m;for(var w=-1,v=-1/0,b=-1,p=1/0,y=0;y<f;++y)F_i=d.data[y]/n.data[y],i.data[y]<c.data[y]&&c.data[y]<e.data[y]?(F_i>v&&(v=F_i,w=y),F_i<p&&(p=F_i,b=y)):c.data[y]==i.data[y]?F_i<p&&(p=F_i,b=y):c.data[y]==e.data[y]&&F_i>v&&(v=F_i,w=y);if(v-p<=u)break;y=b;var g,x=w,A=(i.data[y]-c.data[y])*n.data[y],C=(c.data[x]-e.data[x])*n.data[x],M=C<=A?A:C,R=(e.data[y]-c.data[y])*n.data[y],E=(c.data[x]-i.data[x])*n.data[x],_=R<=E?R:E,z=p-v,V=t.data[y*t.nbColumns+y]/(n.data[y]*n.data[y])+t.data[x*t.nbColumns+x]/(n.data[x]*n.data[x])-2*t.data[y*t.nbColumns+x]/(n.data[y]*n.data[x]);0<V?_<(g=-z/V)?g=_:g<M&&(g=M):g=0<z?M:_;var F=c.data[y],I=c.data[x],P=g/n.data[y],O=-g/n.data[x];c.data[y]+=P,c.data[x]+=O,g==M&&(M==A&&(c.data[y]=i.data[y],P=c.data[y]-F),M==C&&(c.data[x]=e.data[x],O=c.data[x]-I)),g==_&&(_==R&&(c.data[y]=e.data[y],P=c.data[y]-F),_==E&&(c.data[x]=i.data[x],O=c.data[x]-I));for(var k=0;k<f;++k)d.data[k]=d.data[k]+t.data[k*t.nbColumns+y]*P+t.data[k*t.nbColumns+x]*O}return[c,.5*it.vectorDotProduct(c,it.xy(t,c))+it.vectorDotProduct(r,c)]}function L(o,t,i,r,n,e,a,s){void 0===s&&(s={});var u=s.eps||1e-8,h=s.maxIter||1e5,f=!1,l=!1,c=!1;if(null!==o&&null!==t)f=!0;else{if(null!==o&&null===t)throw new Error("equality constraints vector is missing");if(null===o&&null!==t)throw new Error("equality constraints matrix is missing")}if(null!==i&&null!==r)l=!0;else{if(null!==i&&null===r)throw new Error("inequality constraints vector is missing");if(null===i&&null!==r)throw new Error("inequality constraints matrix is missing")}if(null!==e&&null!==a)c=!0;else{if(null!==e&&null===a)throw new Error("upper bounds constraints vector is missing");if(null===e&&null!==a)throw new Error("lower bounds constraints vector is missing")}if(!(n instanceof it))throw new Error("fifth input must be a matrix");if(1!==n.nbColumns)throw new Error("fifth input is not a vector: "+n.nbColumns+"-"+n.nbRows);if(f){if(!(o instanceof it))throw new Error("first input must be a matrix");if(!(t instanceof it))throw new Error("second input must be a matrix");if(o.nbRows!==t.nbRows)throw new Error("first and second inputs number of rows do not match: "+o.nbRows+"-"+t.nbRows);if(o.nbColumns!==n.nbRows)throw new Error("first input number of columns and fifth input number of rows do not match: "+o.nbColumns+"-"+n.nbRows);if(1!==t.nbColumns)throw new Error("second input is not a vector: "+t.nbColumns+"-"+t.nbRows)}if(l){if(!(i instanceof it))throw new Error("third input must be a matrix");if(!(r instanceof it))throw new Error("third input must be a matrix");if(i.nbRows!==r.nbRows)throw new Error("third and fourth inputs number of rows do not match: "+i.nbRows+"-"+r.nbRows);if(i.nbColumns!==n.nbRows)throw new Error("third input number of columns and fifth input number of rows do not match: "+i.nbColumns+"-"+n.nbRows);if(1!==r.nbColumns)throw new Error("fourth input is not a vector: "+r.nbColumns+"-"+r.nbRows)}if(c){if(null!==e.nbRows){if(!(e instanceof it))throw new Error("sixth input must be a matrix");if(e.nbRows!==n.nbRows)throw new Error("sixth input number of rows and fifth input number of rows do not match: "+e.nbRows+"-"+n.nbRows)}if(null!==a.nbRows){if(!(a instanceof it))throw new Error("seventh input must be a matrix");if(a.nbRows!==n.nbRows)throw new Error("seventh input number of rows and fifth input number of rows do not match: "+a.nbRows+"-"+n.nbRows)}}var d=0,m=null,w=null,v=null;f&&(d=o.nbRows,m=it.zeros(d,1),w=it.zeros(d,1),v=it.zeros(d,1));var b=0,p=null,y=null,g=null;l&&(b=i.nbRows,p=it.zeros(b,1),y=it.zeros(b,1),g=it.zeros(b,1));var x=n.nbRows,A=it.ones(x,1),C=it.ones(x,1),M=it.ones(x,1),R=it.zeros(x,1),E=it.zeros(x,1),_=it.zeros(x,1),z=null;f&&(z=it.zeros(d,1));var V=null;l&&(V=it.zeros(b,1));var F=it.fill(x,1,function(t,r){var n=0;f&&(n+=o.vectorNorm("one","column",t));l&&(n+=i.vectorNorm("one","column",t));return 0==n&&(n=1),.9995/n}),I=null;f&&(I=it.fill(d,1,function(t,r){var n=o.vectorNorm("one","row",t);return 0==n&&(n=1),.9995/n}));var P=null;l&&(P=it.fill(b,1,function(t,r){var n=i.vectorNorm("one","row",t);return 0==n&&(n=1),.9995/n}));for(var O=0;;){if(-1!==h&&h<=O)throw new Error("maximum number of iterations reached: "+h);if(++O,f&&l?C=it.xpy(it.xpy(it.txy(o,m,E),it.txy(i,p,_),E),n,C):f?C=it.xpy(it.txy(o,m,E),n,C):l&&(C=it.xpy(it.txy(i,p,E),n,C)),C=it.xmy(A,it.elementwiseProduct(C,F,E),C),c)for(var k=1;k<=x;++k)C.data[k-1]<e.data[k-1]?C.data[k-1]=e.data[k-1]:C.data[k-1]>a.data[k-1]&&(C.data[k-1]=a.data[k-1]);else for(k=1;k<=x;++k)C.data[k-1]<0&&(C.data[k-1]=0);if(M=it.axpby(2,C,-1,A,M),f&&(w=it.xpy(m,it.elementwiseProduct(it.xmy(it.xy(o,M,z),t,z),I,z),w)),l){y=it.xpy(p,it.elementwiseProduct(it.xmy(it.xy(i,M,V),r,V),P,V),y);for(k=1;k<=b;++k)y.data[k-1]<0&&(y.data[k-1]=0)}var S=(R=it.xmy(C,A,R)).vectorNorm("infinity"),D=C.vectorNorm("infinity"),N=0,U=0;f&&(N=(v=it.xmy(w,m,v)).vectorNorm("infinity"),U=w.vectorNorm("infinity"));var W=0,q=0;if(l&&(W=(g=it.xmy(y,p,g)).vectorNorm("infinity"),q=y.vectorNorm("infinity")),S<=u*D&&N<=u*U&&W<=u*q)break;A=it.copy(C,A),f&&(m=it.copy(w,m)),l&&(p=it.copy(y,p))}return[C,it.vectorDotProduct(n,C)]}function G(t,r,n){var o=t.length;rt(o,r,n);for(var i=0,e=0;e<o;++e){var a=0;r&&(a=r[e]);var s=1;n&&(s=n[e]);var u=t[e];if(u<a||s<u)return Number.POSITIVE_INFINITY;i+=u}return 1e-12<Math.abs(i-1)?Number.POSITIVE_INFINITY:0}function rt(t,r,n){for(var o=0,i=0,e=0;e<t;++e){var a=0;r&&(a=r[e]);var s=1;if(n&&(s=n[e]),s<a)throw new Error("infeasible problem detected: lower bound strictly greater than upper bound");if(a<0)throw new Error("incorrect problem detected: lower bound strictly lower than 0");if(1<s)throw new Error("incorrect problem detected: upper bound strictly greater than 1");o+=a,i+=s}if(1<o||i<1)throw new Error("infeasible problem detected: the restricted simplex is empty");return[o,i]}function T(t,r,n){var o=t.length;rt(o,r,n);return B(it.ones(o,1),new it(t),it.ones(o,1),1,r?new it(r):it.zeros(o,1),n?new it(n):it.ones(o,1))[0].toArray()}function H(t,r,n){this.n=t,this.k=r,this.reuseOutputArray=n,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.compositionIterator=new o(r,t,!0),this.sample=function(){var t=this.compositionIterator.next();if(-1==t)return-1;for(var r=0;r<this.n;++r)this.x[r]=t[r]/this.k;return this.reuseOutputArray?this.x:this.x.slice(0)}}function Y(h,t,r,n){if(this.n=h,this.x="function"==typeof Float64Array?new Float64Array(h):new Array(h),this.u="function"==typeof Float64Array?new Float64Array(h-1):new Array(h-1),this.randomGenerator=function(t){for(var r=0;r<this.n;++r)t[r]=Math.random()},n){if("function"!=typeof n)throw new Error("the random number generator must be a function");this.randomGenerator=n}if(t&&(this.lowerBounds=t,!r)){this.upperBounds="function"==typeof Float64Array?new Float64Array(h):new Array(h);for(var o=0;o<this.n;++o)this.upperBounds[o]=1}if(r&&(this.upperBounds=r,!t)){this.lowerBounds="function"==typeof Float64Array?new Float64Array(h):new Array(h);for(o=0;o<this.n;++o)this.lowerBounds[o]=0}if(this.lowerBounds||this.upperBounds){var i=rt(h,this.lowerBounds,this.upperBounds);if(this.sumLowerBounds=i[0],this.sumUpperBounds=i[1],1==this.sumLowerBounds||1==this.sumUpperBounds);else{var e=0,a=0;for(o=0;o<this.n;++o){var s=this.lowerBounds[o],u=this.upperBounds[o],f=Math.max(s,u+1-this.sumUpperBounds),l=Math.min(u,s+1-this.sumLowerBounds);e+=this.lowerBounds[o]=f,a+=this.upperBounds[o]=l}this.sumLowerBounds=e,this.sumUpperBounds=a,this.upperStarBounds="function"==typeof Float64Array?new Float64Array(h):new Array(h),this.runningSumUpperStarBounds="function"==typeof Float64Array?new Float64Array(h):new Array(h);var c=0;for(o=0;o<this.n;++o)this.upperStarBounds[o]=(this.upperBounds[o]-this.lowerBounds[o])/(1-this.sumLowerBounds),c+=this.upperStarBounds[o],this.runningSumUpperStarBounds[o]=c}}this.sample_no_bounds=function(){for(var t=0,r=0;r<this.n;++r){var n=1-Math.random(),o=Math.log(n);t+=this.x[r]=o}for(r=0;r<this.n;++r)this.x[r]=this.x[r]/t;return this.x.slice(0)},this.sample_binding_bounds=function(){var t=null;if(1==this.sumLowerBounds)t=this.lowerBounds;else{if(1!=this.sumUpperBounds)throw new Error("internal error");t=this.upperBounds}for(var r=0;r<this.n;++r)this.x[r]=t[r];return this.x.slice(0)},this.sample_with_bounds=function(){this.randomGenerator(this.u);for(var t=this.u,r=1,n=h;2<=n;--n){if(Math.abs(r)<=1e-14){for(var o=n;1<=o;--o)this.x[o-1]=0;break}var i=t[n-2],e=Math.max(0,1-this.runningSumUpperStarBounds[n-2]/r),a=Math.min(1,this.upperStarBounds[n-1]/r),s=r*(1-Math.pow(i*Math.pow(1-a,n-1)+(1-i)*Math.pow(1-e,n-1),1/(n-1)));r-=this.x[n-1]=s}1==n&&(this.x[0]=r);for(var u=0;u<this.n;++u)this.x[u]=(1-this.sumLowerBounds)*this.x[u]+this.lowerBounds[u];return this.x.slice(0)},this.lowerBounds||this.upperBounds?1==this.sumLowerBounds||1==this.sumUpperBounds?this.sample=this.sample_binding_bounds:this.sample=this.sample_with_bounds:this.sample=this.sample_no_bounds}function K(t,r){for(var n=r,o=new Array(t.length),i=0;i<t.length;++i){var e=r*t[i],a=Math.floor(e),s=e-a;n-=a,o[i]=[a,s,i]}o.sort(function(t,r){return r[1]<t[1]?-1:r[1]>t[1]?1:r[0]-t[0]});var u=new Array(t.length);for(i=0;i<n;++i){u[o[i][2]]=(o[i][0]+1)/r}for(i=n;i<o.length;++i){u[o[i][2]]=o[i][0]/r}return u}function e(t,r,n,o,i){var e=null,a=null;if(o&&(e=o,!i)){a="function"==typeof Float64Array?new Float64Array(r):new Array(r);for(var s=0;s<r;++s)a[s]=1}if(i&&(a=i,!o)){e="function"==typeof Float64Array?new Float64Array(r):new Array(r);for(s=0;s<r;++s)e[s]=0}if(e||a)rt(r,e,a);for(var u=Number.POSITIVE_INFINITY,h=[],f=new H(r,n,!0),l=f.sample();-1!==l;){var c=!0;if(e)for(s=0;s<r;++s)if(e[s]>l[s]){c=!1;break}if(a)for(s=0;s<r;++s)if(l[s]>a[s]){c=!1;break}if(c){var d=t(l);d<u?(u=d,h=[l.slice(0)]):d==u&&h.push(l.slice(0)),l=f.sample()}else l=f.sample()}return h}function X(w,v,t,r){var b=1e-8;var n,o=r.constraint;if(null==o)throw new Error("internal error: missing constraint");if("return"==o)n=function(t,r,n,o){return it.vectorDotProduct(r,t)};else if("volatility"==o)n=function(t,r,n,o){var i=it.vectorDotProduct(it.xy(n,t),t);if(Math.abs(i)<=b)i=0;else if(i<0&&i<-b)throw new Error("negative volatility, covariance matrix might not be semi-definite positive");return Math.sqrt(i)};else{if("riskTolerance"!=o)throw new Error("internal error: unknown constraint");n=function(t,r,n,o){return o}}var i=r.constraintValue;if(null==i)throw new Error("internal error: missing constraint value");if(0===t.length)throw new Error("internal error: no corner portfolios");var e=function(t,r,n){var o=n.length-1,i=0,e=n[o][0],a=n[i][0],s=n[o][1],u=n[i][1],h=t(e,w,v,s),f=t(a,w,v,u);if(f+b<r||r<h-b)return[];if(Math.abs(r-h)<=b)return[[o,e,h]];if(Math.abs(r-f)<=b)return[[i,a,f]];for(;o-i!=1;){var l=Math.floor(i+(o-i)/2),c=n[l][0],d=n[l][1],m=t(c,w,v,d);if(r<m)i=l,f=m,a=c;else{if(!(m<r))return[[l,c,m]];o=l,h=m,e=c}}return[[o,e,h],[i,a,f]]}(n,i,t);if(0==e.length)return[];if(1==e.length){var a=e[0][0];return[e[0][1],a]}a=e[0][0];var s,u=e[0][1],h=e[0][2],f=e[1][0],l=e[1][1],c=e[1][2];if("return"===o)s=(c-i)/(c-h);else if("volatility"===o){var d=it.vectorDotProduct(it.xy(v,u),l),m=h*h+c*c-2*d,p=c*c-i*i,y=-2*(c*c-d)/2,g=0<=y?1:-1,x=y*y-m*p;if(x<0)throw new Error("internal error; the covariance matrix might not be semi-definite positive");var A=-(y+g*Math.sqrt(x)),C=A/m,M=p/A;if(0<C&&C<1)s=C;else{if(!(0<M&&M<1))throw new Error("internal error: the covariance matrix might not be semi-definite positive");s=M}}else{if("riskTolerance"!==o)throw new Error("internal error: unknown constraint");s=(c-i)/(c-h)}return[it.fill(u.nbRows,1,function(t,r){return s*u.getValue(t,1)+(1-s)*l.getValue(t,1)}),a,f]}function Z(t,n,r){var c=1e-8;void 0===r&&(r={constraints:{}}),void 0===r.constraints&&(r.constraints={});var o=r.maxIter||1e3,i=r.constraints.minWeights,e=r.constraints.maxWeights,d=n.nbColumns,a=it.ones(1,d),s=a.nbRows,u=it.ones(1,1),h=i?new it(i):it.zeros(d,1),f=e?new it(e):it.ones(d,1),l=[],m=null,w=new function(t,r){this.STATUS_UNDEF=-1,this.STATUS_IN=0,this.STATUS_LOW=1,this.STATUS_UP=2,this.nbAssets=t,this.nbEqualityConstraints=r,this.varIn=new tt,this.varIn.resize(t+r),this.varOut=new tt,this.varOut.resize(t+r),this.varLow=new tt,this.varLow.resize(t+r),this.varUp=new tt,this.varUp.resize(t+r),this.setIn=function(t){this.varIn.set(t),this.varOut.unset(t),this.varLow.unset(t),this.varUp.unset(t)},this.setOnLowerBound=function(t){this.varLow.set(t),this.varOut.set(t),this.varIn.unset(t),this.varUp.unset(t)},this.setOnUpperBound=function(t){this.varUp.set(t),this.varOut.set(t),this.varIn.unset(t),this.varLow.unset(t)},this.setLambdasIn=function(){for(var t=this.nbAssets+1;t<=this.nbAssets+this.nbEqualityConstraints;++t)this.varIn.set(t),this.varOut.unset(t),this.varLow.unset(t),this.varUp.unset(t)},this.setAssetsOnLowerBounds=function(){for(var t=1;t<=this.nbAssets;++t)this.varLow.set(t),this.varOut.set(t),this.varIn.unset(t),this.varUp.unset(t)},this.isAsset=function(t){return 1<=t&&t<=this.nbAssets},this.isLambda=function(t){return t>=this.nbAssets+1&&t<=this.nbAssets+this.nbEqualityConstraints},this.isIn=function(t){return this.varIn.get(t)},this.isOnLowerBound=function(t){return this.varLow.get(t)},this.isOnUpperBound=function(t){return this.varUp.get(t)},this.isOut=function(t){return this.varOut.get(t)},this.getInIndexes=function(){return this.varIn.toArray()},this.getOutIndexes=function(){return this.varOut.toArray()}}(d,s);m=function(n,t,r){rt(d,t.toArray(),r.toArray());for(var o="function"==typeof Uint32Array?new Uint32Array(d):new Array(d),i=0;i<d;++i)o[i]=i+1;o.sort(function(t,r){return n.getValue(r,1)-n.getValue(t,1)});for(var e=1;e<d;++e)if(n.getValue(o[e],1)==n.getValue(o[e-1],1))throw new Error("unsupported problem detected");var a=new it(t);w.setAssetsOnLowerBounds();var s=1-a.sum(),u=-1;for(e=0;e<d&&!(Math.abs(s)<=c);++e){u=o[e];var h=a.getValue(u,1),f=Math.min(r.getValue(u,1)-h,s),l=h+f;l>=r.getValue(u,1)?(a.setValue(u,1,r.getValue(u,1)),w.setOnUpperBound(u)):(a.setValue(u,1,l),w.setIn(u)),s-=f}return-1==u||e==d||w.isIn(u)||(w.setIn(u),r.setValue(u,1,r.getValue(u,1)+2e-8)),a}(t,h,f);var v=it.ones(1,1);if(Math.abs(1-h.sum())<=c||Math.abs(1-f.sum())<=c)return l.push([m,0]),l;for(var b=w.getInIndexes(),p=w.getOutIndexes(),y=it.zeros(d+s,1),g=it.zeros(d+s,1),x=1;x<=p.length;++x){var A=p[x-1];g.setValue(A,1,m.getValue(A,1))}for(var C=it.zeros(d+s,1),M=it.fill(d+s,d+s,function(t,r){return t<=d&&r<=d?n.data[(t-1)*n.nbColumns+(r-1)]:d+1<=t&&r<=d?a.data[(t-d-1)*a.nbColumns+(r-1)]:t<=d&&d+1<=r?a.data[(r-d-1)*a.nbColumns+(t-1)]:0}),R=it.zeros(d+s,d+s),E=it.atxy(-1,v,it.xy(n.submatrix(b,b),v)),_=1;_<=b.length;++_)for(var z=1;z<=b.length;++z){var V=b[_-1],F=v.getValue(_,z);R.setValue(d+z,V,F),R.setValue(V,d+z,F),R.setValue(d+_,d+z,E.getValue(_,z))}w.setLambdasIn();var I=it.zeros(d+s,1);for(x=1;x<=b.length;++x){var P=b[x-1],O=0;for(_=1;_<=p.length;++_){var k=p[_-1];O-=M.getValue(P,k)*m.getValue(k,1)}I.setValue(P,1,O)}for(x=d+1;x<=d+s;++x){for(P=x,O=u.getValue(P-d,1),_=1;_<=p.length;++_){k=p[_-1];O-=M.getValue(P,k)*m.getValue(k,1)}I.setValue(P,1,O)}for(var S=0,D=0,N=-1,U=0,W=w.STATUS_UNDEF,q=-1,B=0;;){if(-1!==o&&o<=S)throw new Error("maximum number of iterations reached: "+o);if(2<=++S)if(B<=U){g.setValue(N,1,m.getValue(N,1)),C.setValue(N,1,0),W==w.STATUS_LOW?w.setOnLowerBound(N):w.setOnUpperBound(N);var L=w.getInIndexes(),G=R.getValue(N,N);G<=c&&(G=c);for(x=1;x<=L.length;++x)for(P=L[x-1],_=1;_<=L.length;++_){var T=L[_-1];R.setValue(P,T,R.getValue(P,T)-R.getValue(P,N)*R.getValue(N,T)/G)}for(x=1;x<=L.length;++x){P=L[x-1];I.setValue(P,1,I.getValue(P,1)-M.getValue(P,N)*m.getValue(N,1))}}else{for(L=w.getInIndexes(),x=1;x<=L.length;++x){P=L[x-1];var j=0;for(_=1;_<=L.length;++_){T=L[_-1];j+=R.getValue(P,T)*M.getValue(T,q)}y.setValue(P,1,j)}var H=M.getValue(q,q);for(x=1;x<=L.length;++x){P=L[x-1];H-=M.getValue(q,P)*y.getValue(P,1)}H<=c&&(H=c);for(x=1;x<=L.length;++x){for(P=L[x-1],_=1;_<=L.length;++_){T=L[_-1];R.setValue(P,T,R.getValue(P,T)+y.getValue(P,1)*y.getValue(T,1)/H)}R.setValue(P,q,-y.getValue(P,1)/H),R.setValue(q,P,-y.getValue(P,1)/H)}R.setValue(q,q,1/H);for(x=1;x<=L.length;++x){P=L[x-1];I.setValue(P,1,I.getValue(P,1)+M.getValue(P,q)*m.getValue(q,1))}w.setIn(q);for(p=w.getOutIndexes(),O=0,x=1;x<=p.length;++x){A=p[x-1];O-=M.getValue(q,A)*m.getValue(A,1)}I.setValue(q,1,O)}L=w.getInIndexes(),p=w.getOutIndexes();N=-1,U=0,W=w.STATUS_UNDEF;for(x=1;x<=L.length;++x){P=L[x-1];var Y=0,K=0;for(_=1;_<=L.length;++_){T=L[_-1];Y+=R.getValue(P,T)*I.getValue(T,1),T<=d&&(K+=R.getValue(P,T)*t.getValue(T,1))}if(g.setValue(P,1,Y),C.setValue(P,1,K),w.isAsset(P))if(c<K)U<=(X=(h.getValue(P,1)-Y)/K)&&(N=P,U=X,W=w.STATUS_LOW);else if(K<-c){var X;U<=(X=(f.getValue(P,1)-Y)/K)&&(N=P,U=X,W=w.STATUS_UP)}}q=-1,B=0;for(x=1;x<=p.length;++x){A=p[x-1];var Z,J=0,Q=-t.getValue(A,1);for(_=1;_<=d+s;++_){var $=M.getValue(A,_);J+=$*g.getValue(_,1),Q+=$*C.getValue(_,1)}if(w.isOnLowerBound(A)){if(c<Q)B<=(Z=-J/Q)&&(q=A,B=Z)}else if(Q<-c)B<=(Z=-J/Q)&&(q=A,B=Z)}D=Math.max(U,B,0);for(x=1;x<=L.length;++x){P=L[x-1];w.isAsset(P)&&m.setValue(P,1,g.getValue(P,1)+D*C.getValue(P,1))}if(l.push([new it(m),D]),D<c)break}return l}return O.randomCorrelationMatrix=function(t,r){return it.randomCorrelation(t,r)},O.covarianceMatrix=function(i,t){void 0===(t=t)&&(t={}),void 0===t.method&&(t.method="covariance");var r=t.method;if("covariance"!=r&&"sample-covariance"!=r&&"ledoit-wolf-shrinked-covariance"!=r)throw new Error("unsupported covariance matrix computation method");var n=t.shrinkageTarget;if("ledoit-wolf-shrinked-covariance"==r&&-1==["constant-variance-null-correlation","constant-variance-correlation","null-correlation","constant-correlation"].indexOf(n))throw new Error("unsupported covariance matrix shrinkage target");var o,e=i.length,a=i[0].length;if("covariance"==r||"sample-covariance"==r){var s=I;"sample-covariance"==r&&(s=P),o=V(e,e);for(var u=0;u<o.nbRows;++u){for(var h=0;h<u;++h)o.data[u*o.nbColumns+h]=o.data[h*o.nbColumns+u];for(h=u;h<o.nbColumns;++h)o.data[u*o.nbColumns+h]=s(i[u],i[h])}}else{if("ledoit-wolf-shrinked-covariance"!=r)throw new Error("internal error: unsupported covariance matrix computation method");var f,l,c=it.fill(e,1,function(t,r){return F(i[t-1])}),d=it.fill(e,a,function(t,r){return i[t-1][r-1]-c.data[t-1]}),m=it.axty(1/a,d,d).toCovarianceMatrix(),w=m.getStandardDeviations(),v=m.getCorrelationMatrix();if("constant-variance-null-correlation"==n){var b=m.trace()/e;f=it.fill(e,e,function(t,r){return t==r?b:0})}else if("constant-variance-correlation"==n){var p=m.trace()/e,y=0;for(u=0;u<e-1;++u)for(h=u+1;h<e;++h)y+=m.data[u*m.nbColumns+h];y*=2/(e*(e-1)),f=it.fill(e,e,function(t,r){return t==r?p:y})}else if("null-correlation"==n)f=it.fill(e,e,function(t,r){return t==r?w.data[t-1]*w.data[t-1]:0});else if("constant-correlation"==n){for(u=l=0;u<e-1;++u)for(h=u+1;h<e;++h)l+=v.data[u*v.nbColumns+h];l*=2/(e*(e-1)),f=it.fill(e,e,function(t,r){return t==r?w.data[t-1]*w.data[t-1]:l*w.data[t-1]*w.data[r-1]})}var g,x=it.fill(e,e,function(t,r){for(var n=0,o=0;o<a;++o)n+=Math.pow((i[t-1][o]-c.data[t-1])*(i[r-1][o]-c.data[r-1])-m.data[(t-1)*m.nbColumns+(r-1)],2);return n/=a}),A=x.sum();if("constant-variance-null-correlation"==n)g=0;else if("constant-variance-correlation"==n)g=0;else if("null-correlation"==n)g=x.trace();else if("constant-correlation"==n){g=0;for(u=1;u<=e;++u)for(h=1;h<=e;++h)if(u!=h){for(var C=0,M=0;M<a;++M)C+=(Math.pow(i[u-1][M]-c.data[u-1],2)-m.data[(u-1)*m.nbColumns+(u-1)])*((i[u-1][M]-c.data[u-1])*(i[h-1][M]-c.data[h-1])-m.data[(u-1)*m.nbColumns+(h-1)]);C/=a;var R=0;for(M=0;M<a;++M)R+=(Math.pow(i[h-1][M]-c.data[h-1],2)-m.data[(h-1)*m.nbColumns+(h-1)])*((i[u-1][M]-c.data[u-1])*(i[h-1][M]-c.data[h-1])-m.data[(u-1)*m.nbColumns+(h-1)]);R/=a,g+=w.data[h-1]/w.data[u-1]*C+w.data[u-1]/w.data[h-1]*R}g*=l/2,g+=x.trace()}var E=(A-g)/Math.pow(it.xmy(m,f).matrixNorm("frobenius"),2),_=Math.max(0,Math.min(1,E/a));o=it.axpby(_,f,1-_,m)}return z(o),o},(O.Matrix=it).prototype={constructor:it,toString:function(){for(var t=0,r=0;r<this.nbRows;++r)for(var n=0;n<this.nbColumns;++n){var o=String(this.data[r*this.nbColumns+n]).length;t<o&&(t=o)}var i=[];for(r=0;r<this.nbRows;++r){i.push("[ ");for(n=0;n<this.nbColumns;++n){var e=String(this.data[r*this.nbColumns+n]);i.push(new Array(t-e.length+1).join(" ")+e+" ")}i.push("]\n")}return i.join("")},toRowArray:function(t){t=t||function(t,r,n){return!0};for(var r=new Array(this.nbRows),n=0;n<this.nbRows;++n){r[n]=new Array(this.nbColumns);for(var o=0,i=0;i<this.nbColumns;++i){var e=this.data[n*this.nbColumns+i];t(n+1,i+1,e)&&(r[n][o++]=e)}r[n].length=o}return r},toArray:function(t){t=t||function(t,r,n){return!0};for(var r=new Array(this.nbRows*this.nbColumns),n=0,o=0;o<this.nbRows;++o)for(var i=0;i<this.nbColumns;++i){var e=this.data[o*this.nbColumns+i];t(o+1,i+1,e)&&(r[n++]=e)}return r.length=n,r},setValueAt:function(t,r,n){if(t<1||r<1||t>this.nbRows||r>this.nbColumns)throw new Error("index out of bounds when setting matrix value, ("+t+","+r+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(t-1)*this.nbColumns+(r-1)]=n,this},setValue:function(t,r,n){return this.data[(t-1)*this.nbColumns+(r-1)]=n,this},getValueAt:function(t,r){if(t<1||r<1||t>this.nbRows||r>this.nbColumns)throw new Error("index out of bounds when getting matrix value, ("+t+","+r+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(t-1)*this.nbColumns+(r-1)]},getValue:function(t,r){return this.data[(t-1)*this.nbColumns+(r-1)]},isSquare:function(){return this.nbRows===this.nbColumns},isSymmetric:function(t){if(null==t&&(t=0),!this.isSquare())return!1;for(var r=0;r<this.nbRows;++r)for(var n=0;n<this.nbColumns;++n)if(Math.abs(this.data[r*this.nbColumns+n]-this.data[n*this.nbColumns+r])>t)return!1;return!0},isVector:function(){return 1===this.nbColumns},isNonNegative:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(this.data[t*this.nbColumns+r]<0)return!1;return!0},isPositive:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(this.data[t*this.nbColumns+r]<=0)return!1;return!0},isNonPositive:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(0<this.data[t*this.nbColumns+r])return!1;return!0},isNegative:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(0<=this.data[t*this.nbColumns+r])return!1;return!0},sum:function(){for(var t=0,r=0;r<this.data.length;++r)t+=this.data[r];return t},min:function(){for(var t=Number.POSITIVE_INFINITY,r=0;r<this.data.length;++r)this.data[r]<t&&(t=this.data[r]);return t},max:function(){for(var t=Number.NEGATIVE_INFINITY,r=0;r<this.data.length;++r)this.data[r]>t&&(t=this.data[r]);return t},normalize:function(t){var r=V(this.nbRows,this.nbColumns,t),n=this.sum();if(0===n)throw new Error("sum of coefficients of matrix is null");for(var o=0;o<this.data.length;++o)r.data[o]=this.data[o]/n;return r},diagonal:function(t){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var r=V(this.nbRows,1,t),n=0;n<this.nbRows;++n)r.data[n]=this.data[n*(this.nbColumns+1)];return r},row:function(t,r){if(t<1||t>this.nbRows)throw new Error("index out of bounds when getting matrix row, ("+t+") in size ("+this.nbRows+","+this.nbColumns+")");for(var n=V(this.nbColumns,1,r),o=0;o<this.nbColumns;++o)n.data[o]=this.data[(t-1)*this.nbColumns+o];return n},column:function(t,r){if(t<1||t>this.nbColumns)throw new Error("index out of bounds when getting matrix column, ("+t+") in size ("+this.nbRows+","+this.nbColumns+")");for(var n=V(this.nbRows,1,r),o=0;o<this.nbRows;++o)n.data[o]=this.data[o*this.nbColumns+(t-1)];return n},elemMap:function(t,r){for(var n=V(this.nbRows,this.nbColumns,r),o=0;o<n.nbRows;++o)for(var i=0;i<n.nbColumns;++i)n.data[o*n.nbColumns+i]=t(o+1,i+1,this.data[o*this.nbColumns+i]);return n},submatrix:function(t,r,n){if(!(t instanceof Array||t instanceof Uint32Array)||0==t.length)throw new Error("first parameter must be a non empty array");if(!(r instanceof Array||r instanceof Uint32Array)||0==r.length)throw new Error("second parameter must be a non empty array");for(var o=1;o<t.length;++o)if(t[o-1]>=t[o])throw new Error("first parameter must be a sorted array");for(var i=1;i<r.length;++i)if(r[i-1]>=t[i])throw new Error("second parameter must be a sorted array");var e=V(t.length,r.length,n);for(o=0;o<e.nbRows;++o){var a=t[o]-1;for(i=0;i<e.nbColumns;++i){var s=r[i]-1;e.data[o*e.nbColumns+i]=this.data[a*this.nbColumns+s]}}return e},transpose:function(t){for(var r=V(this.nbColumns,this.nbRows,t),n=0;n<r.nbRows;++n)for(var o=0;o<r.nbColumns;++o)r.data[n*r.nbColumns+o]=this.data[o*this.nbColumns+n];return r},determinant:function(){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var t=it.qrDecomposition(this,{qLess:!0}),r=1,n=0;n<t.data.length;n+=t.nbColumns+1)r*=t.data[n];return r},trace:function(){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var t=0,r=0;r<this.nbRows;++r)t+=this.data[r*this.nbColumns+r];return t},matrixNorm:function(t){if("one"==t){for(var r=0,n=0;n<this.nbColumns;++n){for(var o=0,i=0;i<this.nbRows;++i)o+=Math.abs(this.data[i*this.nbColumns+n]);r=Math.max(r,o)}return r}if("infinity"==t){var e=0;for(i=0;i<this.nbRows;++i){var a=0;for(n=0;n<this.nbColumns;++n)a+=Math.abs(this.data[i*this.nbColumns+n]);e=Math.max(e,a)}return e}if("frobenius"==t)return this.vectorNorm("two");throw new Error("unsupported matrix norm: "+t)},vectorNorm:function(t,r,n){var o,i,e,a;if(void 0===r||"matrix"==r)o=0,i=this.nbRows,e=0,a=this.nbColumns;else if("row"==r){if(void 0===n)throw new Error("undefined row index");if(n<1||n>this.nbRows)throw new Error("row index out of bounds: "+n);o=n-1,i=n,e=0,a=this.nbColumns}else if("column"==r){if(void 0===n)throw new Error("undefined row index");if(n<1||n>this.nbColumns)throw new Error("column index out of bounds: "+n);o=0,i=this.nbRows,e=n-1,a=n}else if(void 0!==r)throw new Error("unsupported matrix subset: "+r);if("one"==t){for(var s=0,u=o*this.nbColumns,h=o;h<i;++h){for(var f=u+e,l=e;l<a;++l)s+=Math.abs(this.data[f]),f++;u+=this.nbColumns}return s}if("two"==t){var c=0,d=1;for(u=o*this.nbColumns,h=o;h<i;++h){for(f=u+e,l=e;l<a;++l){var m=this.data[f],w=Math.abs(m);0!=w&&(c<w?(d=1+d*(c/m)*(c/m),c=w):d+=m/c*(m/c)),f++}u+=this.nbColumns}return c*Math.sqrt(d)}if("infinity"!=t)throw new Error("unsupported vector norm: "+t);var v=0;for(u=o*this.nbColumns,h=o;h<i;++h){for(f=u+e,l=e;l<a;++l)v=Math.max(v,Math.abs(this.data[f])),f++;u+=this.nbColumns}return v},toCovarianceMatrix:function(){return z(this),this}},it.areEqual=function(t,r,n){if(!(t instanceof it))throw new Error("a must be a matrix");if(!(r instanceof it))throw new Error("b must be a matrix");if(t.nbRows!==r.nbRows)return!1;if(t.nbColumns!==r.nbColumns)return!1;for(var o=t.nbRows*t.nbColumns,i=n||0,e=0;e<o;++e)if(Math.abs(t.data[e]-r.data[e])>i)return!1;return!0},it.xpy=function(t,r,n){if(!(t instanceof it))throw new Error("first input must be a matrix");if(!(r instanceof it))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbColumns||t.nbRows!==r.nbRows)throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=V(t.nbRows,t.nbColumns,n),i=t.nbRows*t.nbColumns,e=0;e<i;++e)o.data[e]=t.data[e]+r.data[e];return o},it.xmy=function(t,r,n){if(!(t instanceof it))throw new Error("first input must be a matrix");if(!(r instanceof it))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbColumns||t.nbRows!==r.nbRows)throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=V(t.nbRows,t.nbColumns,n),i=t.nbRows*t.nbColumns,e=0;e<i;++e)o.data[e]=t.data[e]-r.data[e];return o},it.axpby=function(t,r,n,o,i){if(!(r instanceof it))throw new Error("first input must be a matrix");if(!(o instanceof it))throw new Error("second input must be a matrix");if(r.nbColumns!==o.nbColumns||r.nbRows!==o.nbRows)throw new Error("input matrices sizes do not match: ("+r.nbRows+","+r.nbColumns+") - ("+o.nbRows+","+o.nbColumns+")");for(var e=V(r.nbRows,r.nbColumns,i),a=r.nbRows*r.nbColumns,s=0;s<a;++s)e.data[s]=t*r.data[s]+n*o.data[s];return e},it.copy=function(t,r){if(!(t instanceof it))throw new Error("first input must be a matrix");for(var n=V(t.nbRows,t.nbColumns,r),o=t.nbRows*t.nbColumns,i=0;i<o;++i)n.data[i]=t.data[i];return n},it.elementwiseProduct=function(t,r,n){if(!(t instanceof it))throw new Error("first input must be a matrix");if(!(r instanceof it))throw new Error("second input must be a matrix");if(!(t.nbRows===r.nbRows&&t.nbColumns===r.nbColumns||r.nbRows===t.nbRows&&1===r.nbColumns||1===r.nbRows&&r.nbColumns===t.nbColumns))throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");var o=V(t.nbRows,t.nbColumns,n),i=t.nbRows,e=t.nbColumns;if(t.nbRows===r.nbRows&&t.nbColumns===r.nbColumns)for(var a=i*e,s=0;s<a;++s)o.data[s]=t.data[s]*r.data[s];else if(r.nbRows===t.nbRows&&1===r.nbColumns)for(var u=0,h=0;h<i;++h)for(var f=r.data[h],l=0;l<e;++l)o.data[u]=t.data[u]*f,u++;else if(1===r.nbRows&&r.nbColumns===t.nbColumns)for(u=0,h=0;h<i;++h)for(l=0;l<e;++l)o.data[u]=t.data[u]*r.data[l],u++;return o},it.xy=function(t,r,n){if(!(t instanceof it))throw new Error("first input must be a matrix");if(!(r instanceof it))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbRows)throw new Error("matrices sizes do not match: ("+t.nbRows+","+r.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=V(t.nbRows,r.nbColumns,n),i=t.nbRows,e=t.nbColumns,a=r.nbColumns,s=0,u=0,h=0;h<i;++h){for(var f=u,l=0;l<a;++l)o.data[f]=0,f++;for(var c=0,d=0;d<e;++d){var m=t.data[s];f=u;for(l=0;l<a;++l)o.data[f]+=m*r.data[c],c++,f++;s++}u+=a}return o},it.txy=function(t,r,n){if(!(t instanceof it))throw new Error("second input must be a matrix");if(!(r instanceof it))throw new Error("third input must be a matrix");if(t.nbRows!==r.nbRows)throw new Error("matrices sizes do not match: ("+t.nbRows+","+r.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=V(t.nbColumns,r.nbColumns,n),i=t.nbColumns,e=t.nbRows,a=r.nbColumns,s=0,u=0,h=0,f=0;f<i;++f){for(var l=t.data[s],c=m,d=0;d<a;++d)o.data[u]=l*r.data[d],u++;s++}var m=a;for(h=1;h<e;++h){for(f=u=0;f<i;++f){for(l=t.data[s],c=m,d=0;d<a;++d)o.data[u]+=l*r.data[c],u++,c++;s++}m+=a}return o},it.axy=function(t,r,n,o){if(!(r instanceof it))throw new Error("second input must be a matrix");if(!(n instanceof it))throw new Error("third input must be a matrix");if(r.nbColumns!==n.nbRows)throw new Error("matrices sizes do not match: ("+r.nbRows+","+n.nbColumns+") - ("+n.nbRows+","+n.nbColumns+")");for(var i=V(r.nbRows,n.nbColumns,o),e=r.nbRows,a=r.nbColumns,s=n.nbColumns,u=0,h=0,f=0;f<e;++f){for(var l=h,c=0;c<s;++c)i.data[l]=0,l++;for(var d=0,m=0;m<a;++m){var w=t*r.data[u];l=h;for(c=0;c<s;++c)i.data[l]+=w*n.data[d],d++,l++;u++}h+=s}return i},it.ax=function(t,r,n){if(!(r instanceof it))throw new Error("second input must be a matrix");for(var o=V(r.nbRows,r.nbColumns,n),i=r.nbRows,e=r.nbColumns,a=1;a<=i;++a)for(var s=1;s<=e;++s)o.setValue(a,s,t*r.getValue(a,s));return o},it.axty=function(t,r,n,o){if(!(r instanceof it))throw new Error("second input must be a matrix");if(!(n instanceof it))throw new Error("third input must be a matrix");if(r.nbColumns!==n.nbColumns)throw new Error("matrices sizes do not match: ("+r.nbRows+","+n.nbColumns+") - ("+n.nbRows+","+n.nbColumns+")");for(var i=V(r.nbRows,n.nbRows,o),e=0;e<r.nbRows;++e)for(var a=0;a<n.nbRows;++a){for(var s=i.data[e*i.nbColumns+a]=0;s<r.nbColumns;++s)i.data[e*i.nbColumns+a]+=r.data[e*r.nbColumns+s]*n.data[a*n.nbColumns+s];i.data[e*i.nbColumns+a]=t*i.data[e*i.nbColumns+a]}return i},it.atxy=function(t,r,n,o){if(!(r instanceof it))throw new Error("second input must be a matrix");if(!(n instanceof it))throw new Error("third input must be a matrix");if(r.nbRows!==n.nbRows)throw new Error("matrices sizes do not match: ("+r.nbRows+","+n.nbColumns+") - ("+n.nbRows+","+n.nbColumns+")");for(var i=V(r.nbColumns,n.nbColumns,o),e=0,a=0;a<r.nbColumns;++a){for(var s=t*r.data[e*r.nbColumns+a],u=0;u<n.nbColumns;++u)i.data[a*i.nbColumns+u]=0;for(u=0;u<n.nbColumns;++u)i.data[a*i.nbColumns+u]+=s*n.data[e*n.nbColumns+u]}for(e=1;e<r.nbRows;++e)for(a=0;a<r.nbColumns;++a)for(s=t*r.data[e*r.nbColumns+a],u=0;u<n.nbColumns;++u)i.data[a*i.nbColumns+u]+=s*n.data[e*n.nbColumns+u];return i},it.diagonal=function(t,r){if(!(t instanceof it&&t.isVector()))throw new Error("first input must be a vector");for(var n=t.nbRows,o=V(n,n,r),i=0;i<n;++i){for(var e=0;e<n;++e)o.data[i*n+e]=0;o.data[i*n+i]=t.data[i]}return o},it.fillSymmetric=function(t,r,n){if(t<1)throw new Error("input number of rows and columns out of bounds: "+t);for(var o=V(t,t,n),i=0;i<t;++i){for(var e=0;e<i;++e)o.data[i*t+e]=o.data[e*t+i];for(e=i;e<o.nbColumns;++e)o.data[i*t+e]=r(i+1,e+1)}return o},it.fill=function(t,r,n,o){if(t<1)throw new Error("input number of rows out of bounds: "+t);if(r<1)throw new Error("input number of columns out of bounds: "+r);for(var i=V(t,r,o),e=0;e<t;++e)for(var a=0;a<r;++a)i.data[e*r+a]=n(e+1,a+1);return i},it.zeros=function(t,r,n){for(var o=V(t,r,n),i=t*r,e=0;e<i;++e)o.data[e]=0;return o},it.ones=function(t,r){for(var n=V(t,r),o=t*r,i=0;i<o;++i)n.data[i]=1;return n},it.identity=function(t){for(var r=V(t,t),n=t*t,o=0;o<n;++o)o%(t+1)==(r.data[o]=0)&&(r.data[o]=1);return r},it.normrnd=function(t,r,n,o){for(var i=V(t,r),e=t*r,a=0;a<e;++a)i.data[a]=f(n,o);return i},it.vectorHadamardProduct=function(t,r){return it.elementwiseProduct(t,r)},it.vectorDotProduct=function(t,r){if(!t.isVector())throw new Error("first argument must be a vector");if(!r.isVector())throw new Error("second argument must be a vector");if(t.nbRows!==r.nbRows)throw new Error("Vectors sizes do not match: ("+t.nbRows+") - ("+r.nbRows+")");for(var n=0,o=t.nbRows,i=0;i<o;++i)n+=t.data[i]*r.data[i];return n},it.qrDecomposition=function(t,r){function n(t,r){var n,o,i;if(0==r)n=0<=t?1:-1,o=0,i=Math.abs(t);else if(0==t)o=(n=0)<=r?1:-1,i=Math.abs(r);else if(Math.abs(t)>Math.abs(r)){o=(e=r/t)*(n=1/(a=(0<=t?1:-1)*Math.sqrt(1+e*e))),i=t*a}else{var e,a;n=(e=t/r)*(o=1/(a=(0<=r?1:-1)*Math.sqrt(1+e*e))),i=r*a}return[n,-o,i]}void 0===r&&(r={});var o=r.qLess||!1;if(!(t instanceof it))throw new Error("first input must be a matrix");if(t.nbRows<t.nbColumns)throw new Error("matrix has more columns than rows: ("+t.nbRows+") v.s. ("+t.nbColumns+")");var i=t.nbRows,e=t.nbColumns,a=new it(t),s=null;o||(s=it.identity(i));for(var u=1;u<=e;++u)for(var h=i;u+1<=h;--h){var f=(h-2)*a.nbColumns+(u-1),l=(h-1)*a.nbColumns+(u-1),c=n(a.data[f],a.data[l]),d=c[0],m=c[1],w=c[2];a.data[f]=w,a.data[l]=0;for(var v=u+1;v<=e;++v){var b=(h-2)*a.nbColumns+(v-1),p=(h-1)*a.nbColumns+(v-1),y=a.data[b],g=a.data[p];a.data[b]=d*y-m*g,a.data[p]=m*y+d*g}if(!o)for(v=1;v<=i;++v){var x=(v-1)*s.nbColumns+(h-2),A=(v-1)*s.nbColumns+(h-1);y=s.data[x],g=s.data[A];s.data[x]=d*y-m*g,s.data[A]=m*y+d*g}}return o?a:[s,a]},it.svdDecomposition=function(t,r){void 0===r&&(r={});var n=r.eps||1e-16,o=r.maxIter||100,i=r.svdForm||"thin";if(!(t instanceof it))throw new Error("first input must be a matrix");if(t.nbRows<t.nbColumns)throw new Error("matrix has more columns than rows: "+t.nbColumns+" v.s. "+t.nbRows);for(var e=t.nbRows,a=t.nbColumns,s=new it(t),u=s.matrixNorm("frobenius"),h=it.identity(a),f=0,l="function"==typeof Float64Array?new Float64Array(a):new Array(a);;){if(++f,-1!==o&&o<f)throw new Error("maximum number of iterations reached: "+o);for(var c=1;c<=a;++c){var d=s.vectorNorm("two","column",c);l[c-1]=d*d}var m=!0;for(c=2;c<=a;++c)for(var w=1;w<=c-1;++w){for(var v=l[w-1],b=l[c-1],p=0,y=1;y<=e;++y)p+=s.data[(y-1)*s.nbColumns+(w-1)]*s.data[(y-1)*s.nbColumns+(c-1)];if(!(Math.abs(p)<=n*Math.sqrt(e*v*b))&&!(Math.sqrt(v)<=n*u||Math.sqrt(b)<=n*u)){m=!1;var g=(v-b)/(2*p),x=(0<=g?1:-1)/(Math.abs(g)+Math.sqrt(1+g*g)),A=1/Math.sqrt(1+x*x),C=A*x;for(y=1;y<=e;++y){var M=s.data[(y-1)*s.nbColumns+(w-1)],R=s.data[(y-1)*s.nbColumns+(c-1)];s.data[(y-1)*s.nbColumns+(w-1)]=A*M+C*R,s.data[(y-1)*s.nbColumns+(c-1)]=-C*M+A*R}l[w-1]+=x*p,l[c-1]-=x*p;for(y=1;y<=a;++y){M=h.data[(y-1)*h.nbColumns+(w-1)],R=h.data[(y-1)*h.nbColumns+(c-1)];h.data[(y-1)*h.nbColumns+(w-1)]=A*M+C*R,h.data[(y-1)*h.nbColumns+(c-1)]=-C*M+A*R}}}if(1==m)break}var E="function"==typeof Float64Array?new Float64Array(a):new Array(a),_="function"==typeof Uint32Array?new Uint32Array(a):new Array(a);for(c=1;c<=a;++c){var z=Math.sqrt(l[c-1]);E[c-1]=z,_[c-1]=c}_.sort(function(t,r){return E[r-1]-E[t-1]});var V=it.zeros(e,a),F=it.zeros(a,a),I=it.zeros(a,a);for(c=1;c<=a;++c){var P=_[c-1],O=E[P-1];if(0!=(F.data[(c-1)*F.nbColumns+(c-1)]=O))for(w=1;w<=e;++w)V.data[(w-1)*V.nbColumns+(c-1)]=s.data[(w-1)*s.nbColumns+(P-1)]/O;for(w=1;w<=a;++w)I.data[(w-1)*I.nbColumns+(c-1)]=h.data[(w-1)*h.nbColumns+(P-1)]}if("thin"==i)return[V,F,I];var k=it.qrDecomposition(V)[0],S=it.zeros(e,e),D=it.zeros(e,a);for(c=1;c<=a;++c){P=_[c-1],O=E[P-1];if(0!=(D.data[(c-1)*D.nbColumns+(c-1)]=O))for(w=1;w<=e;++w)S.data[(w-1)*S.nbColumns+(c-1)]=V.data[(w-1)*V.nbColumns+(c-1)];else for(w=1;w<=e;++w)S.data[(w-1)*S.nbColumns+(c-1)]=k.data[(w-1)*k.nbColumns+(c-1)]}for(c=a+1;c<=e;++c)for(w=1;w<=e;++w)S.data[(w-1)*S.nbColumns+(c-1)]=k.data[(w-1)*k.nbColumns+(c-1)];return"full"==i?[S,D,I]:void 0},it.nullSpace=function(t,r){void 0===r&&(r={});var n=r.eps||void 0;if(!(t instanceof it))throw new Error("first input must be a matrix");var o=t.nbRows,i=t.nbColumns,e=null;if(i<=o){var a=(l=it.svdDecomposition(t,{maxIter:-1}))[0],s=l[1],u=l[2];for(void 0===n&&(n=o*(b(s.data[0])-s.data[0])),c=i;1<=c&&!(s.data[(c-1)*s.nbColumns+(c-1)]>n);--c);if((d=c)==i)e=it.zeros(i,1);else{e=new it.zeros(i,i-d);for(var h=d+1;h<=i;++h)for(var f=1;f<=i;++f)e.data[(f-1)*e.nbColumns+(h-(d+1)+1-1)]=u.data[(f-1)*u.nbColumns+(h-1)]}}else{var l,c,d;a=(l=it.svdDecomposition(t.transpose(),{maxIter:-1,svdForm:"full"}))[0],s=l[1],u=l[2];for(void 0===n&&(n=i*(b(s.data[0])-s.data[0])),c=o;1<=c&&!(s.data[(c-1)*s.nbColumns+(c-1)]>n);--c);if((d=c)==o)e=it.zeros(i,1);else{var m=new it.zeros(i,d);for(h=1;h<=d;++h)for(f=1;f<=i;++f)m.data[(f-1)*m.nbColumns+(h-1)]=a.data[(f-1)*a.nbColumns+(h-1)];var w=it.qrDecomposition(m)[0];for(e=new it.zeros(i,i-d),h=d+1;h<=i;++h)for(f=1;f<=i;++f)e.data[(f-1)*e.nbColumns+(h-(d+1)+1-1)]=w.data[(f-1)*w.nbColumns+(h-1)]}}return e},it.linsolveBackSubstitution=function(t,r,n){if(!(t instanceof it))throw new Error("first input must be a matrix");if(!(r instanceof it))throw new Error("second input must be a matrix");if(!t.isSquare())throw new Error("matrix is not square: ("+t.nbRows+","+t.nbColumns+")");if(t.nbRows!==r.nbRows)throw new Error("matrix and second member sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");if(1!==r.nbColumns)throw new Error("b is not a vector: ("+r.nbRows+","+r.nbColumns+")");for(var o=t.nbColumns,i=V(o,1,n),e=o;1<=e;--e){i.data[e-1]=r.data[e-1];for(var a=e+1;a<=o;++a)i.data[e-1]=i.data[e-1]-t.data[(e-1)*t.nbColumns+(a-1)]*i.data[a-1];var s=t.data[(e-1)*t.nbColumns+(e-1)];if(0==s)throw new Error("input matrix is not invertible: zero diagonal coefficient at index "+e);i.data[e-1]=i.data[e-1]/s}return i},it.randomOrthogonal=function(t){var r=it.normrnd(t,t),n=it.qrDecomposition(r),o=n[0],i=n[1],e=it.fill(1,t,function(t,r){return 0<=i.data[(r-1)*i.nbColumns+(r-1)]?1:-1});return it.elementwiseProduct(o,e)},it.randomCorrelation=function(t,n){if(void 0===n&&(n={}),void 0===n.eps&&(n.eps=1e-14),void 0===n.epsLambda&&(n.epsLambda=1e-8),void 0===n.lambda){n.lambda=new Y(t).sample();for(var r=0;r<t;++r)n.lambda[r]*=t}if(n.lambda.length!=t)throw new Error("number of input eigenvalues not equal to "+t+", but to "+n.lambda.length);var o=0;for(r=0;r<t;++r)o+=n.lambda[r];if(Math.abs(o-t)>n.epsLambda)throw new Error("input eigenvalues not summing to "+t);for(var i=n.eps,e=it.fill(1,t,function(t,r){return n.lambda[r-1]}),a=it.randomOrthogonal(t),s=it.axty(1,it.elementwiseProduct(a,e),a),u=1;u<t;++u){for(var h=!0,f=1;f<=t;++f){var l=s.data[(f-1)*s.nbColumns+(f-1)];if(Math.abs(l-1)>i){h=!1;break}1!=l&&(s.data[(f-1)*s.nbColumns+(f-1)]=1)}if(h)break;r=-1;var c=-1;for(f=1;f<=t;++f)s.data[(f-1)*s.nbColumns+(f-1)]<1&&-1===r&&(r=f),1<s.data[(f-1)*s.nbColumns+(f-1)]&&(c=f);if(c<r){c=r=-1;for(f=1;f<=t;++f)1<s.data[(f-1)*s.nbColumns+(f-1)]&&-1===r&&(r=f),s.data[(f-1)*s.nbColumns+(f-1)]<1&&(c=f)}var d=s.data[(r-1)*s.nbColumns+(r-1)],m=s.data[(r-1)*s.nbColumns+(c-1)],w=s.data[(c-1)*s.nbColumns+(c-1)],v=(m+Math.sqrt(m*m-(d-1)*(w-1)))/(w-1),b=1/Math.sqrt(1+v*v),p=b*v;for(f=1;f<=t;++f){var y=s.data[(r-1)*s.nbColumns+(f-1)],g=s.data[(c-1)*s.nbColumns+(f-1)];s.data[(r-1)*s.nbColumns+(f-1)]=b*y-p*g,s.data[(c-1)*s.nbColumns+(f-1)]=p*y+b*g}for(f=1;f<=t;++f){y=s.data[(f-1)*s.nbColumns+(r-1)],g=s.data[(f-1)*s.nbColumns+(c-1)];s.data[(f-1)*s.nbColumns+(r-1)]=b*y-p*g,s.data[(f-1)*s.nbColumns+(c-1)]=p*y+b*g}s.data[(r-1)*s.nbColumns+(r-1)]=1}for(f=1;f<=t;++f)s.data[(f-1)*s.nbColumns+(f-1)]=1;return s},it.linsolveExtendedKaczmarz=function(t,r,n){void 0===n&&(n={});var o=n.eps||1e-12,i=n.maxIter||1e5,e=!1;if(void 0!==n.randomized&&(e=n.randomized),!(t instanceof it))throw new Error("first input must be a matrix");if(!(r instanceof it))throw new Error("second input must be a matrix");if(t.nbRows!==r.nbRows)throw new Error("matrix and second member sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");if(1!==r.nbColumns)throw new Error("b is not a vector: ("+r.nbRows+","+r.nbColumns+")");var a=t.nbRows,s=t.nbColumns,u=it.zeros(s,1),h=it.copy(r),f=it.zeros(a,1),l=it.zeros(a,1),c=it.zeros(a,1),d=t.matrixNorm("frobenius"),m=d*d;if(0===d)return u;for(var w="function"==typeof Float64Array?new Float64Array(a):new Array(a),v=1;v<=a;++v){var b=t.vectorNorm("two","row",v);w[v-1]=b*b}for(var p="function"==typeof Float64Array?new Float64Array(s):new Array(s),y=1;y<=s;++y){var g=t.vectorNorm("two","column",y);p[y-1]=g*g}if(0==e)for(var x=0;;){if(++x,-1!==i&&i<=x)throw new Error("maximum number of iterations reached: "+i);for(v=1;v<=a;++v)if(0!=w[v-1]){var A=0;for(y=1;y<=s;++y)A+=t.data[(v-1)*t.nbColumns+(y-1)]*u.data[(y-1)*u.nbColumns];var C=A-(r.data[(v-1)*r.nbColumns+0]-h.data[(v-1)*h.nbColumns+0]);for(y=1;y<=s;++y)u.data[(y-1)*u.nbColumns]-=C/w[v-1]*t.data[(v-1)*t.nbColumns+(y-1)]}for(y=1;y<=s;++y)if(0!=p[y-1]){var M=0;for(v=1;v<=a;++v)M+=t.data[(v-1)*t.nbColumns+(y-1)]*h.data[(v-1)*h.nbColumns+0];for(v=1;v<=a;++v)h.data[(v-1)*h.nbColumns+0]-=M/p[y-1]*t.data[(v-1)*t.nbColumns+(y-1)]}var R=u.vectorNorm("two");if(c=it.xy(t,u,c),l=it.xmy(r,h,l),(I=(f=it.xmy(c,l,f)).vectorNorm("two"))<=o*d*R)break}else{var E=it.zeros(s,1),_="function"==typeof Float64Array?new Float64Array(a):new Array(a);for(v=1;v<=a;++v)_[v-1]=w[v-1]/m;var z=new N(_),V="function"==typeof Float64Array?new Float64Array(s):new Array(s);for(y=1;y<=s;++y)V[y-1]=p[y-1]/m;var F=new N(V);for(x=0;;){if(++x,-1!==i&&i<=x)throw new Error("maximum number of iterations reached: "+i);for(v=z.sample()+1,A=0,y=1;y<=s;++y)A+=t.data[(v-1)*t.nbColumns+(y-1)]*u.data[(y-1)*u.nbColumns];for(C=A-(r.data[(v-1)*r.nbColumns+0]-h.data[(v-1)*h.nbColumns+0]),y=1;y<=s;++y)u.data[(y-1)*u.nbColumns]-=C/w[v-1]*t.data[(v-1)*t.nbColumns+(y-1)];for(y=F.sample()+1,M=0,v=1;v<=a;++v)M+=t.data[(v-1)*t.nbColumns+(y-1)]*h.data[(v-1)*h.nbColumns+0];for(v=1;v<=a;++v)h.data[(v-1)*h.nbColumns+0]-=M/p[y-1]*t.data[(v-1)*t.nbColumns+(y-1)];if(x%8*Math.min(a,s)==0){R=u.vectorNorm("two");c=it.xy(t,u,c),l=it.xmy(r,h,l);var I=(f=it.xmy(c,l,f)).vectorNorm("two"),P=(E=it.txy(t,h,E)).vectorNorm("two");if(I<=o*d*R&&P<=o*m*R)break}}}return u},O.meanVector=function(n,t){void 0===(t=t)&&(t={}),void 0===t.method&&(t.method="sample-mean");var r=t.method;if("sample-mean"!=r&&"demiguel-shrinked-mean"!=r)throw new Error("unsupported mean vector computation method");var o,i=n.length,e=n[0].length;if("sample-mean"==r){o=a=it.fill(i,1,function(t,r){return F(n[t-1])})}else{if("demiguel-shrinked-mean"!=r)throw new Error("internal error: unsupported mean vector computation method");var a,s=F((a=it.fill(i,1,function(t,r){return F(n[t-1])})).toArray()),u=it.fill(i,1,function(t,r){return s}),h=it.fill(i,1,function(t,r){return I(n[t-1],n[t-1])}).sum()/i,f=i/e*h/(i/e*h+Math.pow(it.xmy(u,a).vectorNorm("two"),2));o=it.axpby(f,u,1-f,a)}return o},O.randomMeanVector=function(t){return it.fill(t,1,function(t,r){return f(0,1)})},O.perturbedMeanVector=function(t,r){if(void 0===(r=r)&&(r={}),void 0===r.method&&(r.method="chopra-ziemba"),"chopra-ziemba"!=r.method)throw new Error("unsupported perturbation method");var o=r.k;if(void 0===r.k&&(o=.05),!t.isVector())throw new Error("input must be a vector");return t.elemMap(function(t,r,n){return n*(1+o*f(0,1))})},O.randomVariances=function(t){return it.fill(t,1,function(t,r){return i(0,1)})},O.perturbedVariances=function(t,r){if(void 0===(r=r)&&(r={}),void 0===r.method&&(r.method="chopra-ziemba"),"chopra-ziemba"!=r.method)throw new Error("unsupported perturbation method");var i=r.k;if(void 0===r.k&&(i=.05),!t.isVector())throw new Error("input must be a vector");return t.elemMap(function(t,r,n){for(var o=n*(1+i*f(0,1));0==o;)o=n*(1+i*f(0,1));return o})},(O.BitSet_=tt).populationCount=function(t){return t=(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135,t+=t>>>8,63&(t+=t>>>16)},tt.prototype={constructor:tt,resize:function(t){var r=this.words.length;if(!(r<<this.WORD_LOG>t)){var n=t+this.WORD_LENGTH>>>this.WORD_LOG;if("function"==typeof Uint32Array){var o=new Uint32Array(n);o.set(this.words),this.words=o}else{this.words[n-1]=0;for(var i=r;i<n-1;++i)this.words[i]=0}}},toString:function(){for(var t="",r=this.words.length,n=0;n<r;++n){var o="";t+=(o="function"==typeof Uint32Array?this.words[n].toString(2):(this.words[n]>>>0).toString(2)).length>=this.WORD_LENGTH?o:new Array(this.WORD_LENGTH-o.length+1).join("0")+o}return t},set:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]|=1<<t,this},setRange:function(t,r){this.words.length<<this.WORD_LOG<=r&&this.resize(r);for(var n=t;n<=r;++n)this.words[n>>>this.WORD_LOG]|=1<<n;return this},unset:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]&=~(1<<t),this},get:function(t){return 0!=(this.words[t>>>this.WORD_LOG]&1<<t)},clear:function(){return this.words="function"==typeof Uint32Array?new Uint32Array(0):new Array(0),this},flip:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]^=1<<t,this},isEmpty:function(){for(var t=this.words.length,r=0;r<t;++r)if(0!=this.words[r])return!1;return!0},nbSetBits:function(){for(var t=0,r=this.words.length,n=0;n<r;++n)t+=tt.populationCount(0|this.words[n]);return t},toArray:function(){for(var t=new Array(this.nbSetBits()),r=0,n=this.words.length,o=0;o<n;++o)for(var i=this.words[o];0!=i;){var e=i&-i;t[r++]=(o<<this.WORD_LOG)+tt.populationCount(e-1|0),i^=e}return t}},O.aliasMethodSampler_=N,O.randomCompositionsIterator_=function(t,r){this.n=t,this.k=r,this.ranksb=new x(t+r-1,r-1),this.r="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.next=function(){for(var t=this.ranksb.next(),r=0;r<this.k-1;++r)this.r[r]=t[r];this.r[this.k-1]=this.n+this.k;var n=0;for(r=1;r<=this.k;++r){var o=this.r[r-1];this.r[r-1]=o-n-1,n=o}return this.r.slice(0)}},O.compositionsIterator_=o,O.permutationsIterator_=function(t,r){this.n=t,this.reuseOutputArray=r,this.p="function"==typeof Uint32Array?new Uint32Array(this.n):new Array(this.n);for(var n=0;n<this.n;++n)this.p[n]=n+1;this.c="function"==typeof Uint32Array?new Uint32Array(this.n):new Array(this.n);for(n=0;n<this.n;++n)this.c[n]=0;this.j=-1,this.next=function(){if(this.j>=this.n)return-1;if(-1===this.j)return++this.j,this.reuseOutputArray?this.p:this.p.slice(0);for(;this.j<this.n;){if(this.c[this.j]<this.j){if(this.j%2==0){var t=this.p[this.j];this.p[this.j]=this.p[0],this.p[0]=t}else{t=this.p[this.j];this.p[this.j]=this.p[this.c[this.j]],this.p[this.c[this.j]]=t}return++this.c[this.j],this.j=0,this.reuseOutputArray?this.p:this.p.slice(0)}this.c[this.j]=0,++this.j}return-1}},O.subsetsIterator_=v,O.kSubsetsIterator_=k,O.randomKSubsetsIterator_=x,O.randomPermutationsIterator_=h,O.binomial_=y,O.geometricCenter_=g,O.geometricMedian_=A,O.max_=W,O.median_=function(t,r){var n=t.length;return q(t.slice(),Math.ceil(n/2),r)},O.select_=q,O.quantile_=p,O.permutationEntropy_=function(t,r){for(var n=t.length,o={},i=0,e=n-r+1,a="function"==typeof UInt32Array?new UInt32Array(r):new Array(r),s=0;s<e;++s){for(var u=t.slice(s,s+r),h=0;h<r;++h)a[h]=h+1;a.sort(function(t,r){return u[t-1]-u[r-1]});var f=a.toString();o[f]=(o[f]||0)+1,++i}var l=0;for(var c in o)if(o.hasOwnProperty(c)){var d=o[c]/i;l+=d*Math.log(d)}return-l/Math.log(2)},O.hypot_=c,O.rank_=m,O.ftca_=M,O.normcdf_=R,O.norminv_=d,O.normrnd_=f,O.pnormrnd_=i,O.hypersphereRandomSampler_=S,O.boxRandomSampler_=C,O.boxGridSampler_=function(t,r,n,o,i){this.n=t,this.k=r,this.reuseOutputArray=i,this.arrs="function"==typeof UInt32Array?new UInt32Array(this.n):new Array(this.n);for(var e=0;e<this.n;++e)this.arrs[e]=0;if(this.x="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n),this.l=n,!this.l){this.l="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(e=0;e<this.n;++e)this.l[e]=0}if(this.u=o,!this.u){this.u="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(e=0;e<this.n;++e)this.u[e]=1}this.nbGridPoints="function"==typeof UInt32Array?new UInt32Array(this.n):new Array(this.n),this.gridSize="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(e=0;e<this.n;++e){var a;a=this.k[e]?this.k[e]:this.k,this.nbGridPoints[e]=a,this.gridSize[e]=1===a?0:(this.u[e]-this.l[e])/(this.nbGridPoints[e]-1)}for(e=0;e<this.n;++e){var s=this.l[e],u=this.u[e];if(u<s)throw new Error("infeasible problem detected: lower bound "+s+" strictly greater than upper bound "+u);if(s<u&&this.gridSize[e]<=0)throw new Error("incorrect number of grid points to generate on the interval ["+s+", "+u+"]: "+this.nbGridPoints[e])}this.sample=function(){if(this.arrs[0]===this.nbGridPoints[0])return-1;for(var t=0;t<this.n;++t)this.x[t]=this.l[t]+this.arrs[t]*this.gridSize[t];for(var r=!0,n=this.n-1;r&&0<=n;){if(++this.arrs[n],this.arrs[n]===this.nbGridPoints[n]){if(0===n)break;r=!(this.arrs[n]=0)}else r=!1;--n}return this.reuseOutputArray?this.x:this.x.slice(0)}},O.lineSegmentEuclidianProjection_=l,O.lpsolvePDHG_=L,O.qpsolveGSMO_=_,O.qksolveBS_=B,O.ccpsolveFISTA_=U,O.gssSolve_=function(t,r,n,o,i){function e(t,r,n,o){if(this.n=t.nbRows,this.alpha=r,this.nbGeneratedPollingDirections=0,this.d=it.zeros(a,1),this.nbPollingDirections,this.pollingDirectionsIndices,n&&o){this.nbPollingDirections=n.length+o.length,this.pollingDirectionsIndices="function"==typeof Int32Array?new Int32Array(this.nbPollingDirections):new Array(this.nbPollingDirections);for(var i=0;i<n.length;++i)this.pollingDirectionsIndices[i]=n[i];i=n.length;for(var e=0;i<this.nbPollingDirections;++i,++e)this.pollingDirectionsIndices[i]=-o[e]}else{this.nbPollingDirections=2*this.n,this.pollingDirectionsIndices="function"==typeof Int32Array?new Int32Array(this.nbPollingDirections):new Array(this.nbPollingDirections);for(i=0;i<this.n;++i)this.pollingDirectionsIndices[i]=i+1;for(i=this.n,e=0;i<2*this.n;++i,++e)this.pollingDirectionsIndices[i]=-(e+1)}this.next=function(){if(this.nbGeneratedPollingDirections>=this.nbPollingDirections)return-1;if(1<=this.nbGeneratedPollingDirections){var t=this.pollingDirectionsIndices[this.nbGeneratedPollingDirections-1];if(t<0)this.d.data[-t-1]=0;else{if(!(0<t))throw new Error("internal error: 0 polling direction indice detected");this.d.data[t-1]=0}}var r=this.pollingDirectionsIndices[this.nbGeneratedPollingDirections];if(r<0)this.d.data[-r-1]=-1;else{if(!(0<r))throw new Error("internal error: 0 polling direction indice detected");this.d.data[r-1]=1}return++this.nbGeneratedPollingDirections,this.d}}var a=r.nbRows;void 0===i&&(i={});var s=i.maxIter;void 0===s&&(s=1e4);var u=i.eps;void 0===u&&(u=1e-6);if(n&&o){if(n.length!=o.length)throw new Error("incompatible number of lower bounds and upper bounds constraints: "+n.length+" v.s. "+o.length);n=new it(n),o=new it(o)}{if(n&&!o)throw new Error("missing upper bounds constraints");if(!n&&o)throw new Error("missing lower bounds constraints")}var h,f=i.unconstrainedPollingSet;void 0===f&&(f="coordinateDirections");if("coordinateDirections"!==f&&"probabilisticDescentDirections"!==f&&"custom"!==f)throw new Error("unsupported unconstrained polling set");if("coordinateDirections"===f)h=e;else if("probabilisticDescentDirections"===f)h=function(t,r){this.n=t.nbRows,this.nbGeneratedPollingDirections=0,this.d=it.zeros(a,1),this.nbPollingDirections=Math.floor(Math.log(1-Math.log(v)/Math.log(w))/Math.log(2))+1,this.hypersphereRandomSampler=new S(this.n,!0),this.next=function(){if(this.nbGeneratedPollingDirections>=this.nbPollingDirections)return-1;if(2===this.nbPollingDirections&&1===this.nbGeneratedPollingDirections)this.d=it.ax(-1,this.d,this.d);else{var n=this.hypersphereRandomSampler.sample();this.d=it.fill(this.n,1,function(t,r){return n[t-1]},this.d)}return++this.nbGeneratedPollingDirections,this.d}};else{if("custom"!==f)throw new Error("internal error: unsupported unconstrained polling set detected");h=i.customUnconstrainedPollingSetGenerator}var l,c=i.constrainedPollingSet;void 0===c&&(c="coordinateDirections");if("coordinateDirections"!==c&&"custom"!==c)throw new Error("unsupported constrained polling set");if("coordinateDirections"===c)l=e;else{if("custom"!==c)throw new Error("internal error: unsupported constrained polling set detected");l=i.customConstraintedPollingSetGenerator}var d=i.alphaZero;void 0===d&&(d=1);var m=i.alphaMax;void 0===m&&(m=1e10);var w=i.gamma;if(void 0===w)if("coordinateDirections"===f)w=1;else if("probabilisticDescentDirections"===f)w=2;else{if("custom"!==f)throw new Error("internal error: unsupported unconstrained polling set detected");w=1}var v=i.theta;void 0===v&&(v=.5);var b=i.pollingType;void 0===b&&(b="opportunistic");if("opportunistic"!==b&&"complete"!==b)throw new Error("unsupported polling type");var p=i.rho;void 0===p&&(p=function(t){return t*t/2});var y=it.copy(r),g=it.copy(r),x=it.copy(r),A=t(y),C=t(g),M=void 0,R=d,E=0;for(;;){if(-1!==s&&s<E)throw new Error("maximum number of iterations reached: "+s);++E;var _=p(R),z=!1;if(n&&o)for(var V=new Array(0),F=new Array(0),I=0;I<a;++I)y.data[I]+R<=o.data[I]-1e-12&&V.push(I+1),n.data[I]+1e-12<=y.data[I]-R&&F.push(I+1);for(var P,O=(P=n&&o&&V.length+F.length<2*a?new l(y,R,V,F):new h(y,R)).next();-1!=O;){if(g=it.axpby(1,y,R,O,g),(C=t(g))<A-_){if(z=!0,"opportunistic"===b){x=it.copy(g,x),M=C;break}"complete"===b&&(void 0===M?(x=it.copy(g,x),M=C):C<M&&(x=it.copy(g,x),M=C))}O=P.next()}if(!0===z&&(y=it.copy(x,y),A=M,M=void 0),!0===z?R=Math.min(w*R,m):R*=v,R<=u)break}return[y,A]},O.thresholdAcceptingSolve_=D,O.bisection_=E,O.goldenSectionSearch_=function(t,r,n,o){void 0===o&&(o={});var i=o.maxIter;void 0===i&&(i=-1);var e=o.eps;void 0===e&&(e=1e-6);var a=(Math.sqrt(5)-1)/2,s=1-a,u=r,h=n,f=u+s*(h-u),l=u+a*(h-u),c=t(f),d=t(l);if(n<=r)throw new Error("bracketing interval lower bound "+r+" greater than bracketing interval upper bound "+n);var m=0;for(;;){if(-1!==i&&i<m)throw new Error("maximum number of iterations reached: "+i);if(++m,c<d?(h=l,d=c,c=t(f=a*(l=f)+s*u)):d=d<c?(u=f,c=d,t(l=a*(f=l)+s*h)):(l=(u=f)+a*((h=l)-u),c=t(f=u+s*(h-u)),t(l)),Math.abs(h-u)<=e*(Math.abs(f)+Math.abs(l)))return c<d?[f,c]:[l,d]}},O.returns=function(t,r){void 0===(r=r)&&(r={}),void 0===r.method&&(r.method="arithmetic");var n=r.method;if("arithmetic"!=n&&"logarithmic"!=n)throw new Error("unsupported returns computation method");var o="function"==typeof Float64Array?new Float64Array(t.length-1):new Array(t.length-1);if("arithmetic"==n)for(var i=0;i<t.length-1;++i)o[i]=(t[i+1]-t[i])/t[i];else{if("logarithmic"!=n)throw new Error("internal error: unsupported returns computation method");for(i=0;i<t.length-1;++i)o[i]=Math.log(t[i+1]/t[i])}return o},O.simplexCharacteristicFunction_=G,O.simplexEmptinessCheck_=rt,O.simplexRationalRounding_=K,O.simplexRandomSampler_=Y,O.simplexDirectionRandomSampler_=function(t){this.n=t,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.sample=function(){for(var t=0,r=0;r<this.n;++r){for(var n=Math.random();0===n;)n=Math.random();var o=d(n);t+=this.x[r]=o}var i=t/this.n,e=0,a=1;for(r=0;r<this.n;++r){this.x[r]=this.x[r]-i;var s=Math.abs(this.x[r]);0!=s&&(e<s?(a=1+a*(e/this.x[r])*(e/this.x[r]),e=s):a+=this.x[r]/e*(this.x[r]/e))}var u=e*Math.sqrt(a);for(r=0;r<this.n;++r)this.x[r]=this.x[r]/u;return this.x.slice(0)}},O.simplexGridSampler_=H,O.simplexGridSearch_=e,O.simplexEuclidianProjection_=T,O.simplexSparseEuclidianProjection_=function(n,t,r,o){var i=n.length;if(t===i)return T(n,r,o);{if(r||o){n=new it(n);for(var e=1/0,a=null,s=1;s<=t;++s)for(var u=new k(i,s,!1),h=u.next();-1!=h;){var f=h.length,l="function"==typeof UInt32Array?new UInt32Array(f):new Array(f);for(y=0;y<f;++y)l[y]=h[y];var c="function"==typeof Float64Array?new Float64Array(f):new Array(f);for(y=0;y<f;++y)c[y]=n.data[l[y]-1];var d="function"==typeof Float64Array?new Float64Array(f):new Array(f);if(r)for(y=0;y<f;++y)d[y]=r[l[y]-1];else for(y=0;y<f;++y)d[y]=0;var m="function"==typeof Float64Array?new Float64Array(f):new Array(f);if(o)for(y=0;y<f;++y)m[y]=o[l[y]-1];else for(y=0;y<f;++y)m[y]=1;try{var w=T(c,d,m),v=it.zeros(i,1);for(y=0;y<f;++y)v.data[l[y]-1]=w[y];var b=it.axpby(1,n,-1,v).vectorNorm("two");b<e&&(e=b,l,a=v)}catch(t){if("infeasible problem detected: the restricted simplex is empty"!==t.message)throw t}h=u.next()}if(e!=1/0)return a.toArray();throw new Error("infeasible problem detected")}for(var p="function"==typeof UInt32Array?new UInt32Array(i):new Array(i),y=0;y<i;++y)p[y]=y;q(p,t,function(t,r){return n[r]-n[t]});for(var g=n.slice(0,t),y=0;y<t;++y)g[y]=n[p[y]];for(var x=T(g),A="function"==typeof Float64Array?new Float64Array(i):new Array(i),y=0;y<t;++y)A[p[y]]=x[y];for(var y=t;y<i;++y)A[p[y]]=0;return A}},O.bestConstantlyRebalancedWeights=function(f,t){void 0===t&&(t={constraints:{}}),void 0===t.constraints&&(t.constraints={}),void 0===t.eps&&(t.eps=1e-4),void 0===t.maxIter&&(t.maxIter=1e4);var r=t.eps,n=t.maxIter,o=t.constraints.minWeights,i=t.constraints.maxWeights,l=f.length,c=f[0].length;return U(function(t){for(var r=it.zeros(l,1),n=1,o=0;o<c;++o)r=it.fill(l,1,function(t,r){return f[t-1][o]},r),n*=it.vectorDotProduct(t,r);return-n},function(t){for(var r,n=it.zeros(l,1),o="function"==typeof Float64Array?new Float64Array(c):new Array(c),i=1,e=!1,a=0;a<c;++a){n=it.fill(l,1,function(t,r){return f[t-1][a]},n);var s=it.vectorDotProduct(t,n);o[a]=s,!1===e&&(i*=s,Math.abs(s)<=1e-12&&(e=!0))}if(!1!==e)throw new Error("null portfolio relative detected, unsuported case");r=it.fill(c,1,function(t,r){return i/o[t-1]});var u=it.zeros(c,1),h=it.zeros(l,1);for(a=0;a<l;++a)u=it.fill(c,1,function(t,r){return f[a][t-1]},u),h.data[a]=-it.vectorDotProduct(u,r);return h},function(t){return G(t.data,o,i)},function(t){return new it(T(t.data,o,i))},new it(T(it.ones(l,1).data,o,i)),{eps:r,maxIter:n,maxLine:n})[0].toArray()},O.clusterRiskParityWeights=function(t,r){void 0===r&&(r={});var n=r.clusteringMode||"ftca",o=(t=new it(t).toCovarianceMatrix(t)).nbRows,i=[];if("manual"===n){i=r.clusters||[];for(var e=new Array(o),a=0;a<e.length;++a)e[a]=0;for(var s=0;s<i.length;++s){if(0===i[s].length)throw new Error("empty cluster at index: "+s);for(var u=0;u<i[s].length;++u){var h=i[s][u];if(h<1||o<h)throw new Error("asset index out of bounds: "+h);e[h-1]++}}for(a=0;a<e.length;++a)if(1!==e[a])throw 0===e[a]?new Error("missing asset index: "+(a+1)):1<e[a]?new Error("duplicate asset index: "+(a+1)):new Error("unknown error")}else{if("ftca"!==n)throw new Error("unsupported clustering method");i=M(t.getCorrelationMatrix().toRowArray(),r.ftcaThreshold)}var f=i.length,l=it.zeros(f,o);for(a=0;a<f;++a){var c=i[a].slice().sort(function(t,r){return t-r}),d=t.submatrix(c,c),m=O.equalRiskContributionWeights(d,r);for(s=0;s<m.length;++s)l.setValueAt(a+1,c[s],m[s])}var w=it.xy(l,it.axty(1,t,l)),v=O.equalRiskContributionWeights(w,r);return it.txy(l,new it(v)).toArray()},O.equalRiskBoundingWeights=function(t,r){void 0===r&&(r={}),r.outputPortfolioVolatility=!0;var n=(t=new it(t)).nbRows,o=1/0,i=[],e=[],a=new v(n),s=a.next();for(s=a.next();-1!=s;){var u=s,h=t.submatrix(u,u),f=O.equalRiskContributionWeights(h,r),l=f[0],c=f[1],d=c*c/u.length;d<o&&(o=d,i=u,e=l);s=a.next()}for(var m=it.zeros(n,1),w=0;w<i.length;++w)m.setValueAt(i[w],1,e[w]);return m.toArray()},O.equalRiskContributionWeights=function(t,r){var n=(t=new it(t)).nbRows,o=it.fill(n,1,function(t,r){return 1/n});return O.riskBudgetingWeights(t,o,r)},O.equalWeights=function(n,t){return it.fill(n,1,function(t,r){return 1/n}).toArray()},O.globalMinimumVarianceWeights=function(t,r){void 0===r&&(r={}),void 0===r.constraints&&(r.constraints={}),void 0===r.eps&&(r.eps=1e-8),void 0===r.maxIter&&(r.maxIter=1e4);var n=r.eps,o=r.maxIter,i=r.constraints.minWeights,e=r.constraints.maxWeights,a=(t=new it(t)).nbRows,s=it.zeros(a,1),u=it.ones(a,1),h=t,f=s,l=u,c=s;i&&(c=new it(i));var d=u;return e&&(d=new it(e)),_(h,f,l,1,c,d,{eps:n,maxIter:o})[0].toArray()},O.inverseVolatilityWeights=function(t,r){var n=new it(t).elemMap(function(t,r,n){return 1/Math.sqrt(n)});return(n=n.normalize(n)).toArray()},O.maximumSharpeRatioWeights=function(t,r,n,o){var s=1e-8;function u(t,r){return it.vectorDotProduct(r,t)}function h(t,r,n){var o=it.vectorDotProduct(it.xy(n,t),t);if(Math.abs(o)<=s)o=0;else if(o<0&&o<-s)throw new Error("negative volatility, covariance matrix might not be semi-definite positive");return Math.sqrt(o)}function U(t,r,n,o){var i=u(o,t),e=i-n,a=h(o,0,r);return Math.abs(a)<s&&(a=s),[e/a,i,a]}function i(t,r,n,o,i,e,a){var s=U(t,r,n,i),u=s[0],h=s[1],f=s[2],l=f*f,c=U(t,r,n,a),d=c[0],m=c[1],w=c[2],v=w*w,b=h-m,p=m-n,y=b*b,g=2*b*p,x=p*p,A=it.vectorDotProduct(it.xy(r,i),a),C=l+v-2*A,M=-2*(v-A),R=y*M-g*C,E=g*v-x*M,_=2*(y*v-x*C)/2,z=0<=_?1:-1,V=_*_-R*E;if(V<0)throw new Error("internal error, the covariance matrix might not be semi-definite positive");var F=-(_+z*Math.sqrt(V)),I=F/R,P=E/F,O=[[i,u],[a,d]];if(0<I&&I<1){var k=it.fill(i.nbRows,1,function(t,r){return I*i.getValue(t,1)+(1-I)*a.getValue(t,1)}),S=U(t,r,n,k)[0];O.push([k,S])}if(0<P&&P<1){var D=it.fill(i.nbRows,1,function(t,r){return P*i.getValue(t,1)+(1-P)*a.getValue(t,1)}),N=U(t,r,n,D)[0];O.push([D,N])}return W(O,function(t,r){return t[1]-r[1]})[0]}var e=Z(t=new it(t),r=new it(r),o);if(h(e[e.length-1][0],0,r)<s){if(0==(f=X(t,r,e,{constraint:"volatility",constraintValue:s})).length)throw new Error("no corner portfolio with a strictly positive volatility: the covariance matrix might not be semi-definite positive");var a=f[0];e[l=f[1]]=[a,-1],e.length=l+1}if(u(e[e.length-1][0],t)<n+s){var f;if(0==(f=X(t,r,e,{constraint:"return",constraintValue:n+s})).length)throw new Error("no corner portfolio with a strictly positive excess return");var l;a=f[0];e[l=f[1]]=[a,-1],e.length=l+1}var c=function(t,r,n,o){var i=o.length-1,e=0,a=o[i][0],s=o[e][0],u=U(t,r,n,a);if(U(t,r,n,s),i==e)return[i,a,u];for(;i-e!=1;){var h=Math.floor(e+(i-e)/2),f=o[h][0],l=U(t,r,n,f),c=h+1,d=o[c][0],m=U(t,r,n,d);if(l[0]>m[0])i=h,a=f,u=l;else{if(!(l[0]<m[0])){i=c,a=d,u=m,e=h,s=f,l;break}e=h,s=f,l}}return[i,a,u]}(t,r,n,e),d=c[0],m=c[1],w=[[m,c[2][0]]],v=d+1;if(v<=e.length-1){var b=i(t,r,n,0,e[v][0],0,m);w.push(b)}var p=d-1;if(0<=p){var y=i(t,r,n,0,m,0,e[p][0]);w.push(y)}return W(w,function(t,r){return t[1]-r[1]})[0][0].toArray()},O.computeCornerPortfolios_=Z,O.meanVarianceOptimizationWeights=function(n,o,t){var i=1e-8;void 0===t&&(t={constraints:{}}),void 0===t.constraints&&(t.constraints={});var r=!0;void 0!==t.constraints.fullInvestment&&(r=t.constraints.fullInvestment);var e=t.constraints.return,a=t.constraints.volatility,s=t.constraints.maxVolatility,u=t.constraints.riskTolerance;if(void 0===e&&void 0===a&&void 0===s&&null==u)throw new Error("missing return, volatility or risk tolerance constraints");if(void 0!==e&&void 0!==a||void 0!==e&&void 0!==s)throw new Error("simultaneous return and volatility constraints");if(void 0!==u&&(void 0!==e||void 0!==s||void 0!==a))throw new Error("simultaneous risk tolerance and return or volatility constraints");n=new it(n);var h,f,l=(o=new it(o)).nbColumns;if(r)h=Z(n,o,t);else{n=it.fill(l+1,1,function(t,r){return t<=l?n.getValue(t,1):0}),o=it.fill(l+1,l+1,function(t,r){return t<=l&&r<=l?o.getValue(t,r):0});var c=null;if(t.constraints.minWeights){c="function"==typeof Float64Array?new Float64Array(l+1):new Array(l+1);for(var d=0;d<l;++d)c[d]=t.constraints.minWeights[d];c[l]=0}var m=null;if(t.constraints.maxWeights){m="function"==typeof Float64Array?new Float64Array(l+1):new Array(l+1);for(d=0;d<l;++d)m[d]=t.constraints.maxWeights[d];m[l]=1}var w={maxIter:t.maxIter,constraints:t.constraints};t.constraints.minWeights&&(w.constraints.minWeights=c),t.constraints.maxWeights&&(w.constraints.maxWeights=m),h=Z(n,o,w)}if(void 0!==e){if(0==(x=X(n,o,h,{constraint:"return",constraintValue:e})).length)throw new Error("no matching efficient portfolio with a return equal to "+e);f=x[0]}else if(void 0!==a){if(0==(x=X(n,o,h,{constraint:"volatility",constraintValue:a})).length)throw new Error("no matching efficient portfolio with a volatility equal to "+a);f=x[0]}else if(void 0!==u){var v=h[0][0],b=h[0][1],p=h[h.length-1][0],y=h[h.length-1][1];if(b-i<u)f=v;else if(u<y+i)f=p;else{if(0==(x=X(n,o,h,{constraint:"riskTolerance",constraintValue:u})).length)throw new Error("internal error: no matching efficient portfolio with a risk tolerance equal to "+u);f=x[0]}}else if(void 0!==s){var g=h[0][0];if(function(t,r,n){var o=it.vectorDotProduct(it.xy(n,t),t);if(Math.abs(o)<=i)o=0;else if(o<0&&o<-i)throw new Error("negative volatility, covariance matrix might not be semi-definite positive");return Math.sqrt(o)}(g,0,o)-i<s)f=g;else{var x;if(0==(x=X(n,o,h,{constraint:"volatility",constraintValue:s})).length)throw new Error("no matching efficient portfolio with a volatility lower than or equal to "+s);f=x[0]}}return r||(f=it.fill(l,1,function(t,r){if(t<=l)return f.getValue(t,1)})),f.toArray()},O.meanVarianceEfficientFrontierNearestWeights=function(t,r,n,o){r=new it(r),n=new it(n),t=new it(t);var i,e=Z(r,n,o);if(0==e.length)throw new Error("internal error: no corner portfolios");for(var a=Number.POSITIVE_INFINITY,s=0;s<e.length-1;++s){var u=e[s][0],h=l(t,e[s+1][0],u),f=it.xmy(t,new it(h)).vectorNorm("two");f<=a&&(i=h,a=f)}return i},O.meanVarianceEfficientFrontierPortfolios=function(t,r,n){function o(t,r){return it.vectorDotProduct(r,t)}function i(t,r,n){var o=it.vectorDotProduct(it.xy(n,t),t);if(Math.abs(o)<=1e-8)o=0;else if(o<0&&o<-1e-8)throw new Error("negative volatility, covariance matrix might not be semi-definite positive");return Math.sqrt(o)}void 0===n&&(n={constraints:{}});var e=n.nbPortfolios||100,a=Z(t=new it(t),r=new it(r),n),s=(r.nbColumns,new Array(e));if(0==a.length)throw new Error("efficient frontier made of no corner portfolios: internal error");if(1==a.length){if(1!=e)throw new Error("efficient frontier made of only one corner portfolio: only one efficient portfolio can be computed");var u=o(d=a[0][0],t),h=i(d,0,r);return[[d.toArray(),u,h]]}if(e<=1)throw new Error("efficient frontier made of several corner portfolios: at least two efficient portfolios must be computed");for(var f=a[0][1],l=(a[a.length-1][1]-f)/(e-1),c=0;c<e;++c){var d,m=f+c*l;if(0==(d=X(t,r,a,{constraint:"riskTolerance",constraintValue:m})).length)throw new Error("internal error: no matching efficient portfolio with a risk tolerance equal to "+m);u=o(d=d[0],t),h=i(d,0,r);s[e-1-c]=[d.toArray(),u,h]}return s},O.meanVarianceEfficientFrontierCornerPortfolios=function(t,r,n){function o(t,r){return it.vectorDotProduct(r,t)}function i(t,r,n){var o=it.vectorDotProduct(it.xy(n,t),t);if(Math.abs(o)<=1e-8)o=0;else if(o<0&&o<-1e-8)throw new Error("negative volatility, covariance matrix might not be semi-definite positive");return Math.sqrt(o)}var e=Z(t=new it(t),r=new it(r),n),a=[],s=o(l=e[0][0],t),u=i(l,0,r);a.push([l.toArray(),s,u]);for(var h=l,f=1;f<e.length;++f){var l=e[f][0];if(!it.areEqual(l,h,1e-8)){s=o(l,t),u=i(l,0,r);a.push([l.toArray(),s,u]),h=l}}return a.reverse()},O.minimaxWeights=function(n,t){void 0===t&&(t={constraints:{}}),void 0===t.constraints&&(t.constraints={});var r=!0;void 0!==t.constraints.fullInvestment&&(r=t.constraints.fullInvestment);var o=t.outputMinimumPortfolioReturn,i=n.length,e=n[0].length,a=it.fill(i+1,1,function(t,r){return t<=i?0:-1}),s=null,u=null;r&&(s=it.fill(1,i+1,function(t,r){return r<=i?1:0}),u=it.ones(1,1));var h=L(s,u,it.fill(e+(r?0:1),i+1,function(t,r){return t<=e?r<=i?-n[r-1][t-1]:1:t==e+1?r<=i?1:0:void 0}),it.fill(e+(r?0:1),1,function(t,r){return t<=e?0:t==e+1?1:void 0}),a,it.fill(i+1,1,function(t,r){return t<=i?0:-1/0}),it.fill(i+1,1,function(t,r){return t<=i?1:1/0}),{maxIter:-1})[0],f=h.toArray(function(t,r,n){return t!=i+1}),l=h.data[i];return!0===o?[f,l]:f},O.minimumCorrelationWeights=function(t,r){var n=(t=new it(t).toCovarianceMatrix()).getVariances(),o=n.elemMap(function(t,r,n){return 1/Math.sqrt(n)}),i=t.getCorrelationMatrix(),e=i.nbRows;if(e<=2)return O.inverseVolatilityWeights(n,r);for(var a=i.toArray(function(t,r,n){return t<r}),s=F(a),u=w(a),h=i.elemMap(function(t,r,n){return t==r?0:1-R((n-s)/u)}),f=h.toRowArray(function(t,r,n){return t!=r}),l=new Array(e),c=0;c<e;++c)l[c]=F(f[c]);var d=new it(m(l,0),1).normalize();return d=it.xy(h,d).normalize(),(d=it.vectorHadamardProduct(d,o).normalize()).toArray()},O.minimumTrackingErrorWeights=function(n,o,t){void 0===t&&(t={constraints:{}}),void 0===t.constraints&&(t.constraints={}),void 0===t.optimizationMethodParams&&(t.optimizationMethodParams={}),void 0===t.eps&&(t.eps=1e-4),void 0===t.maxIter&&(t.maxIter=1e4),void 0===t.constraints.minNbAssets&&t.constraints.maxNbAssets&&(t.constraints.minNbAssets=1),void 0===t.constraints.maxNbAssets&&t.constraints.minNbAssets&&(t.constraints.maxNbAssets=n.length);var r,i,e,a,s=t.eps,u=t.maxIter,y=t.constraints.minNbAssets,g=t.constraints.maxNbAssets,h=y||g,f=t.constraints.minWeights,l=t.constraints.maxWeights;if(h&&(void 0===(r=t.optimizationMethod)&&(r="combinatorial"),"combinatorial"!=r&&"thresholdAccepting"!=r))throw new Error("unsupported optimisation method");"thresholdAccepting"==r&&(void 0===(i=t.optimizationMethodParams.nRounds)&&(i=3),void 0===(e=t.optimizationMethodParams.nSteps)&&(e=5e3),void 0===(a=t.optimizationMethodParams.nDeltas)&&(a=e));var c,d=n.length,m=n[0].length;o=new it(o);function w(t,r,n,o){var i=t.nbColumns,e=t,a=r;return U(function(t){var r=it.xmy(it.xy(e,t),a).vectorNorm("two");return.5*r*r},function(t){return it.txy(e,it.xmy(it.xy(e,t),a))},function(t){return G(t.data,n,o)},function(t){return new it(T(t.data,n,o))},new it(T(it.ones(i,1).data,n,o)),{eps:s,maxIter:u,maxLine:u})}if(h)if("thresholdAccepting"==r){n=it.fill(m,d,function(t,r){return n[r-1][t-1]});if(!f){f="function"==typeof Float64Array?new Float64Array(d):new Array(d);for(var v=0;v<d;++v)f[v]=0}if(!l){l="function"==typeof Float64Array?new Float64Array(d):new Array(d);for(v=0;v<d;++v)l[v]=1}c=new it(c=D(function(t){t=new it(t);var r=it.xmy(it.xy(n,t),o).vectorNorm("two");return.5*r*r},O.randomWeights(d,{constraints:{minNbAssets:y,maxNbAssets:g,minWeights:f,maxWeights:l}}),{nSteps:e,nRounds:i,nDeltas:a,neighbourGenerator:function(t,r){function n(t,r){return Math.floor(Math.random()*(r-t))+t}for(var o=r.lowerBounds,i=r.upperBounds,e=.05,a=1e-12,s=t.length,u=t,h=0,f=0;f<s;++f)u[f]>a&&++h;var l=new Array(0);if(h==g){for(f=0;f<s;++f)u[f]>a&&u[f]<i[f]-a&&l.push([f,-1]);for(f=0;f<s;++f){var c=new Array(0);if(u[f]<=a&&u[f]<i[f]-a)for(var d=Math.max(o[f],Math.min(i[f]-u[f],e)),m=0;m<s;++m)u[m]>a&&u[m]-d<=a&&c.push([m,u[m]]);0!=c.length&&l.push([f,c])}}else{if(!(h<g))throw new Error("internal error: number of assets strictly greater than the allowed maximum number of assets");for(f=0;f<s;++f)u[f]<i[f]-a&&l.push([f,-1])}var w=l[n(0,l.length)],v=w[0];if(e=Math.min(i[v]-u[v],e),u[v]<=a&&(e=Math.max(o[v],e)),-1==w[1])if(c=new Array(0),h==y){for(f=0;f<s;++f)if(u[f]>a&&u[f]>a+o[f]){var b=Math.min(e,u[f]-o[f]-2*a);u[v]<=a?b>=o[v]&&c.push([f,b]):c.push([f,b])}}else{if(!(y<h))throw new Error("internal error: number of assets strictly lower than the allowed minimum number of assets");for(f=0;f<s;++f)u[f]>a&&u[f]-e<=a?c.push([f,u[f]]):u[f]>a&&u[f]>a+o[f]&&c.push([f,Math.min(e,u[f]-o[f])])}else c=w[1];var p=c[n(0,c.length)];return e=p[1],u[p[0]]-=e,u[v]+=e,u},neighbourGeneratorParameters:{lowerBounds:f,upperBounds:l}})[0])}else{if("combinatorial"!=r)throw new Error("internal error: unsupported optimisation method");for(var b=1/0,p=[],x=[],A=y;A<=g;++A)for(var C=new k(d,A,!1),M=C.next();-1!=M;){var R=M.length,E="function"==typeof UInt32Array?new UInt32Array(R):new Array(R);for(v=0;v<M.length;++v)E[v]=M[v];var _,z,V,F=it.fill(m,R,function(t,r){return n[E[r-1]-1][t-1]});if(f){_="function"==typeof Float64Array?new Float64Array(R):new Array(R);for(v=0;v<R;++v)_[v]=f[E[v]-1]}if(l){z="function"==typeof Float64Array?new Float64Array(R):new Array(R);for(v=0;v<R;++v)z[v]=l[E[v]-1]}var I=1/0;try{var P=w(F,o,_,z);V=P[0],I=P[1]}catch(t){if("infeasible problem detected: the restricted simplex is empty"!==t.message)throw t}I<b&&(b=I,p=E,x=V);M=C.next()}if(b==1/0)throw new Error("infeasible problem detected");c=it.zeros(d,1);for(v=0;v<p.length;++v)c.data[p[v]-1]=x.data[v]}else c=w(n=it.fill(m,d,function(t,r){return n[r-1][t-1]}),o,f,l)[0];return c.toArray()},O.mostDiversifiedWeights=function(t,r){void 0===r&&(r={});var n=r.eps||1e-4,o=r.maxIter||1e4,i=(t=new it(t)).nbRows,e=it.zeros(i,1),a=it.fill(i,1,function(t,r){return Number.MAX_VALUE});return _(t,e,t.diagonal().elemMap(function(t,r,n){return Math.sqrt(n)}),1,e,a,{eps:n,maxIter:o})[0].normalize().toArray()},O.numericalOptimizationWeights=function(t,r,n){void 0===n&&(n={}),void 0===n.constraints&&(n.constraints={}),void 0===n.optimizationMethodParams&&(n.optimizationMethodParams={});var o=n.optimizationMethod;if(void 0===o&&(o="grid-search"),"grid-search"===o&&void 0===n.optimizationMethodParams.k&&(n.optimizationMethodParams.k=t),"grid-search"===o)return e(r,t,n.optimizationMethodParams.k,n.constraints.minWeights,n.constraints.maxWeights);throw new Error("unsupported optimisation method")},O.postOptimizationWeights=function(w,t){void 0===t&&(t={roundingMethodParams:{},roundingOptimizationMethodParams:{}}),void 0===t.roundingOptimizationMethodParams&&(t.roundingOptimizationMethodParams={}),void 0===t.roundingMethodParams&&(t.roundingMethodParams={}),void 0===t.roundingMethod&&(t.roundingMethod="rationalizing"),"rationalizing"==t.roundingMethod&&null==t.roundingMethodParams.k&&(t.roundingMethodParams.k=20);var r,n=t.roundingMethod;if("rationalizing"!=n&&"roundlotting"!=n)throw new Error("unsupported rounding method");"rationalizing"==n&&(r=t.roundingMethodParams.k);var o,i,e,a=t.roundingMethodParams.portfolioValue,v=t.roundingMethodParams.assetsPrices,b=t.roundingMethodParams.sizeLots;if("roundlotting"==n){if(null==a||0==a)throw new Error("missing portfolio value");if(null==v)throw new Error("missing assets prices");if(void 0===b){b="function"==typeof Float64Array?new Float64Array(w.length):new Array(w.length);for(var s=0;s<b.length;++s)b[s]=1}}if("roundlotting"==n&&(void 0===(o=t.roundingOptimizationMethodParams.nRounds)&&(o=3),void 0===(i=t.roundingOptimizationMethodParams.nSteps)&&(i=5e3),void 0===(e=t.roundingOptimizationMethodParams.nDeltas)&&(e=i)),"rationalizing"==n)return x=K(w,r);if("roundlotting"!=n)throw new Error("internal error: unsupported rounding method");var p=w.length;w=new it.fill(p+1,1,function(t,r){return t<=p?w[t-1]:0});function u(n){var t=new it.fill(p+1,1,function(t,r){return t<=p?n[t-1]*b[t-1]*v[t-1]/a:n[p]/a});return it.xmy(w,t).vectorNorm("two")}var h="function"==typeof Float64Array?new Float64Array(p+1):new Array(p+1),f=0;for(s=0;s<p;++s){var l=v[s]*b[s];h[s]=Math.floor(w.getValue(s+1,1)*a/l),f+=h[s]*l}if((y=a-f)<0)throw new Error("internal error: negative cash during intitial feasible point generation");for(h[p]=y;;){var c=-1,d=u(h);for(s=0;s<p;++s){if((l=v[s]*b[s])<y){h[s]+=1,h[p]=y-l;var m=u(h);m<=d&&(c=s,d=m),h[s]-=1,h[p]=y}}if(-1==c)break;h[c]+=1,y-=v[c]*b[c]}if(y<0)throw new Error("internal error: negative cash during intitial feasible point generation");h[p]=y;var y,g=D(u,h,{nSteps:i,nRounds:o,nDeltas:e,neighbourGenerator:function(t,r){function n(t,r){return Math.floor(Math.random()*(r-t))+t}for(var o=0,i=0;i<p;++i)0<t[i]&&++o;for(var e="function"==typeof UInt32Array?new UInt32Array(o):new Array(o),a=i=0;i<p;++i)0<t[i]&&(e[a]=i,++a);if(0!=e.length){var s=e[n(0,o)],u=n(1,t[s]+1);t[s]-=u;var h=v[s]*b[s]*u;t[p]+=h}var f=1;for(i=0;i<p;++i)1e-12<w.getValue(i+1,1)&&++f;var l="function"==typeof UInt32Array?new UInt32Array(f):new Array(f);for(a=i=0;i<p;++i)1e-12<w.getValue(i+1,1)&&(l[a]=i,++a);l[f-1]=p;var c=l[n(0,f)];if(c!=p){var d=n(0,Math.floor(t[p]/(v[c]*b[c]))+1);t[c]+=d;var m=v[c]*b[c]*d;t[p]-=m}return t}})[0],x=new it.fill(p,1,function(t,r){return g[t-1]*b[t-1]*v[t-1]/a}).toArray();return[new it.fill(p,1,function(t,r){return g[t-1]}).toArray(),x,y=g[p]]},O.proportionalMinimumVarianceWeights=function(t,r){for(var n=(t=new it(t)).nbRows,o=t.toRowArray(),i=new Array(n),e=0;e<n;++e)i[e]=F(o[e]);var a=F(i),s=w(i),u=new it(i,1).elemMap(function(t,r,n){return 1-R((n-a)/s)});u=u.normalize(u);var h=t.diagonal().elemMap(function(t,r,n){return 1/n}).normalize();return(u=it.vectorHadamardProduct(u,h).normalize()).toArray()},O.randomSubspaceOptimizationWeights=function(t,r,n){if(void 0===n&&(n={}),void 0===n.constraints&&(n.constraints={}),void 0===n.subsetOptimizationFctOpt&&(n.subsetOptimizationFctOpt={}),void 0===n.subsetOptimizationFctOpt.constraints&&(n.subsetOptimizationFctOpt.constraints={}),t<=1)return[1];var o=n.sizeSubsets;if(void 0===o&&(o=Math.max(2,Math.floor(Math.sqrt(t)))),o<=1||t+1<=o)throw new Error("the size of the subsets of assets must be between 2 and "+t.toString());var i=n.subsetsGenerationMethod;void 0===i&&(i="random");var e,a=n.nbRandomSubsets;if(void 0===a&&(a=128),o===t&&(a=1),"random"===i)e=a;else{if("deterministic"!==i)throw new Error("unsupported subsets of assets generation method");e=y(t,o)}var s=n.subsetsAggregationMethod;if(void 0===s&&(s="average"),"average"!==s&&"median"!==s)throw new Error("unsupported aggregation method");var u,h=n.maxInfeasibleSubsetsRatio;if(void 0===h&&(h=0),"random"===i)u=new x(t,o,!1);else{if("deterministic"!==i)throw new Error("unsupported subsets generation method");u=new k(t,o,!1)}var f=n.subsetOptimizationFctOpt,l=0,c=new Array(e);n.constraints.minWeights&&(f.constraints.minWeights="function"==typeof Float64Array?new Float64Array(o):new Array(o)),n.constraints.maxWeights&&(f.constraints.maxWeights="function"==typeof Float64Array?new Float64Array(o):new Array(o));for(var d=0;d<e;++d){var m=u.next();if(n.constraints.minWeights)for(var w=0;w<o;++w)f.constraints.minWeights[w]=n.constraints.minWeights[m[w]-1];if(n.constraints.maxWeights)for(w=0;w<o;++w)f.constraints.maxWeights[w]=n.constraints.maxWeights[m[w]-1];try{var v=r(m,f);if(v.length!=o)throw new Error("internal error: the portfolio optimization method did not return the expected number of weights")}catch(t){if("infeasible portfolio optimization problem"===t.message)continue;throw t}var b=it.zeros(t,1);for(w=0;w<o;++w)b.setValueAt(m[w],1,v[w]);c[l++]=b}if(0===(c.length=l))throw new Error("no feasible portfolio generated");var p=e-l;if(1<=p&&h<=p/e)throw new Error("too many infeasible portfolios generated");b=null;if("average"==s)b=g(c);else{if("median"!=s)throw new Error("internal error");b=A(c)}return b.toArray()},O.randomSubspaceMeanVarianceOptimizationWeights=function(i,e,t){void 0===t&&(t={}),void 0===t.constraints&&(t.constraints={}),void 0===t.subsetsMeanVarianceOptimizationOpt&&(t.subsetsMeanVarianceOptimizationOpt={}),void 0===t.subsetsMeanVarianceOptimizationOpt.constraints&&(t.subsetsMeanVarianceOptimizationOpt.constraints={});i=new it(i);var r=(e=new it(e)).nbColumns;if(void 0===t.sizeSubsets){var n=-Math.sqrt(2*r*(r+3)),o=2.25-1*n,a=n/-(1.5+Math.sqrt(o));t.sizeSubsets=Math.max(2,Math.floor(a))}return t.subsetOptimizationFctOpt=t.subsetsMeanVarianceOptimizationOpt,t.subsetsMeanVarianceOptimizationOpt.subsetMu=it.zeros(t.sizeSubsets,1),t.subsetsMeanVarianceOptimizationOpt.subsetSigma=it.zeros(t.sizeSubsets,t.sizeSubsets),O.randomSubspaceOptimizationWeights(r,function(t,r){var n=i.submatrix(t,[1],r.subsetMu),o=e.submatrix(t,t,r.subsetSigma);try{return O.meanVarianceOptimizationWeights(n,o,r)}catch(t){throw t.message.includes("no matching efficient portfolio")||"infeasible problem detected: the restricted simplex is empty"===t.message?new Error("infeasible portfolio optimization problem"):t}},t)},O.randomWeights=function(t,r){void 0===r&&(r={}),void 0===r.constraints&&(r.constraints={});var n=r.constraints.minNbAssets||r.constraints.maxNbAssets,o=r.constraints.minNbAssets;void 0===o&&(o=1);var i=r.constraints.maxNbAssets;void 0===i&&(i=t);var e=r.constraints.minExposure;void 0===e&&(e=1);var a=r.constraints.maxExposure;void 0===a&&(a=1);var s=r.maxIter;void 0===s&&(s=1e4);for(var u=-1;;){if(s<++u)throw new Error("maximum number of iterations reached");var h=Math.floor(Math.random()*(i-o+1))+o,f=new x(t,h,!1).next(),l=Math.random()*(a-e)+e,c=0;if(1!==l){c=1;for(var d="function"==typeof Float64Array?new Float64Array(h+c):new Array(h+c),m="function"==typeof Float64Array?new Float64Array(h+c):new Array(h+c),w=0;w<h;++w)d[w]=0,m[w]=1;var v=1-l;d[h]=v,m[h]=v}if(r.constraints.minWeights){if(1===l)d="function"==typeof Float64Array?new Float64Array(h):new Array(h);for(w=0;w<h;++w)d[w]=r.constraints.minWeights[f[w]-1]}if(r.constraints.maxWeights){if(1===l)m="function"==typeof Float64Array?new Float64Array(h):new Array(h);for(w=0;w<h;++w)m[w]=r.constraints.maxWeights[f[w]-1]}try{rt(h+c,d,m)}catch(t){continue}var b=new Y(h+c,d,m).sample();try{if(n)for(w=0;w<h;++w)if(0==b[w])throw new Error("generated weights not compatible with cardinality constraints")}catch(t){continue}break}var p=it.zeros(t,1);for(w=0;w<h;++w){var y=f[w],g=b[w];p.setValueAt(y,1,g)}return p.toArray()},O.riskBudgetingWeights=function(z,V,F){function I(t,r){var n=it.vectorDotProduct(r,t);if(Math.abs(n)<=o)n=0;else if(n<0&&n<-o)throw new Error("negative volatility during iteration "+iter+", covariance matrix might not be semi-definite positive");return Math.sqrt(n)}function r(t,r,n){for(var o=it.fill(D,1,function(t,r){return 1/D}),i=o.elemMap(function(t,r,n){return Math.log(n)}),e=(it.copy(o),it.xy(z,o)),a=I(o,e),s=it.vectorDotProduct(V,i),u=.5*a-s,h=new P(D),f=0;-1==S||f!=S;){if(-1==S&&k<=f)throw new Error("maximum number of cycles reached: "+k);var l;for(++f,h.generateCoordinates();;){var c=h.sampleCoordinate();if(-1==c)break;"acf"===F.coordinatesSampler&&(l=.5*a-s);var d=o.data[c-1],m=i.data[c-1],w=z.data[(c-1)*z.nbColumns+(c-1)],v=e.data[c-1]-o.data[c-1]*w,b=-t*V.data[c-1]*a,p=v/2,y=0<=p?1:-1,g=p*p-w*b;if(g<0)throw new Error("internal error: negative discriminant detected, the covariance matrix might not be semi-definite positive");var x,A=-(p+y*Math.sqrt(g)),C=A/w,M=b/A;if(0<C)x=C;else{if(!(0<M))throw new Error("internal error: no strictly positive root detected, the covariance matrix might not be semi-definite positive");x=M}r&&x<r[c-1]&&(x=r[c-1]),n&&x>n[c-1]&&(x=n[c-1]),o.data[c-1]=x,i.data[c-1]=Math.log(x),s-=m*V.data[c-1],s+=i.data[c-1]*V.data[c-1];for(var R=1;R<=D;++R)e.data[R-1]+=z.data[(R-1)*z.nbColumns+(c-1)]*x,e.data[R-1]-=z.data[(R-1)*z.nbColumns+(c-1)]*d;if(a=I(o,e),"acf"===F.coordinatesSampler){var E=l-(.5*a-s);1==f?h.updateAverageGain(E):h.updateSchedulingPreference(c,E)}}var _=.5*a-s;if(-1==S&&Math.abs(_-u)<=O)break;u=_}return o}void 0===F&&(F={}),void 0===F.constraints&&(F.constraints={}),void 0===F.eps&&(F.eps=1e-10),void 0===F.epsSdp&&(F.epsSdp=1e-12),void 0===F.maxCycles&&(F.maxCycles=1e4),void 0===F.nbCycles&&(F.nbCycles=-1),void 0===F.outputPortfolioVolatility&&(F.outputPortfolioVolatility=!1),void 0===F.coordinatesSampler&&(F.coordinatesSampler="cyclic");var P,O=F.eps,o=F.epsSdp,k=F.maxCycles,S=F.nbCycles,t=F.outputPortfolioVolatility;if("cyclic"===F.coordinatesSampler)P=function(t){this.n=t,this.k=t,this.sampleCoordinate=function(){return this.k==this.n?-1:++this.k},this.generateCoordinates=function(){this.k=0}};else if("shuffledCyclic"===F.coordinatesSampler)P=function(t){this.n=t,this.k=t,this.r="function"==typeof Uint32Array?new Uint32Array(t):new Array(t);for(var r=0;r<t;++r)this.r[r]=r+1;this.sampleCoordinate=function(){return this.k==this.n?-1:this.r[this.k++]},this.generateCoordinates=function(){this.r=new h(void 0,this.r,!0).next(),this.k=0}};else if("randomized"===F.coordinatesSampler)P=function(t){this.n=t,this.k=t;for(var r="function"==typeof Float64Array?new Float64Array(t):new Array(t),n=0;n<t;++n)r[n]=1/t;this.s=new N(r),this.sampleCoordinate=function(){return this.k==this.n?-1:(++this.k,this.s.sample()+1)},this.generateCoordinates=function(){this.k=0}};else{if("acf"!==F.coordinatesSampler)throw new Error("unsupported coordinates sampler");P=function(t){this.n=t,this.k=0,this.change_rate=.2,this.p_min=.05,this.p_max=20,this.idx_set_tmp="function"==typeof Uint32Array?new Uint32Array(2*t):new Array(2*t),this.idx_set=null,this.idx_set_len=0,this.pref="function"==typeof Float64Array?new Float64Array(t):new Array(t);for(var r=0;r<t;++r)this.pref[r]=1;for(this.prefsum=t,this.acc="function"==typeof Float64Array?new Float64Array(t):new Array(t),r=0;r<t;++r)this.acc[r]=.5;this.gain_learning_rate=1/t,this.average_gain=0,this.sampleCoordinate=function(){return this.k==this.idx_set_len?-1:this.idx_set[this.k++]},this.generateCoordinates=function(){this.k=0,this.idx_set_len=0;for(var t=this.n/this.prefsum,r=0;r<this.n;++r){for(var n=this.acc[r]+t*this.pref[r],o=Math.floor(n),i=0;i<o;++i)this.idx_set_tmp[this.idx_set_len]=r+1,this.idx_set_len++;this.acc[r]=n-o}this.idx_set=new h(void 0,this.idx_set_tmp.slice(0,this.idx_set_len),!0).next()},this.updateSchedulingPreference=function(t,r){var n=this.pref[t-1]*Math.exp(this.change_rate*(r/this.average_gain-1));n<this.p_min?n=this.p_min:n>this.p_max&&(n=this.p_max),this.prefsum=this.prefsum+n-this.pref[t-1],this.pref[t-1]=n,this.average_gain=(1-this.gain_learning_rate)*this.average_gain+this.gain_learning_rate*r},this.updateAverageGain=function(t){this.average_gain+=t/this.n}}}var n=null,i=null;if(F.constraints.minWeights&&(n=F.constraints.minWeights,!F.constraints.maxWeights)){i="function"==typeof Float64Array?new Float64Array(F.constraints.minWeights.length):new Array(F.constraints.minWeights.length);for(var e=0;e<i.length;++e)i[e]=1}if(F.constraints.maxWeights&&(i=F.constraints.maxWeights,!F.constraints.minWeights)){n="function"==typeof Float64Array?new Float64Array(F.constraints.maxWeights.length):new Array(F.constraints.maxWeights.length);for(e=0;e<n.length;++e)n[e]=0}z=new it(z),V=new it(V);var a,D=z.nbRows,s=r(1);if(s=s.normalize(),n||i){rt(D,n,i);var u=I(s,it.xy(z,s));a=r(E(function(t){return r(t,n,i).sum()-1},.5*u,2*u),n,i)}else a=s;return!0===t?[a.toArray(),I(a,it.xy(z,a))]:a.toArray()},O}(PortfolioAllocation||{}),"undefined"!=typeof module&&(module.exports=PortfolioAllocation);