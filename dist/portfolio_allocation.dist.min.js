/*! portfolio-allocation - v0.0.9 (2020-08-03), Roman Rubsamen <roman.rubsamen@gmail.com> */
var PortfolioAllocation=PortfolioAllocation||{};PortfolioAllocation=function(T){function V(t){var r={getCorrelationMatrix:function(t){for(var r=z(this.nbRows,this.nbColumns,t),n=0;n<r.nbRows;++n){for(var o=Math.sqrt(this.data[n*this.nbColumns+n]),e=0;e<n;++e)r.data[n*r.nbColumns+e]=r.data[e*this.nbColumns+n];for(e=n;e<r.nbColumns;++e){var i=Math.sqrt(this.data[e*this.nbColumns+e]);r.data[n*r.nbColumns+e]=this.data[n*this.nbColumns+e]/(o*i)}}return r},getVariances:function(t){return this.diagonal(t)},getStandardDeviations:function(t){return this.diagonal(t).elemMap(function(t,r,n){return Math.sqrt(n)},t)},standardizedGeneralizedVariance:function(){var t=this.determinant();if(t<0)throw new Error("covariance matrix is not positive semi-definite");return Math.pow(t,1/this.nbRows)}};for(var n in r)t[n]=r[n]}function st(t){function o(t){var r=Object.prototype.toString.call(t);return"[object Array]"===r||"[object Int8Array]"===r||"[object Uint8Array]"===r||"[object Uint8ClampedArray]"===r||"[object Int16Array]"===r||"[object Uint16Array]"===r||"[object Int32Array]"===r||"[object Uint32Array]"===r||"[object Float32Array]"===r||"[object Float64Array]"===r}if(!(this instanceof st))return new st(t);var e=this;if(o(t)&&o(t[0]))return function(t){e=z(t.length,t[0].length);for(var r=0;r<e.nbRows;++r){if(!o(t[r]))throw new Error("unsupported input type");if(t[r].length!==e.nbColumns)throw new Error("unsupported input type");for(var n=0;n<e.nbColumns;++n)e.data[r*e.nbColumns+n]=t[r][n]}return e}(t);if(o(t))return function(t){e=z(t.length,1);for(var r=0;r<e.nbRows;++r)e.data[r*e.nbColumns]=t[r];return e}(t);if(t instanceof st)return function(t){e=z(t.nbRows,t.nbColumns);for(var r=t.nbRows*t.nbColumns,n=0;n<r;++n)e.data[n]=t.data[n];return e}(t);throw new Error("unsupported input type")}function z(t,r,n){var o;if(void 0===n)(o=Object.create(st.prototype)).nbRows=t,o.nbColumns=r,o.data="function"==typeof Float64Array?new Float64Array(o.nbRows*o.nbColumns):new Array(o.nbRows*o.nbColumns);else{if(!(n instanceof st))throw new Error("provided output must be a matrix");if(n.nbRows!==t||n.nbColumns!==r)throw new Error("provided output matrix size does not match expected matrix size: ("+n.nbRows+","+n.nbColumns+") v.s. ("+t+","+r+")");o=n}return o}function ut(t){if(!(this instanceof ut))return new ut;this.WORD_LENGTH=32,this.WORD_LOG=5,this.words="function"==typeof Uint32Array?new Uint32Array(0):new Array(0);var n=this;(t instanceof Array||"function"==typeof Uint32Array&&t instanceof Uint32Array)&&function(t){for(var r=0;r<t.length;++r)n.set(t[r])}(t),this.iterator=function(){for(this.w_idx=-1,this.w=0;this.w_idx<n.words.length&&0==this.w;)++this.w_idx,this.w=n.words[this.w_idx];this.next=function(){if(this.w_idx==n.words.length)return 0;var t=this.w&-this.w,r=(this.w_idx<<n.WORD_LOG)+ut.populationCount(t-1|0);for(this.w^=t;this.w_idx<n.words.length&&0==this.w;)++this.w_idx,this.w=n.words[this.w_idx];return r}}}function U(t){this.prob="function"==typeof Float64Array?new Float64Array(t.length):new Array(t.length),this.alias="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length);for(var r=1/t.length,n="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length),o=0,e="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length),i=0,a=0;a<t.length;++a)t[a]>r?(e[i]=a,++i):(n[o]=a,++o);for(t=t.slice(0);0<o&&0<i;){a=n[--o];var s=e[--i];this.prob[a]=t.length*t[a],t[this.alias[a]=s]=t[s]+(t[a]-r),t[s]>r?(e[i]=s,++i):(n[o]=s,++o)}for(;0<o;)--o,this.prob[n[o]]=1;for(;0<i;)--i,this.prob[e[i]]=1;this.sample=function(){var t=Math.random()*this.prob.length,r=Math.floor(t);return t-r<=this.prob[r]?r:this.alias[r]}}function o(t,r,n){this.n=t,this.k=r,this.reuseOutputArray=n,this.firstcall=!0,this.mtc=!1,this.r="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.t=this.n,this.h=0,this.next=function(){if(!this.firstcall&&!this.mtc)return-1;if(this.firstcall){this.firstcall=!1,this.r[0]=this.n;for(var t=1;t<=this.k-1;++t)this.r[t]=0}else 1<this.t&&(this.h=0),++this.h,this.t=this.r[this.h-1],this.r[this.h-1]=0,this.r[0]=this.t-1,++this.r[this.h];return this.mtc=this.r[this.k-1]!=this.n,this.reuseOutputArray?this.r:this.r.slice(0)}}function l(t,r,n){if(void 0===r){this.r="function"==typeof Uint32Array?new Uint32Array(t):new Array(t);for(var o=0;o<t;++o)this.r[o]=o+1}else this.r=r;function e(){for(var t=Math.random();0===t;)t=Math.random();return t}this.rrlen=this.r.length,this.reuseOutputArray=n,this.next=function(){if(this.reuseOutputArray)var t=this.r;else t=this.r.slice(0);for(var r=1;r<=this.rrlen;++r){var n=r+Math.floor(e()*(this.rrlen+1-r)),o=t[n-1];t[n-1]=t[r-1],t[r-1]=o}return t}}function L(t,r,n){this.n=t,this.k=r,this.useArrayCopy=n,this.a="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.firstcall=!0,this.mtc=!1,this.m2=0,this.h=this.k,this.endval=this.n-this.k+1,this.next=function(){if(!(this.firstcall||this.mtc&&0!==this.k))return-1;this.firstcall?this.firstcall=!1:(this.m2<this.n-this.h&&(this.h=0),++this.h,this.m2=this.a[this.k-this.h]);for(var t=1;t<=this.h;++t)this.a[this.k+t-this.h-1]=this.m2+t;return this.mtc=this.a[0]!=this.endval,this.useArrayCopy?this.a.slice(0):this.a}}function x(t,r,n){function d(){for(var t=Math.random();0===t;)t=Math.random();return t}this.n=t,this.k=r,this.useArrayCopy=n,this.a="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.N,this.nn,this.idx_a,this.selected_record,this.method_a=function(){for(var t=this.N-this.nn;2<=this.nn;){for(var r=d(),n=0,o=t/this.N;r<o;)++n,--t,--this.N,o=o*t/this.N;this.selected_record+=n+1,this.a[this.idx_a++]=this.selected_record,--this.N,--this.nn}(n=Math.floor(this.N*d()))===this.N&&(n=this.N-1),this.selected_record+=n+1,this.a[this.idx_a++]=this.selected_record},this.method_d=function(){for(var t=1/this.nn,r=Math.pow(d(),t),n=1-this.nn+this.N,o=13*this.nn;1<this.nn&&o<this.N;){for(var e,i,a=1/(-1+this.nn);;){for(;e=this.N*(1-r),!((i=Math.floor(e))<n);)r=Math.pow(d(),t);var s=d(),u=Math.pow(s*this.N/n,a);if((r=u*(-e/this.N+1)*(n/(-i+n)))<=1)break;var l,h,f=1,m=-1+this.N;h=-1+this.nn>i?(l=-this.nn+this.N,-i+this.N):(l=-1-i+this.N,n);for(var c=-1+this.N;h<=c;--c)f=f*m/l,--m,--l;if(this.N/(-e+this.N)>=u*Math.pow(f,a)){r=Math.pow(d(),a);break}r=Math.pow(d(),t)}this.selected_record+=i+1,this.a[this.idx_a++]=this.selected_record,this.N=-i+(-1+this.N),--this.nn,t=a,n=-i+n,o+=-13}1<this.nn?this.method_a():((i=Math.floor(this.N*r))===this.N&&(i=this.N-1),this.selected_record+=i+1,this.a[this.idx_a++]=this.selected_record)},this.next=function(){for(var t=0;t<this.k;++t)this.a[t]=0;return this.N=this.n,this.nn=this.k,this.idx_a=0,this.selected_record=0,this.method_d(),this.useArrayCopy?this.a.slice(0):this.a}}function v(t){this.n=t,this.firstcall=!0,this.mtc=!1,this.iin="function"==typeof Uint32Array?new Uint32Array(t):new Array(t),this.ncard=0,this.next=function(){var t=[];if(!this.firstcall&&!this.mtc)return-1;if(this.firstcall){this.firstcall=!1;for(var r=0;r<=this.n-1;++r)this.iin[r]=0;this.mtc=!0}else{var n=0;if(this.ncard%2!=0)for(++n;0==this.iin[n-1];)++n;this.iin[n]=1-this.iin[n],this.ncard=this.ncard+2*this.iin[n]-1,t="function"==typeof Uint32Array?new Uint32Array(this.ncard):new Array(this.ncard);var o=0;for(r=0;r<=this.n-1;++r)1==this.iin[r]&&(t[o++]=r+1);this.mtc=this.ncard!=this.iin[this.n-1]}return t}}function g(t){for(var r=t.length,n=t[0].nbRows,o=st.zeros(n,1),e=1;e<=n;++e){for(var i=0,a=0;a<r;++a)i+=t[a].getValue(e,1);var s=i/r,u=0;for(a=0;a<r;++a)u+=t[a].getValue(e,1)-s;o.setValue(e,1,(i+u)/r)}return o}function p(t,r,n){t=new st(t),r=new st(r),n=new st(n);if(r.nbRows!=t.nbRows||n.nbRows!=t.nbRows)throw new Error("incompatible dimensions: "+t.nbRows+", "+r.nbRows+", "+n.nbRows);var o=st.xmy(n,r),e=st.xmy(t,r),i=o.vectorNorm("two");if(i<=1e-8)return r.toArray();var a=Math.max(0,Math.min(1,st.vectorDotProduct(o,e)/(i*i)));return st.axpby(1,r,a,o).toArray()}function b(t,r,n){var o=t;n||(o=t.slice(0).sort(function(t,r){return t-r}));var e=r*(t.length-1),i=Math.floor(e);return i==e?o[i]:o[i]+(o[i+1]-o[i])*(e-i)}function y(t,r,n,o){if(this.n=t,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.reuseOutputArray=o,this.l=r,!this.l){this.l="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(var e=0;e<this.n;++e)this.l[e]=0}if(this.u=n,!this.u){this.u="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(e=0;e<this.n;++e)this.u[e]=1}for(e=0;e<this.n;++e)if(this.l[e]>this.u[e])throw new Error("empty box detected: lower bound strictly greater than upper bound");this.sample=function(){for(var t=0;t<this.n;++t)this.x[t]=Math.random()*(this.u[t]-this.l[t])+this.l[t];return this.reuseOutputArray?this.x:this.x.slice(0)}}function B(t,r){r=r||function(t,r){return t-r};for(var n=t.length,o=t[0],e=0,i=1;i<n;++i)0<r(t[i],o)&&(o=t[i],e=i);return[o,e]}function W(t,r,n){n=n||function(t,r){return t-r};var o=t.length,e="function"==typeof UInt32Array?new UInt32Array(10):new Array(10),i="function"==typeof UInt32Array?new UInt32Array(10):new Array(10),a=0,s=0,u=o-1;for(r=r-1;;)if(600<u-s&&a<10){var l=u-s+1,h=r-s+1,f=l,m=Math.log(f),c=Math.floor(.5*Math.exp(2*m/3)+.5),d=f/2<=h?1:-1,w=.5*Math.sqrt(m*c*(1-c/f))*d+.5;w=-1<w&&w<1?0:1<=w?Math.floor(w):Math.ceil(w),h==l/2&&(w=0),e[a]=s,i[a]=u,a++;var v=r-h*(c/f)+w;s<v&&(s=Math.floor(v+.5)),v+c<u&&(u=Math.floor(v+c+.5))}else{if(u<=s){if(0==a)return t[r];s=e[--a],u=i[a]}var p=t[r];for(h=s,j=u,t[r]=t[s],n(t[s]=p,t[u])<0&&(t[s]=t[u],t[u]=p);h<j;){var b=t[j];for(t[j]=t[h],t[h]=b,++h,--j;n(t[h],p)<0;)++h;for(;0<n(t[j],p);)--j}if(0==n(t[s],p)){b=t[s];t[s]=t[j],t[j]=b}else{++j;b=t[j];t[j]=t[u],t[u]=b}j<=r&&(s=j+1),r<=j&&(u=j-1)}}function C(t){var r=Math.pow(2,-52),n=(2-r)*Math.pow(2,1023),o=Math.pow(2,-1022);if(t!=t)return t;if(t===-1/0)return-n;if(t===1/0)return 1/0;if(t===+n)return 1/0;var e=t*(t<0?1-r/2:1+r);e===t&&(e=0<o*r?t+o*r:t+o),e===1/0&&(e=+n);var i=t+(e-t)/2;t<i&&i<e&&(e=i);var a=(e+t)/2;return t<a&&a<e&&(e=a),0===e?-0:e}function A(t,r){var n=0,o=Math.abs(t),e=Math.abs(r);return n=e<o?(n=r/t,o*Math.sqrt(1+n*n)):0!=r?(n=t/r,e*Math.sqrt(1+n*n)):0}function I(t){for(var r,n=t.length,o=0,e=0;e<n;++e)o+=t[e];r=o/n;var i=0;for(e=0;e<n;++e)i+=t[e]-r;return(o+i)/n}function n(t){for(var r=t.length,n=I(t),o=0,e=0,i=0;i<r;++i){var a=t[i]-n;o+=a*a,e+=a}return(o-e*e/r)/r}function d(t){return Math.sqrt(function(t){var r=t.length;return n(t)*r/(r-1)}(t))}function w(t){var r=t,n=0,o=t,e=t*t,i=1;if(t<-8)return 0;if(8<t)return 1;for(;r!=n;)r=(n=r)+(o*=e/(i+=2));return.5+r*Math.exp(-.5*e-.9189385332046728)}function R(t,r){null==t&&(t=0),null==r&&(r=1);for(var n=Math.random();0===n;)n=Math.random();return t+r*function(t){if(t<=0||1<=t){if(0==t)return-1/0;if(1==t)return 1/0;throw"The probality p must be bigger than 0 and smaller than 1"}var r,n=t-.5;if(Math.abs(n)<=.425){r=n*(((((((2509.0809287301227*(o=.180625-n*n)+33430.57558358813)*o+67265.7709270087)*o+45921.95393154987)*o+13731.69376550946)*o+1971.5909503065513)*o+133.14166789178438)*o+3.3871328727963665)/(((((((5226.495278852854*o+28729.085735721943)*o+39307.89580009271)*o+21213.794301586597)*o+5394.196021424751)*o+687.1870074920579)*o+42.31333070160091)*o+1)}else{var o;if(o=n<0?t:1-t,(o=Math.sqrt(-Math.log(o)))<=5)r=(((((((.0007745450142783414*(o-=1.6)+.022723844989269184)*o+.2417807251774506)*o+1.2704582524523684)*o+3.6478483247632045)*o+5.769497221460691)*o+4.630337846156546)*o+1.4234371107496835)/(((((((1.0507500716444169e-9*o+.0005475938084995345)*o+.015198666563616457)*o+.14810397642748008)*o+.6897673349851)*o+1.6763848301838038)*o+2.053191626637759)*o+1);else r=(((((((2.0103343992922881e-7*(o-=5)+27115555687434876e-21)*o+.0012426609473880784)*o+.026532189526576124)*o+.29656057182850487)*o+1.7848265399172913)*o+5.463784911164114)*o+6.657904643501103)/(((((((20442631033899397e-31*o+1.421511758316446e-7)*o+18463183175100548e-21)*o+.0007868691311456133)*o+.014875361290850615)*o+.1369298809227358)*o+.599832206555888)*o+1);n<0&&(r=-r)}return r}(n)}function E(t,r){this.n=t,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.reuseOutputArray=r,this.sample=function(){for(var t=0,r=1,n=0;n<this.n;++n){var o=R();this.x[n]=o;var e=Math.abs(o);0!=e&&(t<e?(r=1+r*(t/o)*(t/o),t=e):r+=o/t*(o/t))}var i=t*Math.sqrt(r);for(n=0;n<this.n;++n)this.x[n]=this.x[n]/i;return this.reuseOutputArray?this.x:this.x.slice(0)}}function k(t,r){for(var n=t.length,o=I(t),e=I(r),i=0,a=0,s=0,u=0;u<n;++u){var l=t[u]-o,h=r[u]-e;i+=l*h,a+=l,s+=h}return(i-a*s/n)/n}function N(t,r){var n=t.length;return k(t,r)*n/(n-1)}function q(t,r,n){r.nbRows;void 0===n&&(n={});var o=n.nRounds;void 0===o&&(o=10);var e=n.nSteps;void 0===e&&(e=5e3);var i=n.nDeltas;void 0===i&&(i=e);var f=n.neighbourGenerator,a=n.neighbourGeneratorParameters;void 0===f&&(f=function(t,r){for(var n=r.alpha,o=r.lowerBounds,e=r.upperBounds,i=t.length,a=t.slice(),s=t.slice(),u=0;u<i;++u)a[u]=t[u]-n/2,s[u]=t[u]+n/2,o&&(a[u]=Math.max(a[u],o[u])),e&&(s[u]=Math.min(s[u],e[u]));return new y(i,a,s).sample()},void 0!==a&&void 0!==a.alpha||(a={alpha:.001}));for(var s,u=function(t,r,n,o,e){for(var i=t(r),a="function"==typeof Float64Array?new Float64Array(o):new Array(o),s=0;s<o;++s){var u=f(r,n),l=t(u);a[s]=Math.abs(i-l),r=u,i=l}a.sort(function(t,r){return t-r});var h="function"==typeof Float64Array?new Float64Array(e):new Array(e);for(s=0;s<e;++s)h[s]=b(a,(e-(s+1))/e,!0);return h[e-1]=0,h}(t,s=r.slice(),a,i,o),l=r.slice(),h=t(l),m=t(s=r.slice()),c=0;c<o;++c)for(var d=0;d<e;++d){var w=s.slice(),v=f(s,a),p=t(v);p-m<u[c]?(s=v.slice(),m=p):s=w,p<h&&(h=p,l=v.slice())}return[l,h]}function M(t,r,n,o){void 0===o&&(o={});var e=o.maxIter;void 0===e&&(e=45);var i=o.eps;void 0===i&&(i=1e-6);var a=o.outputInterval;void 0===a&&(a=!1);var s,u,l=t(r),h=t(n);if(u=l<=0?n-(s=r):r-(s=n),n<=r)throw new Error("bracketing interval lower bound "+r+" greater than bracketing interval upper bound "+n);if(0==l)return a?[r,r+i]:r;if(0==h)return a?[n-i,n]:n;if(0<l*h)throw new Error("interval ["+r+","+n+"] is not a bracketing interval");for(var f=0;;){if(-1!==e&&e<f)throw new Error("maximum number of iterations reached: "+e);++f;var m=s+(u/=2),c=t(m);if(c<=0&&(s=m),Math.abs(u)<=i||0==c)return a?[Math.max(r,s-i),Math.min(n,s+i)]:s}}function D(r,t,n,e,o,i){function a(t){return r(t)+n(t)}function s(t,r,n){var o=st.axpby(1,r,-t,n);return[o,st.copy(e(o,t))]}void 0===i&&(i={});for(var u,l,h,f,m,c,d,w,v,p,b,g,y,x,C,A,R=i.eps||1e-4,E=i.maxIter||1e4,M=i.maxLine||100,P=i.beta||.5,V=i.alphaMin||1e-10,z=i.alphaMax||1e10,I=i.restartPeriod||1e3,k=o.nbRows,N=1e-12,S=.5,_=V,F=st.zeros(k,1),O=st.zeros(k,1),T=st.zeros(k,1),U=st.zeros(k,1),L=st.zeros(k,1),B=!0,W=0;;){if(-1!==E&&E<W)throw new Error("maximum number of iterations reached: "+E);++W%I==0&&(o=m,B=!0),!0===B&&(u=0,h=l=1,f=null,new st(c=new st(m=new st(o))),d=st.zeros(k,1),F=st.copy(t(m),F),O=st.copy(F,O),T=st.copy(O,T),w=st.zeros(k,1),U=st.copy(m,U),L=st.copy(F,L),B=!1);for(var q=_,D=s(q,U,L),G=D[0],H=D[1],j=0;a(H)>(v=q,p=H,g=L,x=void 0,y=r(b=U),x=st.xmy(p,b),C=x.vectorNorm("two"),A=n(p),y+st.vectorDotProduct(x,g)+1/(2*v)*C*C+A+N);){if(-1!==M&&M<j)throw new Error("maximum number of line searches reached: "+M+" at iteration: "+W);++j,q*=P,h/=P,l=(1+Math.sqrt(1+4*h*u*u))/2,G=(D=s(q,U=st.axpby(1,c,(u-1)/l,d,U),L=st.axpby(1,O,(u-1)/l,w,L)))[0],H=D[1]}F=st.copy(t(m=H),F);var Y=st.xmy(m,c),K=st.xmy(F,O),J=st.vectorDotProduct(Y,Y),Q=Math.max(st.vectorDotProduct(K,K),N),X=st.vectorDotProduct(Y,K);if(X<=N)mu_kp_0=z;else{var Z=Math.max(V,Math.min(J/X,z)),$=Math.max(V,Math.min(X/Q,z));$/Z<=S?(mu_kp_0=$,S*=.9):(mu_kp_0=Z,S*=1.1)}f=q/mu_kp_0;var tt=(1+Math.sqrt(1+4*f*l*l))/2,rt=st.axpby(1,m,(l-1)/tt,Y),nt=st.axpby(1,F,(l-1)/tt,K),ot=st.axpby(1/q,G,-1/q,m);if(st.xpy(F,ot).vectorNorm("infinity")<=R)break;N<=st.vectorDotProduct(st.xmy(U,m),Y)&&(o=m,B=!0),_=mu_kp_0,c,c=m,d=Y,T=st.copy(O,T),O=st.copy(F,O),w=K,U=st.copy(rt,U),L=st.copy(nt,L),h=f,u=l,l=tt}return[m,a(m)]}function F(a,s,u,t,l,h,r){function n(t,r){return t instanceof Array?(t.length=r,t):t instanceof Float64Array||t instanceof Int32Array?t.subarray(0,r):void 0}function o(t){for(var r=p-t*b+g,n=new v.iterator,o=n.next();0!=o;){var e,i=o-1;t<=w[i]?e=h.data[i]:w[i]<=t&&t<=d[i]?e=(s.data[i]-t*u.data[i])/a.data[i]:d[i]<=t&&(e=l.data[i]),r+=u.data[i]*e,o=n.next()}return r}void 0===r&&(r={});var e=r.eps||1e-16,i=r.outputLagrangeMultiplier;if(!(a instanceof st&&a.isVector()))throw new Error("first input must be a vector");if(!(s instanceof st&&s.isVector()))throw new Error("second input must be a vector");if(!(u instanceof st&&u.isVector()))throw new Error("third input must be a vector");if(!(l instanceof st&&l.isVector()))throw new Error("fifth input must be a vector");if(!(h instanceof st&&h.isVector()))throw new Error("sixth input must be a vector");if(a.nbRows!==s.nbRows)throw new Error("first and second inputs number of rows do not match: "+a.nbRows+"-"+s.nbRows);if(a.nbRows!==u.nbRows)throw new Error("first and third inputs number of rows do not match: "+a.nbRows+"-"+u.nbRows);if(a.nbRows!==l.nbRows)throw new Error("first and fifth inputs number of rows do not match: "+a.nbRows+"-"+l.nbRows);if(a.nbRows!==h.nbRows)throw new Error("first and sixth inputs number of rows do not match: "+a.nbRows+"-"+h.nbRows);for(var f=u.nbRows,m=Math.abs(t),c="function"==typeof Float64Array?new Float64Array(2*f):new Array(2*f),d="function"==typeof Float64Array?new Float64Array(f):new Array(f),w="function"==typeof Float64Array?new Float64Array(f):new Array(f),v=(new ut).setRange(1,f),p=0,b=0,g=0,y=1/0,x=-1/0,C=0,A=0;C<f;++C){if(l.data[C]>h.data[C])throw new Error("infeasible problem detected");if(u.data[C]<=0)throw new Error("negative element detected in b");if(a.data[C]<=0)throw new Error("negative element detected in d");var R=(s.data[C]-l.data[C]*a.data[C])/u.data[C];d[C]=R,c[A++]=R;var E=(s.data[C]-h.data[C]*a.data[C])/u.data[C];w[C]=E,x<R&&(x=R),(c[A++]=E)<y&&(y=E)}var M=o(y),P=o(x);if(M<t||t<P)throw new Error("infeasible problem detected");var V=null;if(Math.abs(M-t)<=e*m)V=y;else if(Math.abs(M-t)<=e*m)V=x;else{for(var z=y,I=x;0!=c.length;){var k=Math.ceil(c.length/2),N=W(c,k),S=o(N);if(Math.abs(S-t)<=e*m){V=N;break}if(t<S){z=N;for(A=0,C=k;C<c.length;++C)c[A++]=c[C];c=n(c,A)}else S<t&&(I=N,c=n(c,k-1));for(var _=new v.iterator,F=_.next();0!=F;){var O=!1;if(d[C=F-1]<=z&&(g+=u.data[C]*l.data[C],O=!0),I<=w[C]&&(g+=u.data[C]*h.data[C],O=!0),w[C]<=z&&I<=d[C]){var T=u.data[C]/a.data[C];p+=s.data[C]*T,b+=u.data[C]*T,O=!0}!0===O&&v.unset(C+1),F=_.next()}}0==c.length&&(V=(p+g-t)/b)}var U=function(){for(var t=st.zeros(f,1),r=0;r<f;++r){var n;V<=w[r]?n=h.data[r]:w[r]<=V&&V<=d[r]?n=(s.data[r]-V*u.data[r])/a.data[r]:d[r]<=V&&(n=l.data[r]),t.data[r]=n}return t}(),L=.5*st.vectorDotProduct(U,st.elementwiseProduct(U,a))-st.vectorDotProduct(s,U);return!0===i?[U,L,V]:[U,L]}function P(t,r,n,o,e,i,s){void 0===s&&(s={});var u=s.eps||1e-4,l=s.maxIter||1e4;if(!(t instanceof st&&t.isSquare()))throw new Error("first input must be a square matrix");if(!(r instanceof st&&r.isVector()))throw new Error("second input must be a vector");if(!(n instanceof st&&n.isVector()))throw new Error("third input must be a vector");if(!(e instanceof st&&e.isVector()))throw new Error("fifth input must be a vector");if(!(i instanceof st&&i.isVector()))throw new Error("sixth input must be a vector");if(t.nbRows!==r.nbRows)throw new Error("first and second inputs number of rows do not match: "+t.nbRows+"-"+a.nbRows);if(t.nbRows!==n.nbRows)throw new Error("first and third inputs number of rows do not match: "+t.nbRows+"-"+n.nbRows);if(t.nbRows!==e.nbRows)throw new Error("first and fifth inputs number of rows do not match: "+t.nbRows+"-"+e.nbRows);if(t.nbRows!==i.nbRows)throw new Error("first and sixth inputs number of rows do not match: "+t.nbRows+"-"+i.nbRows);for(var h=t.nbRows,f=st.fill(h,1,function(t,r){return o/h*1/n.data[t-1]}),m=F(st.ones(h,1),f,n,o,e,i)[0],c=st.xpy(st.xy(t,m),r),d=0;;){if(-1!==l&&l<=d)throw new Error("maximum number of iterations reached: "+l);++d;for(var w=-1,v=-1/0,p=-1,b=1/0,g=0;g<h;++g)F_i=c.data[g]/n.data[g],e.data[g]<m.data[g]&&m.data[g]<i.data[g]?(F_i>v&&(v=F_i,w=g),F_i<b&&(b=F_i,p=g)):m.data[g]==e.data[g]?F_i<b&&(b=F_i,p=g):m.data[g]==i.data[g]&&F_i>v&&(v=F_i,w=g);if(v-b<=u)break;g=p;var y,x=w,C=(e.data[g]-m.data[g])*n.data[g],A=(m.data[x]-i.data[x])*n.data[x],R=A<=C?C:A,E=(i.data[g]-m.data[g])*n.data[g],M=(m.data[x]-e.data[x])*n.data[x],P=E<=M?E:M,V=b-v,z=t.data[g*t.nbColumns+g]/(n.data[g]*n.data[g])+t.data[x*t.nbColumns+x]/(n.data[x]*n.data[x])-2*t.data[g*t.nbColumns+x]/(n.data[g]*n.data[x]);if(0<z)P<(y=-V/z)?y=P:y<R&&(y=R);else{if(0!=z)throw new Error("internal error: the input matrix might not be positive semi-definite");y=0<V?R:P}var I=m.data[g],k=m.data[x],N=y/n.data[g],S=-y/n.data[x];m.data[g]+=N,m.data[x]+=S,y==R&&(R==C&&(m.data[g]=e.data[g],N=m.data[g]-I),R==A&&(m.data[x]=i.data[x],S=m.data[x]-k)),y==P&&(P==E&&(m.data[g]=i.data[g],N=m.data[g]-I),P==M&&(m.data[x]=e.data[x],S=m.data[x]-k));for(var _=0;_<h;++_)c.data[_]=c.data[_]+t.data[_*t.nbColumns+g]*N+t.data[_*t.nbColumns+x]*S}return[m,.5*st.vectorDotProduct(m,st.xy(t,m))+st.vectorDotProduct(r,m)]}function lt(n,t,r){var o=(n=new st(n)).nbRows;t=t?new st(t):st.zeros(o,1),r=r?new st(r):st.ones(o,1);Y(o,t.toArray(),r.toArray());for(var e="function"==typeof Uint32Array?new Uint32Array(o):new Array(o),i=0;i<o;++i)e[i]=i+1;e.sort(function(t,r){return n.getValue(t,1)-n.getValue(r,1)});for(var a=new st(t),s=1-a.sum(),u=-1,l=0;l<o&&!(Math.abs(s)<=1e-16);++l){u=e[l];var h=a.getValue(u,1);s>=r.getValue(u,1)-h?(a.setValue(u,1,r.getValue(u,1)),s-=r.getValue(u,1)-h):(a.setValue(u,1,h+s),s=0)}return[a.toArray(),st.vectorDotProduct(n,a)]}function G(t,r,n){var o=t.length;Y(o,r,n);for(var e=0,i=0;i<o;++i){var a=0;r&&(a=r[i]);var s=1;n&&(s=n[i]);var u=t[i];if(u<a||s<u)return Number.POSITIVE_INFINITY;e+=u}return 1e-12<Math.abs(e-1)?Number.POSITIVE_INFINITY:0}function H(t,r,n){for(var o=0,e=0,i=0;i<t;++i){var a=0;r&&(a=r[i]);var s=1;if(n&&(s=n[i]),s<a)throw new Error("infeasible problem detected: lower bound strictly greater than upper bound");if(a<0)throw new Error("incorrect problem detected: lower bound strictly lower than 0");if(1<s)throw new Error("incorrect problem detected: upper bound strictly greater than 1");o+=a,e+=s}if(1<o)throw new Error("infeasible problem detected: the restricted simplex is empty");return[o,e]}function Y(t,r,n){for(var o=0,e=0,i=0;i<t;++i){var a=0;r&&(a=r[i]);var s=1;if(n&&(s=n[i]),s<a)throw new Error("infeasible problem detected: lower bound strictly greater than upper bound");if(a<0)throw new Error("incorrect problem detected: lower bound strictly lower than 0");if(1<s)throw new Error("incorrect problem detected: upper bound strictly greater than 1");o+=a,e+=s}if(1<o||e<1)throw new Error("infeasible problem detected: the restricted simplex is empty");return[o,e]}function K(t,i,a){var r=t.length;H(r,i,a);var n=new st(t).elemMap(function(t,r,n){var o=i?i[t-1]:0,e=a?a[t-1]:1;return Math.max(-o,Math.min(e,n))}),o=st.ones(r,1);return st.vectorDotProduct(o,n)<=1?n.toArray():J(t,i,a)}function J(t,r,n){var o=t.length;Y(o,r,n);for(var e=st.ones(o,1),i=new st(t),a=st.ones(o,1),s=r?new st(r):st.zeros(o,1),u=n?new st(n):st.ones(o,1),l=F(e,i,a,1,s,u),h=l[0].toArray();G(h,r,n)==Number.POSITIVE_INFINITY;)h=(l=F(e,i=new st(h),a,1,s,u))[0].toArray();return h}function S(t,r,n){this.n=t,this.k=r,this.reuseOutputArray=n,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.compositionIterator=new o(r,t,!0),this.sample=function(){var t=this.compositionIterator.next();if(-1==t)return-1;for(var r=0;r<this.n;++r)this.x[r]=t[r]/this.k;return this.reuseOutputArray?this.x:this.x.slice(0)}}function _(l,t,r,n){if(this.n=l,this.x="function"==typeof Float64Array?new Float64Array(l):new Array(l),this.u="function"==typeof Float64Array?new Float64Array(l-1):new Array(l-1),this.randomGenerator=function(t){for(var r=0;r<this.n;++r)t[r]=Math.random()},n){if("function"!=typeof n)throw new Error("the random number generator must be a function");this.randomGenerator=n}if(t&&(this.lowerBounds=t,!r)){this.upperBounds="function"==typeof Float64Array?new Float64Array(l):new Array(l);for(var o=0;o<this.n;++o)this.upperBounds[o]=1}if(r&&(this.upperBounds=r,!t)){this.lowerBounds="function"==typeof Float64Array?new Float64Array(l):new Array(l);for(o=0;o<this.n;++o)this.lowerBounds[o]=0}if(this.lowerBounds||this.upperBounds){var e=Y(l,this.lowerBounds,this.upperBounds);if(this.sumLowerBounds=e[0],this.sumUpperBounds=e[1],1==this.sumLowerBounds||1==this.sumUpperBounds);else{var i=0,a=0;for(o=0;o<this.n;++o){var s=this.lowerBounds[o],u=this.upperBounds[o],h=Math.max(s,u+1-this.sumUpperBounds),f=Math.min(u,s+1-this.sumLowerBounds);i+=this.lowerBounds[o]=h,a+=this.upperBounds[o]=f}this.sumLowerBounds=i,this.sumUpperBounds=a,this.upperStarBounds="function"==typeof Float64Array?new Float64Array(l):new Array(l),this.runningSumUpperStarBounds="function"==typeof Float64Array?new Float64Array(l):new Array(l);var m=0;for(o=0;o<this.n;++o)this.upperStarBounds[o]=(this.upperBounds[o]-this.lowerBounds[o])/(1-this.sumLowerBounds),m+=this.upperStarBounds[o],this.runningSumUpperStarBounds[o]=m}}this.sample_no_bounds=function(){for(var t=0,r=0;r<this.n;++r){var n=1-Math.random(),o=Math.log(n);t+=this.x[r]=o}for(r=0;r<this.n;++r)this.x[r]=this.x[r]/t;return this.x.slice(0)},this.sample_binding_bounds=function(){var t=null;if(1==this.sumLowerBounds)t=this.lowerBounds;else{if(1!=this.sumUpperBounds)throw new Error("internal error");t=this.upperBounds}for(var r=0;r<this.n;++r)this.x[r]=t[r];return this.x.slice(0)},this.sample_with_bounds=function(){this.randomGenerator(this.u);for(var t=this.u,r=1,n=l;2<=n;--n){if(Math.abs(r)<=1e-14){for(var o=n;1<=o;--o)this.x[o-1]=0;break}var e=t[n-2],i=Math.max(0,1-this.runningSumUpperStarBounds[n-2]/r),a=Math.min(1,this.upperStarBounds[n-1]/r),s=r*(1-Math.pow(e*Math.pow(1-a,n-1)+(1-e)*Math.pow(1-i,n-1),1/(n-1)));r-=this.x[n-1]=s}1==n&&(this.x[0]=r);for(var u=0;u<this.n;++u)this.x[u]=(1-this.sumLowerBounds)*this.x[u]+this.lowerBounds[u];return this.x.slice(0)},this.lowerBounds||this.upperBounds?1==this.sumLowerBounds||1==this.sumUpperBounds?this.sample=this.sample_binding_bounds:this.sample=this.sample_with_bounds:this.sample=this.sample_no_bounds}function O(t,r,n){if(h.call(this,t,r,n),1==this.fullInvestment)this.cornerPortfolios=u(this.mu,this.sigma,this.lowerBounds,this.upperBounds,n);else{var o=this;this.alteredCornerPortfolios=u(this.alteredMu,this.alteredSigma,this.alteredLowerBounds,this.alteredUpperBounds,n),this.cornerPortfolios=new Array(this.alteredCornerPortfolios.length);for(var e=0;e<this.alteredCornerPortfolios.length;++e){var i=this.alteredCornerPortfolios[e][0],a=this.alteredCornerPortfolios[e][1],s=st.fill(this.nbAssets,1,function(t,r){if(t<=o.nbAssets)return i.getValue(t,1)});this.cornerPortfolios[e]=[s,a]}}if(0==this.cornerPortfolios.length)throw new Error("internal error: no corner portfolio could be computed");function u(n,o,t,r,e){var i=1e-8;void 0===e&&(e={constraints:{}}),void 0===e.optimizationMethodParams&&(e.optimizationMethodParams={});var a=e.optimizationMethodParams.maxIterCriticalLine;null==a&&(a=1e3);for(var s=o.nbColumns,u=st.ones(1,s),l=u.nbRows,h=st.ones(1,1),f=t,m=r,c=[],d=null,w=new function(t,r){this.STATUS_UNDEF=-1,this.STATUS_IN=0,this.STATUS_LOW=1,this.STATUS_UP=2,this.nbAssets=t,this.nbEqualityConstraints=r,this.varIn=new ut,this.varIn.resize(t+r),this.varOut=new ut,this.varOut.resize(t+r),this.varLow=new ut,this.varLow.resize(t+r),this.varUp=new ut,this.varUp.resize(t+r),this.setIn=function(t){this.varIn.set(t),this.varOut.unset(t),this.varLow.unset(t),this.varUp.unset(t)},this.setOnLowerBound=function(t){this.varLow.set(t),this.varOut.set(t),this.varIn.unset(t),this.varUp.unset(t)},this.setOnUpperBound=function(t){this.varUp.set(t),this.varOut.set(t),this.varIn.unset(t),this.varLow.unset(t)},this.setLambdasIn=function(){for(var t=this.nbAssets+1;t<=this.nbAssets+this.nbEqualityConstraints;++t)this.varIn.set(t),this.varOut.unset(t),this.varLow.unset(t),this.varUp.unset(t)},this.isAsset=function(t){return 1<=t&&t<=this.nbAssets},this.isLambda=function(t){return t>=this.nbAssets+1&&t<=this.nbAssets+this.nbEqualityConstraints},this.isIn=function(t){return this.varIn.get(t)},this.isOnLowerBound=function(t){return this.varLow.get(t)},this.isOnUpperBound=function(t){return this.varUp.get(t)},this.isOut=function(t){return this.varOut.get(t)},this.getInIndexes=function(){return this.varIn.toArray()},this.getOutIndexes=function(){return this.varOut.toArray()}}(s,l),v="function"==typeof Uint32Array?new Uint32Array(s):new Array(s),p=0;p<s;++p)v[p]=p+1;v.sort(function(t,r){return n.getValue(r,1)-n.getValue(t,1)});for(var b=1;b<s;++b)if(n.getValue(v[b],1)==n.getValue(v[b-1],1))throw new Error("unsupported problem: equal returns are not supported by the critical line algorithm");d=new st(lt(n.elemMap(function(t,r,n){return-n}),f,m)[0]);var g=0,y=0,x=0;for(b=1;b<=s;++b)Math.abs(d.data[b-1]-f.data[b-1])<=1e-14?(w.setOnLowerBound(b),++y):Math.abs(d.data[b-1]-m.data[b-1])<=1e-14?(w.setOnUpperBound(b),++x):(w.setIn(b),++g);if(y==s||x==s){var C=new st(d);return c.push([C,0]),c}if(0==g)for(b=1;b<=s-1;++b){var A=v[b-1],R=v[b];w.isOnUpperBound(A)&&w.isOnLowerBound(R)&&w.setIn(A)}var E=w.getInIndexes(),M=w.getOutIndexes(),P=st.zeros(s+l,1),V=st.zeros(s+l,1);for(b=1;b<=M.length;++b){var z=M[b-1];V.setValue(z,1,d.getValue(z,1))}var I=st.zeros(s+l,1),k=st.fill(s+l,s+l,function(t,r){return t<=s&&r<=s?o.data[(t-1)*o.nbColumns+(r-1)]:s+1<=t&&r<=s?u.data[(t-s-1)*u.nbColumns+(r-1)]:t<=s&&s+1<=r?u.data[(r-s-1)*u.nbColumns+(t-1)]:0}),N=st.ones(1,1),S=st.zeros(s+l,s+l),_=st.atxy(-1,N,st.xy(o.submatrix(E,E),N));for(p=1;p<=E.length;++p)for(var F=1;F<=E.length;++F){var O=E[p-1],T=N.getValue(p,F);S.setValue(s+F,O,T),S.setValue(O,s+F,T),S.setValue(s+p,s+F,_.getValue(p,F))}w.setLambdasIn();var U=st.zeros(s+l,1);for(b=1;b<=E.length;++b){var L=E[b-1],B=0;for(p=1;p<=M.length;++p){var W=M[p-1];B-=k.getValue(L,W)*d.getValue(W,1)}U.setValue(L,1,B)}for(b=s+1;b<=s+l;++b){for(L=b,B=h.getValue(L-s,1),p=1;p<=M.length;++p){W=M[p-1];B-=k.getValue(L,W)*d.getValue(W,1)}U.setValue(L,1,B)}for(var q=0,D=0,G=-1,H=0,j=w.STATUS_UNDEF,Y=-1,K=0;;){if(-1!==a&&a<=q)throw new Error("maximum number of iterations reached: "+a);if(2<=++q)if(K<=H){V.setValue(G,1,d.getValue(G,1)),I.setValue(G,1,0),j==w.STATUS_LOW?w.setOnLowerBound(G):w.setOnUpperBound(G);var J=w.getInIndexes(),Q=S.getValue(G,G);Q<=i&&(Q=i);for(b=1;b<=J.length;++b)for(L=J[b-1],p=1;p<=J.length;++p){var X=J[p-1];S.setValue(L,X,S.getValue(L,X)-S.getValue(L,G)*S.getValue(G,X)/Q)}for(b=1;b<=J.length;++b){L=J[b-1];U.setValue(L,1,U.getValue(L,1)-k.getValue(L,G)*d.getValue(G,1))}}else{for(J=w.getInIndexes(),b=1;b<=J.length;++b){L=J[b-1];var Z=0;for(p=1;p<=J.length;++p){X=J[p-1];Z+=S.getValue(L,X)*k.getValue(X,Y)}P.setValue(L,1,Z)}var $=k.getValue(Y,Y);for(b=1;b<=J.length;++b){L=J[b-1];$-=k.getValue(Y,L)*P.getValue(L,1)}$<=i&&($=i);for(b=1;b<=J.length;++b){for(L=J[b-1],p=1;p<=J.length;++p){X=J[p-1];S.setValue(L,X,S.getValue(L,X)+P.getValue(L,1)*P.getValue(X,1)/$)}S.setValue(L,Y,-P.getValue(L,1)/$),S.setValue(Y,L,-P.getValue(L,1)/$)}S.setValue(Y,Y,1/$);for(b=1;b<=J.length;++b){L=J[b-1];U.setValue(L,1,U.getValue(L,1)+k.getValue(L,Y)*d.getValue(Y,1))}w.setIn(Y);for(M=w.getOutIndexes(),B=0,b=1;b<=M.length;++b){z=M[b-1];B-=k.getValue(Y,z)*d.getValue(z,1)}U.setValue(Y,1,B)}J=w.getInIndexes(),M=w.getOutIndexes();G=-1,H=0,j=w.STATUS_UNDEF;for(b=1;b<=J.length;++b){L=J[b-1];var tt=0,rt=0;for(p=1;p<=J.length;++p){X=J[p-1];tt+=S.getValue(L,X)*U.getValue(X,1),X<=s&&(rt+=S.getValue(L,X)*n.getValue(X,1))}if(V.setValue(L,1,tt),I.setValue(L,1,rt),w.isAsset(L))if(i<rt)H<=(nt=(f.getValue(L,1)-tt)/rt)&&(G=L,H=nt,j=w.STATUS_LOW);else if(rt<-i){var nt;H<=(nt=(m.getValue(L,1)-tt)/rt)&&(G=L,H=nt,j=w.STATUS_UP)}}Y=-1,K=0;for(b=1;b<=M.length;++b){z=M[b-1];var ot,et=0,it=-n.getValue(z,1);for(p=1;p<=s+l;++p){var at=k.getValue(z,p);et+=at*V.getValue(p,1),it+=at*I.getValue(p,1)}if(w.isOnLowerBound(z)){if(i<it)K<=(ot=-et/it)&&(Y=z,K=ot)}else if(it<-i)K<=(ot=-et/it)&&(Y=z,K=ot)}D=Math.max(H,K,0);for(b=1;b<=J.length;++b){L=J[b-1];w.isAsset(L)&&d.setValue(L,1,V.getValue(L,1)+D*I.getValue(L,1))}C=new st(d);if(c.push([C,D]),D<i)break}return c}}function Q(t,r,n){h.call(this,t,r,n),void 0===n&&(n={constraints:{}}),void 0===n.optimizationMethodParams&&(n.optimizationMethodParams={}),this.epsGsmo=n.optimizationMethodParams.epsGsmo,null==this.epsGsmo&&(this.epsGsmo=1e-6),this.maxIterationsGsmo=n.optimizationMethodParams.maxIterGsmo,null==this.maxIterationsGsmo&&(this.maxIterationsGsmo=1e4);var o=function(){var n,t,r,o,e;e=1==this.fullInvestment?(n=this.nbAssets,t=this.mu,r=this.sigma,o=this.lowerBounds,this.upperBounds):(n=this.alteredNbAssets,t=this.alteredMu,r=this.alteredSigma,o=this.alteredLowerBounds,this.alteredUpperBounds);var i=r,a=st.zeros(n,1),s=st.ones(n,1),u=o,l=e,h=P(i,a,s,1,u,l,{eps:this.epsGsmo,maxIter:this.maxIterationsGsmo}),f=this.computePortfolioVolatility(h[0]),m=2;do{a=st.ax(-(m/=2),t);var c=P(i,a,s,1,u,l,{eps:this.epsGsmo,maxIter:this.maxIterationsGsmo}),d=this.computePortfolioVolatility(c[0])}while(1e-12<Math.abs(d-f));var w=c[0];0==this.fullInvestment&&(w=st.fill(n,1,function(t,r){if(t<=n)return w.getValue(t,1)}));return[w,m]}.call(this);this.lowestRiskTolerance=o[1],this.lowestRiskTolerancePortfolio=o[0];var e=function(){var n,t,r,o,e;e=1==this.fullInvestment?(n=this.nbAssets,t=this.mu,r=this.sigma,o=this.lowerBounds,this.upperBounds):(n=this.alteredNbAssets,t=this.alteredMu,r=this.alteredSigma,o=this.alteredLowerBounds,this.alteredUpperBounds);var i=-lt(t.elemMap(function(t,r,n){return-n}),o,e)[1],a=r,s=st.ones(n,1),u=o,l=e,h=0,f=.5;do{if(54<++h)throw new Error("internal error: maximum number of iterations reached when searching for the efficient portfolio with maximum return");var m=st.ax(-(f*=2),t),c=P(a,m,s,1,u,l,{eps:this.epsGsmo,maxIter:this.maxIterationsGsmo}),d=this.computePortfolioReturn(c[0],t,r)}while(1e-12<Math.abs(d-i));var w=c[0];0==this.fullInvestment&&(w=st.fill(n,1,function(t,r){if(t<=n)return w.getValue(t,1)}));return[w,f]}.call(this);this.highestRiskTolerance=e[1],this.highestRiskTolerancePortfolio=e[0]}function h(t,r,n){if(void 0===n&&(n={constraints:{}}),void 0===n.constraints&&(n.constraints={}),this.epsPortfolioVolatility=1e-14,this.epsEfficientPortfolioComputation=1e-10,this.mu=new st(t),this.sigma=new st(r),this.nbAssets=this.mu.nbRows,this.fullInvestment=null==n.constraints.fullInvestment||n.constraints.fullInvestment,this.lowerBounds=null==n.constraints.minWeights?st.zeros(this.nbAssets,1):new st(n.constraints.minWeights),this.upperBounds=null==n.constraints.maxWeights?st.ones(this.nbAssets,1):new st(n.constraints.maxWeights),0==this.fullInvestment){var o=this;this.alteredMu=st.fill(this.nbAssets+1,1,function(t,r){return t<=o.nbAssets?o.mu.getValue(t,1):0}),this.alteredSigma=st.fill(this.nbAssets+1,this.nbAssets+1,function(t,r){return t<=o.nbAssets&&r<=o.nbAssets?o.sigma.getValue(t,r):0}),this.alteredLowerBounds=st.fill(this.nbAssets+1,1,function(t,r){return t<=o.nbAssets?o.lowerBounds.getValue(t,1):0}),this.alteredUpperBounds=st.fill(this.nbAssets+1,1,function(t,r){return t<=o.nbAssets?o.upperBounds.getValue(t,1):1}),this.alteredNbAssets=this.nbAssets+1}1==this.fullInvestment?Y(this.nbAssets,this.lowerBounds.toArray(),this.upperBounds.toArray()):0==this.fullInvestment&&Y(this.alteredNbAssets,this.alteredLowerBounds.toArray(),this.alteredUpperBounds.toArray())}return T.randomCorrelationMatrix=function(t,r){return st.randomCorrelation(t,r)},T.nearestCorrelationMatrix=function(t,r){function n(t){if(!t.isSymmetric(a))throw new Error("internal error: input matrix must be symmetric");return t.unitDiagonalize()}function o(t,o){if(!t.isSymmetric(a))throw new Error("internal error: input matrix must be symmetric");var r=st.eig(t,{epsSymmetric:a}),n=r[0],e=r[1].elemMap(function(t,r,n){return Math.max(o,n)}),i=st.axty(1,st.elementwiseProduct(n,e.transpose()),n);return i=i.symmetrize()}t=new st(t);void 0===r&&(r={});var a=r.epsSymmetric;null==a&&(a=1e-12);var e=r.eps;null==e&&(e=1e-6);var i=r.maxIter;null==i&&(i=100);var s=r.minEigenvalue;if(null==s&&(s=1e-12),!t.isSymmetric(a))throw new Error("input matrix must be symmetric");for(var u=t.nbRows,l=st.copy(t),h=st.copy(t),f=st.zeros(u,u),m=Number.POSITIVE_INFINITY,c=Number.POSITIVE_INFINITY,d=Number.POSITIVE_INFINITY,w=0;;){if(-1!==i&&i<=w)throw new Error("maximum number of iterations reached: "+i);++w;var v=st.xmy(h,f),p=o(v,s),b=st.xmy(p,v),g=n(p);if(m=st.xmy(p,l).vectorNorm("infinity")/l.vectorNorm("infinity"),c=st.xmy(g,h).vectorNorm("infinity")/h.vectorNorm("infinity"),d=st.xmy(g,p).vectorNorm("infinity")/g.vectorNorm("infinity"),l=p,h=g,f=b,0==e){if(h.isCorrelationMatrix())break}else if(Math.max(m,c,d)<=e)break}return 0==e?h:l},T.repairCorrelationMatrix=function(t,r){void 0===r&&(r={});var n=r.method;void 0===n&&(n="nearest-correlation-matrix");var o=r.minEigenvalue;null==o&&(o=0);var e=r.epsNcm;null==e&&(e=1e-6);var i=r.epsSymmetric;null==i&&(i=1e-12);var a=r.epsUnitDiagonal;null==a&&(a=1e-12);var s=r.shrinkageTarget;if("spectral"!=n&&"linear-shrinkage"!=n&&"nearest-correlation-matrix"!=n)throw new Error("unsupported correlation matrix repair method");if(!(t=new st(t)).isSymmetric(i))throw new Error("input matrix must be symmetric");if(!t.isUnitDiagonal(a))throw new Error("input matrix must be unit diagonal");if(o<0||1<o)throw new Error("lower bound on the smallest eigenvalue(s) of the correlation matrix must belong to interval [0,1]");var u,l=t.nbRows;if((w=st.eig(t,{epsSymmetric:i,sortedEigenvalues:!0}))[1].data[l-1]>=o)return t;if("spectral"==n){var h=w[0],f=w[1].elemMap(function(t,r,n){return Math.sqrt(Math.max(0,n))}),m=st.elementwiseProduct(h,f.transpose()),c=st.fill(l,1,function(t,r){return 1/m.vectorNorm("two","row",t)}),d=st.elementwiseProduct(m,c);u=(u=st.axty(1,d,d)).unitDiagonalize()}else if("linear-shrinkage"==n){if(null==s)s=st.identity(l);else{if(!(s=new st(s)).isSymmetric(i))throw new Error("shrinkage target matrix must be symmetric");if(!s.isUnitDiagonal(a))throw new Error("shrinkage target matrix must be unit diagonal");var w;if((w=st.eig(s,{epsSymmetric:i,sortedEigenvalues:!0}))[1].data[l-1]<o)throw new Error("smallest eigenvalue of the shrinkage target matrix strictly lower than the desired lower bound on the smallest eigenvalue(s) of the correlation matrix")}var v=t,p=s,b=M(function(t){var r=st.axpby(t,p,1-t,v);return st.eig(r,{epsSymmetric:i,sortedEigenvalues:!0})[1].data[l-1]-o},0,1,{outputInterval:!0})[1];u=(u=st.axpby(b,p,1-b,v)).symmetrize().unitDiagonalize()}else{if("nearest-correlation-matrix"!=n)throw new Error("internal error: unsupported repair method");u=T.nearestCorrelationMatrix(t,{maxIter:-1,eps:e,minEigenvalue:o})}return u},T.perturbedCorrelationMatrix=function(e,t){void 0===(t=t)&&(t={}),void 0===t.method&&(t.method="additive-noise");var r=t.epsCorrMat;null==r&&(r=1e-12);var n=t.epsNcm;null==n&&(n=1e-6);var o=t.maxIterNcm;null==o&&(o=100);var i=t.sigma;null==i&&(i=.05);var a=t.noiseLevelMax;null==a&&(a=.01);var s=t.noiseSpaceDimension;null==s&&(s=3);var u=t.method;if("spectral-noise"!=u&&"multiplicative-noise"!=u&&"additive-noise"!=u)throw new Error("unsupported perturbation method");if(!(e=new st(e)).isCorrelationMatrix(r))throw new Error("input matrix must be symmetric, unit diagonal and positive semidefinite");var l,h=e.nbRows;if("spectral-noise"==u){var f=st.eig(e,{epsSymmetric:r,sortedEigenvalues:!0}),m=f[0],c=f[1].elemMap(function(t,r,n){return n*Math.exp(i*R(0,1))}),d=st.axty(1,st.elementwiseProduct(m,c.transpose()),m);l=(l=d.elemMap(function(t,r,n){return n/Math.sqrt(d.data[(t-1)*d.nbColumns+(t-1)]*d.data[(r-1)*d.nbColumns+(r-1)])})).symmetrize().unitDiagonalize()}else if("multiplicative-noise"==u)(l=st.fillSymmetric(h,function(t,r){return t==r?1:Math.max(-1,Math.min(1,e.data[(t-1)*e.nbColumns+(r-1)]*(1+i*R(0,1))))})).isCorrelationMatrix()||(l=T.nearestCorrelationMatrix(l,{maxIter:o,eps:n}));else{if("additive-noise"!=u)throw new Error("internal error: unsupported perturbation method");for(var w=new E(s,!0),v=new Array(h),p=0;p<h;++p)v[p]=new st(w.sample());(l=st.fillSymmetric(h,function(t,r){if(t==r)return 1;var n=e.data[(t-1)*e.nbColumns+(r-1)],o=a*st.vectorDotProduct(v[t-1],v[r-1]);return Math.max(-1,Math.min(1,n+o))})).isCorrelationMatrix()||(l=T.nearestCorrelationMatrix(l,{maxIter:o,eps:n}))}return l},T.covarianceMatrixFromCorrelationMatrix=function(t,r,n){void 0===(n=n)&&(n={}),void 0===n.diagonalVectorType&&(n.diagonalVectorType="variances");var o=n.epsSymmetric;null==o&&(o=1e-12);var e=n.epsUnitDiagonal;null==e&&(e=1e-12);var i=n.diagonalVectorType;if("variances"!=i&&"standard-deviations"!=i)throw new Error("unsupported diagonal vector type");t=new st(t),r=new st(r);if(!t.isSymmetric(o))throw new Error("input correlation matrix not symmetric");if(t.nbRows!=r.nbRows)throw new Error("input correlation matrix dimensions not compatible with input variances vector dimension");if(st.xmy(t.diagonal(),st.ones(t.nbRows,1)).vectorNorm("infinity")>e)throw new Error("input correlation matrix not unit diagonal");var a;t.nbRows;if("variances"==i)a=r.elemMap(function(t,r,n){return Math.sqrt(n)});else{if("standard-deviations"!=i)throw new Error("internal error: unsupported diagonal vector type");a=r}var s=st.elementwiseProduct(st.elementwiseProduct(t,a),a.transpose());return s=s.symmetrize()},T.covarianceMatrix=function(e,t){void 0===(t=t)&&(t={}),void 0===t.method&&(t.method="covariance");var r=t.method;if("covariance"!=r&&"sample-covariance"!=r&&"linear-shrinkage"!=r)throw new Error("unsupported covariance matrix computation method");var n=t.shrinkageTarget;if("linear-shrinkage"==r&&-1==["constant-variance-null-correlation","constant-variance-correlation","null-correlation","constant-correlation"].indexOf(n))throw new Error("unsupported covariance matrix shrinkage target");var o,i=e.length,a=e[0].length;if("covariance"==r||"sample-covariance"==r){var s=k;"sample-covariance"==r&&(s=N),o=z(i,i);for(var u=0;u<o.nbRows;++u){for(var l=0;l<u;++l)o.data[u*o.nbColumns+l]=o.data[l*o.nbColumns+u];for(l=u;l<o.nbColumns;++l)o.data[u*o.nbColumns+l]=s(e[u],e[l])}}else{if("linear-shrinkage"!=r)throw new Error("internal error: unsupported covariance matrix computation method");var h,f,m=st.fill(i,1,function(t,r){return I(e[t-1])}),c=st.fill(i,a,function(t,r){return e[t-1][r-1]-m.data[t-1]}),d=st.axty(1/a,c,c).toCovarianceMatrix(),w=d.getStandardDeviations(),v=d.getCorrelationMatrix();if("constant-variance-null-correlation"==n){var p=d.trace()/i;h=st.fill(i,i,function(t,r){return t==r?p:0})}else if("constant-variance-correlation"==n){var b=d.trace()/i,g=0;for(u=0;u<i-1;++u)for(l=u+1;l<i;++l)g+=d.data[u*d.nbColumns+l];g*=2/(i*(i-1)),h=st.fill(i,i,function(t,r){return t==r?b:g})}else if("null-correlation"==n)h=st.fill(i,i,function(t,r){return t==r?w.data[t-1]*w.data[t-1]:0});else if("constant-correlation"==n){for(u=f=0;u<i-1;++u)for(l=u+1;l<i;++l)f+=v.data[u*v.nbColumns+l];f*=2/(i*(i-1)),h=st.fill(i,i,function(t,r){return t==r?w.data[t-1]*w.data[t-1]:f*w.data[t-1]*w.data[r-1]})}var y,x=st.fill(i,i,function(t,r){for(var n=0,o=0;o<a;++o)n+=Math.pow((e[t-1][o]-m.data[t-1])*(e[r-1][o]-m.data[r-1])-d.data[(t-1)*d.nbColumns+(r-1)],2);return n/=a}),C=x.sum();if("constant-variance-null-correlation"==n)y=0;else if("constant-variance-correlation"==n)y=0;else if("null-correlation"==n)y=x.trace();else if("constant-correlation"==n){y=0;for(u=1;u<=i;++u)for(l=1;l<=i;++l)if(u!=l){for(var A=0,R=0;R<a;++R)A+=(Math.pow(e[u-1][R]-m.data[u-1],2)-d.data[(u-1)*d.nbColumns+(u-1)])*((e[u-1][R]-m.data[u-1])*(e[l-1][R]-m.data[l-1])-d.data[(u-1)*d.nbColumns+(l-1)]);A/=a;var E=0;for(R=0;R<a;++R)E+=(Math.pow(e[l-1][R]-m.data[l-1],2)-d.data[(l-1)*d.nbColumns+(l-1)])*((e[u-1][R]-m.data[u-1])*(e[l-1][R]-m.data[l-1])-d.data[(u-1)*d.nbColumns+(l-1)]);E/=a,y+=w.data[l-1]/w.data[u-1]*A+w.data[u-1]/w.data[l-1]*E}y*=f/2,y+=x.trace()}var M=(C-y)/Math.pow(st.xmy(d,h).matrixNorm("frobenius"),2),P=Math.max(0,Math.min(1,M/a));o=st.axpby(P,h,1-P,d)}return V(o),o},st.prototype={constructor:st,toString:function(){for(var t=0,r=0;r<this.nbRows;++r)for(var n=0;n<this.nbColumns;++n){var o=String(this.data[r*this.nbColumns+n]).length;t<o&&(t=o)}var e=[];for(r=0;r<this.nbRows;++r){e.push("[ ");for(n=0;n<this.nbColumns;++n){var i=String(this.data[r*this.nbColumns+n]);e.push(new Array(t-i.length+1).join(" ")+i+" ")}e.push("]\n")}return e.join("")},toRowArray:function(t){t=t||function(t,r,n){return!0};for(var r=new Array(this.nbRows),n=0;n<this.nbRows;++n){r[n]=new Array(this.nbColumns);for(var o=0,e=0;e<this.nbColumns;++e){var i=this.data[n*this.nbColumns+e];t(n+1,e+1,i)&&(r[n][o++]=i)}r[n].length=o}return r},toArray:function(t){t=t||function(t,r,n){return!0};for(var r=new Array(this.nbRows*this.nbColumns),n=0,o=0;o<this.nbRows;++o)for(var e=0;e<this.nbColumns;++e){var i=this.data[o*this.nbColumns+e];t(o+1,e+1,i)&&(r[n++]=i)}return r.length=n,r},setValueAt:function(t,r,n){if(t<1||r<1||t>this.nbRows||r>this.nbColumns)throw new Error("index out of bounds when setting matrix value, ("+t+","+r+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(t-1)*this.nbColumns+(r-1)]=n,this},setValue:function(t,r,n){return this.data[(t-1)*this.nbColumns+(r-1)]=n,this},getValueAt:function(t,r){if(t<1||r<1||t>this.nbRows||r>this.nbColumns)throw new Error("index out of bounds when getting matrix value, ("+t+","+r+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(t-1)*this.nbColumns+(r-1)]},getValue:function(t,r){return this.data[(t-1)*this.nbColumns+(r-1)]},isSquare:function(){return this.nbRows===this.nbColumns},isSymmetric:function(t){if(null==t&&(t=0),!this.isSquare())return!1;for(var r=0;r<this.nbRows;++r)for(var n=0;n<this.nbColumns;++n)if(Math.abs(this.data[r*this.nbColumns+n]-this.data[n*this.nbColumns+r])>t)return!1;return!0},isUnitDiagonal:function(t){if(null==t&&(t=0),!this.isSquare())return!1;for(var r=this.data[0],n=0;n<this.nbRows;++n){var o=this.data[n*this.nbColumns+n];r<o&&(r=o)}return!(Math.abs(r-1)>t)},isCorrelationMatrix:function(t){if(null==t&&(t=0),!this.isSquare())return!1;if(!this.isSymmetric(t))return!1;if(!this.isUnitDiagonal(t))return!1;try{st.choleskyDecomposition(this)}catch(t){if("input matrix must be positive definite"===t.message)return!1;throw t}return!0},isVector:function(){return 1===this.nbColumns},isNonNegative:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(this.data[t*this.nbColumns+r]<0)return!1;return!0},isPositive:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(this.data[t*this.nbColumns+r]<=0)return!1;return!0},isNonPositive:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(0<this.data[t*this.nbColumns+r])return!1;return!0},isNegative:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(0<=this.data[t*this.nbColumns+r])return!1;return!0},sum:function(){for(var t=0,r=0;r<this.data.length;++r)t+=this.data[r];return t},min:function(){for(var t=Number.POSITIVE_INFINITY,r=0;r<this.data.length;++r)this.data[r]<t&&(t=this.data[r]);return t},max:function(){for(var t=Number.NEGATIVE_INFINITY,r=0;r<this.data.length;++r)this.data[r]>t&&(t=this.data[r]);return t},normalize:function(t){var r=z(this.nbRows,this.nbColumns,t),n=this.sum();if(0===n)throw new Error("sum of coefficients of matrix is null");for(var o=0;o<this.data.length;++o)r.data[o]=this.data[o]/n;return r},diagonal:function(t){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var r=z(this.nbRows,1,t),n=0;n<this.nbRows;++n)r.data[n]=this.data[n*(this.nbColumns+1)];return r},row:function(t,r){if(t<1||t>this.nbRows)throw new Error("index out of bounds when getting matrix row, ("+t+") in size ("+this.nbRows+","+this.nbColumns+")");for(var n=z(this.nbColumns,1,r),o=0;o<this.nbColumns;++o)n.data[o]=this.data[(t-1)*this.nbColumns+o];return n},column:function(t,r){if(t<1||t>this.nbColumns)throw new Error("index out of bounds when getting matrix column, ("+t+") in size ("+this.nbRows+","+this.nbColumns+")");for(var n=z(this.nbRows,1,r),o=0;o<this.nbRows;++o)n.data[o]=this.data[o*this.nbColumns+(t-1)];return n},elemMap:function(t,r){for(var n=z(this.nbRows,this.nbColumns,r),o=0;o<n.nbRows;++o)for(var e=0;e<n.nbColumns;++e)n.data[o*n.nbColumns+e]=t(o+1,e+1,this.data[o*this.nbColumns+e]);return n},submatrix:function(t,r,n){if(!(t instanceof Array||t instanceof Uint32Array)||0==t.length)throw new Error("first parameter must be a non empty array");if(!(r instanceof Array||r instanceof Uint32Array)||0==r.length)throw new Error("second parameter must be a non empty array");for(var o=1;o<t.length;++o)if(t[o-1]>=t[o])throw new Error("first parameter must be a sorted array");for(var e=1;e<r.length;++e)if(r[e-1]>=t[e])throw new Error("second parameter must be a sorted array");var i=z(t.length,r.length,n);for(o=0;o<i.nbRows;++o){var a=t[o]-1;for(e=0;e<i.nbColumns;++e){var s=r[e]-1;i.data[o*i.nbColumns+e]=this.data[a*this.nbColumns+s]}}return i},transpose:function(t){for(var r=z(this.nbColumns,this.nbRows,t),n=0;n<r.nbRows;++n)for(var o=0;o<r.nbColumns;++o)r.data[n*r.nbColumns+o]=this.data[o*this.nbColumns+n];return r},determinant:function(){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var t=st.qrDecomposition(this,{qLess:!0}),r=1,n=0;n<t.data.length;n+=t.nbColumns+1)r*=t.data[n];return r},trace:function(){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var t=0,r=0;r<this.nbRows;++r)t+=this.data[r*this.nbColumns+r];return t},symmetrize:function(t){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var r=z(this.nbRows,this.nbColumns,t),n=1;n<=r.nbRows;++n){r.data[(n-1)*r.nbColumns+(n-1)]=this.data[(n-1)*this.nbColumns+(n-1)];for(var o=n+1;o<=r.nbColumns;++o){var e=(this.data[(n-1)*this.nbColumns+(o-1)]+this.data[(o-1)*this.nbColumns+(n-1)])/2;r.data[(n-1)*r.nbColumns+(o-1)]=e,r.data[(o-1)*r.nbColumns+(n-1)]=e}}return r},unitDiagonalize:function(t){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var r=z(this.nbRows,this.nbColumns,t),n=0;n<r.nbRows;++n){for(var o=0;o<r.nbColumns;++o)r.data[n*r.nbColumns+o]=this.data[n*this.nbColumns+o];r.data[n*r.nbColumns+n]=1}return r},matrixNorm:function(t){if("one"==t){for(var r=0,n=0;n<this.nbColumns;++n){for(var o=0,e=0;e<this.nbRows;++e)o+=Math.abs(this.data[e*this.nbColumns+n]);r=Math.max(r,o)}return r}if("infinity"==t){var i=0;for(e=0;e<this.nbRows;++e){var a=0;for(n=0;n<this.nbColumns;++n)a+=Math.abs(this.data[e*this.nbColumns+n]);i=Math.max(i,a)}return i}if("frobenius"==t)return this.vectorNorm("two");throw new Error("unsupported matrix norm: "+t)},vectorNorm:function(t,r,n){var o,e,i,a;if(void 0===r||"matrix"==r)o=0,e=this.nbRows,i=0,a=this.nbColumns;else if("row"==r){if(void 0===n)throw new Error("undefined row index");if(n<1||n>this.nbRows)throw new Error("row index out of bounds: "+n);o=n-1,e=n,i=0,a=this.nbColumns}else if("column"==r){if(void 0===n)throw new Error("undefined row index");if(n<1||n>this.nbColumns)throw new Error("column index out of bounds: "+n);o=0,e=this.nbRows,i=n-1,a=n}else if(void 0!==r)throw new Error("unsupported matrix subset: "+r);if("one"==t){for(var s=0,u=o*this.nbColumns,l=o;l<e;++l){for(var h=u+i,f=i;f<a;++f)s+=Math.abs(this.data[h]),h++;u+=this.nbColumns}return s}if("two"==t){var m=0,c=1;for(u=o*this.nbColumns,l=o;l<e;++l){for(h=u+i,f=i;f<a;++f){var d=this.data[h],w=Math.abs(d);0!=w&&(m<w?(c=1+c*(m/d)*(m/d),m=w):c+=d/m*(d/m)),h++}u+=this.nbColumns}return m*Math.sqrt(c)}if("infinity"!=t)throw new Error("unsupported vector norm: "+t);var v=0;for(u=o*this.nbColumns,l=o;l<e;++l){for(h=u+i,f=i;f<a;++f)v=Math.max(v,Math.abs(this.data[h])),h++;u+=this.nbColumns}return v},toCovarianceMatrix:function(){return V(this),this}},st.areEqual=function(t,r,n){if(!(t instanceof st))throw new Error("a must be a matrix");if(!(r instanceof st))throw new Error("b must be a matrix");if(t.nbRows!==r.nbRows)return!1;if(t.nbColumns!==r.nbColumns)return!1;for(var o=t.nbRows*t.nbColumns,e=n||0,i=0;i<o;++i)if(Math.abs(t.data[i]-r.data[i])>e)return!1;return!0},st.xpy=function(t,r,n){if(!(t instanceof st))throw new Error("first input must be a matrix");if(!(r instanceof st))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbColumns||t.nbRows!==r.nbRows)throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=z(t.nbRows,t.nbColumns,n),e=t.nbRows*t.nbColumns,i=0;i<e;++i)o.data[i]=t.data[i]+r.data[i];return o},st.xmy=function(t,r,n){if(!(t instanceof st))throw new Error("first input must be a matrix");if(!(r instanceof st))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbColumns||t.nbRows!==r.nbRows)throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=z(t.nbRows,t.nbColumns,n),e=t.nbRows*t.nbColumns,i=0;i<e;++i)o.data[i]=t.data[i]-r.data[i];return o},st.axpby=function(t,r,n,o,e){if(!(r instanceof st))throw new Error("first input must be a matrix");if(!(o instanceof st))throw new Error("second input must be a matrix");if(r.nbColumns!==o.nbColumns||r.nbRows!==o.nbRows)throw new Error("input matrices sizes do not match: ("+r.nbRows+","+r.nbColumns+") - ("+o.nbRows+","+o.nbColumns+")");for(var i=z(r.nbRows,r.nbColumns,e),a=r.nbRows*r.nbColumns,s=0;s<a;++s)i.data[s]=t*r.data[s]+n*o.data[s];return i},st.copy=function(t,r){if(!(t instanceof st))throw new Error("first input must be a matrix");for(var n=z(t.nbRows,t.nbColumns,r),o=t.nbRows*t.nbColumns,e=0;e<o;++e)n.data[e]=t.data[e];return n},st.elementwiseProduct=function(t,r,n){if(!(t instanceof st))throw new Error("first input must be a matrix");if(!(r instanceof st))throw new Error("second input must be a matrix");if(!(t.nbRows===r.nbRows&&t.nbColumns===r.nbColumns||r.nbRows===t.nbRows&&1===r.nbColumns||1===r.nbRows&&r.nbColumns===t.nbColumns))throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");var o=z(t.nbRows,t.nbColumns,n),e=t.nbRows,i=t.nbColumns;if(t.nbRows===r.nbRows&&t.nbColumns===r.nbColumns)for(var a=e*i,s=0;s<a;++s)o.data[s]=t.data[s]*r.data[s];else if(r.nbRows===t.nbRows&&1===r.nbColumns)for(var u=0,l=0;l<e;++l)for(var h=r.data[l],f=0;f<i;++f)o.data[u]=t.data[u]*h,u++;else if(1===r.nbRows&&r.nbColumns===t.nbColumns)for(u=0,l=0;l<e;++l)for(f=0;f<i;++f)o.data[u]=t.data[u]*r.data[f],u++;return o},st.xy=function(t,r,n){if(!(t instanceof st))throw new Error("first input must be a matrix");if(!(r instanceof st))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbRows)throw new Error("matrices sizes do not match: ("+t.nbRows+","+r.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=z(t.nbRows,r.nbColumns,n),e=t.nbRows,i=t.nbColumns,a=r.nbColumns,s=0,u=0,l=0;l<e;++l){for(var h=u,f=0;f<a;++f)o.data[h]=0,h++;for(var m=0,c=0;c<i;++c){var d=t.data[s];h=u;for(f=0;f<a;++f)o.data[h]+=d*r.data[m],m++,h++;s++}u+=a}return o},st.txy=function(t,r,n){if(!(t instanceof st))throw new Error("second input must be a matrix");if(!(r instanceof st))throw new Error("third input must be a matrix");if(t.nbRows!==r.nbRows)throw new Error("matrices sizes do not match: ("+t.nbRows+","+r.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=z(t.nbColumns,r.nbColumns,n),e=t.nbColumns,i=t.nbRows,a=r.nbColumns,s=0,u=0,l=0,h=0;h<e;++h){for(var f=t.data[s],m=d,c=0;c<a;++c)o.data[u]=f*r.data[c],u++;s++}var d=a;for(l=1;l<i;++l){for(h=u=0;h<e;++h){for(f=t.data[s],m=d,c=0;c<a;++c)o.data[u]+=f*r.data[m],u++,m++;s++}d+=a}return o},st.axy=function(t,r,n,o){if(!(r instanceof st))throw new Error("second input must be a matrix");if(!(n instanceof st))throw new Error("third input must be a matrix");if(r.nbColumns!==n.nbRows)throw new Error("matrices sizes do not match: ("+r.nbRows+","+n.nbColumns+") - ("+n.nbRows+","+n.nbColumns+")");for(var e=z(r.nbRows,n.nbColumns,o),i=r.nbRows,a=r.nbColumns,s=n.nbColumns,u=0,l=0,h=0;h<i;++h){for(var f=l,m=0;m<s;++m)e.data[f]=0,f++;for(var c=0,d=0;d<a;++d){var w=t*r.data[u];f=l;for(m=0;m<s;++m)e.data[f]+=w*n.data[c],c++,f++;u++}l+=s}return e},st.ax=function(t,r,n){if(!(r instanceof st))throw new Error("second input must be a matrix");for(var o=z(r.nbRows,r.nbColumns,n),e=r.nbRows,i=r.nbColumns,a=1;a<=e;++a)for(var s=1;s<=i;++s)o.setValue(a,s,t*r.getValue(a,s));return o},st.axty=function(t,r,n,o){if(!(r instanceof st))throw new Error("second input must be a matrix");if(!(n instanceof st))throw new Error("third input must be a matrix");if(r.nbColumns!==n.nbColumns)throw new Error("matrices sizes do not match: ("+r.nbRows+","+n.nbColumns+") - ("+n.nbRows+","+n.nbColumns+")");for(var e=z(r.nbRows,n.nbRows,o),i=0;i<r.nbRows;++i)for(var a=0;a<n.nbRows;++a){for(var s=e.data[i*e.nbColumns+a]=0;s<r.nbColumns;++s)e.data[i*e.nbColumns+a]+=r.data[i*r.nbColumns+s]*n.data[a*n.nbColumns+s];e.data[i*e.nbColumns+a]=t*e.data[i*e.nbColumns+a]}return e},st.atxy=function(t,r,n,o){if(!(r instanceof st))throw new Error("second input must be a matrix");if(!(n instanceof st))throw new Error("third input must be a matrix");if(r.nbRows!==n.nbRows)throw new Error("matrices sizes do not match: ("+r.nbRows+","+n.nbColumns+") - ("+n.nbRows+","+n.nbColumns+")");for(var e=z(r.nbColumns,n.nbColumns,o),i=0,a=0;a<r.nbColumns;++a){for(var s=t*r.data[i*r.nbColumns+a],u=0;u<n.nbColumns;++u)e.data[a*e.nbColumns+u]=0;for(u=0;u<n.nbColumns;++u)e.data[a*e.nbColumns+u]+=s*n.data[i*n.nbColumns+u]}for(i=1;i<r.nbRows;++i)for(a=0;a<r.nbColumns;++a)for(s=t*r.data[i*r.nbColumns+a],u=0;u<n.nbColumns;++u)e.data[a*e.nbColumns+u]+=s*n.data[i*n.nbColumns+u];return e},st.diagonal=function(t,r){if(!(t instanceof st&&t.isVector()))throw new Error("first input must be a vector");for(var n=t.nbRows,o=z(n,n,r),e=0;e<n;++e){for(var i=0;i<n;++i)o.data[e*n+i]=0;o.data[e*n+e]=t.data[e]}return o},st.fillSymmetric=function(t,r,n){if(t<1)throw new Error("input number of rows and columns out of bounds: "+t);for(var o=z(t,t,n),e=0;e<t;++e){for(var i=0;i<e;++i)o.data[e*t+i]=o.data[i*t+e];for(i=e;i<o.nbColumns;++i)o.data[e*t+i]=r(e+1,i+1)}return o},st.fill=function(t,r,n,o){if(t<1)throw new Error("input number of rows out of bounds: "+t);if(r<1)throw new Error("input number of columns out of bounds: "+r);for(var e=z(t,r,o),i=0;i<t;++i)for(var a=0;a<r;++a)e.data[i*r+a]=n(i+1,a+1);return e},st.zeros=function(t,r,n){for(var o=z(t,r,n),e=t*r,i=0;i<e;++i)o.data[i]=0;return o},st.ones=function(t,r){for(var n=z(t,r),o=t*r,e=0;e<o;++e)n.data[e]=1;return n},st.identity=function(t){for(var r=z(t,t),n=t*t,o=0;o<n;++o)o%(t+1)==(r.data[o]=0)&&(r.data[o]=1);return r},st.normrnd=function(t,r,n,o){for(var e=z(t,r),i=t*r,a=0;a<i;++a)e.data[a]=R(n,o);return e},st.vectorHadamardProduct=function(t,r){return st.elementwiseProduct(t,r)},st.vectorDotProduct=function(t,r){if(!t.isVector())throw new Error("first argument must be a vector");if(!r.isVector())throw new Error("second argument must be a vector");if(t.nbRows!==r.nbRows)throw new Error("Vectors sizes do not match: ("+t.nbRows+") - ("+r.nbRows+")");for(var n=0,o=t.nbRows,e=0;e<o;++e)n+=t.data[e]*r.data[e];return n},st.choleskyDecomposition=function(t,r){void 0===r&&(r={});var n=r.epsSymmetric;if(null==n&&(n=1e-12),!(t instanceof st))throw new Error("input must be a matrix");if(!t.isSymmetric(n))throw new Error("input matrix must be symmetric");for(var o=t.nbRows,e=st.zeros(o,o),i=st.zeros(o,1),a=1;a<=o;++a){for(var s=a;s<=o;++s)i.data[s-1]=t.data[(s-1)*t.nbColumns+(a-1)];for(var u=1;u<=a-1;++u)for(s=a;s<=o;++s)i.data[s-1]-=e.data[(a-1)*e.nbColumns+(u-1)]*e.data[(s-1)*e.nbColumns+(u-1)];if(i.data[a-1]<0)throw new Error("input matrix must be positive definite");for(s=a;s<=o;++s)e.data[(s-1)*e.nbColumns+(a-1)]=i.data[s-1]/Math.sqrt(i.data[a-1])}return e},st.qrDecomposition=function(t,r){function n(t,r){var n,o,e;if(0==r)n=0<=t?1:-1,o=0,e=Math.abs(t);else if(0==t)o=(n=0)<=r?1:-1,e=Math.abs(r);else if(Math.abs(t)>Math.abs(r)){o=(i=r/t)*(n=1/(a=(0<=t?1:-1)*Math.sqrt(1+i*i))),e=t*a}else{var i,a;n=(i=t/r)*(o=1/(a=(0<=r?1:-1)*Math.sqrt(1+i*i))),e=r*a}return[n,-o,e]}void 0===r&&(r={});var o=r.qLess||!1;if(!(t instanceof st))throw new Error("first input must be a matrix");if(t.nbRows<t.nbColumns)throw new Error("matrix has more columns than rows: ("+t.nbRows+") v.s. ("+t.nbColumns+")");var e=t.nbRows,i=t.nbColumns,a=new st(t),s=null;o||(s=st.identity(e));for(var u=1;u<=i;++u)for(var l=e;u+1<=l;--l){var h=(l-2)*a.nbColumns+(u-1),f=(l-1)*a.nbColumns+(u-1),m=n(a.data[h],a.data[f]),c=m[0],d=m[1],w=m[2];a.data[h]=w,a.data[f]=0;for(var v=u+1;v<=i;++v){var p=(l-2)*a.nbColumns+(v-1),b=(l-1)*a.nbColumns+(v-1),g=a.data[p],y=a.data[b];a.data[p]=c*g-d*y,a.data[b]=d*g+c*y}if(!o)for(v=1;v<=e;++v){var x=(v-1)*s.nbColumns+(l-2),C=(v-1)*s.nbColumns+(l-1);g=s.data[x],y=s.data[C];s.data[x]=c*g-d*y,s.data[C]=d*g+c*y}}return o?a:[s,a]},st.svdDecomposition=function(t,r){void 0===r&&(r={});var n=r.eps||1e-16,o=r.maxIter||100,e=r.svdForm||"thin";if(!(t instanceof st))throw new Error("first input must be a matrix");if(t.nbRows<t.nbColumns)throw new Error("matrix has more columns than rows: "+t.nbColumns+" v.s. "+t.nbRows);for(var i=t.nbRows,a=t.nbColumns,s=new st(t),u=s.matrixNorm("frobenius"),l=st.identity(a),h=0,f="function"==typeof Float64Array?new Float64Array(a):new Array(a);;){if(++h,-1!==o&&o<h)throw new Error("maximum number of iterations reached: "+o);for(var m=1;m<=a;++m){var c=s.vectorNorm("two","column",m);f[m-1]=c*c}var d=!0;for(m=2;m<=a;++m)for(var w=1;w<=m-1;++w){for(var v=f[w-1],p=f[m-1],b=0,g=1;g<=i;++g)b+=s.data[(g-1)*s.nbColumns+(w-1)]*s.data[(g-1)*s.nbColumns+(m-1)];if(!(Math.abs(b)<=n*Math.sqrt(i*v*p))&&!(Math.sqrt(v)<=n*u||Math.sqrt(p)<=n*u)){d=!1;var y=(v-p)/(2*b),x=(0<=y?1:-1)/(Math.abs(y)+Math.sqrt(1+y*y)),C=1/Math.sqrt(1+x*x),A=C*x;for(g=1;g<=i;++g){var R=s.data[(g-1)*s.nbColumns+(w-1)],E=s.data[(g-1)*s.nbColumns+(m-1)];s.data[(g-1)*s.nbColumns+(w-1)]=C*R+A*E,s.data[(g-1)*s.nbColumns+(m-1)]=-A*R+C*E}f[w-1]+=x*b,f[m-1]-=x*b;for(g=1;g<=a;++g){R=l.data[(g-1)*l.nbColumns+(w-1)],E=l.data[(g-1)*l.nbColumns+(m-1)];l.data[(g-1)*l.nbColumns+(w-1)]=C*R+A*E,l.data[(g-1)*l.nbColumns+(m-1)]=-A*R+C*E}}}if(1==d)break}var M="function"==typeof Float64Array?new Float64Array(a):new Array(a),P="function"==typeof Uint32Array?new Uint32Array(a):new Array(a);for(m=1;m<=a;++m){var V=Math.sqrt(f[m-1]);M[m-1]=V,P[m-1]=m}P.sort(function(t,r){return M[r-1]-M[t-1]});var z=st.zeros(i,a),I=st.zeros(a,a),k=st.zeros(a,a);for(m=1;m<=a;++m){var N=P[m-1],S=M[N-1];if(0!=(I.data[(m-1)*I.nbColumns+(m-1)]=S))for(w=1;w<=i;++w)z.data[(w-1)*z.nbColumns+(m-1)]=s.data[(w-1)*s.nbColumns+(N-1)]/S;for(w=1;w<=a;++w)k.data[(w-1)*k.nbColumns+(m-1)]=l.data[(w-1)*l.nbColumns+(N-1)]}if("thin"==e)return[z,I,k];var _=st.qrDecomposition(z)[0],F=st.zeros(i,i),O=st.zeros(i,a);for(m=1;m<=a;++m){N=P[m-1],S=M[N-1];if(0!=(O.data[(m-1)*O.nbColumns+(m-1)]=S))for(w=1;w<=i;++w)F.data[(w-1)*F.nbColumns+(m-1)]=z.data[(w-1)*z.nbColumns+(m-1)];else for(w=1;w<=i;++w)F.data[(w-1)*F.nbColumns+(m-1)]=_.data[(w-1)*_.nbColumns+(m-1)]}for(m=a+1;m<=i;++m)for(w=1;w<=i;++w)F.data[(w-1)*F.nbColumns+(m-1)]=_.data[(w-1)*_.nbColumns+(m-1)];return"full"==e?[F,O,k]:void 0},st.eig=function(t,r){void 0===r&&(r={});var n=r.epsSymmetric;null==n&&(n=1e-12);var o=r.maxIter;null==o&&(o=100);var e=r.sortedEigenvalues;if(null==e&&(e=!1),!(t instanceof st))throw new Error("input must be a matrix");if(!t.isSymmetric(n))throw new Error("input matrix must be symmetric");for(var i=t.nbRows,a=new st(t),s=st.identity(i),u=a.diagonal(),l=new st(u),h=st.zeros(i,1),f=0;;){if(++f,-1!==o&&o<f)throw new Error("maximum number of iterations reached: "+o);for(var m=0,c=1;c<=i-1;++c)for(var d=c+1;d<=i;++d)m+=Math.abs(a.data[(c-1)*a.nbColumns+(d-1)]);if(0==m)break;var w=f<4?.2*m/(i*i):0;for(c=1;c<=i-1;++c)for(d=c+1;d<=i;++d){var v=100*Math.abs(a.data[(c-1)*a.nbColumns+(d-1)]);if(4<f&&Math.abs(u.data[c-1])+v==Math.abs(u.data[c-1])&&Math.abs(u.data[d-1])+v==Math.abs(u.data[d-1]))a.data[(c-1)*a.nbColumns+(d-1)]=0;else if(Math.abs(a.data[(c-1)*a.nbColumns+(d-1)])>w){var p,b=u.data[d-1]-u.data[c-1];if(Math.abs(b)+v==Math.abs(b))p=a.data[(c-1)*a.nbColumns+(d-1)]/b;else{var g=.5*b/a.data[(c-1)*a.nbColumns+(d-1)];p=1/(Math.abs(g)+Math.sqrt(1+g*g)),g<0&&(p=-p)}var y=1/Math.sqrt(1+p*p),x=p*y,C=x/(1+y);b=p*a.data[(c-1)*a.nbColumns+(d-1)];for(h.data[c-1]-=b,h.data[d-1]+=b,u.data[c-1]-=b,u.data[d-1]+=b,a.data[(c-1)*a.nbColumns+(d-1)]=0,A=1;A<=c-1;++A){v=a.data[(A-1)*a.nbColumns+(c-1)],b=a.data[(A-1)*a.nbColumns+(d-1)];a.data[(A-1)*a.nbColumns+(c-1)]=v-x*(b+v*C),a.data[(A-1)*a.nbColumns+(d-1)]=b+x*(v-b*C)}for(A=c+1;A<=d-1;++A){v=a.data[(c-1)*a.nbColumns+(A-1)],b=a.data[(A-1)*a.nbColumns+(d-1)];a.data[(c-1)*a.nbColumns+(A-1)]=v-x*(b+v*C),a.data[(A-1)*a.nbColumns+(d-1)]=b+x*(v-b*C)}for(A=d+1;A<=i;++A){v=a.data[(c-1)*a.nbColumns+(A-1)],b=a.data[(d-1)*a.nbColumns+(A-1)];a.data[(c-1)*a.nbColumns+(A-1)]=v-x*(b+v*C),a.data[(d-1)*a.nbColumns+(A-1)]=b+x*(v-b*C)}for(var A=1;A<=i;++A){v=s.data[(A-1)*s.nbColumns+(c-1)],b=s.data[(A-1)*s.nbColumns+(d-1)];s.data[(A-1)*s.nbColumns+(c-1)]=v-x*(b+v*C),s.data[(A-1)*s.nbColumns+(d-1)]=b+x*(v-b*C)}}}for(c=1;c<=i;++c)l.data[c-1]+=h.data[c-1],u.data[c-1]=l.data[c-1],h.data[c-1]=0}var R=u,E=s;if(e){for(var M="function"==typeof Uint32Array?new Uint32Array(i):new Array(i),P=1;P<=i;++P)M[P-1]=P;M.sort(function(t,r){return u.data[r-1]-u.data[t-1]}),R=st.zeros(i,1),E=st.zeros(i,i);for(P=1;P<=i;++P){var V=M[P-1];R.data[P-1]=u.data[V-1];for(A=1;A<=i;++A)E.data[(A-1)*E.nbColumns+(P-1)]=s.data[(A-1)*s.nbColumns+(V-1)]}}return[E,R]},st.nullSpace=function(t,r){void 0===r&&(r={});var n=r.eps||void 0;if(!(t instanceof st))throw new Error("first input must be a matrix");var o=t.nbRows,e=t.nbColumns,i=null;if(e<=o){var a=(f=st.svdDecomposition(t,{maxIter:-1}))[0],s=f[1],u=f[2];for(void 0===n&&(n=o*(C(s.data[0])-s.data[0])),m=e;1<=m&&!(s.data[(m-1)*s.nbColumns+(m-1)]>n);--m);if((c=m)==e)i=st.zeros(e,1);else{i=new st.zeros(e,e-c);for(var l=c+1;l<=e;++l)for(var h=1;h<=e;++h)i.data[(h-1)*i.nbColumns+(l-(c+1)+1-1)]=u.data[(h-1)*u.nbColumns+(l-1)]}}else{var f,m,c;a=(f=st.svdDecomposition(t.transpose(),{maxIter:-1,svdForm:"full"}))[0],s=f[1],u=f[2];for(void 0===n&&(n=e*(C(s.data[0])-s.data[0])),m=o;1<=m&&!(s.data[(m-1)*s.nbColumns+(m-1)]>n);--m);if((c=m)==o)i=st.zeros(e,1);else{var d=new st.zeros(e,c);for(l=1;l<=c;++l)for(h=1;h<=e;++h)d.data[(h-1)*d.nbColumns+(l-1)]=a.data[(h-1)*a.nbColumns+(l-1)];var w=st.qrDecomposition(d)[0];for(i=new st.zeros(e,e-c),l=c+1;l<=e;++l)for(h=1;h<=e;++h)i.data[(h-1)*i.nbColumns+(l-(c+1)+1-1)]=w.data[(h-1)*w.nbColumns+(l-1)]}}return i},st.linsolveBackSubstitution=function(t,r,n){if(!(t instanceof st))throw new Error("first input must be a matrix");if(!(r instanceof st))throw new Error("second input must be a matrix");if(!t.isSquare())throw new Error("matrix is not square: ("+t.nbRows+","+t.nbColumns+")");if(t.nbRows!==r.nbRows)throw new Error("matrix and second member sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");if(1!==r.nbColumns)throw new Error("b is not a vector: ("+r.nbRows+","+r.nbColumns+")");for(var o=t.nbColumns,e=z(o,1,n),i=o;1<=i;--i){e.data[i-1]=r.data[i-1];for(var a=i+1;a<=o;++a)e.data[i-1]=e.data[i-1]-t.data[(i-1)*t.nbColumns+(a-1)]*e.data[a-1];var s=t.data[(i-1)*t.nbColumns+(i-1)];if(0==s)throw new Error("input matrix is not invertible: zero diagonal coefficient at index "+i);e.data[i-1]=e.data[i-1]/s}return e},st.randomOrthogonal=function(t){var r=st.normrnd(t,t),n=st.qrDecomposition(r),o=n[0],e=n[1],i=st.fill(1,t,function(t,r){return 0<=e.data[(r-1)*e.nbColumns+(r-1)]?1:-1});return st.elementwiseProduct(o,i)},st.randomCorrelation=function(t,n){if(void 0===n&&(n={}),void 0===n.eps&&(n.eps=1e-14),void 0===n.epsLambda&&(n.epsLambda=1e-8),void 0===n.lambda){n.lambda=new _(t).sample();for(var r=0;r<t;++r)n.lambda[r]*=t}if(n.lambda.length!=t)throw new Error("number of input eigenvalues not equal to "+t+", but to "+n.lambda.length);var o=0;for(r=0;r<t;++r)o+=n.lambda[r];if(Math.abs(o-t)>n.epsLambda)throw new Error("input eigenvalues not summing to "+t);for(var e=n.eps,i=st.fill(1,t,function(t,r){return n.lambda[r-1]}),a=st.randomOrthogonal(t),s=st.axty(1,st.elementwiseProduct(a,i),a),u=1;u<t;++u){for(var l=!0,h=1;h<=t;++h){var f=s.data[(h-1)*s.nbColumns+(h-1)];if(Math.abs(f-1)>e){l=!1;break}1!=f&&(s.data[(h-1)*s.nbColumns+(h-1)]=1)}if(l)break;r=-1;var m=-1;for(h=1;h<=t;++h)s.data[(h-1)*s.nbColumns+(h-1)]<1&&-1===r&&(r=h),1<s.data[(h-1)*s.nbColumns+(h-1)]&&(m=h);if(m<r){m=r=-1;for(h=1;h<=t;++h)1<s.data[(h-1)*s.nbColumns+(h-1)]&&-1===r&&(r=h),s.data[(h-1)*s.nbColumns+(h-1)]<1&&(m=h)}var c=s.data[(r-1)*s.nbColumns+(r-1)],d=s.data[(r-1)*s.nbColumns+(m-1)],w=s.data[(m-1)*s.nbColumns+(m-1)],v=(d+Math.sqrt(d*d-(c-1)*(w-1)))/(w-1),p=1/Math.sqrt(1+v*v),b=p*v;for(h=1;h<=t;++h){var g=s.data[(r-1)*s.nbColumns+(h-1)],y=s.data[(m-1)*s.nbColumns+(h-1)];s.data[(r-1)*s.nbColumns+(h-1)]=p*g-b*y,s.data[(m-1)*s.nbColumns+(h-1)]=b*g+p*y}for(h=1;h<=t;++h){g=s.data[(h-1)*s.nbColumns+(r-1)],y=s.data[(h-1)*s.nbColumns+(m-1)];s.data[(h-1)*s.nbColumns+(r-1)]=p*g-b*y,s.data[(h-1)*s.nbColumns+(m-1)]=b*g+p*y}s.data[(r-1)*s.nbColumns+(r-1)]=1}for(h=1;h<=t;++h)s.data[(h-1)*s.nbColumns+(h-1)]=1;for(r=1;r<=t;++r)for(m=r+1;m<=t;++m){d=s.data[(r-1)*s.nbColumns+(m-1)];var x=s.data[(m-1)*s.nbColumns+(r-1)],C=Math.min(1,Math.max(-1,(d+x)/2));s.data[(r-1)*s.nbColumns+(m-1)]=C,s.data[(m-1)*s.nbColumns+(r-1)]=C}return s},st.linsolveExtendedKaczmarz=function(t,r,n){void 0===n&&(n={});var o=n.eps||1e-12,e=n.maxIter||1e5,i=!1;if(void 0!==n.randomized&&(i=n.randomized),!(t instanceof st))throw new Error("first input must be a matrix");if(!(r instanceof st))throw new Error("second input must be a matrix");if(t.nbRows!==r.nbRows)throw new Error("matrix and second member sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");if(1!==r.nbColumns)throw new Error("b is not a vector: ("+r.nbRows+","+r.nbColumns+")");var a=t.nbRows,s=t.nbColumns,u=st.zeros(s,1),l=new st(r),h=st.zeros(a,1),f=st.zeros(a,1),m=st.zeros(a,1),c=t.matrixNorm("frobenius"),d=c*c;if(0===c)return u;for(var w="function"==typeof Float64Array?new Float64Array(a):new Array(a),v=1;v<=a;++v){var p=t.vectorNorm("two","row",v);w[v-1]=p*p}for(var b="function"==typeof Float64Array?new Float64Array(s):new Array(s),g=1;g<=s;++g){var y=t.vectorNorm("two","column",g);b[g-1]=y*y}if(0==i)for(var x=0;;){if(++x,-1!==e&&e<=x)throw new Error("maximum number of iterations reached: "+e);for(v=1;v<=a;++v)if(0!=w[v-1]){var C=0;for(g=1;g<=s;++g)C+=t.data[(v-1)*t.nbColumns+(g-1)]*u.data[(g-1)*u.nbColumns];var A=C-(r.data[(v-1)*r.nbColumns+0]-l.data[(v-1)*l.nbColumns+0]);for(g=1;g<=s;++g)u.data[(g-1)*u.nbColumns]-=A/w[v-1]*t.data[(v-1)*t.nbColumns+(g-1)]}for(g=1;g<=s;++g)if(0!=b[g-1]){var R=0;for(v=1;v<=a;++v)R+=t.data[(v-1)*t.nbColumns+(g-1)]*l.data[(v-1)*l.nbColumns+0];for(v=1;v<=a;++v)l.data[(v-1)*l.nbColumns+0]-=R/b[g-1]*t.data[(v-1)*t.nbColumns+(g-1)]}var E=u.vectorNorm("two");if(m=st.xy(t,u,m),f=st.xmy(r,l,f),(k=(h=st.xmy(m,f,h)).vectorNorm("two"))<=o*c*E)break}else{var M=st.zeros(s,1),P="function"==typeof Float64Array?new Float64Array(a):new Array(a);for(v=1;v<=a;++v)P[v-1]=w[v-1]/d;var V=new U(P),z="function"==typeof Float64Array?new Float64Array(s):new Array(s);for(g=1;g<=s;++g)z[g-1]=b[g-1]/d;var I=new U(z);for(x=0;;){if(++x,-1!==e&&e<=x)throw new Error("maximum number of iterations reached: "+e);for(v=V.sample()+1,C=0,g=1;g<=s;++g)C+=t.data[(v-1)*t.nbColumns+(g-1)]*u.data[(g-1)*u.nbColumns];for(A=C-(r.data[(v-1)*r.nbColumns+0]-l.data[(v-1)*l.nbColumns+0]),g=1;g<=s;++g)u.data[(g-1)*u.nbColumns]-=A/w[v-1]*t.data[(v-1)*t.nbColumns+(g-1)];for(g=I.sample()+1,R=0,v=1;v<=a;++v)R+=t.data[(v-1)*t.nbColumns+(g-1)]*l.data[(v-1)*l.nbColumns+0];for(v=1;v<=a;++v)l.data[(v-1)*l.nbColumns+0]-=R/b[g-1]*t.data[(v-1)*t.nbColumns+(g-1)];if(x%8*Math.min(a,s)==0){E=u.vectorNorm("two");m=st.xy(t,u,m),f=st.xmy(r,l,f);var k=(h=st.xmy(m,f,h)).vectorNorm("two"),N=(M=st.txy(t,l,M)).vectorNorm("two");if(k<=o*c*E&&N<=o*d*E)break}}}return u},T.meanVector=function(n,t){void 0===(t=t)&&(t={}),void 0===t.method&&(t.method="sample-mean");var r=t.method;if("sample-mean"!=r&&"linear-shrinkage"!=r)throw new Error("unsupported mean vector computation method");var o,e=n.length,i=n[0].length;if("sample-mean"==r){o=a=st.fill(e,1,function(t,r){return I(n[t-1])})}else{if("linear-shrinkage"!=r)throw new Error("internal error: unsupported mean vector computation method");var a,s=I((a=st.fill(e,1,function(t,r){return I(n[t-1])})).toArray()),u=st.fill(e,1,function(t,r){return s}),l=st.fill(e,1,function(t,r){return k(n[t-1],n[t-1])}).sum()/e,h=e/i*l/(e/i*l+Math.pow(st.xmy(u,a).vectorNorm("two"),2));o=st.axpby(h,u,1-h,a)}return o},T.randomMeanVector=function(t,r){var n=null==r?1:r;return st.fill(t,1,function(t,r){return R(0,n)})},T.perturbedMeanVector=function(t,r){if(void 0===(r=r)&&(r={}),void 0===r.method&&(r.method="multiplicative-noise"),"multiplicative-noise"!=r.method)throw new Error("unsupported perturbation method");var o=r.sigma;if(void 0===r.sigma&&(o=.05),!(t=new st(t)).isVector())throw new Error("input must be a vector");return t.elemMap(function(t,r,n){return n*(1+o*R(0,1))})},T.randomVariances=function(t,r){var n=null==r?1:r;return st.fill(t,1,function(t,r){return function(t,r){null==t&&(t=0);null==r&&(r=1);var n,o=r*r,e=1.136717791056118,i=(1-e*e)/e*r,a=r*Math.sqrt(Math.PI/2);for(;;){var s;if(t<i){var u=(-t+Math.sqrt(t*t+4*o))/2/o;n=-Math.log(1-Math.random())/u,s=Math.exp(-(n-t)*(n-t)/2/o-u*(t-n+u*o/2))}else if(t<=0)n=Math.abs(R())*r+t,s=0<=n?1:0;else if(t<a){var l=Math.random()<t/(t+Math.sqrt(Math.PI/2)*r)?1:0,h=Math.random()*t,f=Math.abs(R()*r)+t;n=l*h+(1-l)*f,s=l*Math.exp(-(n-t)*(n-t)/2/o)+(1-l)}else n=R()*r+t,s=0<=n?1:0;if(Math.random()<=s)break}return n}(0,n)})},T.perturbedVariances=function(t,r){if(void 0===(r=r)&&(r={}),void 0===r.method&&(r.method="multiplicative-noise"),"multiplicative-noise"!=r.method)throw new Error("unsupported perturbation method");var e=r.sigma;if(void 0===r.sigma&&(e=.05),!(t=new st(t)).isVector())throw new Error("input must be a vector");return t.elemMap(function(t,r,n){for(var o=n*(1+e*R(0,1));o<=0;)o=n*(1+e*R(0,1));return o})},ut.populationCount=function(t){return t=(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135,t+=t>>>8,63&(t+=t>>>16)},ut.prototype={constructor:ut,resize:function(t){var r=this.words.length;if(!(r<<this.WORD_LOG>t)){var n=t+this.WORD_LENGTH>>>this.WORD_LOG;if("function"==typeof Uint32Array){var o=new Uint32Array(n);o.set(this.words),this.words=o}else{this.words[n-1]=0;for(var e=r;e<n-1;++e)this.words[e]=0}}},toString:function(){for(var t="",r=this.words.length,n=0;n<r;++n){var o="";t+=(o="function"==typeof Uint32Array?this.words[n].toString(2):(this.words[n]>>>0).toString(2)).length>=this.WORD_LENGTH?o:new Array(this.WORD_LENGTH-o.length+1).join("0")+o}return t},set:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]|=1<<t,this},setRange:function(t,r){this.words.length<<this.WORD_LOG<=r&&this.resize(r);for(var n=t;n<=r;++n)this.words[n>>>this.WORD_LOG]|=1<<n;return this},unset:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]&=~(1<<t),this},get:function(t){return 0!=(this.words[t>>>this.WORD_LOG]&1<<t)},clear:function(){return this.words="function"==typeof Uint32Array?new Uint32Array(0):new Array(0),this},flip:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]^=1<<t,this},isEmpty:function(){for(var t=this.words.length,r=0;r<t;++r)if(0!=this.words[r])return!1;return!0},nbSetBits:function(){for(var t=0,r=this.words.length,n=0;n<r;++n)t+=ut.populationCount(0|this.words[n]);return t},toArray:function(){for(var t=new Array(this.nbSetBits()),r=0,n=this.words.length,o=0;o<n;++o)for(var e=this.words[o];0!=e;){var i=e&-e;t[r++]=(o<<this.WORD_LOG)+ut.populationCount(i-1|0),e^=i}return t}},T.returns=function(t,r){void 0===(r=r)&&(r={}),void 0===r.method&&(r.method="arithmetic");var n=r.method;if("arithmetic"!=n&&"logarithmic"!=n)throw new Error("unsupported returns computation method");var o="function"==typeof Float64Array?new Float64Array(t.length-1):new Array(t.length-1);if("arithmetic"==n)for(var e=0;e<t.length-1;++e)o[e]=(t[e+1]-t[e])/t[e];else{if("logarithmic"!=n)throw new Error("internal error: unsupported returns computation method");for(e=0;e<t.length-1;++e)o[e]=Math.log(t[e+1]/t[e])}return o},T.bestConstantlyRebalancedWeights=function(h,t){void 0===t&&(t={constraints:{}}),void 0===t.constraints&&(t.constraints={}),void 0===t.eps&&(t.eps=1e-4),void 0===t.maxIter&&(t.maxIter=1e4);var r=t.eps,n=t.maxIter,o=t.constraints.minWeights,e=t.constraints.maxWeights,f=h.length,m=h[0].length;return D(function(t){for(var r=st.zeros(f,1),n=1,o=0;o<m;++o)r=st.fill(f,1,function(t,r){return h[t-1][o]},r),n*=st.vectorDotProduct(t,r);return-n},function(t){for(var r,n=st.zeros(f,1),o="function"==typeof Float64Array?new Float64Array(m):new Array(m),e=1,i=!1,a=0;a<m;++a){n=st.fill(f,1,function(t,r){return h[t-1][a]},n);var s=st.vectorDotProduct(t,n);o[a]=s,!1===i&&(e*=s,Math.abs(s)<=1e-12&&(i=!0))}if(!1!==i)throw new Error("null portfolio relative detected, unsuported case");r=st.fill(m,1,function(t,r){return e/o[t-1]});var u=st.zeros(m,1),l=st.zeros(f,1);for(a=0;a<f;++a)u=st.fill(m,1,function(t,r){return h[a][t-1]},u),l.data[a]=-st.vectorDotProduct(u,r);return l},function(t){return G(t.data,o,e)},function(t){return new st(J(t.data,o,e))},new st(J(st.ones(f,1).data,o,e)),{eps:r,maxIter:n,maxLine:n})[0].toArray()},T.clusterRiskParityWeights=function(t,r){void 0===r&&(r={});var n=r.clusteringMode||"ftca",o=(t=new st(t).toCovarianceMatrix(t)).nbRows,e=[];if("manual"===n){e=r.clusters||[];for(var i=new Array(o),a=0;a<i.length;++a)i[a]=0;for(var s=0;s<e.length;++s){if(0===e[s].length)throw new Error("empty cluster at index: "+s);for(var u=0;u<e[s].length;++u){var l=e[s][u];if(l<1||o<l)throw new Error("asset index out of bounds: "+l);i[l-1]++}}for(a=0;a<i.length;++a)if(1!==i[a])throw 0===i[a]?new Error("missing asset index: "+(a+1)):1<i[a]?new Error("duplicate asset index: "+(a+1)):new Error("unknown error")}else{if("ftca"!==n)throw new Error("unsupported clustering method");e=function(t,r){void 0===(r=r)&&(r=.5);for(var n=[],o=(t=new st(t)).nbRows,e=new Array(o),i=0;i<e.length;++i)e[i]=i+1;for(;0!=e.length;){if(1===e.length){var a=[e[0]];e[0]=null,n.push(a)}else{var s=t.submatrix(e,e).toRowArray(function(t,r,n){return t!=r}),u=new Array(e);for(i=0;i<e.length;++i)u[i]=I(s[i]);var l=0,h=-1,f=-1,m=0,c=-1,d=1;for(i=0;i<e.length;++i)u[i]>=f&&(l=e[i],f=u[h=i]),u[i]<=d&&(m=e[i],d=u[c=i]);if(t.getValueAt(l,m)>r){var w=l===m?[l]:[l,m];e[h]=null,e[c]=null;for(i=0;i<e.length;++i){if(null!==e[i])r<(t.getValueAt(e[i],l)+t.getValueAt(e[i],m))/2&&(w.push(e[i]),e[i]=null)}n.push(w)}else{var v=[l];e[h]=null;for(i=0;i<e.length;++i)null!==e[i]&&t.getValueAt(e[i],l)>r&&(v.push(e[i]),e[i]=null);if(n.push(v),l!==m){var p=[m];e[c]=null;for(i=0;i<e.length;++i)null!==e[i]&&t.getValueAt(e[i],m)>r&&(p.push(e[i]),e[i]=null);n.push(p)}}}var b=[];for(i=0;i<e.length;++i)null!==e[i]&&b.push(e[i]);e=b}return n}(t.getCorrelationMatrix().toRowArray(),r.ftcaThreshold)}var h=e.length,f=st.zeros(h,o);for(a=0;a<h;++a){var m=e[a].slice().sort(function(t,r){return t-r}),c=t.submatrix(m,m),d=T.equalRiskContributionWeights(c,r);for(s=0;s<d.length;++s)f.setValueAt(a+1,m[s],d[s])}var w=st.xy(f,st.axty(1,t,f)),v=T.equalRiskContributionWeights(w,r);return st.txy(f,new st(v)).toArray()},T.equalRiskBoundingWeights=function(t,r){void 0===r&&(r={}),r.outputPortfolioVolatility=!0;var n=(t=new st(t)).nbRows,o=1/0,e=[],i=[],a=new v(n),s=a.next();for(s=a.next();-1!=s;){var u=s,l=t.submatrix(u,u),h=T.equalRiskContributionWeights(l,r),f=h[0],m=h[1],c=m*m/u.length;c<o&&(o=c,e=u,i=f);s=a.next()}for(var d=st.zeros(n,1),w=0;w<e.length;++w)d.setValueAt(e[w],1,i[w]);return d.toArray()},T.equalRiskContributionWeights=function(t,r){var n=(t=new st(t)).nbRows,o=st.fill(n,1,function(t,r){return 1/n});return T.riskBudgetingWeights(t,o,r)},T.equalWeights=function(n,t){return st.fill(n,1,function(t,r){return 1/n}).toArray()},T.globalMinimumVarianceWeights=function(t,r){void 0===r&&(r={}),void 0===r.constraints&&(r.constraints={}),void 0===r.optimizationMethodParams&&(r.optimizationMethodParams={});var n=(t=new st(t)).nbRows;return new Q(null==r.mu?st.zeros(n,1):new st(r.mu),t,r).getLowestRiskTolerancePortfolio().toArray()},T.inverseVolatilityWeights=function(t,r){var n=new st(t).elemMap(function(t,r,n){return 1/Math.sqrt(n)});return(n=n.normalize(n)).toArray()},T.maximumSharpeRatioWeights=function(t,r,n,o){void 0===o&&(o={constraints:{}}),void 0===o.constraints&&(o.constraints={}),void 0===o.optimizationMethodParams&&(o.optimizationMethodParams={});var e=o.optimizationMethod;if(void 0===e&&(e="gsmo"),"critical-line"!=e&&"gsmo"!=e)throw new Error("unsupported optimisation method");var i,a=o.epsVolatility;if(void 0===a&&(a=1e-4),"critical-line"==e)i=new O(t,r,o);else{if("gsmo"!=e)throw new Error("internal error: unsupported optimisation method");i=new Q(t,r,o)}return i.restrict("minVolatility",a),i.restrict("minReturn",n),i.computeMaximumSharpeRatioEfficientPortfolio(n)[0].toArray()},((O.prototype=Object.create(h.prototype)).constructor=O).prototype.getHighestRiskTolerancePortfolio=function(t){return this.cornerPortfolios[0][0]},O.prototype.getHighestRiskTolerance=function(t){return this.cornerPortfolios[0][1]},O.prototype.getLowestRiskTolerancePortfolio=function(t){return this.cornerPortfolios[this.cornerPortfolios.length-1][0]},O.prototype.getLowestRiskTolerance=function(t){return this.cornerPortfolios[this.cornerPortfolios.length-1][1]},O.prototype.computeEfficientPortfolio=function(t,r){if(null==t)throw new Error("missing constraint type");var n,o=this;if("return"==t)n=function(t){return o.computePortfolioReturn(t[0])};else if("volatility"==t)n=function(t){return o.computePortfolioVolatility(t[0])};else{if("riskTolerance"!=t)throw new Error("unknown constraint type");n=function(t){return t[1]}}if(null==r)throw new Error("missing constraint value");var e=function(t,r,n,o){var e=n.length-1,i=0,a=(n[e][0],n[i][0],t(n[e])),s=t(n[i]);if(s+o<r||r<a-o)return[];{if(Math.abs(r-a)<=o)return[e];if(Math.abs(r-s)<=o)return[i]}for(;e-i!=1;){var u=Math.floor((e+i)/2),l=t(n[u]);if(r<l)i=u;else{if(!(l<r))return[u];e=u}}return[e,i]}(n,r,this.cornerPortfolios,this.epsEfficientPortfolioComputation);if(0==e.length)return[];if(1==e.length){var i=e[0];return[this.cornerPortfolios[i][0],this.cornerPortfolios[i][1]]}i=e[0];var a,s=this.cornerPortfolios[i][0],u=n(this.cornerPortfolios[i]),l=e[1],h=this.cornerPortfolios[l][0],f=n(this.cornerPortfolios[l]);if("return"===t)a=(f-r)/(f-u);else if("volatility"===t){var m=st.vectorDotProduct(st.xy(this.sigma,s),h),c=u*u+f*f-2*m,d=f*f-r*r,w=-2*(f*f-m)/2,v=0<=w?1:-1,p=w*w-c*d;if(p<0)throw new Error("internal error; the covariance matrix might not be semi-definite positive");var b=-(w+v*Math.sqrt(p)),g=b/c,y=d/b;if(0<g&&g<1)a=g;else{if(!(0<y&&y<1))throw new Error("internal error: the covariance matrix might not be semi-definite positive");a=y}}else{if("riskTolerance"!==t)throw new Error("internal error: unknown constraint type");a=(f-r)/(f-u)}return[st.fill(s.nbRows,1,function(t,r){return a*s.getValue(t,1)+(1-a)*h.getValue(t,1)}),a*this.cornerPortfolios[i][1]+(1-a)*this.cornerPortfolios[l][1]]},O.prototype.getCornerPortfolios=function(){for(var t=new Array(this.cornerPortfolios.length),r=0;r<t.length;++r)t[r]=new st(this.cornerPortfolios[r][0]);return t},O.prototype.restrict=function(t,r){if(null==t)throw new Error("missing constraint type");if(null==r)throw new Error("missing constraint value");if("minReturn"==t){if(this.getLowestReturn()<r){if(this.getHighestReturn()<r)throw new Error("impossible to restrict the efficient frontier: the minimum return constraint is not feasible");if(0==(a=this.computeEfficientPortfolio("return",r+this.epsEfficientPortfolioComputation)).length)throw new Error("internal error: no efficient portfolio with a return greater than "+r);var n=a[0],o=a[1],e=new Array;for(i=0;i<this.cornerPortfolios.length-1&&this.cornerPortfolios[i][1]>o;++i)e.push(this.cornerPortfolios[i]);e.push([n,o]),this.cornerPortfolios=e}}else{if("minVolatility"!=t)throw new Error("unknown constraint type");if(this.getLowestVolatility()<r){var a;if(this.getHighestVolatility()<r)throw new Error("impossible to restrict the efficient frontier: the minimum volatility constraint is not feasible");if(0==(a=this.computeEfficientPortfolio("volatility",r+this.epsEfficientPortfolioComputation)).length)throw new Error("internal error: no efficient portfolio with a volatility greater than "+r+": the covariance matrix might not be semi-definite positive");n=a[0],o=a[1],e=new Array;for(i=0;i<this.cornerPortfolios.length-1&&this.cornerPortfolios[i][1]>o;++i)e.push(this.cornerPortfolios[i]);e.push([n,o]),this.cornerPortfolios=e}}},O.prototype.computeMaximumSharpeRatioEfficientPortfolio=function(t){var r=function(t){var r=this.cornerPortfolios.length-1,n=0;if(r==n)return r;for(;r-n!=1;){var o=Math.floor((r+n)/2),e=this.cornerPortfolios[o][0],i=this.computePortfolioSharpeRatio(e,t),a=o+1,s=this.cornerPortfolios[a][0],u=this.computePortfolioSharpeRatio(s,t);if(u<i)r=o;else{if(!(i<u)){r=a,n=o;break}n=o}}return r}.call(this,t),n=this.cornerPortfolios[r][0],o=[[n,this.computePortfolioSharpeRatio(n,t),this.cornerPortfolios[r][1]]];r<=this.cornerPortfolios.length-2&&o.push(i.call(this,t,r+1,r)),1<=r&&o.push(i.call(this,t,r,r-1));var e=B(o,function(t,r){return t[1]-r[1]})[0];return[e[0],e[2]];function i(t,r,n){var o=this.cornerPortfolios,e=o[r][0],i=o[n][0],a=this.computePortfolioSharpeRatio(e,t),s=this.computePortfolioReturn(e),u=this.computePortfolioVolatility(e),l=u*u,h=this.computePortfolioSharpeRatio(i,t),f=this.computePortfolioReturn(i),m=this.computePortfolioVolatility(i),c=m*m,d=s-f,w=f-t,v=d*d,p=2*d*w,b=w*w,g=st.vectorDotProduct(st.xy(this.sigma,e),i),y=l+c-2*g,x=-2*(c-g),C=v*x-p*y,A=p*c-b*x,R=2*(v*c-b*y)/2,E=0<=R?1:-1,M=R*R-C*A;if(M<0)throw new Error("internal error, the covariance matrix might not be semi-definite positive");var P=-(R+E*Math.sqrt(M)),V=P/C,z=A/P,I=[[e,a,o[r][1]],[i,h,o[n][1]]];if(0<V&&V<1){var k=st.fill(e.nbRows,1,function(t,r){return V*e.getValue(t,1)+(1-V)*i.getValue(t,1)}),N=this.computePortfolioSharpeRatio(k,t),S=V*o[r][1]+(1-V)*o[n][1];I.push([k,N,S])}if(0<z&&z<1){var _=st.fill(e.nbRows,1,function(t,r){return z*e.getValue(t,1)+(1-z)*i.getValue(t,1)}),F=this.computePortfolioSharpeRatio(_,t),O=z*o[r][1]+(1-z)*o[n][1];I.push([_,F,O])}return B(I,function(t,r){return t[1]-r[1]})[0]}},((Q.prototype=Object.create(h.prototype)).constructor=Q).prototype.getHighestRiskTolerancePortfolio=function(t){var n=this.highestRiskTolerancePortfolio;if(0==this.fullInvestment){var o=this;n=st.fill(this.nbAssets,1,function(t,r){if(t<=o.nbAssets)return n.getValue(t,1)})}return n},Q.prototype.getHighestRiskTolerance=function(t){return this.highestRiskTolerance},Q.prototype.getLowestRiskTolerancePortfolio=function(t){var n=this.lowestRiskTolerancePortfolio;if(0==this.fullInvestment){var o=this;n=st.fill(this.nbAssets,1,function(t,r){if(t<=o.nbAssets)return n.getValue(t,1)})}return n},Q.prototype.getLowestRiskTolerance=function(t){return this.lowestRiskTolerance},Q.prototype.computeEfficientPortfolio=function(t,o){if(null==t)throw new Error("internal error: missing constraint type");var e,r,i,n,a,s,u=this;if("return"==t)e=function(t){return u.computePortfolioReturn(t)};else if("volatility"==t)e=function(t){return u.computePortfolioVolatility(t)};else if("riskTolerance"!=t)throw new Error("internal error: unknown constraint type");if(null==o)throw new Error("internal error: missing constraint value");var l=this.epsEfficientPortfolioComputation;s=1==this.fullInvestment?(r=this.nbAssets,i=this.mu,n=this.sigma,a=this.lowerBounds,this.upperBounds):(r=this.alteredNbAssets,i=this.alteredMu,n=this.alteredSigma,a=this.alteredLowerBounds,this.alteredUpperBounds);var h,f,m=n,c=st.ones(r,1),d=a,w=s;if("return"===t||"volatility"===t){var v=this.getLowestRiskTolerancePortfolio(),p=e(v),b=this.getHighestRiskTolerancePortfolio(),g=e(b);if(g+l<o||o<p-l)return[];if(Math.abs(o-p)<=l)h=v,f=this.getLowestRiskTolerance();else if(Math.abs(o-g)<=l)h=b,f=this.getHighestRiskTolerance();else{u=this;f=M(function(t){var r=st.ax(-t,i),n=P(m,r,c,1,d,w,{eps:u.epsGsmo,maxIter:u.maxIterationsGsmo});return h=n[0],e(h)-o},this.getLowestRiskTolerance(),this.getHighestRiskTolerance())}}else{if("riskTolerance"!==t)throw new Error("internal error: unknown constraint type");var y=o,x=st.ax(-y,i),C=P(m,x,c,1,d,w,{eps:this.epsGsmo,maxIter:this.maxIterationsGsmo});h=C[0],f=y}if(0==this.fullInvestment){u=this;h=st.fill(this.nbAssets,1,function(t,r){if(t<=u.nbAssets)return h.getValue(t,1)})}return[h,f]},Q.prototype.restrict=function(t,r){if(null==t)throw new Error("missing constraint type");if(null==r)throw new Error("missing constraint value");if("minReturn"==t){if(this.getLowestReturn()<r){if(this.getHighestReturn()<r)throw new Error("impossible to restrict the efficient frontier: the minimum return constraint is not feasible");if(0==(e=this.computeEfficientPortfolio("return",r+this.epsEfficientPortfolioComputation)).length)throw new Error("internal error: no efficient portfolio with a return greater than "+r);var n=e[0],o=e[1];this.lowestRiskTolerancePortfolio=n,this.lowestRiskTolerance=o,this.lowestRiskTolerance>=this.highestRiskTolerance&&(this.highestRiskTolerancePortfolio=n,this.highestRiskTolerance=o)}}else{if("minVolatility"!=t)throw new Error("unknown constraint type");if(this.getLowestVolatility()<r){var e;if(this.getHighestVolatility()<r)throw new Error("impossible to restrict the efficient frontier: the minimum volatility constraint is not feasible");if(0==(e=this.computeEfficientPortfolio("volatility",r+this.epsEfficientPortfolioComputation)).length)throw new Error("internal error: no efficient portfolio with a volatility greater than "+r+": the covariance matrix might not be semi-definite positive");n=e[0],o=e[1];this.lowestRiskTolerancePortfolio=n,this.lowestRiskTolerance=o,this.lowestRiskTolerance>=this.highestRiskTolerance&&(this.highestRiskTolerancePortfolio=n,this.highestRiskTolerance=o)}}},Q.prototype.computeMaximumSharpeRatioEfficientPortfolio=function(o){var t,e,r,n,i;this.epsEfficientPortfolioComputation;i=1==this.fullInvestment?(t=this.nbAssets,e=this.mu,r=this.sigma,n=this.lowerBounds,this.upperBounds):(t=this.alteredNbAssets,e=this.alteredMu,r=this.alteredSigma,n=this.alteredLowerBounds,this.alteredUpperBounds);var a,s=r,u=st.ones(t,1),l=n,h=i,f=this,m=function(t,r,n,o){void 0===o&&(o={});var e=o.maxIter;void 0===e&&(e=-1);var i=o.eps;void 0===i&&(i=1e-6);var a=(Math.sqrt(5)-1)/2,s=r,u=n,l=u-a*(u-s),h=s+a*(u-s),f=t(r),m=t(n),c=t(l),d=t(h);if(n<r)throw new Error("bracketing interval lower bound "+r+" greater than bracketing interval upper bound "+n);for(var w=0;;){if(-1!==e&&e<w)throw new Error("maximum number of iterations reached: "+e);if(++w,c<=d?(u=h,h=l,d=c,c=t(l=u-a*(u-s))):d<c&&(s=l,l=h,c=d,d=t(h=s+a*(u-s))),Math.abs(u-s)<=i)return c<d?f<c?[r,f]:[l,c]:m<d?[n,m]:[h,d]}}(function(t){var r=st.ax(-t,e),n=P(s,r,u,1,l,h,{eps:f.epsGsmo,maxIter:f.maxIterationsGsmo});return a=n[0],-f.computePortfolioSharpeRatio(a,o)},this.getLowestRiskTolerance(),this.getHighestRiskTolerance());if(0==this.fullInvestment){f=this;a=st.fill(this.nbAssets,1,function(t,r){if(t<=f.nbAssets)return a.getValue(t,1)})}return[a,m[0]]},h.prototype.getHighestReturnPortfolio=function(t){return this.getHighestRiskTolerancePortfolio()},h.prototype.getHighestReturn=function(t){return this.computePortfolioReturn(this.getHighestReturnPortfolio())},h.prototype.getLowestReturnPortfolio=function(t){return this.getLowestRiskTolerancePortfolio()},h.prototype.getLowestReturn=function(t){return this.computePortfolioReturn(this.getLowestReturnPortfolio())},h.prototype.getHighestVolatilityPortfolio=function(t){return this.getHighestRiskTolerancePortfolio()},h.prototype.getHighestVolatility=function(t){return this.computePortfolioVolatility(this.getHighestVolatilityPortfolio())},h.prototype.getLowestVolatilityPortfolio=function(t){return this.getLowestRiskTolerancePortfolio()},h.prototype.getLowestVolatility=function(t){return this.computePortfolioVolatility(this.getLowestVolatilityPortfolio())},h.prototype.getHighestRiskTolerancePortfolio=function(t){throw new Error("internal error: function is not implemented")},h.prototype.getHighestRiskTolerance=function(t){throw new Error("internal error: function is not implemented")},h.prototype.getLowestRiskTolerancePortfolio=function(t){throw new Error("internal error: unction is not implemented")},h.prototype.getLowestRiskTolerance=function(t){throw new Error("internal error: function is not implemented")},h.prototype.computePortfolioReturn=function(t){if(1==this.fullInvestment)return st.vectorDotProduct(this.mu,t);if(t.nbRows==this.alteredNbAssets)return st.vectorDotProduct(this.alteredMu,t);if(t.nbRows==this.nbAssets)return st.vectorDotProduct(this.mu,t);throw new Error("internal error: unexpected portfolio number of weights: "+t.nbRows)},h.prototype.computePortfolioVolatility=function(t){var r;if(1==this.fullInvestment)r=st.vectorDotProduct(st.xy(this.sigma,t),t);else if(t.nbRows==this.alteredNbAssets)r=st.vectorDotProduct(st.xy(this.alteredSigma,t),t);else{if(t.nbRows!=this.nbAssets)throw new Error("internal error: unexpected portfolio number of weights: "+t.nbRows);r=st.vectorDotProduct(st.xy(this.sigma,t),t)}if(Math.abs(r)<=this.epsPortfolioVolatility)r=0;else if(r<0&&r<-this.epsPortfolioVolatility)throw new Error("internal error: negative volatility, covariance matrix might not be semi-definite positive");return Math.sqrt(r)},h.prototype.computePortfolioSharpeRatio=function(t,r){if(null==r||null==r)throw new Error("internal error: missing risk free rate");var n=this.computePortfolioReturn(t)-r,o=Math.max(this.epsPortfolioVolatility,this.computePortfolioVolatility(t));if(0==o)throw new Error("internal error: null volatility when computing the Sharpe ratio");return n/o},h.prototype.computeEfficientPortfolio=function(t,r){throw new Error("internal error: function is not implemented")},h.prototype.restrict=function(t,r){throw new Error("internal error: function is not implemented")},h.prototype.computeMaximumSharpeRatioEfficientPortfolio=function(t){throw new Error("internal error: function is not implemented")},T.meanVarianceOptimizationWeights=function(t,r,n){void 0===n&&(n={constraints:{}}),void 0===n.constraints&&(n.constraints={}),void 0===n.optimizationMethodParams&&(n.optimizationMethodParams={});var o=n.optimizationMethod;if(void 0===o&&(o="gsmo"),"critical-line"!=o&&"gsmo"!=o)throw new Error("unsupported optimisation method");var e,i,a=n.constraints.return,s=n.constraints.volatility,u=n.constraints.maxVolatility,l=n.constraints.riskTolerance;if(void 0===a&&void 0===s&&void 0===u&&null==l)throw new Error("missing return, volatility or risk tolerance constraints");if(void 0!==a&&void 0!==s||void 0!==a&&void 0!==u)throw new Error("simultaneous return and volatility constraints");if(void 0!==l&&(void 0!==a||void 0!==u||void 0!==s))throw new Error("simultaneous risk tolerance and return or volatility constraints");if("critical-line"==o)e=new O(t,r,n);else{if("gsmo"!=o)throw new Error("internal error: unsupported optimisation method");e=new Q(t,r,n)}if(void 0!==a){if(0==(v=e.computeEfficientPortfolio("return",a)).length)throw new Error("no matching efficient portfolio with a return equal to "+a);i=v[0]}else if(void 0!==s){if(0==(v=e.computeEfficientPortfolio("volatility",s)).length)throw new Error("no matching efficient portfolio with a volatility equal to "+s);i=v[0]}else if(void 0!==l){var h=e.getHighestRiskTolerancePortfolio(),f=e.getHighestRiskTolerance(),m=e.getLowestRiskTolerancePortfolio(),c=e.getLowestRiskTolerance();if(f-(d=e.epsEfficientPortfolioComputation)<l)i=h;else if(l<c+d)i=m;else{if(0==(v=e.computeEfficientPortfolio("riskTolerance",l)).length)throw new Error("internal error: no matching efficient portfolio with a risk tolerance equal to "+l);i=v[0]}}else if(void 0!==u){var d,w=e.getHighestVolatilityPortfolio();if(e.getHighestVolatility()-(d=e.epsEfficientPortfolioComputation)<u)i=w;else{var v;if(0==(v=e.computeEfficientPortfolio("volatility",u)).length)throw new Error("no matching efficient portfolio with a volatility lower than or equal to "+u);i=v[0]}}return i.toArray()},T.meanVarianceEfficientFrontierNearestWeights=function(t,r,n,o){void 0===o&&(o={constraints:{}}),void 0===o.constraints&&(o.constraints={}),void 0===o.optimizationMethodParams&&(o.optimizationMethodParams={});var e=o.optimizationMethod;if(void 0===e&&(e="gsmo"),"critical-line"!=e&&"gsmo"!=e)throw new Error("unsupported optimisation method");var i,a;t=new st(t);if("critical-line"==e)a=(i=new O(r,n,o)).getCornerPortfolios();else{if("gsmo"!=e)throw new Error("internal error: unsupported optimisation method");i=new Q(r,n,o);var s=o.optimizationMethodParams.nbPortfoliosGsmo;null==s&&(s=100),a=new Array(s);for(var u=i.getLowestRiskTolerance(),l=(i.getHighestRiskTolerance()-u)/(s-1),h=0;h<s;++h){var f,m=u+h*l;if(0==(f=i.computeEfficientPortfolio("riskTolerance",m)).length)throw new Error("internal error: no matching efficient portfolio with a risk tolerance of "+m);a[h]=f[0]}}var c=Number.POSITIVE_INFINITY;for(h=0;h<a.length-1;++h){var d=a[h],w=p(t,a[h+1],d),v=st.xmy(t,new st(w)).vectorNorm("two");v<=c&&(f=w,c=v)}return f},T.meanVarianceEfficientFrontierPortfolios=function(t,r,n){void 0===n&&(n={constraints:{}}),void 0===n.constraints&&(n.constraints={}),void 0===n.optimizationMethodParams&&(n.optimizationMethodParams={});var o=n.optimizationMethod;if(void 0===o&&(o="gsmo"),"critical-line"!=o&&"gsmo"!=o)throw new Error("unsupported optimisation method");var e,i=n.nbPortfolios||100,a=n.discretizationType;if(null==a&&(a="return"),"return"!=a&&"volatility"!=a&&"riskTolerance"!=a)throw new Error("unsupported discretization type");if("critical-line"==o)e=new O(t,r,n);else{if("gsmo"!=o)throw new Error("internal error: unsupported optimisation method");e=new Q(t,r,n)}var s,u,l=new Array(i);if("return"==a)s=e.getLowestReturn(),u=e.getHighestReturn();else if("volatility"==a)s=e.getLowestVolatility(),u=e.getHighestVolatility();else{if("riskTolerance"!=a)throw new Error("internal error: unsupported discretization type");s=e.getLowestRiskTolerance(),u=e.getHighestRiskTolerance()}for(var h=1==i?-1:(u-s)/(i-1),f=1==i?(s+u)/2:s,m=0;m<i;++m){var c=f+m*h,d=e.computeEfficientPortfolio(a,c);if(0==d.length)throw new Error("internal error: no matching efficient portfolio with a constraint value "+a+" equal to "+c);d=d[0];var w=e.computePortfolioReturn(d),v=e.computePortfolioVolatility(d);l[m]=[d.toArray(),w,v]}return l},T.minimaxWeights=function(n,t){void 0===t&&(t={constraints:{}}),void 0===t.constraints&&(t.constraints={});var r=!0;void 0!==t.constraints.fullInvestment&&(r=t.constraints.fullInvestment);var o=t.outputMinimumPortfolioReturn,e=n.length,i=n[0].length,a=st.fill(e+1,1,function(t,r){return t<=e?0:-1}),s=null,u=null;r&&(s=st.fill(1,e+1,function(t,r){return r<=e?1:0}),u=st.ones(1,1));var l=function(o,t,e,r,n,i,a,s){void 0===s&&(s={});var u=s.eps||1e-8,l=s.maxIter||1e5,h=!1,f=!1,m=!1;if(null!==o&&null!==t)h=!0;else{if(null!==o&&null===t)throw new Error("equality constraints vector is missing");if(null===o&&null!==t)throw new Error("equality constraints matrix is missing")}if(null!==e&&null!==r)f=!0;else{if(null!==e&&null===r)throw new Error("inequality constraints vector is missing");if(null===e&&null!==r)throw new Error("inequality constraints matrix is missing")}if(null!==i&&null!==a)m=!0;else{if(null!==i&&null===a)throw new Error("upper bounds constraints vector is missing");if(null===i&&null!==a)throw new Error("lower bounds constraints vector is missing")}if(!(n instanceof st))throw new Error("fifth input must be a matrix");if(1!==n.nbColumns)throw new Error("fifth input is not a vector: "+n.nbColumns+"-"+n.nbRows);if(h){if(!(o instanceof st))throw new Error("first input must be a matrix");if(!(t instanceof st))throw new Error("second input must be a matrix");if(o.nbRows!==t.nbRows)throw new Error("first and second inputs number of rows do not match: "+o.nbRows+"-"+t.nbRows);if(o.nbColumns!==n.nbRows)throw new Error("first input number of columns and fifth input number of rows do not match: "+o.nbColumns+"-"+n.nbRows);if(1!==t.nbColumns)throw new Error("second input is not a vector: "+t.nbColumns+"-"+t.nbRows)}if(f){if(!(e instanceof st))throw new Error("third input must be a matrix");if(!(r instanceof st))throw new Error("third input must be a matrix");if(e.nbRows!==r.nbRows)throw new Error("third and fourth inputs number of rows do not match: "+e.nbRows+"-"+r.nbRows);if(e.nbColumns!==n.nbRows)throw new Error("third input number of columns and fifth input number of rows do not match: "+e.nbColumns+"-"+n.nbRows);if(1!==r.nbColumns)throw new Error("fourth input is not a vector: "+r.nbColumns+"-"+r.nbRows)}if(m){if(null!==i.nbRows){if(!(i instanceof st))throw new Error("sixth input must be a matrix");if(i.nbRows!==n.nbRows)throw new Error("sixth input number of rows and fifth input number of rows do not match: "+i.nbRows+"-"+n.nbRows)}if(null!==a.nbRows){if(!(a instanceof st))throw new Error("seventh input must be a matrix");if(a.nbRows!==n.nbRows)throw new Error("seventh input number of rows and fifth input number of rows do not match: "+a.nbRows+"-"+n.nbRows)}}var c=0,d=null,w=null,v=null;h&&(c=o.nbRows,d=st.zeros(c,1),w=st.zeros(c,1),v=st.zeros(c,1));var p=0,b=null,g=null,y=null;f&&(p=e.nbRows,b=st.zeros(p,1),g=st.zeros(p,1),y=st.zeros(p,1));var x=n.nbRows,C=st.ones(x,1),A=st.ones(x,1),R=st.ones(x,1),E=st.zeros(x,1),M=st.zeros(x,1),P=st.zeros(x,1),V=null;h&&(V=st.zeros(c,1));var z=null;f&&(z=st.zeros(p,1));var I=st.fill(x,1,function(t,r){var n=0;h&&(n+=o.vectorNorm("one","column",t));f&&(n+=e.vectorNorm("one","column",t));return 0==n&&(n=1),.9995/n}),k=null;h&&(k=st.fill(c,1,function(t,r){var n=o.vectorNorm("one","row",t);return 0==n&&(n=1),.9995/n}));var N=null;f&&(N=st.fill(p,1,function(t,r){var n=e.vectorNorm("one","row",t);return 0==n&&(n=1),.9995/n}));for(var S=0;;){if(-1!==l&&l<=S)throw new Error("maximum number of iterations reached: "+l);if(++S,h&&f?A=st.xpy(st.xpy(st.txy(o,d,M),st.txy(e,b,P),M),n,A):h?A=st.xpy(st.txy(o,d,M),n,A):f&&(A=st.xpy(st.txy(e,b,M),n,A)),A=st.xmy(C,st.elementwiseProduct(A,I,M),A),m)for(var _=1;_<=x;++_)A.data[_-1]<i.data[_-1]?A.data[_-1]=i.data[_-1]:A.data[_-1]>a.data[_-1]&&(A.data[_-1]=a.data[_-1]);else for(_=1;_<=x;++_)A.data[_-1]<0&&(A.data[_-1]=0);if(R=st.axpby(2,A,-1,C,R),h&&(w=st.xpy(d,st.elementwiseProduct(st.xmy(st.xy(o,R,V),t,V),k,V),w)),f){g=st.xpy(b,st.elementwiseProduct(st.xmy(st.xy(e,R,z),r,z),N,z),g);for(_=1;_<=p;++_)g.data[_-1]<0&&(g.data[_-1]=0)}var F=(E=st.xmy(A,C,E)).vectorNorm("infinity"),O=A.vectorNorm("infinity"),T=0,U=0;h&&(T=(v=st.xmy(w,d,v)).vectorNorm("infinity"),U=w.vectorNorm("infinity"));var L=0,B=0;if(f&&(L=(y=st.xmy(g,b,y)).vectorNorm("infinity"),B=g.vectorNorm("infinity")),F<=u*O&&T<=u*U&&L<=u*B)break;C=st.copy(A,C),h&&(d=st.copy(w,d)),f&&(b=st.copy(g,b))}return[A,st.vectorDotProduct(n,A)]}(s,u,st.fill(i+(r?0:1),e+1,function(t,r){return t<=i?r<=e?-n[r-1][t-1]:1:t==i+1?r<=e?1:0:void 0}),st.fill(i+(r?0:1),1,function(t,r){return t<=i?0:t==i+1?1:void 0}),a,st.fill(e+1,1,function(t,r){return t<=e?0:-1/0}),st.fill(e+1,1,function(t,r){return t<=e?1:1/0}),{maxIter:-1})[0],h=l.toArray(function(t,r,n){return t!=e+1}),f=l.data[e];return!0===o?[h,f]:h},T.minimumCorrelationWeights=function(t,r){var n=(t=new st(t).toCovarianceMatrix()).getVariances(),o=n.elemMap(function(t,r,n){return 1/Math.sqrt(n)}),e=t.getCorrelationMatrix(),i=e.nbRows;if(i<=2)return T.inverseVolatilityWeights(n,r);for(var a=e.toArray(function(t,r,n){return t<r}),s=I(a),u=d(a),l=e.elemMap(function(t,r,n){return t==r?0:1-w((n-s)/u)}),h=l.toRowArray(function(t,r,n){return t!=r}),f=new Array(i),m=0;m<i;++m)f[m]=I(h[m]);var c=new st(function(t,r){for(var n=new Array(t.length),o=0;o<t.length;++o)n[o]=[t[o],o];0==r?n.sort(function(t,r){return t[0]>r[0]?-1:1}):1==r&&n.sort(function(t,r){return t[0]<r[0]?-1:1});var e=new Array(t.length);for(o=e[n[0][1]]=1;o<t.length;++o)n[o][0]==n[o-1][0]?e[n[o][1]]=e[n[o-1][1]]:e[n[o][1]]=o+1;return e}(f,0),1).normalize();return c=st.xy(l,c).normalize(),(c=st.vectorHadamardProduct(c,o).normalize()).toArray()},T.minimumTrackingErrorWeights=function(n,o,t){void 0===t&&(t={constraints:{}}),void 0===t.constraints&&(t.constraints={}),void 0===t.optimizationMethodParams&&(t.optimizationMethodParams={}),void 0===t.optimizationMethodParams.eps&&(t.optimizationMethodParams.eps=1e-4),void 0===t.optimizationMethodParams.maxIter&&(t.optimizationMethodParams.maxIter=1e4),void 0===t.constraints.minNbAssets&&t.constraints.maxNbAssets&&(t.constraints.minNbAssets=1),void 0===t.constraints.maxNbAssets&&t.constraints.minNbAssets&&(t.constraints.maxNbAssets=n.length);var a=t.optimizationMethodParams.eps,s=t.optimizationMethodParams.maxIter,E=!0;void 0!==t.constraints.fullInvestment&&(E=t.constraints.fullInvestment);var r,e,i,u,l,M=t.constraints.minNbAssets,P=t.constraints.maxNbAssets,h=M||P;if(h&&(void 0===(r=t.optimizationMethod)&&(r="heuristic"),"heuristic"!=r&&"exact"!=r))throw new Error("unsupported optimisation method");"heuristic"==r&&(void 0===(e=t.optimizationMethodParams.nRounds)&&(e=3),void 0===(i=t.optimizationMethodParams.nSteps)&&(i=5e3),void 0===(u=t.optimizationMethodParams.nDeltas)&&(u=i),void 0===(l=t.optimizationMethodParams.maxIterationsInitPoint)&&(l=1e4));for(var f,V=n.length,m=n[0].length,c=(o=new st(o),n=st.fill(m,V,function(t,r){return n[r-1][t-1]}),"function"==typeof Float64Array?new Float64Array(V):new Array(V)),d="function"==typeof Float64Array?new Float64Array(V):new Array(V),w=0;w<V;++w)c[w]=t.constraints.minWeights?t.constraints.minWeights[w]:0,d[w]=t.constraints.maxWeights?t.constraints.maxWeights[w]:1;function v(n,o,r,e,i){return D(function(t){var r=st.xmy(st.xy(n,t),o).vectorNorm("two");return.5*r*r},function(t){return st.txy(n,st.xmy(st.xy(n,t),o))},function(t){return 1==i?G(t.data,r,e):function(t,r,n){var o=t.length;H(o,r,n);for(var e=0,i=0;i<o;++i){var a=0;r&&(a=r[i]);var s=1;n&&(s=n[i]);var u=t[i];if(u<a||s<u)return Number.POSITIVE_INFINITY;e+=u}return 1e-12<e-1?Number.POSITIVE_INFINITY:0}(t.data,r,e)},function(t){return new st(1==i?J(t.data,r,e):K(t.data,r,e))},new st(1==i?J(st.ones(n.nbColumns,1).data,r,e):K(st.ones(n.nbColumns,1).data,r,e)),{eps:a,maxIter:s,maxLine:s})}if(h)if("heuristic"==r){var p;try{var b=1;E||(b=Math.random()),p=T.randomWeights(V,{maxIter:l,constraints:{minExposure:b,maxExposure:1,minNbAssets:M,maxNbAssets:P,minWeights:c,maxWeights:d}})}catch(t){throw"maximum number of iterations reached"===t.message?new Error("infeasible problem detected"):t}f=new st(f=q(function(t){t=new st(t);var r=st.xmy(st.xy(n,t),o).vectorNorm("two");return.5*r*r},p,{nSteps:i,nRounds:e,nDeltas:u,neighbourGenerator:function(t,r){for(var n=r.lowerBounds,o=r.upperBounds,e=t,i=0,a=1,s=0;s<V;++s)if(0<e[s]&&0==n[s]||e[s]>=n[s]&&0<n[s]){if(++i,a-=e[s],e[s]<n[s])throw new Error("internal error: asset present in the portfolio, but strictly below its lower bound");if(e[s]>o[s])throw new Error("internal error: asset present in the portfolio, but strictly above its upper bound")}if(a=Math.max(0,a),P<i)throw new Error("internal error: number of assets strictly greater than the allowed maximum number of assets");if(i<M)throw new Error("internal error: number of assets strictly lower than the allowed minimum number of assets");var u=[];for(s=0;s<V;++s)if(0<e[s]&&0==n[s]||e[s]>=n[s]&&0<n[s]){var l=e[s]-n[s],h=Math.min(0,l),f=e[s];E||(u.push([s,-1,h,l]),M<i&&u.push([s,-1,f]));for(var m=0;m<V;++m){if((e[m]<n[m]||0==e[m])&&e[m]<o[m]){var c=n[m],d=Math.max(c,o[m]-e[m]);if(i<P&&h<=c&&c<=l){var w=c,v=Math.min(d,l);u.push([s,m,w,v])}c<=f&&f<=d&&u.push([s,m,f])}if((0<e[m]&&0==n[m]||e[m]>=n[m]&&0<n[m])&&e[m]<o[m]){d=o[m]-e[m],c=Math.min(0,d);if(M<i&&c<=f&&f<=d&&u.push([s,m,f]),h<=c&&c<=l){w=c,v=Math.min(d,l);u.push([s,m,w,v])}}}}if(!E)for(s=0;s<V;++s){if(0<e[s]&&0==n[s]||e[s]>=n[s]&&0<n[s]){d=o[s]-e[s];if((c=Math.min(0,d))<=a){w=c,v=Math.min(d,a);u.push([-1,s,w,v])}}if((e[s]<n[s]||0==e[s])&&e[s]<o[s]&&i<P){c=n[s],d=Math.max(c,o[s]-e[s]);if(c<=a){w=c,v=Math.min(d,a);u.push([-1,s,w,v])}}}if(0==u.length)throw new Error("internal error: no feasible switch");var p,b,g,y,x,C=u[(p=0,b=u.length,Math.floor(Math.random()*(b-p))+p)],A=C[0],R=C[1];if(3==C.length)g=C[2],-1!=A&&(e[A]=0),-1!=R&&(e[R]+=g);else{if(4!=C.length)throw new Error("internal error: unexpected lenght of the switches structure");y=C[2],x=C[3],g=Math.random()*(x-y)+y,-1!=A&&(e[A]-=g),-1!=R&&(e[R]+=g)}return e},neighbourGeneratorParameters:{lowerBounds:c,upperBounds:d}})[0])}else{if("exact"!=r)throw new Error("internal error: unsupported optimisation method");for(var g=1/0,y=[],x=[],C=M;C<=P;++C)for(var A=new L(V,C,!1),R=A.next();-1!=R;){var z=R.length,I="function"==typeof UInt32Array?new UInt32Array(z):new Array(z);for(w=0;w<R.length;++w)I[w]=R[w];var k,N=st.fill(m,z,function(t,r){return n.getValueAt(t,I[r-1])}),S="function"==typeof Float64Array?new Float64Array(z):new Array(z),_="function"==typeof Float64Array?new Float64Array(z):new Array(z);for(w=0;w<z;++w)S[w]=c[I[w]-1],_[w]=d[I[w]-1];var F=1/0;try{var O=v(N,o,S,_,E);k=O[0],F=O[1]}catch(t){if("infeasible problem detected: the restricted simplex is empty"!==t.message)throw t}F<g&&(g=F,y=I,x=k);R=A.next()}if(g==1/0)throw new Error("infeasible problem detected");f=st.zeros(V,1);for(w=0;w<y.length;++w)f.data[y[w]-1]=x.data[w]}else f=v(n,o,c,d,E)[0];return f.toArray()},T.mostDiversifiedWeights=function(t,r){void 0===r&&(r={}),void 0===r.constraints&&(r.constraints={});var n=r.epsVolatility;void 0===n&&(n=1e-4);var o=new Q(new st(t).toCovarianceMatrix().getStandardDeviations(),t,{optimizationMethodParams:{epsGsmo:r.eps,maxIterGsmo:r.maxIter},constraints:{fullInvestment:r.constraints.fullInvestment,minWeights:r.constraints.minWeights,maxWeights:r.constraints.maxWeights}});o.restrict("minVolatility",n);return o.computeMaximumSharpeRatioEfficientPortfolio(0)[0].toArray()},T.numericalOptimizationWeights=function(t,r,n){void 0===n&&(n={}),void 0===n.constraints&&(n.constraints={}),void 0===n.optimizationMethodParams&&(n.optimizationMethodParams={});var o=n.optimizationMethod;if(void 0===o&&(o="grid-search"),"grid-search"===o&&void 0===n.optimizationMethodParams.k&&(n.optimizationMethodParams.k=t),"grid-search"===o)return function(t,r,n,o,e){var i=null,a=null;if(o&&(i=o,!e)){a="function"==typeof Float64Array?new Float64Array(r):new Array(r);for(var s=0;s<r;++s)a[s]=1}if(e&&(a=e,!o)){i="function"==typeof Float64Array?new Float64Array(r):new Array(r);for(s=0;s<r;++s)i[s]=0}if(i||a)Y(r,i,a);for(var u=Number.POSITIVE_INFINITY,l=[],h=new S(r,n,!0),f=h.sample();-1!==f;){var m=!0;if(i)for(s=0;s<r;++s)if(i[s]>f[s]){m=!1;break}if(a)for(s=0;s<r;++s)if(f[s]>a[s]){m=!1;break}if(m){var c=t(f);c<u?(u=c,l=[f.slice(0)]):c==u&&l.push(f.slice(0)),f=h.sample()}else f=h.sample()}return l}(r,t,n.optimizationMethodParams.k,n.constraints.minWeights,n.constraints.maxWeights);throw new Error("unsupported optimisation method")},T.postOptimizationWeights=function(w,t){void 0===t&&(t={roundingMethodParams:{},roundingOptimizationMethodParams:{}}),void 0===t.roundingOptimizationMethodParams&&(t.roundingOptimizationMethodParams={}),void 0===t.roundingMethodParams&&(t.roundingMethodParams={}),void 0===t.roundingMethod&&(t.roundingMethod="rationalizing"),"rationalizing"==t.roundingMethod&&null==t.roundingMethodParams.k&&(t.roundingMethodParams.k=20);var r,n=t.roundingMethod;if("rationalizing"!=n&&"roundlotting"!=n)throw new Error("unsupported rounding method");"rationalizing"==n&&(r=t.roundingMethodParams.k);var o,e,i,a=t.roundingMethodParams.portfolioValue,v=t.roundingMethodParams.assetsPrices,p=t.roundingMethodParams.sizeLots;if("roundlotting"==n){if(null==a||0==a)throw new Error("missing portfolio value");if(null==v)throw new Error("missing assets prices");if(void 0===p){p="function"==typeof Float64Array?new Float64Array(w.length):new Array(w.length);for(var s=0;s<p.length;++s)p[s]=1}}if("roundlotting"==n&&(void 0===(o=t.roundingOptimizationMethodParams.nRounds)&&(o=3),void 0===(e=t.roundingOptimizationMethodParams.nSteps)&&(e=5e3),void 0===(i=t.roundingOptimizationMethodParams.nDeltas)&&(i=e)),"rationalizing"==n)return x=function(t,r){for(var n=r,o=new Array(t.length),e=0;e<t.length;++e){var i=r*t[e],a=Math.floor(i),s=i-a;n-=a,o[e]=[a,s,e]}o.sort(function(t,r){return r[1]<t[1]?-1:r[1]>t[1]?1:r[0]-t[0]});var u=new Array(t.length);for(e=0;e<n;++e){u[o[e][2]]=(o[e][0]+1)/r}for(e=n;e<o.length;++e){u[o[e][2]]=o[e][0]/r}return u}(w,r);if("roundlotting"!=n)throw new Error("internal error: unsupported rounding method");var b=w.length;w=new st.fill(b+1,1,function(t,r){return t<=b?w[t-1]:0});function u(n){var t=new st.fill(b+1,1,function(t,r){return t<=b?n[t-1]*p[t-1]*v[t-1]/a:n[b]/a});return st.xmy(w,t).vectorNorm("two")}var l="function"==typeof Float64Array?new Float64Array(b+1):new Array(b+1),h=0;for(s=0;s<b;++s){var f=v[s]*p[s];l[s]=Math.floor(w.getValue(s+1,1)*a/f),h+=l[s]*f}if((g=a-h)<0)throw new Error("internal error: negative cash during intitial feasible point generation");for(l[b]=g;;){var m=-1,c=u(l);for(s=0;s<b;++s){if((f=v[s]*p[s])<g){l[s]+=1,l[b]=g-f;var d=u(l);d<=c&&(m=s,c=d),l[s]-=1,l[b]=g}}if(-1==m)break;l[m]+=1,g-=v[m]*p[m]}if(g<0)throw new Error("internal error: negative cash during intitial feasible point generation");l[b]=g;var g,y=q(u,l,{nSteps:e,nRounds:o,nDeltas:i,neighbourGenerator:function(t,r){function n(t,r){return Math.floor(Math.random()*(r-t))+t}for(var o=0,e=0;e<b;++e)0<t[e]&&++o;for(var i="function"==typeof UInt32Array?new UInt32Array(o):new Array(o),a=e=0;e<b;++e)0<t[e]&&(i[a]=e,++a);if(0!=i.length){var s=i[n(0,o)],u=n(1,t[s]+1);t[s]-=u;var l=v[s]*p[s]*u;t[b]+=l}var h=1;for(e=0;e<b;++e)1e-12<w.getValue(e+1,1)&&++h;var f="function"==typeof UInt32Array?new UInt32Array(h):new Array(h);for(a=e=0;e<b;++e)1e-12<w.getValue(e+1,1)&&(f[a]=e,++a);f[h-1]=b;var m=f[n(0,h)];if(m!=b){var c=n(0,Math.floor(t[b]/(v[m]*p[m]))+1);t[m]+=c;var d=v[m]*p[m]*c;t[b]-=d}return t}})[0],x=new st.fill(b,1,function(t,r){return y[t-1]*p[t-1]*v[t-1]/a}).toArray();return[new st.fill(b,1,function(t,r){return y[t-1]}).toArray(),x,g=y[b]]},T.proportionalMinimumVarianceWeights=function(t,r){for(var n=(t=new st(t)).nbRows,o=t.toRowArray(),e=new Array(n),i=0;i<n;++i)e[i]=I(o[i]);var a=I(e),s=d(e),u=new st(e,1).elemMap(function(t,r,n){return 1-w((n-a)/s)});u=u.normalize(u);var l=t.diagonal().elemMap(function(t,r,n){return 1/n}).normalize();return(u=st.vectorHadamardProduct(u,l).normalize()).toArray()},T.randomSubspaceOptimizationWeights=function(t,r,n){if(void 0===n&&(n={}),void 0===n.constraints&&(n.constraints={}),void 0===n.subsetOptimizationFctOpt&&(n.subsetOptimizationFctOpt={}),void 0===n.subsetOptimizationFctOpt.constraints&&(n.subsetOptimizationFctOpt.constraints={}),t<=1)return[1];var o=n.sizeSubsets;if(void 0===o&&(o=Math.max(2,Math.floor(Math.sqrt(t)))),o<=1||t+1<=o)throw new Error("the size of the subsets of assets must be between 2 and "+t.toString());var e=n.subsetsGenerationMethod;void 0===e&&(e="random");var i,a=n.nbRandomSubsets;if(void 0===a&&(a=128),o===t&&(a=1),"random"===e)i=a;else{if("deterministic"!==e)throw new Error("unsupported subsets of assets generation method");i=function(t,r){if(t<0)throw new Error("n must be a positive integer");if(r<0)throw new Error("k must be a positive integer");if(t<r)throw new Error("k must be less than or equal to n");for(var n=1,o=1;o<=r;++o)n*=t+1-o,n/=o;return n}(t,o)}var s=n.subsetsAggregationMethod;if(void 0===s&&(s="average"),"average"!==s&&"median"!==s)throw new Error("unsupported aggregation method");var u,l=n.maxInfeasibleSubsetsRatio;if(void 0===l&&(l=0),"random"===e)u=new x(t,o,!1);else{if("deterministic"!==e)throw new Error("unsupported subsets generation method");u=new L(t,o,!1)}var h=n.subsetOptimizationFctOpt,f=0,m=new Array(i);n.constraints.minWeights&&(h.constraints.minWeights="function"==typeof Float64Array?new Float64Array(o):new Array(o)),n.constraints.maxWeights&&(h.constraints.maxWeights="function"==typeof Float64Array?new Float64Array(o):new Array(o));for(var c=0;c<i;++c){var d=u.next();if(n.constraints.minWeights)for(var w=0;w<o;++w)h.constraints.minWeights[w]=n.constraints.minWeights[d[w]-1];if(n.constraints.maxWeights)for(w=0;w<o;++w)h.constraints.maxWeights[w]=n.constraints.maxWeights[d[w]-1];try{var v=r(d,h);if(v.length!=o)throw new Error("internal error: the portfolio optimization method did not return the expected number of weights")}catch(t){if("infeasible portfolio optimization problem"===t.message)continue;throw t}var p=st.zeros(t,1);for(w=0;w<o;++w)p.setValueAt(d[w],1,v[w]);m[f++]=p}if(0===(m.length=f))throw new Error("no feasible portfolio generated");var b=i-f;if(1<=b&&l<=b/i)throw new Error("too many infeasible portfolios generated");p=null;if("average"==s)p=g(m);else{if("median"!=s)throw new Error("internal error");p=function(i){function t(t){for(var r=0,n=0;n<a;++n){r+=A(st.xmy(t,i[n],u).vectorNorm("two"),l)}return r}function r(t){for(var r=st.zeros(s,1),n=0;n<a;++n){var o=st.xmy(t,i[n],u),e=o.vectorNorm("two");r=st.axpby(1,r,1/A(e,l),o,r)}return r}function n(t){return 0}function o(t,r){return t}var a=i.length,s=i[0].nbRows,u=st.zeros(s,1),e=g(i),l=1/a,h=D(t,r,n,o,e,{eps:1e-4,maxIter:-1,maxLine:-1});return l=.1/a,h=D(t,r,n,o,h[0],{eps:1e-4,maxIter:-1,maxLine:-1}),l=.01/a,(h=D(t,r,n,o,h[0],{eps:1e-4,maxIter:-1,maxLine:-1}))[0]}(m)}return p.toArray()},T.randomSubspaceMeanVarianceOptimizationWeights=function(e,i,t){void 0===t&&(t={}),void 0===t.constraints&&(t.constraints={}),void 0===t.subsetsOpt&&(t.subsetsOpt={}),void 0===t.subsetsOpt.constraints&&(t.subsetsOpt.constraints={});e=new st(e);var r=(i=new st(i)).nbColumns;if(void 0===t.sizeSubsets){var n=-2*Math.sqrt(r*(r+3)/2),o=2.25-1*n,a=n/-(1.5+Math.sqrt(o));t.sizeSubsets=Math.max(2,Math.floor(a))}return t.subsetOptimizationFctOpt=t.subsetsOpt,T.randomSubspaceOptimizationWeights(r,function(t,r){var n=e.submatrix(t,[1]),o=i.submatrix(t,t);try{return T.meanVarianceOptimizationWeights(n,o,r)}catch(t){throw t.message.includes("no matching efficient portfolio")||"infeasible problem detected: the restricted simplex is empty"===t.message?new Error("infeasible portfolio optimization problem"):t}},t)},T.randomSubspaceGlobalMinimumVarianceOptimizationWeights=function(e,t){void 0===t&&(t={}),void 0===t.constraints&&(t.constraints={}),void 0===t.subsetsOpt&&(t.subsetsOpt={}),void 0===t.subsetsOpt.optimizationMethodParams&&(t.subsetsOpt.optimizationMethodParams={}),void 0===t.subsetsOpt.constraints&&(t.subsetsOpt.constraints={});var i=t.mu;null!=i&&(i=new st(i));var r=(e=new st(e)).nbColumns;if(void 0===t.sizeSubsets){var n=null==i?1:3,o=null==i?-2*Math.sqrt(r*(r+1)/2):-2*Math.sqrt(r*(r+3)/2),a=n/2,s=a*a-1*o,u=o/-(a+Math.sqrt(s));t.sizeSubsets=Math.max(2,Math.floor(u))}return t.subsetOptimizationFctOpt=t.subsetsOpt,T.randomSubspaceOptimizationWeights(r,function(t,r){var n,o=e.submatrix(t,t);null!=i&&(n=i.submatrix(t,[1]),r.mu=n);try{return T.globalMinimumVarianceWeights(o,r)}catch(t){throw"infeasible problem detected: the restricted simplex is empty"===t.message?new Error("infeasible portfolio optimization problem"):t}},t)},T.randomWeights=function(t,r){void 0===r&&(r={}),void 0===r.constraints&&(r.constraints={});var n=r.constraints.minNbAssets||r.constraints.maxNbAssets,o=r.constraints.minNbAssets;void 0===o&&(o=1);var e=r.constraints.maxNbAssets;void 0===e&&(e=t);var i=r.constraints.minExposure;void 0===i&&(i=1);var a=r.constraints.maxExposure;void 0===a&&(a=1);var s=r.maxIter;void 0===s&&(s=1e4);for(var u=-1;;){if(++u,-1!==s&&s<u)throw new Error("maximum number of iterations reached");var l=Math.floor(Math.random()*(e-o+1))+o,h=new x(t,l,!1).next(),f=Math.random()*(a-i)+i,m=0;if(1!==f){m=1;for(var c="function"==typeof Float64Array?new Float64Array(l+m):new Array(l+m),d="function"==typeof Float64Array?new Float64Array(l+m):new Array(l+m),w=0;w<l;++w)c[w]=0,d[w]=1;var v=1-f;c[l]=v,d[l]=v}if(r.constraints.minWeights){if(1===f)c="function"==typeof Float64Array?new Float64Array(l):new Array(l);for(w=0;w<l;++w)c[w]=r.constraints.minWeights[h[w]-1]}if(r.constraints.maxWeights){if(1===f)d="function"==typeof Float64Array?new Float64Array(l):new Array(l);for(w=0;w<l;++w)d[w]=r.constraints.maxWeights[h[w]-1]}try{Y(l+m,c,d)}catch(t){continue}var p=new _(l+m,c,d).sample();try{if(n)for(w=0;w<l;++w)if(0==p[w])throw new Error("generated weights not compatible with cardinality constraints")}catch(t){continue}break}var b=st.zeros(t,1);for(w=0;w<l;++w){var g=h[w],y=p[w];b.setValueAt(g,1,y)}return b.toArray()},T.riskBudgetingWeights=function(V,z,I){function k(t,r){var n=st.vectorDotProduct(r,t);if(Math.abs(n)<=o)n=0;else if(n<0&&n<-o)throw new Error("negative volatility during iteration "+iter+", covariance matrix might not be semi-definite positive");return Math.sqrt(n)}function r(t,r,n){for(var o=st.fill(O,1,function(t,r){return 1/O}),e=o.elemMap(function(t,r,n){return Math.log(n)}),i=(st.copy(o),st.xy(V,o)),a=k(o,i),s=st.vectorDotProduct(z,e),u=.5*a-s,l=new N(O),h=0;-1==F||h!=F;){if(-1==F&&_<=h)throw new Error("maximum number of cycles reached: "+_);var f;for(++h,l.generateCoordinates();;){var m=l.sampleCoordinate();if(-1==m)break;"acf"===I.coordinatesSampler&&(f=.5*a-s);var c=o.data[m-1],d=e.data[m-1],w=V.data[(m-1)*V.nbColumns+(m-1)],v=i.data[m-1]-o.data[m-1]*w,p=-t*z.data[m-1]*a,b=v/2,g=0<=b?1:-1,y=b*b-w*p;if(y<0)throw new Error("internal error: negative discriminant detected, the covariance matrix might not be semi-definite positive");var x,C=-(b+g*Math.sqrt(y)),A=C/w,R=p/C;if(0<A)x=A;else{if(!(0<R))throw new Error("internal error: no strictly positive root detected, the covariance matrix might not be semi-definite positive");x=R}r&&x<r[m-1]&&(x=r[m-1]),n&&x>n[m-1]&&(x=n[m-1]),o.data[m-1]=x,e.data[m-1]=Math.log(x),s-=d*z.data[m-1],s+=e.data[m-1]*z.data[m-1];for(var E=1;E<=O;++E)i.data[E-1]+=V.data[(E-1)*V.nbColumns+(m-1)]*x,i.data[E-1]-=V.data[(E-1)*V.nbColumns+(m-1)]*c;if(a=k(o,i),"acf"===I.coordinatesSampler){var M=f-(.5*a-s);1==h?l.updateAverageGain(M):l.updateSchedulingPreference(m,M)}}var P=.5*a-s;if(-1==F&&Math.abs(P-u)<=S)break;u=P}return o}void 0===I&&(I={}),void 0===I.constraints&&(I.constraints={}),void 0===I.eps&&(I.eps=1e-10),void 0===I.epsSdp&&(I.epsSdp=1e-12),void 0===I.maxCycles&&(I.maxCycles=1e4),void 0===I.nbCycles&&(I.nbCycles=-1),void 0===I.outputPortfolioVolatility&&(I.outputPortfolioVolatility=!1),void 0===I.coordinatesSampler&&(I.coordinatesSampler="cyclic");var N,S=I.eps,o=I.epsSdp,_=I.maxCycles,F=I.nbCycles,t=I.outputPortfolioVolatility;if("cyclic"===I.coordinatesSampler)N=function(t){this.n=t,this.k=t,this.sampleCoordinate=function(){return this.k==this.n?-1:++this.k},this.generateCoordinates=function(){this.k=0}};else if("shuffledCyclic"===I.coordinatesSampler)N=function(t){this.n=t,this.k=t,this.r="function"==typeof Uint32Array?new Uint32Array(t):new Array(t);for(var r=0;r<t;++r)this.r[r]=r+1;this.sampleCoordinate=function(){return this.k==this.n?-1:this.r[this.k++]},this.generateCoordinates=function(){this.r=new l(void 0,this.r,!0).next(),this.k=0}};else if("randomized"===I.coordinatesSampler)N=function(t){this.n=t,this.k=t;for(var r="function"==typeof Float64Array?new Float64Array(t):new Array(t),n=0;n<t;++n)r[n]=1/t;this.s=new U(r),this.sampleCoordinate=function(){return this.k==this.n?-1:(++this.k,this.s.sample()+1)},this.generateCoordinates=function(){this.k=0}};else{if("acf"!==I.coordinatesSampler)throw new Error("unsupported coordinates sampler");N=function(t){this.n=t,this.k=0,this.change_rate=.2,this.p_min=.05,this.p_max=20,this.idx_set_tmp="function"==typeof Uint32Array?new Uint32Array(2*t):new Array(2*t),this.idx_set=null,this.idx_set_len=0,this.pref="function"==typeof Float64Array?new Float64Array(t):new Array(t);for(var r=0;r<t;++r)this.pref[r]=1;for(this.prefsum=t,this.acc="function"==typeof Float64Array?new Float64Array(t):new Array(t),r=0;r<t;++r)this.acc[r]=.5;this.gain_learning_rate=1/t,this.average_gain=0,this.sampleCoordinate=function(){return this.k==this.idx_set_len?-1:this.idx_set[this.k++]},this.generateCoordinates=function(){this.k=0,this.idx_set_len=0;for(var t=this.n/this.prefsum,r=0;r<this.n;++r){for(var n=this.acc[r]+t*this.pref[r],o=Math.floor(n),e=0;e<o;++e)this.idx_set_tmp[this.idx_set_len]=r+1,this.idx_set_len++;this.acc[r]=n-o}this.idx_set=new l(void 0,this.idx_set_tmp.slice(0,this.idx_set_len),!0).next()},this.updateSchedulingPreference=function(t,r){var n=this.pref[t-1]*Math.exp(this.change_rate*(r/this.average_gain-1));n<this.p_min?n=this.p_min:n>this.p_max&&(n=this.p_max),this.prefsum=this.prefsum+n-this.pref[t-1],this.pref[t-1]=n,this.average_gain=(1-this.gain_learning_rate)*this.average_gain+this.gain_learning_rate*r},this.updateAverageGain=function(t){this.average_gain+=t/this.n}}}var n=null,e=null;if(I.constraints.minWeights&&(n=I.constraints.minWeights,!I.constraints.maxWeights)){e="function"==typeof Float64Array?new Float64Array(I.constraints.minWeights.length):new Array(I.constraints.minWeights.length);for(var i=0;i<e.length;++i)e[i]=1}if(I.constraints.maxWeights&&(e=I.constraints.maxWeights,!I.constraints.minWeights)){n="function"==typeof Float64Array?new Float64Array(I.constraints.maxWeights.length):new Array(I.constraints.maxWeights.length);for(i=0;i<n.length;++i)n[i]=0}V=new st(V),z=new st(z);var a,O=V.nbRows,s=r(1);if(s=s.normalize(),n||e){Y(O,n,e);var u=k(s,st.xy(V,s));a=r(M(function(t){return r(t,n,e).sum()-1},.5*u,2*u),n,e)}else a=s;return!0===t?[a.toArray(),k(a,st.xy(V,a))]:a.toArray()},T}(PortfolioAllocation||{}),"undefined"!=typeof module&&(module.exports=PortfolioAllocation);