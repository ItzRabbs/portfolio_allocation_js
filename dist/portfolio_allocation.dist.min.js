/*! portfolio-allocation - v0.0.8 (2020-04-16), Roman Rubsamen <roman.rubsamen@gmail.com> */
var PortfolioAllocation=PortfolioAllocation||{};PortfolioAllocation=function(N){function z(t){var r={getCorrelationMatrix:function(t){for(var r=_(this.nbRows,this.nbColumns,t),n=0;n<r.nbRows;++n){for(var o=Math.sqrt(this.data[n*this.nbColumns+n]),e=0;e<n;++e)r.data[n*r.nbColumns+e]=r.data[e*this.nbColumns+n];for(e=n;e<r.nbColumns;++e){var a=Math.sqrt(this.data[e*this.nbColumns+e]);r.data[n*r.nbColumns+e]=this.data[n*this.nbColumns+e]/(o*a)}}return r},getVariances:function(t){return this.diagonal(t)},getStandardDeviations:function(t){return this.diagonal(t).elemMap(function(t,r,n){return Math.sqrt(n)},t)},standardizedGeneralizedVariance:function(){var t=this.determinant();if(t<0)throw new Error("covariance matrix is not positive semi-definite");return Math.pow(t,1/this.nbRows)}};for(var n in r)t[n]=r[n]}function et(t){if(!(this instanceof et))return new et(t);var o=this;if(t instanceof Array&&t[0]instanceof Array)return function(t){o=_(t.length,t[0].length);for(var r=0;r<o.nbRows;++r){if(!(t[r]instanceof Array))throw new Error("unsupported input type");if(t[r].length!==o.nbColumns)throw new Error("unsupported input type");for(var n=0;n<o.nbColumns;++n)o.data[r*o.nbColumns+n]=t[r][n]}return o}(t);if(t instanceof Array||"function"==typeof Float64Array&&t instanceof Float64Array)return function(t){o=_(t.length,1);for(var r=0;r<o.nbRows;++r)o.data[r*o.nbColumns]=t[r];return o}(t);if(t instanceof et)return o=et.copy(t);throw new Error("unsupported input type")}function _(t,r,n){var o;if(void 0===n)(o=Object.create(et.prototype)).nbRows=t,o.nbColumns=r,o.data="function"==typeof Float64Array?new Float64Array(o.nbRows*o.nbColumns):new Array(o.nbRows*o.nbColumns);else{if(!(n instanceof et))throw new Error("provided output must be a matrix");if(n.nbRows!==t||n.nbColumns!==r)throw new Error("provided output matrix size does not match expected matrix size: ("+n.nbRows+","+n.nbColumns+") v.s. ("+t+","+r+")");o=n}return o}function tt(t){if(!(this instanceof tt))return new tt;this.WORD_LENGTH=32,this.WORD_LOG=5,this.words="function"==typeof Uint32Array?new Uint32Array(0):new Array(0);var n=this;(t instanceof Array||"function"==typeof Uint32Array&&t instanceof Uint32Array)&&function(t){for(var r=0;r<t.length;++r)n.set(t[r])}(t),this.iterator=function(){for(this.w_idx=-1,this.w=0;this.w_idx<n.words.length&&0==this.w;)++this.w_idx,this.w=n.words[this.w_idx];this.next=function(){if(this.w_idx==n.words.length)return 0;var t=this.w&-this.w,r=(this.w_idx<<n.WORD_LOG)+tt.populationCount(t-1|0);for(this.w^=t;this.w_idx<n.words.length&&0==this.w;)++this.w_idx,this.w=n.words[this.w_idx];return r}}}function S(t){this.prob="function"==typeof Float64Array?new Float64Array(t.length):new Array(t.length),this.alias="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length);for(var r=1/t.length,n="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length),o=0,e="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length),a=0,i=0;i<t.length;++i)t[i]>r?(e[a]=i,++a):(n[o]=i,++o);for(t=t.slice(0);0<o&&0<a;){i=n[--o];var s=e[--a];this.prob[i]=t.length*t[i],t[this.alias[i]=s]=t[s]+(t[i]-r),t[s]>r?(e[a]=s,++a):(n[o]=s,++o)}for(;0<o;)--o,this.prob[n[o]]=1;for(;0<a;)--a,this.prob[e[a]]=1;this.sample=function(){var t=Math.random()*this.prob.length,r=Math.floor(t);return t-r<=this.prob[r]?r:this.alias[r]}}function o(t,r,n){this.n=t,this.k=r,this.reuseOutputArray=n,this.firstcall=!0,this.mtc=!1,this.r="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.t=this.n,this.h=0,this.next=function(){if(!this.firstcall&&!this.mtc)return-1;if(this.firstcall){this.firstcall=!1,this.r[0]=this.n;for(var t=1;t<=this.k-1;++t)this.r[t]=0}else 1<this.t&&(this.h=0),++this.h,this.t=this.r[this.h-1],this.r[this.h-1]=0,this.r[0]=this.t-1,++this.r[this.h];return this.mtc=this.r[this.k-1]!=this.n,this.reuseOutputArray?this.r:this.r.slice(0)}}function f(t,r,n){if(void 0===r){this.r="function"==typeof Uint32Array?new Uint32Array(t):new Array(t);for(var o=0;o<t;++o)this.r[o]=o+1}else this.r=r;function e(){for(var t=Math.random();0===t;)t=Math.random();return t}this.rrlen=this.r.length,this.reuseOutputArray=n,this.next=function(){if(this.reuseOutputArray)var t=this.r;else t=this.r.slice(0);for(var r=1;r<=this.rrlen;++r){var n=r+Math.floor(e()*(this.rrlen+1-r)),o=t[n-1];t[n-1]=t[r-1],t[r-1]=o}return t}}function k(t,r,n){this.n=t,this.k=r,this.useArrayCopy=n,this.a="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.firstcall=!0,this.mtc=!1,this.m2=0,this.h=this.k,this.endval=this.n-this.k+1,this.next=function(){if(!(this.firstcall||this.mtc&&0!==this.k))return-1;this.firstcall?this.firstcall=!1:(this.m2<this.n-this.h&&(this.h=0),++this.h,this.m2=this.a[this.k-this.h]);for(var t=1;t<=this.h;++t)this.a[this.k+t-this.h-1]=this.m2+t;return this.mtc=this.a[0]!=this.endval,this.useArrayCopy?this.a.slice(0):this.a}}function x(t,r,n){function d(){for(var t=Math.random();0===t;)t=Math.random();return t}this.n=t,this.k=r,this.useArrayCopy=n,this.a="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.N,this.nn,this.idx_a,this.selected_record,this.method_a=function(){for(var t=this.N-this.nn;2<=this.nn;){for(var r=d(),n=0,o=t/this.N;r<o;)++n,--t,--this.N,o=o*t/this.N;this.selected_record+=n+1,this.a[this.idx_a++]=this.selected_record,--this.N,--this.nn}(n=Math.floor(this.N*d()))===this.N&&(n=this.N-1),this.selected_record+=n+1,this.a[this.idx_a++]=this.selected_record},this.method_d=function(){for(var t=1/this.nn,r=Math.pow(d(),t),n=1-this.nn+this.N,o=13*this.nn;1<this.nn&&o<this.N;){for(var e,a,i=1/(-1+this.nn);;){for(;e=this.N*(1-r),!((a=Math.floor(e))<n);)r=Math.pow(d(),t);var s=d(),u=Math.pow(s*this.N/n,i);if((r=u*(-e/this.N+1)*(n/(-a+n)))<=1)break;var f,h,l=1,m=-1+this.N;h=-1+this.nn>a?(f=-this.nn+this.N,-a+this.N):(f=-1-a+this.N,n);for(var c=-1+this.N;h<=c;--c)l=l*m/f,--m,--f;if(this.N/(-e+this.N)>=u*Math.pow(l,i)){r=Math.pow(d(),i);break}r=Math.pow(d(),t)}this.selected_record+=a+1,this.a[this.idx_a++]=this.selected_record,this.N=-a+(-1+this.N),--this.nn,t=i,n=-a+n,o+=-13}1<this.nn?this.method_a():((a=Math.floor(this.N*r))===this.N&&(a=this.N-1),this.selected_record+=a+1,this.a[this.idx_a++]=this.selected_record)},this.next=function(){for(var t=0;t<this.k;++t)this.a[t]=0;return this.N=this.n,this.nn=this.k,this.idx_a=0,this.selected_record=0,this.method_d(),this.useArrayCopy?this.a.slice(0):this.a}}function v(t){this.n=t,this.firstcall=!0,this.mtc=!1,this.iin="function"==typeof Uint32Array?new Uint32Array(t):new Array(t),this.ncard=0,this.next=function(){var t=[];if(!this.firstcall&&!this.mtc)return-1;if(this.firstcall){this.firstcall=!1;for(var r=0;r<=this.n-1;++r)this.iin[r]=0;this.mtc=!0}else{var n=0;if(this.ncard%2!=0)for(++n;0==this.iin[n-1];)++n;this.iin[n]=1-this.iin[n],this.ncard=this.ncard+2*this.iin[n]-1,t="function"==typeof Uint32Array?new Uint32Array(this.ncard):new Array(this.ncard);var o=0;for(r=0;r<=this.n-1;++r)1==this.iin[r]&&(t[o++]=r+1);this.mtc=this.ncard!=this.iin[this.n-1]}return t}}function y(t){for(var r=t.length,n=t[0].nbRows,o=et.zeros(n,1),e=1;e<=n;++e){for(var a=0,i=0;i<r;++i)a+=t[i].getValue(e,1);var s=a/r,u=0;for(i=0;i<r;++i)u+=t[i].getValue(e,1)-s;o.setValue(e,1,(a+u)/r)}return o}function l(t,r,n){t=new et(t),r=new et(r),n=new et(n);if(r.nbRows!=t.nbRows||n.nbRows!=t.nbRows)throw new Error("incompatible dimensions: "+t.nbRows+", "+r.nbRows+", "+n.nbRows);var o=et.xmy(n,r),e=et.xmy(t,r),a=o.vectorNorm("two");if(a<=1e-8)return r.toArray();var i=Math.max(0,Math.min(1,et.vectorDotProduct(o,e)/(a*a)));return et.axpby(1,r,i,o).toArray()}function p(t,r,n){var o=t;n||(o=t.slice(0).sort(function(t,r){return t-r}));var e=r*(t.length-1),a=Math.floor(e);return a==e?o[a]:o[a]+(o[a+1]-o[a])*(e-a)}function g(t,r,n,o){if(this.n=t,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.reuseOutputArray=o,this.l=r,!this.l){this.l="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(var e=0;e<this.n;++e)this.l[e]=0}if(this.u=n,!this.u){this.u="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(e=0;e<this.n;++e)this.u[e]=1}for(e=0;e<this.n;++e)if(this.l[e]>this.u[e])throw new Error("empty box detected: lower bound strictly greater than upper bound");this.sample=function(){for(var t=0;t<this.n;++t)this.x[t]=Math.random()*(this.u[t]-this.l[t])+this.l[t];return this.reuseOutputArray?this.x:this.x.slice(0)}}function q(t,r){r=r||function(t,r){return t-r};for(var n=t.length,o=t[0],e=0,a=1;a<n;++a)0<r(t[a],o)&&(o=t[a],e=a);return[o,e]}function D(t,r,n){n=n||function(t,r){return t-r};var o=t.length,e="function"==typeof UInt32Array?new UInt32Array(10):new Array(10),a="function"==typeof UInt32Array?new UInt32Array(10):new Array(10),i=0,s=0,u=o-1;for(r=r-1;;)if(600<u-s&&i<10){var f=u-s+1,h=r-s+1,l=f,m=Math.log(l),c=Math.floor(.5*Math.exp(2*m/3)+.5),d=l/2<=h?1:-1,w=.5*Math.sqrt(m*c*(1-c/l))*d+.5;w=-1<w&&w<1?0:1<=w?Math.floor(w):Math.ceil(w),h==f/2&&(w=0),e[i]=s,a[i]=u,i++;var v=r-h*(c/l)+w;s<v&&(s=Math.floor(v+.5)),v+c<u&&(u=Math.floor(v+c+.5))}else{if(u<=s){if(0==i)return t[r];s=e[--i],u=a[i]}var b=t[r];for(h=s,j=u,t[r]=t[s],n(t[s]=b,t[u])<0&&(t[s]=t[u],t[u]=b);h<j;){var p=t[j];for(t[j]=t[h],t[h]=p,++h,--j;n(t[h],b)<0;)++h;for(;0<n(t[j],b);)--j}if(0==n(t[s],b)){p=t[s];t[s]=t[j],t[j]=p}else{++j;p=t[j];t[j]=t[u],t[u]=p}j<=r&&(s=j+1),r<=j&&(u=j-1)}}function b(t){var r=Math.pow(2,-52),n=(2-r)*Math.pow(2,1023),o=Math.pow(2,-1022);if(t!=t)return t;if(t===-1/0)return-n;if(t===1/0)return 1/0;if(t===+n)return 1/0;var e=t*(t<0?1-r/2:1+r);e===t&&(e=0<o*r?t+o*r:t+o),e===1/0&&(e=+n);var a=t+(e-t)/2;t<a&&a<e&&(e=a);var i=(e+t)/2;return t<i&&i<e&&(e=i),0===e?-0:e}function C(t,r){var n=0,o=Math.abs(t),e=Math.abs(r);return n=e<o?(n=r/t,o*Math.sqrt(1+n*n)):0!=r?(n=t/r,e*Math.sqrt(1+n*n)):0}function F(t){for(var r,n=t.length,o=0,e=0;e<n;++e)o+=t[e];r=o/n;var a=0;for(e=0;e<n;++e)a+=t[e]-r;return(o+a)/n}function n(t){for(var r=t.length,n=F(t),o=0,e=0,a=0;a<r;++a){var i=t[a]-n;o+=i*i,e+=i}return(o-e*e/r)/r}function d(t){return Math.sqrt(function(t){var r=t.length;return n(t)*r/(r-1)}(t))}function w(t){var r=t,n=0,o=t,e=t*t,a=1;if(t<-8)return 0;if(8<t)return 1;for(;r!=n;)r=(n=r)+(o*=e/(a+=2));return.5+r*Math.exp(-.5*e-.9189385332046728)}function m(t,r){t||(t=0),r||(r=1);for(var n=Math.random();0===n;)n=Math.random();return t+r*e(n)}function e(t){if(t<=0||1<=t){if(0==t)return-1/0;if(1==t)return 1/0;throw"The probality p must be bigger than 0 and smaller than 1"}var r,n=t-.5;if(Math.abs(n)<=.425){r=n*(((((((2509.0809287301227*(o=.180625-n*n)+33430.57558358813)*o+67265.7709270087)*o+45921.95393154987)*o+13731.69376550946)*o+1971.5909503065513)*o+133.14166789178438)*o+3.3871328727963665)/(((((((5226.495278852854*o+28729.085735721943)*o+39307.89580009271)*o+21213.794301586597)*o+5394.196021424751)*o+687.1870074920579)*o+42.31333070160091)*o+1)}else{var o;if(o=n<0?t:1-t,(o=Math.sqrt(-Math.log(o)))<=5)r=(((((((.0007745450142783414*(o-=1.6)+.022723844989269184)*o+.2417807251774506)*o+1.2704582524523684)*o+3.6478483247632045)*o+5.769497221460691)*o+4.630337846156546)*o+1.4234371107496835)/(((((((1.0507500716444169e-9*o+.0005475938084995345)*o+.015198666563616457)*o+.14810397642748008)*o+.6897673349851)*o+1.6763848301838038)*o+2.053191626637759)*o+1);else r=(((((((2.0103343992922881e-7*(o-=5)+27115555687434876e-21)*o+.0012426609473880784)*o+.026532189526576124)*o+.29656057182850487)*o+1.7848265399172913)*o+5.463784911164114)*o+6.657904643501103)/(((((((20442631033899397e-31*o+1.421511758316446e-7)*o+18463183175100548e-21)*o+.0007868691311456133)*o+.014875361290850615)*o+.1369298809227358)*o+.599832206555888)*o+1);n<0&&(r=-r)}return r}function O(t,r){for(var n=t.length,o=F(t),e=F(r),a=0,i=0,s=0,u=0;u<n;++u){var f=t[u]-o,h=r[u]-e;a+=f*h,i+=f,s+=h}return(a-i*s/n)/n}function I(t,r){var n=t.length;return O(t,r)*n/(n-1)}function P(t,r,n){r.nbRows;void 0===n&&(n={});var o=n.nRounds;void 0===o&&(o=10);var e=n.nSteps;void 0===e&&(e=5e3);var a=n.nDeltas;void 0===a&&(a=e);var l=n.neighbourGenerator,i=n.neighbourGeneratorParameters;void 0===l&&(l=function(t,r){for(var n=r.alpha,o=r.lowerBounds,e=r.upperBounds,a=t.length,i=t.slice(),s=t.slice(),u=0;u<a;++u)i[u]=t[u]-n/2,s[u]=t[u]+n/2,o&&(i[u]=Math.max(i[u],o[u])),e&&(s[u]=Math.min(s[u],e[u]));return new g(a,i,s).sample()},void 0!==i&&void 0!==i.alpha||(i={alpha:.001}));for(var s,u=function(t,r,n,o,e){for(var a=t(r),i="function"==typeof Float64Array?new Float64Array(o):new Array(o),s=0;s<o;++s){var u=l(r,n),f=t(u);i[s]=Math.abs(a-f),r=u,a=f}i.sort(function(t,r){return t-r});var h="function"==typeof Float64Array?new Float64Array(e):new Array(e);for(s=0;s<e;++s)h[s]=p(i,(e-(s+1))/e,!0);return h[e-1]=0,h}(t,s=r.slice(),i,a,o),f=r.slice(),h=t(f),m=t(s=r.slice()),c=0;c<o;++c)for(var d=0;d<e;++d){var w=s.slice(),v=l(s,i),b=t(v);b-m<u[c]?(s=v.slice(),m=b):s=w,b<h&&(h=b,f=v.slice())}return[f,h]}function W(r,t,n,e,o,a){function i(t){return r(t)+n(t)}function s(t,r,n){var o=et.axpby(1,r,-t,n);return[o,et.copy(e(o,t))]}void 0===a&&(a={});for(var u,f,h,l,m,c,d,w,v,b,p,y,g,x,C,A,R=a.eps||1e-4,M=a.maxIter||1e4,E=a.maxLine||100,V=a.beta||.5,z=a.alphaMin||1e-10,_=a.alphaMax||1e10,F=a.restartPeriod||1e3,O=o.nbRows,I=1e-12,N=.5,k=z,P=et.zeros(O,1),W=et.zeros(O,1),S=et.zeros(O,1),U=et.zeros(O,1),q=et.zeros(O,1),D=!0,B=0;;){if(-1!==M&&M<B)throw new Error("maximum number of iterations reached: "+M);++B%F==0&&(o=m,D=!0),!0===D&&(u=0,h=f=1,l=null,m=et.copy(o),c=et.copy(m),et.copy(c),d=et.zeros(O,1),P=et.copy(t(m),P),W=et.copy(P,W),S=et.copy(W,S),w=et.zeros(O,1),U=et.copy(m,U),q=et.copy(P,q),D=!1);for(var L=k,T=s(L,U,q),G=T[0],j=T[1],H=0;i(j)>(v=L,b=j,y=q,x=void 0,g=r(p=U),x=et.xmy(b,p),C=x.vectorNorm("two"),A=n(b),g+et.vectorDotProduct(x,y)+1/(2*v)*C*C+A+I);){if(-1!==E&&E<H)throw new Error("maximum number of line searches reached: "+E+" at iteration: "+B);++H,L*=V,h/=V,f=(1+Math.sqrt(1+4*h*u*u))/2,G=(T=s(L,U=et.axpby(1,c,(u-1)/f,d,U),q=et.axpby(1,W,(u-1)/f,w,q)))[0],j=T[1]}P=et.copy(t(m=j),P);var Y=et.xmy(m,c),K=et.xmy(P,W),X=et.vectorDotProduct(Y,Y),J=Math.max(et.vectorDotProduct(K,K),I),Q=et.vectorDotProduct(Y,K);if(Q<=I)mu_kp_0=_;else{var Z=Math.max(z,Math.min(X/Q,_)),$=Math.max(z,Math.min(Q/J,_));$/Z<=N?(mu_kp_0=$,N*=.9):(mu_kp_0=Z,N*=1.1)}l=L/mu_kp_0;var tt=(1+Math.sqrt(1+4*l*f*f))/2,rt=et.axpby(1,m,(f-1)/tt,Y),nt=et.axpby(1,P,(f-1)/tt,K),ot=et.axpby(1/L,G,-1/L,m);if(et.xpy(P,ot).vectorNorm("infinity")<=R)break;I<=et.vectorDotProduct(et.xmy(U,m),Y)&&(o=m,D=!0),k=mu_kp_0,c,c=m,d=Y,S=et.copy(W,S),W=et.copy(P,W),w=K,U=et.copy(rt,U),q=et.copy(nt,q),h=l,u=f,f=tt}return[m,i(m)]}function U(i,s,u,t,f,h,r){function n(t,r){return t instanceof Array?(t.length=r,t):t instanceof Float64Array||t instanceof Int32Array?t.subarray(0,r):void 0}function o(t){for(var r=b-t*p+y,n=new v.iterator,o=n.next();0!=o;){var e,a=o-1;t<=w[a]?e=h.data[a]:w[a]<=t&&t<=d[a]?e=(s.data[a]-t*u.data[a])/i.data[a]:d[a]<=t&&(e=f.data[a]),r+=u.data[a]*e,o=n.next()}return r}void 0===r&&(r={});var e=r.eps||1e-16,a=r.outputLagrangeMultiplier;if(!(i instanceof et&&i.isVector()))throw new Error("first input must be a vector");if(!(s instanceof et&&s.isVector()))throw new Error("second input must be a vector");if(!(u instanceof et&&u.isVector()))throw new Error("third input must be a vector");if(!(f instanceof et&&f.isVector()))throw new Error("fifth input must be a vector");if(!(h instanceof et&&h.isVector()))throw new Error("sixth input must be a vector");if(i.nbRows!==s.nbRows)throw new Error("first and second inputs number of rows do not match: "+i.nbRows+"-"+s.nbRows);if(i.nbRows!==u.nbRows)throw new Error("first and third inputs number of rows do not match: "+i.nbRows+"-"+u.nbRows);if(i.nbRows!==f.nbRows)throw new Error("first and fifth inputs number of rows do not match: "+i.nbRows+"-"+f.nbRows);if(i.nbRows!==h.nbRows)throw new Error("first and sixth inputs number of rows do not match: "+i.nbRows+"-"+h.nbRows);for(var l=u.nbRows,m=Math.abs(t),c="function"==typeof Float64Array?new Float64Array(2*l):new Array(2*l),d="function"==typeof Float64Array?new Float64Array(l):new Array(l),w="function"==typeof Float64Array?new Float64Array(l):new Array(l),v=(new tt).setRange(1,l),b=0,p=0,y=0,g=1/0,x=-1/0,C=0,A=0;C<l;++C){if(f.data[C]>h.data[C])throw new Error("infeasible problem detected");if(u.data[C]<=0)throw new Error("negative element detected in b");if(i.data[C]<=0)throw new Error("negative element detected in d");var R=(s.data[C]-f.data[C]*i.data[C])/u.data[C];d[C]=R,c[A++]=R;var M=(s.data[C]-h.data[C]*i.data[C])/u.data[C];w[C]=M,x<R&&(x=R),(c[A++]=M)<g&&(g=M)}var E=o(g),V=o(x);if(E<t||t<V)throw new Error("infeasible problem detected");var z=null;if(Math.abs(E-t)<=e*m)z=g;else if(Math.abs(E-t)<=e*m)z=x;else{for(var _=g,F=x;0!=c.length;){var O=Math.ceil(c.length/2),I=D(c,O),N=o(I);if(Math.abs(N-t)<=e*m){z=I;break}if(t<N){_=I;for(A=0,C=O;C<c.length;++C)c[A++]=c[C];c=n(c,A)}else N<t&&(F=I,c=n(c,O-1));for(var k=new v.iterator,P=k.next();0!=P;){var W=!1;if(d[C=P-1]<=_&&(y+=u.data[C]*f.data[C],W=!0),F<=w[C]&&(y+=u.data[C]*h.data[C],W=!0),w[C]<=_&&F<=d[C]){var S=u.data[C]/i.data[C];b+=s.data[C]*S,p+=u.data[C]*S,W=!0}!0===W&&v.unset(C+1),P=k.next()}}0==c.length&&(z=(b+y-t)/p)}var U=function(){for(var t=et.zeros(l,1),r=0;r<l;++r){var n;z<=w[r]?n=h.data[r]:w[r]<=z&&z<=d[r]?n=(s.data[r]-z*u.data[r])/i.data[r]:d[r]<=z&&(n=f.data[r]),t.data[r]=n}return t}(),q=.5*et.vectorDotProduct(U,et.elementwiseProduct(U,i))-et.vectorDotProduct(s,U);return!0===a?[U,q,z]:[U,q]}function A(t,r,n,o,e,i,s){void 0===s&&(s={});var u=s.eps||1e-4,f=s.maxIter||1e4;if(!(t instanceof et&&t.isSquare()))throw new Error("first input must be a square matrix");if(!(r instanceof et&&r.isVector()))throw new Error("second input must be a vector");if(!(n instanceof et&&n.isVector()))throw new Error("third input must be a vector");if(!(e instanceof et&&e.isVector()))throw new Error("fifth input must be a vector");if(!(i instanceof et&&i.isVector()))throw new Error("sixth input must be a vector");if(t.nbRows!==r.nbRows)throw new Error("first and second inputs number of rows do not match: "+t.nbRows+"-"+a.nbRows);if(t.nbRows!==n.nbRows)throw new Error("first and third inputs number of rows do not match: "+t.nbRows+"-"+n.nbRows);if(t.nbRows!==e.nbRows)throw new Error("first and fifth inputs number of rows do not match: "+t.nbRows+"-"+e.nbRows);if(t.nbRows!==i.nbRows)throw new Error("first and sixth inputs number of rows do not match: "+t.nbRows+"-"+i.nbRows);for(var h=t.nbRows,l=et.fill(h,1,function(t,r){return o/h*1/n.data[t-1]}),m=U(et.ones(h,1),l,n,o,e,i)[0],c=et.xpy(et.xy(t,m),r),d=0;;){if(-1!==f&&f<=d)throw new Error("maximum number of iterations reached: "+f);++d;for(var w=-1,v=-1/0,b=-1,p=1/0,y=0;y<h;++y)F_i=c.data[y]/n.data[y],e.data[y]<m.data[y]&&m.data[y]<i.data[y]?(F_i>v&&(v=F_i,w=y),F_i<p&&(p=F_i,b=y)):m.data[y]==e.data[y]?F_i<p&&(p=F_i,b=y):m.data[y]==i.data[y]&&F_i>v&&(v=F_i,w=y);if(v-p<=u)break;y=b;var g,x=w,C=(e.data[y]-m.data[y])*n.data[y],A=(m.data[x]-i.data[x])*n.data[x],R=A<=C?C:A,M=(i.data[y]-m.data[y])*n.data[y],E=(m.data[x]-e.data[x])*n.data[x],V=M<=E?M:E,z=p-v,_=t.data[y*t.nbColumns+y]/(n.data[y]*n.data[y])+t.data[x*t.nbColumns+x]/(n.data[x]*n.data[x])-2*t.data[y*t.nbColumns+x]/(n.data[y]*n.data[x]);0<_?V<(g=-z/_)?g=V:g<R&&(g=R):g=0<z?R:V;var F=m.data[y],O=m.data[x],I=g/n.data[y],N=-g/n.data[x];m.data[y]+=I,m.data[x]+=N,g==R&&(R==C&&(m.data[y]=e.data[y],I=m.data[y]-F),R==A&&(m.data[x]=i.data[x],N=m.data[x]-O)),g==V&&(V==M&&(m.data[y]=i.data[y],I=m.data[y]-F),V==E&&(m.data[x]=e.data[x],N=m.data[x]-O));for(var k=0;k<h;++k)c.data[k]=c.data[k]+t.data[k*t.nbColumns+y]*I+t.data[k*t.nbColumns+x]*N}return[m,.5*et.vectorDotProduct(m,et.xy(t,m))+et.vectorDotProduct(r,m)]}function B(t,r,n){var o=t.length;rt(o,r,n);for(var e=0,a=0;a<o;++a){var i=0;r&&(i=r[a]);var s=1;n&&(s=n[a]);var u=t[a];if(u<i||s<u)return Number.POSITIVE_INFINITY;e+=u}return 1e-12<Math.abs(e-1)?Number.POSITIVE_INFINITY:0}function rt(t,r,n){for(var o=0,e=0,a=0;a<t;++a){var i=0;r&&(i=r[a]);var s=1;if(n&&(s=n[a]),s<i)throw new Error("infeasible problem detected: lower bound strictly greater than upper bound");if(i<0)throw new Error("incorrect problem detected: lower bound strictly lower than 0");if(1<s)throw new Error("incorrect problem detected: upper bound strictly greater than 1");o+=i,e+=s}if(1<o||e<1)throw new Error("infeasible problem detected: the restricted simplex is empty");return[o,e]}function L(t,r,n){var o=t.length;rt(o,r,n);return U(et.ones(o,1),new et(t),et.ones(o,1),1,r?new et(r):et.zeros(o,1),n?new et(n):et.ones(o,1))[0].toArray()}function R(t,r,n){this.n=t,this.k=r,this.reuseOutputArray=n,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.compositionIterator=new o(r,t,!0),this.sample=function(){var t=this.compositionIterator.next();if(-1==t)return-1;for(var r=0;r<this.n;++r)this.x[r]=t[r]/this.k;return this.reuseOutputArray?this.x:this.x.slice(0)}}function M(f,t,r,n){if(this.n=f,this.x="function"==typeof Float64Array?new Float64Array(f):new Array(f),this.u="function"==typeof Float64Array?new Float64Array(f-1):new Array(f-1),this.randomGenerator=function(t){for(var r=0;r<this.n;++r)t[r]=Math.random()},n){if("function"!=typeof n)throw new Error("the random number generator must be a function");this.randomGenerator=n}if(t&&(this.lowerBounds=t,!r)){this.upperBounds="function"==typeof Float64Array?new Float64Array(f):new Array(f);for(var o=0;o<this.n;++o)this.upperBounds[o]=1}if(r&&(this.upperBounds=r,!t)){this.lowerBounds="function"==typeof Float64Array?new Float64Array(f):new Array(f);for(o=0;o<this.n;++o)this.lowerBounds[o]=0}if(this.lowerBounds||this.upperBounds){var e=rt(f,this.lowerBounds,this.upperBounds);if(this.sumLowerBounds=e[0],this.sumUpperBounds=e[1],1==this.sumLowerBounds||1==this.sumUpperBounds);else{var a=0,i=0;for(o=0;o<this.n;++o){var s=this.lowerBounds[o],u=this.upperBounds[o],h=Math.max(s,u+1-this.sumUpperBounds),l=Math.min(u,s+1-this.sumLowerBounds);a+=this.lowerBounds[o]=h,i+=this.upperBounds[o]=l}this.sumLowerBounds=a,this.sumUpperBounds=i,this.upperStarBounds="function"==typeof Float64Array?new Float64Array(f):new Array(f),this.runningSumUpperStarBounds="function"==typeof Float64Array?new Float64Array(f):new Array(f);var m=0;for(o=0;o<this.n;++o)this.upperStarBounds[o]=(this.upperBounds[o]-this.lowerBounds[o])/(1-this.sumLowerBounds),m+=this.upperStarBounds[o],this.runningSumUpperStarBounds[o]=m}}this.sample_no_bounds=function(){for(var t=0,r=0;r<this.n;++r){var n=1-Math.random(),o=Math.log(n);t+=this.x[r]=o}for(r=0;r<this.n;++r)this.x[r]=this.x[r]/t;return this.x.slice(0)},this.sample_binding_bounds=function(){var t=null;if(1==this.sumLowerBounds)t=this.lowerBounds;else{if(1!=this.sumUpperBounds)throw new Error("internal error");t=this.upperBounds}for(var r=0;r<this.n;++r)this.x[r]=t[r];return this.x.slice(0)},this.sample_with_bounds=function(){this.randomGenerator(this.u);for(var t=this.u,r=1,n=f;2<=n;--n){if(Math.abs(r)<=1e-14){for(var o=n;1<=o;--o)this.x[o-1]=0;break}var e=t[n-2],a=Math.max(0,1-this.runningSumUpperStarBounds[n-2]/r),i=Math.min(1,this.upperStarBounds[n-1]/r),s=r*(1-Math.pow(e*Math.pow(1-i,n-1)+(1-e)*Math.pow(1-a,n-1),1/(n-1)));r-=this.x[n-1]=s}1==n&&(this.x[0]=r);for(var u=0;u<this.n;++u)this.x[u]=(1-this.sumLowerBounds)*this.x[u]+this.lowerBounds[u];return this.x.slice(0)},this.lowerBounds||this.upperBounds?1==this.sumLowerBounds||1==this.sumUpperBounds?this.sample=this.sample_binding_bounds:this.sample=this.sample_with_bounds:this.sample=this.sample_no_bounds}function E(w,v,t,r){var b=1e-8;var n,o=r.constraint;if(null==o)throw new Error("internal error: missing constraint");if("return"==o)n=function(t,r,n,o){return et.vectorDotProduct(r,t)};else if("volatility"==o)n=function(t,r,n,o){var e=et.vectorDotProduct(et.xy(n,t),t);if(Math.abs(e)<=b)e=0;else if(e<0&&e<-b)throw new Error("negative volatility, covariance matrix might not be semi-definite positive");return Math.sqrt(e)};else{if("riskTolerance"!=o)throw new Error("internal error: unknown constraint");n=function(t,r,n,o){return o}}var e=r.constraintValue;if(null==e)throw new Error("internal error: missing constraint value");if(0===t.length)throw new Error("internal error: no corner portfolios");var a=function(t,r,n){var o=n.length-1,e=0,a=n[o][0],i=n[e][0],s=n[o][1],u=n[e][1],f=t(a,w,v,s),h=t(i,w,v,u);if(h+b<r||r<f-b)return[];if(Math.abs(r-f)<=b)return[[o,a,f]];if(Math.abs(r-h)<=b)return[[e,i,h]];for(;o-e!=1;){var l=Math.floor(e+(o-e)/2),m=n[l][0],c=n[l][1],d=t(m,w,v,c);if(r<d)e=l,h=d,i=m;else{if(!(d<r))return[[l,m,d]];o=l,f=d,a=m}}return[[o,a,f],[e,i,h]]}(n,e,t);if(0==a.length)return[];if(1==a.length){var i=a[0][0];return[a[0][1],i]}i=a[0][0];var s,u=a[0][1],f=a[0][2],h=a[1][0],l=a[1][1],m=a[1][2];if("return"===o)s=(m-e)/(m-f);else if("volatility"===o){var c=et.vectorDotProduct(et.xy(v,u),l),d=f*f+m*m-2*c,p=m*m-e*e,y=-2*(m*m-c)/2,g=0<=y?1:-1,x=y*y-d*p;if(x<0)throw new Error("internal error; the covariance matrix might not be semi-definite positive");var C=-(y+g*Math.sqrt(x)),A=C/d,R=p/C;if(0<A&&A<1)s=A;else{if(!(0<R&&R<1))throw new Error("internal error: the covariance matrix might not be semi-definite positive");s=R}}else{if("riskTolerance"!==o)throw new Error("internal error: unknown constraint");s=(m-e)/(m-f)}return[et.fill(u.nbRows,1,function(t,r){return s*u.getValue(t,1)+(1-s)*l.getValue(t,1)}),i,h]}function V(t,n,r){var m=1e-8;void 0===r&&(r={constraints:{}}),void 0===r.constraints&&(r.constraints={});var o=r.maxIter||1e3,e=r.constraints.minWeights,a=r.constraints.maxWeights,c=n.nbColumns,i=et.ones(1,c),s=i.nbRows,u=et.ones(1,1),f=e?new et(e):et.zeros(c,1),h=a?new et(a):et.ones(c,1),l=[],d=null,w=new function(t,r){this.STATUS_UNDEF=-1,this.STATUS_IN=0,this.STATUS_LOW=1,this.STATUS_UP=2,this.nbAssets=t,this.nbEqualityConstraints=r,this.varIn=new tt,this.varIn.resize(t+r),this.varOut=new tt,this.varOut.resize(t+r),this.varLow=new tt,this.varLow.resize(t+r),this.varUp=new tt,this.varUp.resize(t+r),this.setIn=function(t){this.varIn.set(t),this.varOut.unset(t),this.varLow.unset(t),this.varUp.unset(t)},this.setOnLowerBound=function(t){this.varLow.set(t),this.varOut.set(t),this.varIn.unset(t),this.varUp.unset(t)},this.setOnUpperBound=function(t){this.varUp.set(t),this.varOut.set(t),this.varIn.unset(t),this.varLow.unset(t)},this.setLambdasIn=function(){for(var t=this.nbAssets+1;t<=this.nbAssets+this.nbEqualityConstraints;++t)this.varIn.set(t),this.varOut.unset(t),this.varLow.unset(t),this.varUp.unset(t)},this.setAssetsOnLowerBounds=function(){for(var t=1;t<=this.nbAssets;++t)this.varLow.set(t),this.varOut.set(t),this.varIn.unset(t),this.varUp.unset(t)},this.isAsset=function(t){return 1<=t&&t<=this.nbAssets},this.isLambda=function(t){return t>=this.nbAssets+1&&t<=this.nbAssets+this.nbEqualityConstraints},this.isIn=function(t){return this.varIn.get(t)},this.isOnLowerBound=function(t){return this.varLow.get(t)},this.isOnUpperBound=function(t){return this.varUp.get(t)},this.isOut=function(t){return this.varOut.get(t)},this.getInIndexes=function(){return this.varIn.toArray()},this.getOutIndexes=function(){return this.varOut.toArray()}}(c,s);d=function(n,t,r){rt(c,t.toArray(),r.toArray());for(var o="function"==typeof Uint32Array?new Uint32Array(c):new Array(c),e=0;e<c;++e)o[e]=e+1;o.sort(function(t,r){return n.getValue(r,1)-n.getValue(t,1)});for(var a=1;a<c;++a)if(n.getValue(o[a],1)==n.getValue(o[a-1],1))throw new Error("unsupported problem detected");var i=new et(t);w.setAssetsOnLowerBounds();var s=1-i.sum(),u=-1;for(a=0;a<c&&!(Math.abs(s)<=m);++a){u=o[a];var f=i.getValue(u,1),h=Math.min(r.getValue(u,1)-f,s),l=f+h;l>=r.getValue(u,1)?(i.setValue(u,1,r.getValue(u,1)),w.setOnUpperBound(u)):(i.setValue(u,1,l),w.setIn(u)),s-=h}return-1==u||a==c||w.isIn(u)||(w.setIn(u),r.setValue(u,1,r.getValue(u,1)+2e-8)),i}(t,f,h);var v=et.ones(1,1);if(Math.abs(1-f.sum())<=m||Math.abs(1-h.sum())<=m)return l.push([d,0]),l;for(var b=w.getInIndexes(),p=w.getOutIndexes(),y=et.zeros(c+s,1),g=et.zeros(c+s,1),x=1;x<=p.length;++x){var C=p[x-1];g.setValue(C,1,d.getValue(C,1))}for(var A=et.zeros(c+s,1),R=et.fill(c+s,c+s,function(t,r){return t<=c&&r<=c?n.data[(t-1)*n.nbColumns+(r-1)]:c+1<=t&&r<=c?i.data[(t-c-1)*i.nbColumns+(r-1)]:t<=c&&c+1<=r?i.data[(r-c-1)*i.nbColumns+(t-1)]:0}),M=et.zeros(c+s,c+s),E=et.atxy(-1,v,et.xy(n.submatrix(b,b),v)),V=1;V<=b.length;++V)for(var z=1;z<=b.length;++z){var _=b[V-1],F=v.getValue(V,z);M.setValue(c+z,_,F),M.setValue(_,c+z,F),M.setValue(c+V,c+z,E.getValue(V,z))}w.setLambdasIn();var O=et.zeros(c+s,1);for(x=1;x<=b.length;++x){var I=b[x-1],N=0;for(V=1;V<=p.length;++V){var k=p[V-1];N-=R.getValue(I,k)*d.getValue(k,1)}O.setValue(I,1,N)}for(x=c+1;x<=c+s;++x){for(I=x,N=u.getValue(I-c,1),V=1;V<=p.length;++V){k=p[V-1];N-=R.getValue(I,k)*d.getValue(k,1)}O.setValue(I,1,N)}for(var P=0,W=0,S=-1,U=0,q=w.STATUS_UNDEF,D=-1,B=0;;){if(-1!==o&&o<=P)throw new Error("maximum number of iterations reached: "+o);if(2<=++P)if(B<=U){g.setValue(S,1,d.getValue(S,1)),A.setValue(S,1,0),q==w.STATUS_LOW?w.setOnLowerBound(S):w.setOnUpperBound(S);var L=w.getInIndexes(),T=M.getValue(S,S);T<=m&&(T=m);for(x=1;x<=L.length;++x)for(I=L[x-1],V=1;V<=L.length;++V){var G=L[V-1];M.setValue(I,G,M.getValue(I,G)-M.getValue(I,S)*M.getValue(S,G)/T)}for(x=1;x<=L.length;++x){I=L[x-1];O.setValue(I,1,O.getValue(I,1)-R.getValue(I,S)*d.getValue(S,1))}}else{for(L=w.getInIndexes(),x=1;x<=L.length;++x){I=L[x-1];var j=0;for(V=1;V<=L.length;++V){G=L[V-1];j+=M.getValue(I,G)*R.getValue(G,D)}y.setValue(I,1,j)}var H=R.getValue(D,D);for(x=1;x<=L.length;++x){I=L[x-1];H-=R.getValue(D,I)*y.getValue(I,1)}H<=m&&(H=m);for(x=1;x<=L.length;++x){for(I=L[x-1],V=1;V<=L.length;++V){G=L[V-1];M.setValue(I,G,M.getValue(I,G)+y.getValue(I,1)*y.getValue(G,1)/H)}M.setValue(I,D,-y.getValue(I,1)/H),M.setValue(D,I,-y.getValue(I,1)/H)}M.setValue(D,D,1/H);for(x=1;x<=L.length;++x){I=L[x-1];O.setValue(I,1,O.getValue(I,1)+R.getValue(I,D)*d.getValue(D,1))}w.setIn(D);for(p=w.getOutIndexes(),N=0,x=1;x<=p.length;++x){C=p[x-1];N-=R.getValue(D,C)*d.getValue(C,1)}O.setValue(D,1,N)}L=w.getInIndexes(),p=w.getOutIndexes();S=-1,U=0,q=w.STATUS_UNDEF;for(x=1;x<=L.length;++x){I=L[x-1];var Y=0,K=0;for(V=1;V<=L.length;++V){G=L[V-1];Y+=M.getValue(I,G)*O.getValue(G,1),G<=c&&(K+=M.getValue(I,G)*t.getValue(G,1))}if(g.setValue(I,1,Y),A.setValue(I,1,K),w.isAsset(I))if(m<K)U<=(X=(f.getValue(I,1)-Y)/K)&&(S=I,U=X,q=w.STATUS_LOW);else if(K<-m){var X;U<=(X=(h.getValue(I,1)-Y)/K)&&(S=I,U=X,q=w.STATUS_UP)}}D=-1,B=0;for(x=1;x<=p.length;++x){C=p[x-1];var J,Q=0,Z=-t.getValue(C,1);for(V=1;V<=c+s;++V){var $=R.getValue(C,V);Q+=$*g.getValue(V,1),Z+=$*A.getValue(V,1)}if(w.isOnLowerBound(C)){if(m<Z)B<=(J=-Q/Z)&&(D=C,B=J)}else if(Z<-m)B<=(J=-Q/Z)&&(D=C,B=J)}W=Math.max(U,B,0);for(x=1;x<=L.length;++x){I=L[x-1];w.isAsset(I)&&d.setValue(I,1,g.getValue(I,1)+W*A.getValue(I,1))}if(l.push([new et(d),W]),W<m)break}return l}return N.randomCorrelationMatrix=function(t,r){return et.randomCorrelation(t,r)},N.covarianceMatrix=function(e,t){void 0===(t=t)&&(t={}),void 0===t.method&&(t.method="covariance");var r=t.method;if("covariance"!=r&&"sample-covariance"!=r&&"ledoit-wolf-shrinked-covariance"!=r)throw new Error("unsupported covariance matrix computation method");var n=t.shrinkageTarget;if("ledoit-wolf-shrinked-covariance"==r&&-1==["constant-variance-null-correlation","constant-variance-correlation","null-correlation","constant-correlation"].indexOf(n))throw new Error("unsupported covariance matrix shrinkage target");var o,a=e.length,i=e[0].length;if("covariance"==r||"sample-covariance"==r){var s=O;"sample-covariance"==r&&(s=I),o=_(a,a);for(var u=0;u<o.nbRows;++u){for(var f=0;f<u;++f)o.data[u*o.nbColumns+f]=o.data[f*o.nbColumns+u];for(f=u;f<o.nbColumns;++f)o.data[u*o.nbColumns+f]=s(e[u],e[f])}}else{if("ledoit-wolf-shrinked-covariance"!=r)throw new Error("internal error: unsupported covariance matrix computation method");var h,l,m=et.fill(a,1,function(t,r){return F(e[t-1])}),c=et.fill(a,i,function(t,r){return e[t-1][r-1]-m.data[t-1]}),d=et.axty(1/i,c,c).toCovarianceMatrix(),w=d.getStandardDeviations(),v=d.getCorrelationMatrix();if("constant-variance-null-correlation"==n){var b=d.trace()/a;h=et.fill(a,a,function(t,r){return t==r?b:0})}else if("constant-variance-correlation"==n){var p=d.trace()/a,y=0;for(u=0;u<a-1;++u)for(f=u+1;f<a;++f)y+=d.data[u*d.nbColumns+f];y*=2/(a*(a-1)),h=et.fill(a,a,function(t,r){return t==r?p:y})}else if("null-correlation"==n)h=et.fill(a,a,function(t,r){return t==r?w.data[t-1]*w.data[t-1]:0});else if("constant-correlation"==n){for(u=l=0;u<a-1;++u)for(f=u+1;f<a;++f)l+=v.data[u*v.nbColumns+f];l*=2/(a*(a-1)),h=et.fill(a,a,function(t,r){return t==r?w.data[t-1]*w.data[t-1]:l*w.data[t-1]*w.data[r-1]})}var g,x=et.fill(a,a,function(t,r){for(var n=0,o=0;o<i;++o)n+=Math.pow((e[t-1][o]-m.data[t-1])*(e[r-1][o]-m.data[r-1])-d.data[(t-1)*d.nbColumns+(r-1)],2);return n/=i}),C=x.sum();if("constant-variance-null-correlation"==n)g=0;else if("constant-variance-correlation"==n)g=0;else if("null-correlation"==n)g=x.trace();else if("constant-correlation"==n){g=0;for(u=1;u<=a;++u)for(f=1;f<=a;++f)if(u!=f){for(var A=0,R=0;R<i;++R)A+=(Math.pow(e[u-1][R]-m.data[u-1],2)-d.data[(u-1)*d.nbColumns+(u-1)])*((e[u-1][R]-m.data[u-1])*(e[f-1][R]-m.data[f-1])-d.data[(u-1)*d.nbColumns+(f-1)]);A/=i;var M=0;for(R=0;R<i;++R)M+=(Math.pow(e[f-1][R]-m.data[f-1],2)-d.data[(f-1)*d.nbColumns+(f-1)])*((e[u-1][R]-m.data[u-1])*(e[f-1][R]-m.data[f-1])-d.data[(u-1)*d.nbColumns+(f-1)]);M/=i,g+=w.data[f-1]/w.data[u-1]*A+w.data[u-1]/w.data[f-1]*M}g*=l/2,g+=x.trace()}var E=(C-g)/Math.pow(et.xmy(d,h).matrixNorm("frobenius"),2),V=Math.max(0,Math.min(1,E/i));o=et.axpby(V,h,1-V,d)}return z(o),o},et.prototype={constructor:et,toString:function(){for(var t=0,r=0;r<this.nbRows;++r)for(var n=0;n<this.nbColumns;++n){var o=String(this.data[r*this.nbColumns+n]).length;t<o&&(t=o)}var e=[];for(r=0;r<this.nbRows;++r){e.push("[ ");for(n=0;n<this.nbColumns;++n){var a=String(this.data[r*this.nbColumns+n]);e.push(new Array(t-a.length+1).join(" ")+a+" ")}e.push("]\n")}return e.join("")},toRowArray:function(t){t=t||function(t,r,n){return!0};for(var r=new Array(this.nbRows),n=0;n<this.nbRows;++n){r[n]=new Array(this.nbColumns);for(var o=0,e=0;e<this.nbColumns;++e){var a=this.data[n*this.nbColumns+e];t(n+1,e+1,a)&&(r[n][o++]=a)}r[n].length=o}return r},toArray:function(t){t=t||function(t,r,n){return!0};for(var r=new Array(this.nbRows*this.nbColumns),n=0,o=0;o<this.nbRows;++o)for(var e=0;e<this.nbColumns;++e){var a=this.data[o*this.nbColumns+e];t(o+1,e+1,a)&&(r[n++]=a)}return r.length=n,r},setValueAt:function(t,r,n){if(t<1||r<1||t>this.nbRows||r>this.nbColumns)throw new Error("index out of bounds when setting matrix value, ("+t+","+r+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(t-1)*this.nbColumns+(r-1)]=n,this},setValue:function(t,r,n){return this.data[(t-1)*this.nbColumns+(r-1)]=n,this},getValueAt:function(t,r){if(t<1||r<1||t>this.nbRows||r>this.nbColumns)throw new Error("index out of bounds when getting matrix value, ("+t+","+r+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(t-1)*this.nbColumns+(r-1)]},getValue:function(t,r){return this.data[(t-1)*this.nbColumns+(r-1)]},isSquare:function(){return this.nbRows===this.nbColumns},isSymmetric:function(t){if(null==t&&(t=0),!this.isSquare())return!1;for(var r=0;r<this.nbRows;++r)for(var n=0;n<this.nbColumns;++n)if(Math.abs(this.data[r*this.nbColumns+n]-this.data[n*this.nbColumns+r])>t)return!1;return!0},isVector:function(){return 1===this.nbColumns},isNonNegative:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(this.data[t*this.nbColumns+r]<0)return!1;return!0},isPositive:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(this.data[t*this.nbColumns+r]<=0)return!1;return!0},isNonPositive:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(0<this.data[t*this.nbColumns+r])return!1;return!0},isNegative:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(0<=this.data[t*this.nbColumns+r])return!1;return!0},sum:function(){for(var t=0,r=0;r<this.data.length;++r)t+=this.data[r];return t},min:function(){for(var t=Number.POSITIVE_INFINITY,r=0;r<this.data.length;++r)this.data[r]<t&&(t=this.data[r]);return t},max:function(){for(var t=Number.NEGATIVE_INFINITY,r=0;r<this.data.length;++r)this.data[r]>t&&(t=this.data[r]);return t},normalize:function(t){var r=_(this.nbRows,this.nbColumns,t),n=this.sum();if(0===n)throw new Error("sum of coefficients of matrix is null");for(var o=0;o<this.data.length;++o)r.data[o]=this.data[o]/n;return r},diagonal:function(t){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var r=_(this.nbRows,1,t),n=0;n<this.nbRows;++n)r.data[n]=this.data[n*(this.nbColumns+1)];return r},row:function(t,r){if(t<1||t>this.nbRows)throw new Error("index out of bounds when getting matrix row, ("+t+") in size ("+this.nbRows+","+this.nbColumns+")");for(var n=_(this.nbColumns,1,r),o=0;o<this.nbColumns;++o)n.data[o]=this.data[(t-1)*this.nbColumns+o];return n},column:function(t,r){if(t<1||t>this.nbColumns)throw new Error("index out of bounds when getting matrix column, ("+t+") in size ("+this.nbRows+","+this.nbColumns+")");for(var n=_(this.nbRows,1,r),o=0;o<this.nbRows;++o)n.data[o]=this.data[o*this.nbColumns+(t-1)];return n},elemMap:function(t,r){for(var n=_(this.nbRows,this.nbColumns,r),o=0;o<n.nbRows;++o)for(var e=0;e<n.nbColumns;++e)n.data[o*n.nbColumns+e]=t(o+1,e+1,this.data[o*this.nbColumns+e]);return n},submatrix:function(t,r,n){if(!(t instanceof Array||t instanceof Uint32Array)||0==t.length)throw new Error("first parameter must be a non empty array");if(!(r instanceof Array||r instanceof Uint32Array)||0==r.length)throw new Error("second parameter must be a non empty array");for(var o=1;o<t.length;++o)if(t[o-1]>=t[o])throw new Error("first parameter must be a sorted array");for(var e=1;e<r.length;++e)if(r[e-1]>=t[e])throw new Error("second parameter must be a sorted array");var a=_(t.length,r.length,n);for(o=0;o<a.nbRows;++o){var i=t[o]-1;for(e=0;e<a.nbColumns;++e){var s=r[e]-1;a.data[o*a.nbColumns+e]=this.data[i*this.nbColumns+s]}}return a},transpose:function(t){for(var r=_(this.nbColumns,this.nbRows,t),n=0;n<r.nbRows;++n)for(var o=0;o<r.nbColumns;++o)r.data[n*r.nbColumns+o]=this.data[o*this.nbColumns+n];return r},determinant:function(){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var t=et.qrDecomposition(this,{qLess:!0}),r=1,n=0;n<t.data.length;n+=t.nbColumns+1)r*=t.data[n];return r},trace:function(){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var t=0,r=0;r<this.nbRows;++r)t+=this.data[r*this.nbColumns+r];return t},matrixNorm:function(t){if("one"==t){for(var r=0,n=0;n<this.nbColumns;++n){for(var o=0,e=0;e<this.nbRows;++e)o+=Math.abs(this.data[e*this.nbColumns+n]);r=Math.max(r,o)}return r}if("infinity"==t){var a=0;for(e=0;e<this.nbRows;++e){var i=0;for(n=0;n<this.nbColumns;++n)i+=Math.abs(this.data[e*this.nbColumns+n]);a=Math.max(a,i)}return a}if("frobenius"==t)return this.vectorNorm("two");throw new Error("unsupported matrix norm: "+t)},vectorNorm:function(t,r,n){var o,e,a,i;if(void 0===r||"matrix"==r)o=0,e=this.nbRows,a=0,i=this.nbColumns;else if("row"==r){if(void 0===n)throw new Error("undefined row index");if(n<1||n>this.nbRows)throw new Error("row index out of bounds: "+n);o=n-1,e=n,a=0,i=this.nbColumns}else if("column"==r){if(void 0===n)throw new Error("undefined row index");if(n<1||n>this.nbColumns)throw new Error("column index out of bounds: "+n);o=0,e=this.nbRows,a=n-1,i=n}else if(void 0!==r)throw new Error("unsupported matrix subset: "+r);if("one"==t){for(var s=0,u=o*this.nbColumns,f=o;f<e;++f){for(var h=u+a,l=a;l<i;++l)s+=Math.abs(this.data[h]),h++;u+=this.nbColumns}return s}if("two"==t){var m=0,c=1;for(u=o*this.nbColumns,f=o;f<e;++f){for(h=u+a,l=a;l<i;++l){var d=this.data[h],w=Math.abs(d);0!=w&&(m<w?(c=1+c*(m/d)*(m/d),m=w):c+=d/m*(d/m)),h++}u+=this.nbColumns}return m*Math.sqrt(c)}if("infinity"!=t)throw new Error("unsupported vector norm: "+t);var v=0;for(u=o*this.nbColumns,f=o;f<e;++f){for(h=u+a,l=a;l<i;++l)v=Math.max(v,Math.abs(this.data[h])),h++;u+=this.nbColumns}return v},toCovarianceMatrix:function(){return z(this),this}},et.areEqual=function(t,r,n){if(!(t instanceof et))throw new Error("a must be a matrix");if(!(r instanceof et))throw new Error("b must be a matrix");if(t.nbRows!==r.nbRows)return!1;if(t.nbColumns!==r.nbColumns)return!1;for(var o=t.nbRows*t.nbColumns,e=n||0,a=0;a<o;++a)if(Math.abs(t.data[a]-r.data[a])>e)return!1;return!0},et.xpy=function(t,r,n){if(!(t instanceof et))throw new Error("first input must be a matrix");if(!(r instanceof et))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbColumns||t.nbRows!==r.nbRows)throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=_(t.nbRows,t.nbColumns,n),e=t.nbRows*t.nbColumns,a=0;a<e;++a)o.data[a]=t.data[a]+r.data[a];return o},et.xmy=function(t,r,n){if(!(t instanceof et))throw new Error("first input must be a matrix");if(!(r instanceof et))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbColumns||t.nbRows!==r.nbRows)throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=_(t.nbRows,t.nbColumns,n),e=t.nbRows*t.nbColumns,a=0;a<e;++a)o.data[a]=t.data[a]-r.data[a];return o},et.axpby=function(t,r,n,o,e){if(!(r instanceof et))throw new Error("first input must be a matrix");if(!(o instanceof et))throw new Error("second input must be a matrix");if(r.nbColumns!==o.nbColumns||r.nbRows!==o.nbRows)throw new Error("input matrices sizes do not match: ("+r.nbRows+","+r.nbColumns+") - ("+o.nbRows+","+o.nbColumns+")");for(var a=_(r.nbRows,r.nbColumns,e),i=r.nbRows*r.nbColumns,s=0;s<i;++s)a.data[s]=t*r.data[s]+n*o.data[s];return a},et.copy=function(t,r){if(!(t instanceof et))throw new Error("first input must be a matrix");for(var n=_(t.nbRows,t.nbColumns,r),o=t.nbRows*t.nbColumns,e=0;e<o;++e)n.data[e]=t.data[e];return n},et.elementwiseProduct=function(t,r,n){if(!(t instanceof et))throw new Error("first input must be a matrix");if(!(r instanceof et))throw new Error("second input must be a matrix");if(!(t.nbRows===r.nbRows&&t.nbColumns===r.nbColumns||r.nbRows===t.nbRows&&1===r.nbColumns||1===r.nbRows&&r.nbColumns===t.nbColumns))throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");var o=_(t.nbRows,t.nbColumns,n),e=t.nbRows,a=t.nbColumns;if(t.nbRows===r.nbRows&&t.nbColumns===r.nbColumns)for(var i=e*a,s=0;s<i;++s)o.data[s]=t.data[s]*r.data[s];else if(r.nbRows===t.nbRows&&1===r.nbColumns)for(var u=0,f=0;f<e;++f)for(var h=r.data[f],l=0;l<a;++l)o.data[u]=t.data[u]*h,u++;else if(1===r.nbRows&&r.nbColumns===t.nbColumns)for(u=0,f=0;f<e;++f)for(l=0;l<a;++l)o.data[u]=t.data[u]*r.data[l],u++;return o},et.xy=function(t,r,n){if(!(t instanceof et))throw new Error("first input must be a matrix");if(!(r instanceof et))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbRows)throw new Error("matrices sizes do not match: ("+t.nbRows+","+r.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=_(t.nbRows,r.nbColumns,n),e=t.nbRows,a=t.nbColumns,i=r.nbColumns,s=0,u=0,f=0;f<e;++f){for(var h=u,l=0;l<i;++l)o.data[h]=0,h++;for(var m=0,c=0;c<a;++c){var d=t.data[s];h=u;for(l=0;l<i;++l)o.data[h]+=d*r.data[m],m++,h++;s++}u+=i}return o},et.txy=function(t,r,n){if(!(t instanceof et))throw new Error("second input must be a matrix");if(!(r instanceof et))throw new Error("third input must be a matrix");if(t.nbRows!==r.nbRows)throw new Error("matrices sizes do not match: ("+t.nbRows+","+r.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=_(t.nbColumns,r.nbColumns,n),e=t.nbColumns,a=t.nbRows,i=r.nbColumns,s=0,u=0,f=0,h=0;h<e;++h){for(var l=t.data[s],m=d,c=0;c<i;++c)o.data[u]=l*r.data[c],u++;s++}var d=i;for(f=1;f<a;++f){for(h=u=0;h<e;++h){for(l=t.data[s],m=d,c=0;c<i;++c)o.data[u]+=l*r.data[m],u++,m++;s++}d+=i}return o},et.axy=function(t,r,n,o){if(!(r instanceof et))throw new Error("second input must be a matrix");if(!(n instanceof et))throw new Error("third input must be a matrix");if(r.nbColumns!==n.nbRows)throw new Error("matrices sizes do not match: ("+r.nbRows+","+n.nbColumns+") - ("+n.nbRows+","+n.nbColumns+")");for(var e=_(r.nbRows,n.nbColumns,o),a=r.nbRows,i=r.nbColumns,s=n.nbColumns,u=0,f=0,h=0;h<a;++h){for(var l=f,m=0;m<s;++m)e.data[l]=0,l++;for(var c=0,d=0;d<i;++d){var w=t*r.data[u];l=f;for(m=0;m<s;++m)e.data[l]+=w*n.data[c],c++,l++;u++}f+=s}return e},et.ax=function(t,r,n){if(!(r instanceof et))throw new Error("second input must be a matrix");for(var o=_(r.nbRows,r.nbColumns,n),e=r.nbRows,a=r.nbColumns,i=1;i<=e;++i)for(var s=1;s<=a;++s)o.setValue(i,s,t*r.getValue(i,s));return o},et.axty=function(t,r,n,o){if(!(r instanceof et))throw new Error("second input must be a matrix");if(!(n instanceof et))throw new Error("third input must be a matrix");if(r.nbColumns!==n.nbColumns)throw new Error("matrices sizes do not match: ("+r.nbRows+","+n.nbColumns+") - ("+n.nbRows+","+n.nbColumns+")");for(var e=_(r.nbRows,n.nbRows,o),a=0;a<r.nbRows;++a)for(var i=0;i<n.nbRows;++i){for(var s=e.data[a*e.nbColumns+i]=0;s<r.nbColumns;++s)e.data[a*e.nbColumns+i]+=r.data[a*r.nbColumns+s]*n.data[i*n.nbColumns+s];e.data[a*e.nbColumns+i]=t*e.data[a*e.nbColumns+i]}return e},et.atxy=function(t,r,n,o){if(!(r instanceof et))throw new Error("second input must be a matrix");if(!(n instanceof et))throw new Error("third input must be a matrix");if(r.nbRows!==n.nbRows)throw new Error("matrices sizes do not match: ("+r.nbRows+","+n.nbColumns+") - ("+n.nbRows+","+n.nbColumns+")");for(var e=_(r.nbColumns,n.nbColumns,o),a=0,i=0;i<r.nbColumns;++i){for(var s=t*r.data[a*r.nbColumns+i],u=0;u<n.nbColumns;++u)e.data[i*e.nbColumns+u]=0;for(u=0;u<n.nbColumns;++u)e.data[i*e.nbColumns+u]+=s*n.data[a*n.nbColumns+u]}for(a=1;a<r.nbRows;++a)for(i=0;i<r.nbColumns;++i)for(s=t*r.data[a*r.nbColumns+i],u=0;u<n.nbColumns;++u)e.data[i*e.nbColumns+u]+=s*n.data[a*n.nbColumns+u];return e},et.diagonal=function(t,r){if(!(t instanceof et&&t.isVector()))throw new Error("first input must be a vector");for(var n=t.nbRows,o=_(n,n,r),e=0;e<n;++e){for(var a=0;a<n;++a)o.data[e*n+a]=0;o.data[e*n+e]=t.data[e]}return o},et.fillSymmetric=function(t,r,n){if(t<1)throw new Error("input number of rows and columns out of bounds: "+t);for(var o=_(t,t,n),e=0;e<t;++e){for(var a=0;a<e;++a)o.data[e*t+a]=o.data[a*t+e];for(a=e;a<o.nbColumns;++a)o.data[e*t+a]=r(e+1,a+1)}return o},et.fill=function(t,r,n,o){if(t<1)throw new Error("input number of rows out of bounds: "+t);if(r<1)throw new Error("input number of columns out of bounds: "+r);for(var e=_(t,r,o),a=0;a<t;++a)for(var i=0;i<r;++i)e.data[a*r+i]=n(a+1,i+1);return e},et.zeros=function(t,r,n){for(var o=_(t,r,n),e=t*r,a=0;a<e;++a)o.data[a]=0;return o},et.ones=function(t,r){for(var n=_(t,r),o=t*r,e=0;e<o;++e)n.data[e]=1;return n},et.identity=function(t){for(var r=_(t,t),n=t*t,o=0;o<n;++o)o%(t+1)==(r.data[o]=0)&&(r.data[o]=1);return r},et.normrnd=function(t,r,n,o){for(var e=_(t,r),a=t*r,i=0;i<a;++i)e.data[i]=m(n,o);return e},et.vectorHadamardProduct=function(t,r){return et.elementwiseProduct(t,r)},et.vectorDotProduct=function(t,r){if(!t.isVector())throw new Error("first argument must be a vector");if(!r.isVector())throw new Error("second argument must be a vector");if(t.nbRows!==r.nbRows)throw new Error("Vectors sizes do not match: ("+t.nbRows+") - ("+r.nbRows+")");for(var n=0,o=t.nbRows,e=0;e<o;++e)n+=t.data[e]*r.data[e];return n},et.qrDecomposition=function(t,r){function n(t,r){var n,o,e;if(0==r)n=0<=t?1:-1,o=0,e=Math.abs(t);else if(0==t)o=(n=0)<=r?1:-1,e=Math.abs(r);else if(Math.abs(t)>Math.abs(r)){o=(a=r/t)*(n=1/(i=(0<=t?1:-1)*Math.sqrt(1+a*a))),e=t*i}else{var a,i;n=(a=t/r)*(o=1/(i=(0<=r?1:-1)*Math.sqrt(1+a*a))),e=r*i}return[n,-o,e]}void 0===r&&(r={});var o=r.qLess||!1;if(!(t instanceof et))throw new Error("first input must be a matrix");if(t.nbRows<t.nbColumns)throw new Error("matrix has more columns than rows: ("+t.nbRows+") v.s. ("+t.nbColumns+")");var e=t.nbRows,a=t.nbColumns,i=new et(t),s=null;o||(s=et.identity(e));for(var u=1;u<=a;++u)for(var f=e;u+1<=f;--f){var h=(f-2)*i.nbColumns+(u-1),l=(f-1)*i.nbColumns+(u-1),m=n(i.data[h],i.data[l]),c=m[0],d=m[1],w=m[2];i.data[h]=w,i.data[l]=0;for(var v=u+1;v<=a;++v){var b=(f-2)*i.nbColumns+(v-1),p=(f-1)*i.nbColumns+(v-1),y=i.data[b],g=i.data[p];i.data[b]=c*y-d*g,i.data[p]=d*y+c*g}if(!o)for(v=1;v<=e;++v){var x=(v-1)*s.nbColumns+(f-2),C=(v-1)*s.nbColumns+(f-1);y=s.data[x],g=s.data[C];s.data[x]=c*y-d*g,s.data[C]=d*y+c*g}}return o?i:[s,i]},et.svdDecomposition=function(t,r){void 0===r&&(r={});var n=r.eps||1e-16,o=r.maxIter||100,e=r.svdForm||"thin";if(!(t instanceof et))throw new Error("first input must be a matrix");if(t.nbRows<t.nbColumns)throw new Error("matrix has more columns than rows: "+t.nbColumns+" v.s. "+t.nbRows);for(var a=t.nbRows,i=t.nbColumns,s=new et(t),u=s.matrixNorm("frobenius"),f=et.identity(i),h=0,l="function"==typeof Float64Array?new Float64Array(i):new Array(i);;){if(++h,-1!==o&&o<h)throw new Error("maximum number of iterations reached: "+o);for(var m=1;m<=i;++m){var c=s.vectorNorm("two","column",m);l[m-1]=c*c}var d=!0;for(m=2;m<=i;++m)for(var w=1;w<=m-1;++w){for(var v=l[w-1],b=l[m-1],p=0,y=1;y<=a;++y)p+=s.data[(y-1)*s.nbColumns+(w-1)]*s.data[(y-1)*s.nbColumns+(m-1)];if(!(Math.abs(p)<=n*Math.sqrt(a*v*b))&&!(Math.sqrt(v)<=n*u||Math.sqrt(b)<=n*u)){d=!1;var g=(v-b)/(2*p),x=(0<=g?1:-1)/(Math.abs(g)+Math.sqrt(1+g*g)),C=1/Math.sqrt(1+x*x),A=C*x;for(y=1;y<=a;++y){var R=s.data[(y-1)*s.nbColumns+(w-1)],M=s.data[(y-1)*s.nbColumns+(m-1)];s.data[(y-1)*s.nbColumns+(w-1)]=C*R+A*M,s.data[(y-1)*s.nbColumns+(m-1)]=-A*R+C*M}l[w-1]+=x*p,l[m-1]-=x*p;for(y=1;y<=i;++y){R=f.data[(y-1)*f.nbColumns+(w-1)],M=f.data[(y-1)*f.nbColumns+(m-1)];f.data[(y-1)*f.nbColumns+(w-1)]=C*R+A*M,f.data[(y-1)*f.nbColumns+(m-1)]=-A*R+C*M}}}if(1==d)break}var E="function"==typeof Float64Array?new Float64Array(i):new Array(i),V="function"==typeof Uint32Array?new Uint32Array(i):new Array(i);for(m=1;m<=i;++m){var z=Math.sqrt(l[m-1]);E[m-1]=z,V[m-1]=m}V.sort(function(t,r){return E[r-1]-E[t-1]});var _=et.zeros(a,i),F=et.zeros(i,i),O=et.zeros(i,i);for(m=1;m<=i;++m){var I=V[m-1],N=E[I-1];if(0!=(F.data[(m-1)*F.nbColumns+(m-1)]=N))for(w=1;w<=a;++w)_.data[(w-1)*_.nbColumns+(m-1)]=s.data[(w-1)*s.nbColumns+(I-1)]/N;for(w=1;w<=i;++w)O.data[(w-1)*O.nbColumns+(m-1)]=f.data[(w-1)*f.nbColumns+(I-1)]}if("thin"==e)return[_,F,O];var k=et.qrDecomposition(_)[0],P=et.zeros(a,a),W=et.zeros(a,i);for(m=1;m<=i;++m){I=V[m-1],N=E[I-1];if(0!=(W.data[(m-1)*W.nbColumns+(m-1)]=N))for(w=1;w<=a;++w)P.data[(w-1)*P.nbColumns+(m-1)]=_.data[(w-1)*_.nbColumns+(m-1)];else for(w=1;w<=a;++w)P.data[(w-1)*P.nbColumns+(m-1)]=k.data[(w-1)*k.nbColumns+(m-1)]}for(m=i+1;m<=a;++m)for(w=1;w<=a;++w)P.data[(w-1)*P.nbColumns+(m-1)]=k.data[(w-1)*k.nbColumns+(m-1)];return"full"==e?[P,W,O]:void 0},et.nullSpace=function(t,r){void 0===r&&(r={});var n=r.eps||void 0;if(!(t instanceof et))throw new Error("first input must be a matrix");var o=t.nbRows,e=t.nbColumns,a=null;if(e<=o){var i=(l=et.svdDecomposition(t,{maxIter:-1}))[0],s=l[1],u=l[2];for(void 0===n&&(n=o*(b(s.data[0])-s.data[0])),m=e;1<=m&&!(s.data[(m-1)*s.nbColumns+(m-1)]>n);--m);if((c=m)==e)a=et.zeros(e,1);else{a=new et.zeros(e,e-c);for(var f=c+1;f<=e;++f)for(var h=1;h<=e;++h)a.data[(h-1)*a.nbColumns+(f-(c+1)+1-1)]=u.data[(h-1)*u.nbColumns+(f-1)]}}else{var l,m,c;i=(l=et.svdDecomposition(t.transpose(),{maxIter:-1,svdForm:"full"}))[0],s=l[1],u=l[2];for(void 0===n&&(n=e*(b(s.data[0])-s.data[0])),m=o;1<=m&&!(s.data[(m-1)*s.nbColumns+(m-1)]>n);--m);if((c=m)==o)a=et.zeros(e,1);else{var d=new et.zeros(e,c);for(f=1;f<=c;++f)for(h=1;h<=e;++h)d.data[(h-1)*d.nbColumns+(f-1)]=i.data[(h-1)*i.nbColumns+(f-1)];var w=et.qrDecomposition(d)[0];for(a=new et.zeros(e,e-c),f=c+1;f<=e;++f)for(h=1;h<=e;++h)a.data[(h-1)*a.nbColumns+(f-(c+1)+1-1)]=w.data[(h-1)*w.nbColumns+(f-1)]}}return a},et.linsolveBackSubstitution=function(t,r,n){if(!(t instanceof et))throw new Error("first input must be a matrix");if(!(r instanceof et))throw new Error("second input must be a matrix");if(!t.isSquare())throw new Error("matrix is not square: ("+t.nbRows+","+t.nbColumns+")");if(t.nbRows!==r.nbRows)throw new Error("matrix and second member sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");if(1!==r.nbColumns)throw new Error("b is not a vector: ("+r.nbRows+","+r.nbColumns+")");for(var o=t.nbColumns,e=_(o,1,n),a=o;1<=a;--a){e.data[a-1]=r.data[a-1];for(var i=a+1;i<=o;++i)e.data[a-1]=e.data[a-1]-t.data[(a-1)*t.nbColumns+(i-1)]*e.data[i-1];var s=t.data[(a-1)*t.nbColumns+(a-1)];if(0==s)throw new Error("input matrix is not invertible: zero diagonal coefficient at index "+a);e.data[a-1]=e.data[a-1]/s}return e},et.randomOrthogonal=function(t){var r=et.normrnd(t,t),n=et.qrDecomposition(r),o=n[0],e=n[1],a=et.fill(1,t,function(t,r){return 0<=e.data[(r-1)*e.nbColumns+(r-1)]?1:-1});return et.elementwiseProduct(o,a)},et.randomCorrelation=function(t,n){if(void 0===n&&(n={}),void 0===n.eps&&(n.eps=1e-14),void 0===n.epsLambda&&(n.epsLambda=1e-8),void 0===n.lambda){n.lambda=new M(t).sample();for(var r=0;r<t;++r)n.lambda[r]*=t}if(n.lambda.length!=t)throw new Error("number of input eigenvalues not equal to "+t+", but to "+n.lambda.length);var o=0;for(r=0;r<t;++r)o+=n.lambda[r];if(Math.abs(o-t)>n.epsLambda)throw new Error("input eigenvalues not summing to "+t);for(var e=n.eps,a=et.fill(1,t,function(t,r){return n.lambda[r-1]}),i=et.randomOrthogonal(t),s=et.axty(1,et.elementwiseProduct(i,a),i),u=1;u<t;++u){for(var f=!0,h=1;h<=t;++h){var l=s.data[(h-1)*s.nbColumns+(h-1)];if(Math.abs(l-1)>e){f=!1;break}1!=l&&(s.data[(h-1)*s.nbColumns+(h-1)]=1)}if(f)break;r=-1;var m=-1;for(h=1;h<=t;++h)s.data[(h-1)*s.nbColumns+(h-1)]<1&&-1===r&&(r=h),1<s.data[(h-1)*s.nbColumns+(h-1)]&&(m=h);if(m<r){m=r=-1;for(h=1;h<=t;++h)1<s.data[(h-1)*s.nbColumns+(h-1)]&&-1===r&&(r=h),s.data[(h-1)*s.nbColumns+(h-1)]<1&&(m=h)}var c=s.data[(r-1)*s.nbColumns+(r-1)],d=s.data[(r-1)*s.nbColumns+(m-1)],w=s.data[(m-1)*s.nbColumns+(m-1)],v=(d+Math.sqrt(d*d-(c-1)*(w-1)))/(w-1),b=1/Math.sqrt(1+v*v),p=b*v;for(h=1;h<=t;++h){var y=s.data[(r-1)*s.nbColumns+(h-1)],g=s.data[(m-1)*s.nbColumns+(h-1)];s.data[(r-1)*s.nbColumns+(h-1)]=b*y-p*g,s.data[(m-1)*s.nbColumns+(h-1)]=p*y+b*g}for(h=1;h<=t;++h){y=s.data[(h-1)*s.nbColumns+(r-1)],g=s.data[(h-1)*s.nbColumns+(m-1)];s.data[(h-1)*s.nbColumns+(r-1)]=b*y-p*g,s.data[(h-1)*s.nbColumns+(m-1)]=p*y+b*g}s.data[(r-1)*s.nbColumns+(r-1)]=1}for(h=1;h<=t;++h)s.data[(h-1)*s.nbColumns+(h-1)]=1;return s},et.linsolveExtendedKaczmarz=function(t,r,n){void 0===n&&(n={});var o=n.eps||1e-12,e=n.maxIter||1e5,a=!1;if(void 0!==n.randomized&&(a=n.randomized),!(t instanceof et))throw new Error("first input must be a matrix");if(!(r instanceof et))throw new Error("second input must be a matrix");if(t.nbRows!==r.nbRows)throw new Error("matrix and second member sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");if(1!==r.nbColumns)throw new Error("b is not a vector: ("+r.nbRows+","+r.nbColumns+")");var i=t.nbRows,s=t.nbColumns,u=et.zeros(s,1),f=et.copy(r),h=et.zeros(i,1),l=et.zeros(i,1),m=et.zeros(i,1),c=t.matrixNorm("frobenius"),d=c*c;if(0===c)return u;for(var w="function"==typeof Float64Array?new Float64Array(i):new Array(i),v=1;v<=i;++v){var b=t.vectorNorm("two","row",v);w[v-1]=b*b}for(var p="function"==typeof Float64Array?new Float64Array(s):new Array(s),y=1;y<=s;++y){var g=t.vectorNorm("two","column",y);p[y-1]=g*g}if(0==a)for(var x=0;;){if(++x,-1!==e&&e<=x)throw new Error("maximum number of iterations reached: "+e);for(v=1;v<=i;++v)if(0!=w[v-1]){var C=0;for(y=1;y<=s;++y)C+=t.data[(v-1)*t.nbColumns+(y-1)]*u.data[(y-1)*u.nbColumns];var A=C-(r.data[(v-1)*r.nbColumns+0]-f.data[(v-1)*f.nbColumns+0]);for(y=1;y<=s;++y)u.data[(y-1)*u.nbColumns]-=A/w[v-1]*t.data[(v-1)*t.nbColumns+(y-1)]}for(y=1;y<=s;++y)if(0!=p[y-1]){var R=0;for(v=1;v<=i;++v)R+=t.data[(v-1)*t.nbColumns+(y-1)]*f.data[(v-1)*f.nbColumns+0];for(v=1;v<=i;++v)f.data[(v-1)*f.nbColumns+0]-=R/p[y-1]*t.data[(v-1)*t.nbColumns+(y-1)]}var M=u.vectorNorm("two");if(m=et.xy(t,u,m),l=et.xmy(r,f,l),(O=(h=et.xmy(m,l,h)).vectorNorm("two"))<=o*c*M)break}else{var E=et.zeros(s,1),V="function"==typeof Float64Array?new Float64Array(i):new Array(i);for(v=1;v<=i;++v)V[v-1]=w[v-1]/d;var z=new S(V),_="function"==typeof Float64Array?new Float64Array(s):new Array(s);for(y=1;y<=s;++y)_[y-1]=p[y-1]/d;var F=new S(_);for(x=0;;){if(++x,-1!==e&&e<=x)throw new Error("maximum number of iterations reached: "+e);for(v=z.sample()+1,C=0,y=1;y<=s;++y)C+=t.data[(v-1)*t.nbColumns+(y-1)]*u.data[(y-1)*u.nbColumns];for(A=C-(r.data[(v-1)*r.nbColumns+0]-f.data[(v-1)*f.nbColumns+0]),y=1;y<=s;++y)u.data[(y-1)*u.nbColumns]-=A/w[v-1]*t.data[(v-1)*t.nbColumns+(y-1)];for(y=F.sample()+1,R=0,v=1;v<=i;++v)R+=t.data[(v-1)*t.nbColumns+(y-1)]*f.data[(v-1)*f.nbColumns+0];for(v=1;v<=i;++v)f.data[(v-1)*f.nbColumns+0]-=R/p[y-1]*t.data[(v-1)*t.nbColumns+(y-1)];if(x%8*Math.min(i,s)==0){M=u.vectorNorm("two");m=et.xy(t,u,m),l=et.xmy(r,f,l);var O=(h=et.xmy(m,l,h)).vectorNorm("two"),I=(E=et.txy(t,f,E)).vectorNorm("two");if(O<=o*c*M&&I<=o*d*M)break}}}return u},N.meanVector=function(n,t){void 0===(t=t)&&(t={}),void 0===t.method&&(t.method="sample-mean");var r=t.method;if("sample-mean"!=r&&"demiguel-shrinked-mean"!=r)throw new Error("unsupported mean vector computation method");var o,e=n.length,a=n[0].length;if("sample-mean"==r){o=i=et.fill(e,1,function(t,r){return F(n[t-1])})}else{if("demiguel-shrinked-mean"!=r)throw new Error("internal error: unsupported mean vector computation method");var i,s=F((i=et.fill(e,1,function(t,r){return F(n[t-1])})).toArray()),u=et.fill(e,1,function(t,r){return s}),f=et.fill(e,1,function(t,r){return O(n[t-1],n[t-1])}).sum()/e,h=e/a*f/(e/a*f+Math.pow(et.xmy(u,i).vectorNorm("two"),2));o=et.axpby(h,u,1-h,i)}return o},N.randomMeanVector=function(t){return et.fill(t,1,function(t,r){return m(0,1)})},N.perturbedMeanVector=function(t,r){if(void 0===(r=r)&&(r={}),void 0===r.method&&(r.method="chopra-ziemba"),"chopra-ziemba"!=r.method)throw new Error("unsupported perturbation method");var o=r.k;if(void 0===r.k&&(o=.05),!t.isVector())throw new Error("input must be a vector");return t.elemMap(function(t,r,n){return n*(1+o*m(0,1))})},N.randomVariances=function(t){return et.fill(t,1,function(t,r){return function(t,r){null==t&&(t=0);null==r&&(r=1);var n,o=r*r,e=1.136717791056118,a=(1-e*e)/e*r,i=r*Math.sqrt(Math.PI/2);for(;;){var s;if(t<a){var u=(-t+Math.sqrt(t*t+4*o))/2/o;n=-Math.log(1-Math.random())/u,s=Math.exp(-(n-t)*(n-t)/2/o-u*(t-n+u*o/2))}else if(t<=0)n=Math.abs(m())*r+t,s=0<=n?1:0;else if(t<i){var f=Math.random()<t/(t+Math.sqrt(Math.PI/2)*r)?1:0,h=Math.random()*t,l=Math.abs(m()*r)+t;n=f*h+(1-f)*l,s=f*Math.exp(-(n-t)*(n-t)/2/o)+(1-f)}else n=m()*r+t,s=0<=n?1:0;if(Math.random()<=s)break}return n}(0,1)})},N.perturbedVariances=function(t,r){if(void 0===(r=r)&&(r={}),void 0===r.method&&(r.method="chopra-ziemba"),"chopra-ziemba"!=r.method)throw new Error("unsupported perturbation method");var e=r.k;if(void 0===r.k&&(e=.05),!t.isVector())throw new Error("input must be a vector");return t.elemMap(function(t,r,n){for(var o=n*(1+e*m(0,1));0==o;)o=n*(1+e*m(0,1));return o})},tt.populationCount=function(t){return t=(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135,t+=t>>>8,63&(t+=t>>>16)},tt.prototype={constructor:tt,resize:function(t){var r=this.words.length;if(!(r<<this.WORD_LOG>t)){var n=t+this.WORD_LENGTH>>>this.WORD_LOG;if("function"==typeof Uint32Array){var o=new Uint32Array(n);o.set(this.words),this.words=o}else{this.words[n-1]=0;for(var e=r;e<n-1;++e)this.words[e]=0}}},toString:function(){for(var t="",r=this.words.length,n=0;n<r;++n){var o="";t+=(o="function"==typeof Uint32Array?this.words[n].toString(2):(this.words[n]>>>0).toString(2)).length>=this.WORD_LENGTH?o:new Array(this.WORD_LENGTH-o.length+1).join("0")+o}return t},set:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]|=1<<t,this},setRange:function(t,r){this.words.length<<this.WORD_LOG<=r&&this.resize(r);for(var n=t;n<=r;++n)this.words[n>>>this.WORD_LOG]|=1<<n;return this},unset:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]&=~(1<<t),this},get:function(t){return 0!=(this.words[t>>>this.WORD_LOG]&1<<t)},clear:function(){return this.words="function"==typeof Uint32Array?new Uint32Array(0):new Array(0),this},flip:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]^=1<<t,this},isEmpty:function(){for(var t=this.words.length,r=0;r<t;++r)if(0!=this.words[r])return!1;return!0},nbSetBits:function(){for(var t=0,r=this.words.length,n=0;n<r;++n)t+=tt.populationCount(0|this.words[n]);return t},toArray:function(){for(var t=new Array(this.nbSetBits()),r=0,n=this.words.length,o=0;o<n;++o)for(var e=this.words[o];0!=e;){var a=e&-e;t[r++]=(o<<this.WORD_LOG)+tt.populationCount(a-1|0),e^=a}return t}},N.returns=function(t,r){void 0===(r=r)&&(r={}),void 0===r.method&&(r.method="arithmetic");var n=r.method;if("arithmetic"!=n&&"logarithmic"!=n)throw new Error("unsupported returns computation method");var o="function"==typeof Float64Array?new Float64Array(t.length-1):new Array(t.length-1);if("arithmetic"==n)for(var e=0;e<t.length-1;++e)o[e]=(t[e+1]-t[e])/t[e];else{if("logarithmic"!=n)throw new Error("internal error: unsupported returns computation method");for(e=0;e<t.length-1;++e)o[e]=Math.log(t[e+1]/t[e])}return o},N.bestConstantlyRebalancedWeights=function(h,t){void 0===t&&(t={constraints:{}}),void 0===t.constraints&&(t.constraints={}),void 0===t.eps&&(t.eps=1e-4),void 0===t.maxIter&&(t.maxIter=1e4);var r=t.eps,n=t.maxIter,o=t.constraints.minWeights,e=t.constraints.maxWeights,l=h.length,m=h[0].length;return W(function(t){for(var r=et.zeros(l,1),n=1,o=0;o<m;++o)r=et.fill(l,1,function(t,r){return h[t-1][o]},r),n*=et.vectorDotProduct(t,r);return-n},function(t){for(var r,n=et.zeros(l,1),o="function"==typeof Float64Array?new Float64Array(m):new Array(m),e=1,a=!1,i=0;i<m;++i){n=et.fill(l,1,function(t,r){return h[t-1][i]},n);var s=et.vectorDotProduct(t,n);o[i]=s,!1===a&&(e*=s,Math.abs(s)<=1e-12&&(a=!0))}if(!1!==a)throw new Error("null portfolio relative detected, unsuported case");r=et.fill(m,1,function(t,r){return e/o[t-1]});var u=et.zeros(m,1),f=et.zeros(l,1);for(i=0;i<l;++i)u=et.fill(m,1,function(t,r){return h[i][t-1]},u),f.data[i]=-et.vectorDotProduct(u,r);return f},function(t){return B(t.data,o,e)},function(t){return new et(L(t.data,o,e))},new et(L(et.ones(l,1).data,o,e)),{eps:r,maxIter:n,maxLine:n})[0].toArray()},N.clusterRiskParityWeights=function(t,r){void 0===r&&(r={});var n=r.clusteringMode||"ftca",o=(t=new et(t).toCovarianceMatrix(t)).nbRows,e=[];if("manual"===n){e=r.clusters||[];for(var a=new Array(o),i=0;i<a.length;++i)a[i]=0;for(var s=0;s<e.length;++s){if(0===e[s].length)throw new Error("empty cluster at index: "+s);for(var u=0;u<e[s].length;++u){var f=e[s][u];if(f<1||o<f)throw new Error("asset index out of bounds: "+f);a[f-1]++}}for(i=0;i<a.length;++i)if(1!==a[i])throw 0===a[i]?new Error("missing asset index: "+(i+1)):1<a[i]?new Error("duplicate asset index: "+(i+1)):new Error("unknown error")}else{if("ftca"!==n)throw new Error("unsupported clustering method");e=function(t,r){void 0===(r=r)&&(r=.5);for(var n=[],o=(t=new et(t)).nbRows,e=new Array(o),a=0;a<e.length;++a)e[a]=a+1;for(;0!=e.length;){if(1===e.length){var i=[e[0]];e[0]=null,n.push(i)}else{var s=t.submatrix(e,e).toRowArray(function(t,r,n){return t!=r}),u=new Array(e);for(a=0;a<e.length;++a)u[a]=F(s[a]);var f=0,h=-1,l=-1,m=0,c=-1,d=1;for(a=0;a<e.length;++a)u[a]>=l&&(f=e[a],l=u[h=a]),u[a]<=d&&(m=e[a],d=u[c=a]);if(t.getValueAt(f,m)>r){var w=f===m?[f]:[f,m];e[h]=null,e[c]=null;for(a=0;a<e.length;++a){if(null!==e[a])r<(t.getValueAt(e[a],f)+t.getValueAt(e[a],m))/2&&(w.push(e[a]),e[a]=null)}n.push(w)}else{var v=[f];e[h]=null;for(a=0;a<e.length;++a)null!==e[a]&&t.getValueAt(e[a],f)>r&&(v.push(e[a]),e[a]=null);if(n.push(v),f!==m){var b=[m];e[c]=null;for(a=0;a<e.length;++a)null!==e[a]&&t.getValueAt(e[a],m)>r&&(b.push(e[a]),e[a]=null);n.push(b)}}}var p=[];for(a=0;a<e.length;++a)null!==e[a]&&p.push(e[a]);e=p}return n}(t.getCorrelationMatrix().toRowArray(),r.ftcaThreshold)}var h=e.length,l=et.zeros(h,o);for(i=0;i<h;++i){var m=e[i].slice().sort(function(t,r){return t-r}),c=t.submatrix(m,m),d=N.equalRiskContributionWeights(c,r);for(s=0;s<d.length;++s)l.setValueAt(i+1,m[s],d[s])}var w=et.xy(l,et.axty(1,t,l)),v=N.equalRiskContributionWeights(w,r);return et.txy(l,new et(v)).toArray()},N.equalRiskBoundingWeights=function(t,r){void 0===r&&(r={}),r.outputPortfolioVolatility=!0;var n=(t=new et(t)).nbRows,o=1/0,e=[],a=[],i=new v(n),s=i.next();for(s=i.next();-1!=s;){var u=s,f=t.submatrix(u,u),h=N.equalRiskContributionWeights(f,r),l=h[0],m=h[1],c=m*m/u.length;c<o&&(o=c,e=u,a=l);s=i.next()}for(var d=et.zeros(n,1),w=0;w<e.length;++w)d.setValueAt(e[w],1,a[w]);return d.toArray()},N.equalRiskContributionWeights=function(t,r){var n=(t=new et(t)).nbRows,o=et.fill(n,1,function(t,r){return 1/n});return N.riskBudgetingWeights(t,o,r)},N.equalWeights=function(n,t){return et.fill(n,1,function(t,r){return 1/n}).toArray()},N.globalMinimumVarianceWeights=function(t,r){void 0===r&&(r={}),void 0===r.constraints&&(r.constraints={}),void 0===r.eps&&(r.eps=1e-8),void 0===r.maxIter&&(r.maxIter=1e4);var n=r.eps,o=r.maxIter,e=r.constraints.minWeights,a=r.constraints.maxWeights,i=(t=new et(t)).nbRows,s=et.zeros(i,1),u=et.ones(i,1),f=t,h=s,l=u,m=s;e&&(m=new et(e));var c=u;return a&&(c=new et(a)),A(f,h,l,1,m,c,{eps:n,maxIter:o})[0].toArray()},N.inverseVolatilityWeights=function(t,r){var n=new et(t).elemMap(function(t,r,n){return 1/Math.sqrt(n)});return(n=n.normalize(n)).toArray()},N.maximumSharpeRatioWeights=function(t,r,n,o){var s=1e-8;function u(t,r){return et.vectorDotProduct(r,t)}function f(t,r,n){var o=et.vectorDotProduct(et.xy(n,t),t);if(Math.abs(o)<=s)o=0;else if(o<0&&o<-s)throw new Error("negative volatility, covariance matrix might not be semi-definite positive");return Math.sqrt(o)}function U(t,r,n,o){var e=u(o,t),a=e-n,i=f(o,0,r);return Math.abs(i)<s&&(i=s),[a/i,e,i]}function e(t,r,n,o,e,a,i){var s=U(t,r,n,e),u=s[0],f=s[1],h=s[2],l=h*h,m=U(t,r,n,i),c=m[0],d=m[1],w=m[2],v=w*w,b=f-d,p=d-n,y=b*b,g=2*b*p,x=p*p,C=et.vectorDotProduct(et.xy(r,e),i),A=l+v-2*C,R=-2*(v-C),M=y*R-g*A,E=g*v-x*R,V=2*(y*v-x*A)/2,z=0<=V?1:-1,_=V*V-M*E;if(_<0)throw new Error("internal error, the covariance matrix might not be semi-definite positive");var F=-(V+z*Math.sqrt(_)),O=F/M,I=E/F,N=[[e,u],[i,c]];if(0<O&&O<1){var k=et.fill(e.nbRows,1,function(t,r){return O*e.getValue(t,1)+(1-O)*i.getValue(t,1)}),P=U(t,r,n,k)[0];N.push([k,P])}if(0<I&&I<1){var W=et.fill(e.nbRows,1,function(t,r){return I*e.getValue(t,1)+(1-I)*i.getValue(t,1)}),S=U(t,r,n,W)[0];N.push([W,S])}return q(N,function(t,r){return t[1]-r[1]})[0]}var a=V(t=new et(t),r=new et(r),o);if(f(a[a.length-1][0],0,r)<s){if(0==(h=E(t,r,a,{constraint:"volatility",constraintValue:s})).length)throw new Error("no corner portfolio with a strictly positive volatility: the covariance matrix might not be semi-definite positive");var i=h[0];a[l=h[1]]=[i,-1],a.length=l+1}if(u(a[a.length-1][0],t)<n+s){var h;if(0==(h=E(t,r,a,{constraint:"return",constraintValue:n+s})).length)throw new Error("no corner portfolio with a strictly positive excess return");var l;i=h[0];a[l=h[1]]=[i,-1],a.length=l+1}var m=function(t,r,n,o){var e=o.length-1,a=0,i=o[e][0],s=o[a][0],u=U(t,r,n,i);if(U(t,r,n,s),e==a)return[e,i,u];for(;e-a!=1;){var f=Math.floor(a+(e-a)/2),h=o[f][0],l=U(t,r,n,h),m=f+1,c=o[m][0],d=U(t,r,n,c);if(l[0]>d[0])e=f,i=h,u=l;else{if(!(l[0]<d[0])){e=m,i=c,u=d,a=f,s=h,l;break}a=f,s=h,l}}return[e,i,u]}(t,r,n,a),c=m[0],d=m[1],w=[[d,m[2][0]]],v=c+1;if(v<=a.length-1){var b=e(t,r,n,0,a[v][0],0,d);w.push(b)}var p=c-1;if(0<=p){var y=e(t,r,n,0,d,0,a[p][0]);w.push(y)}return q(w,function(t,r){return t[1]-r[1]})[0][0].toArray()},N.meanVarianceOptimizationWeights=function(n,o,t){var e=1e-8;void 0===t&&(t={constraints:{}}),void 0===t.constraints&&(t.constraints={});var r=!0;void 0!==t.constraints.fullInvestment&&(r=t.constraints.fullInvestment);var a=t.constraints.return,i=t.constraints.volatility,s=t.constraints.maxVolatility,u=t.constraints.riskTolerance;if(void 0===a&&void 0===i&&void 0===s&&null==u)throw new Error("missing return, volatility or risk tolerance constraints");if(void 0!==a&&void 0!==i||void 0!==a&&void 0!==s)throw new Error("simultaneous return and volatility constraints");if(void 0!==u&&(void 0!==a||void 0!==s||void 0!==i))throw new Error("simultaneous risk tolerance and return or volatility constraints");n=new et(n);var f,h,l=(o=new et(o)).nbColumns;if(r)f=V(n,o,t);else{n=et.fill(l+1,1,function(t,r){return t<=l?n.getValue(t,1):0}),o=et.fill(l+1,l+1,function(t,r){return t<=l&&r<=l?o.getValue(t,r):0});var m=null;if(t.constraints.minWeights){m="function"==typeof Float64Array?new Float64Array(l+1):new Array(l+1);for(var c=0;c<l;++c)m[c]=t.constraints.minWeights[c];m[l]=0}var d=null;if(t.constraints.maxWeights){d="function"==typeof Float64Array?new Float64Array(l+1):new Array(l+1);for(c=0;c<l;++c)d[c]=t.constraints.maxWeights[c];d[l]=1}var w={maxIter:t.maxIter,constraints:t.constraints};t.constraints.minWeights&&(w.constraints.minWeights=m),t.constraints.maxWeights&&(w.constraints.maxWeights=d),f=V(n,o,w)}if(void 0!==a){if(0==(x=E(n,o,f,{constraint:"return",constraintValue:a})).length)throw new Error("no matching efficient portfolio with a return equal to "+a);h=x[0]}else if(void 0!==i){if(0==(x=E(n,o,f,{constraint:"volatility",constraintValue:i})).length)throw new Error("no matching efficient portfolio with a volatility equal to "+i);h=x[0]}else if(void 0!==u){var v=f[0][0],b=f[0][1],p=f[f.length-1][0],y=f[f.length-1][1];if(b-e<u)h=v;else if(u<y+e)h=p;else{if(0==(x=E(n,o,f,{constraint:"riskTolerance",constraintValue:u})).length)throw new Error("internal error: no matching efficient portfolio with a risk tolerance equal to "+u);h=x[0]}}else if(void 0!==s){var g=f[0][0];if(function(t,r,n){var o=et.vectorDotProduct(et.xy(n,t),t);if(Math.abs(o)<=e)o=0;else if(o<0&&o<-e)throw new Error("negative volatility, covariance matrix might not be semi-definite positive");return Math.sqrt(o)}(g,0,o)-e<s)h=g;else{var x;if(0==(x=E(n,o,f,{constraint:"volatility",constraintValue:s})).length)throw new Error("no matching efficient portfolio with a volatility lower than or equal to "+s);h=x[0]}}return r||(h=et.fill(l,1,function(t,r){if(t<=l)return h.getValue(t,1)})),h.toArray()},N.meanVarianceEfficientFrontierNearestWeights=function(t,r,n,o){r=new et(r),n=new et(n),t=new et(t);var e,a=V(r,n,o);if(0==a.length)throw new Error("internal error: no corner portfolios");for(var i=Number.POSITIVE_INFINITY,s=0;s<a.length-1;++s){var u=a[s][0],f=l(t,a[s+1][0],u),h=et.xmy(t,new et(f)).vectorNorm("two");h<=i&&(e=f,i=h)}return e},N.meanVarianceEfficientFrontierPortfolios=function(t,r,n){function o(t,r){return et.vectorDotProduct(r,t)}function e(t,r,n){var o=et.vectorDotProduct(et.xy(n,t),t);if(Math.abs(o)<=1e-8)o=0;else if(o<0&&o<-1e-8)throw new Error("negative volatility, covariance matrix might not be semi-definite positive");return Math.sqrt(o)}void 0===n&&(n={constraints:{}});var a=n.nbPortfolios||100,i=V(t=new et(t),r=new et(r),n),s=(r.nbColumns,new Array(a));if(0==i.length)throw new Error("efficient frontier made of no corner portfolios: internal error");if(1==i.length){if(1!=a)throw new Error("efficient frontier made of only one corner portfolio: only one efficient portfolio can be computed");var u=o(c=i[0][0],t),f=e(c,0,r);return[[c.toArray(),u,f]]}if(a<=1)throw new Error("efficient frontier made of several corner portfolios: at least two efficient portfolios must be computed");for(var h=i[0][1],l=(i[i.length-1][1]-h)/(a-1),m=0;m<a;++m){var c,d=h+m*l;if(0==(c=E(t,r,i,{constraint:"riskTolerance",constraintValue:d})).length)throw new Error("internal error: no matching efficient portfolio with a risk tolerance equal to "+d);u=o(c=c[0],t),f=e(c,0,r);s[a-1-m]=[c.toArray(),u,f]}return s},N.meanVarianceEfficientFrontierCornerPortfolios=function(t,r,n){function o(t,r){return et.vectorDotProduct(r,t)}function e(t,r,n){var o=et.vectorDotProduct(et.xy(n,t),t);if(Math.abs(o)<=1e-8)o=0;else if(o<0&&o<-1e-8)throw new Error("negative volatility, covariance matrix might not be semi-definite positive");return Math.sqrt(o)}var a=V(t=new et(t),r=new et(r),n),i=[],s=o(l=a[0][0],t),u=e(l,0,r);i.push([l.toArray(),s,u]);for(var f=l,h=1;h<a.length;++h){var l=a[h][0];if(!et.areEqual(l,f,1e-8)){s=o(l,t),u=e(l,0,r);i.push([l.toArray(),s,u]),f=l}}return i.reverse()},N.minimaxWeights=function(n,t){void 0===t&&(t={constraints:{}}),void 0===t.constraints&&(t.constraints={});var r=!0;void 0!==t.constraints.fullInvestment&&(r=t.constraints.fullInvestment);var o=t.outputMinimumPortfolioReturn,e=n.length,a=n[0].length,i=et.fill(e+1,1,function(t,r){return t<=e?0:-1}),s=null,u=null;r&&(s=et.fill(1,e+1,function(t,r){return r<=e?1:0}),u=et.ones(1,1));var f=function(o,t,e,r,n,a,i,s){void 0===s&&(s={});var u=s.eps||1e-8,f=s.maxIter||1e5,h=!1,l=!1,m=!1;if(null!==o&&null!==t)h=!0;else{if(null!==o&&null===t)throw new Error("equality constraints vector is missing");if(null===o&&null!==t)throw new Error("equality constraints matrix is missing")}if(null!==e&&null!==r)l=!0;else{if(null!==e&&null===r)throw new Error("inequality constraints vector is missing");if(null===e&&null!==r)throw new Error("inequality constraints matrix is missing")}if(null!==a&&null!==i)m=!0;else{if(null!==a&&null===i)throw new Error("upper bounds constraints vector is missing");if(null===a&&null!==i)throw new Error("lower bounds constraints vector is missing")}if(!(n instanceof et))throw new Error("fifth input must be a matrix");if(1!==n.nbColumns)throw new Error("fifth input is not a vector: "+n.nbColumns+"-"+n.nbRows);if(h){if(!(o instanceof et))throw new Error("first input must be a matrix");if(!(t instanceof et))throw new Error("second input must be a matrix");if(o.nbRows!==t.nbRows)throw new Error("first and second inputs number of rows do not match: "+o.nbRows+"-"+t.nbRows);if(o.nbColumns!==n.nbRows)throw new Error("first input number of columns and fifth input number of rows do not match: "+o.nbColumns+"-"+n.nbRows);if(1!==t.nbColumns)throw new Error("second input is not a vector: "+t.nbColumns+"-"+t.nbRows)}if(l){if(!(e instanceof et))throw new Error("third input must be a matrix");if(!(r instanceof et))throw new Error("third input must be a matrix");if(e.nbRows!==r.nbRows)throw new Error("third and fourth inputs number of rows do not match: "+e.nbRows+"-"+r.nbRows);if(e.nbColumns!==n.nbRows)throw new Error("third input number of columns and fifth input number of rows do not match: "+e.nbColumns+"-"+n.nbRows);if(1!==r.nbColumns)throw new Error("fourth input is not a vector: "+r.nbColumns+"-"+r.nbRows)}if(m){if(null!==a.nbRows){if(!(a instanceof et))throw new Error("sixth input must be a matrix");if(a.nbRows!==n.nbRows)throw new Error("sixth input number of rows and fifth input number of rows do not match: "+a.nbRows+"-"+n.nbRows)}if(null!==i.nbRows){if(!(i instanceof et))throw new Error("seventh input must be a matrix");if(i.nbRows!==n.nbRows)throw new Error("seventh input number of rows and fifth input number of rows do not match: "+i.nbRows+"-"+n.nbRows)}}var c=0,d=null,w=null,v=null;h&&(c=o.nbRows,d=et.zeros(c,1),w=et.zeros(c,1),v=et.zeros(c,1));var b=0,p=null,y=null,g=null;l&&(b=e.nbRows,p=et.zeros(b,1),y=et.zeros(b,1),g=et.zeros(b,1));var x=n.nbRows,C=et.ones(x,1),A=et.ones(x,1),R=et.ones(x,1),M=et.zeros(x,1),E=et.zeros(x,1),V=et.zeros(x,1),z=null;h&&(z=et.zeros(c,1));var _=null;l&&(_=et.zeros(b,1));var F=et.fill(x,1,function(t,r){var n=0;h&&(n+=o.vectorNorm("one","column",t));l&&(n+=e.vectorNorm("one","column",t));return 0==n&&(n=1),.9995/n}),O=null;h&&(O=et.fill(c,1,function(t,r){var n=o.vectorNorm("one","row",t);return 0==n&&(n=1),.9995/n}));var I=null;l&&(I=et.fill(b,1,function(t,r){var n=e.vectorNorm("one","row",t);return 0==n&&(n=1),.9995/n}));for(var N=0;;){if(-1!==f&&f<=N)throw new Error("maximum number of iterations reached: "+f);if(++N,h&&l?A=et.xpy(et.xpy(et.txy(o,d,E),et.txy(e,p,V),E),n,A):h?A=et.xpy(et.txy(o,d,E),n,A):l&&(A=et.xpy(et.txy(e,p,E),n,A)),A=et.xmy(C,et.elementwiseProduct(A,F,E),A),m)for(var k=1;k<=x;++k)A.data[k-1]<a.data[k-1]?A.data[k-1]=a.data[k-1]:A.data[k-1]>i.data[k-1]&&(A.data[k-1]=i.data[k-1]);else for(k=1;k<=x;++k)A.data[k-1]<0&&(A.data[k-1]=0);if(R=et.axpby(2,A,-1,C,R),h&&(w=et.xpy(d,et.elementwiseProduct(et.xmy(et.xy(o,R,z),t,z),O,z),w)),l){y=et.xpy(p,et.elementwiseProduct(et.xmy(et.xy(e,R,_),r,_),I,_),y);for(k=1;k<=b;++k)y.data[k-1]<0&&(y.data[k-1]=0)}var P=(M=et.xmy(A,C,M)).vectorNorm("infinity"),W=A.vectorNorm("infinity"),S=0,U=0;h&&(S=(v=et.xmy(w,d,v)).vectorNorm("infinity"),U=w.vectorNorm("infinity"));var q=0,D=0;if(l&&(q=(g=et.xmy(y,p,g)).vectorNorm("infinity"),D=y.vectorNorm("infinity")),P<=u*W&&S<=u*U&&q<=u*D)break;C=et.copy(A,C),h&&(d=et.copy(w,d)),l&&(p=et.copy(y,p))}return[A,et.vectorDotProduct(n,A)]}(s,u,et.fill(a+(r?0:1),e+1,function(t,r){return t<=a?r<=e?-n[r-1][t-1]:1:t==a+1?r<=e?1:0:void 0}),et.fill(a+(r?0:1),1,function(t,r){return t<=a?0:t==a+1?1:void 0}),i,et.fill(e+1,1,function(t,r){return t<=e?0:-1/0}),et.fill(e+1,1,function(t,r){return t<=e?1:1/0}),{maxIter:-1})[0],h=f.toArray(function(t,r,n){return t!=e+1}),l=f.data[e];return!0===o?[h,l]:h},N.minimumCorrelationWeights=function(t,r){var n=(t=new et(t).toCovarianceMatrix()).getVariances(),o=n.elemMap(function(t,r,n){return 1/Math.sqrt(n)}),e=t.getCorrelationMatrix(),a=e.nbRows;if(a<=2)return N.inverseVolatilityWeights(n,r);for(var i=e.toArray(function(t,r,n){return t<r}),s=F(i),u=d(i),f=e.elemMap(function(t,r,n){return t==r?0:1-w((n-s)/u)}),h=f.toRowArray(function(t,r,n){return t!=r}),l=new Array(a),m=0;m<a;++m)l[m]=F(h[m]);var c=new et(function(t,r){for(var n=new Array(t.length),o=0;o<t.length;++o)n[o]=[t[o],o];0==r?n.sort(function(t,r){return t[0]>r[0]?-1:1}):1==r&&n.sort(function(t,r){return t[0]<r[0]?-1:1});var e=new Array(t.length);for(o=e[n[0][1]]=1;o<t.length;++o)n[o][0]==n[o-1][0]?e[n[o][1]]=e[n[o-1][1]]:e[n[o][1]]=o+1;return e}(l,0),1).normalize();return c=et.xy(f,c).normalize(),(c=et.vectorHadamardProduct(c,o).normalize()).toArray()},N.minimumTrackingErrorWeights=function(n,o,t){void 0===t&&(t={constraints:{}}),void 0===t.constraints&&(t.constraints={}),void 0===t.optimizationMethodParams&&(t.optimizationMethodParams={}),void 0===t.eps&&(t.eps=1e-4),void 0===t.maxIter&&(t.maxIter=1e4),void 0===t.constraints.minNbAssets&&t.constraints.maxNbAssets&&(t.constraints.minNbAssets=1),void 0===t.constraints.maxNbAssets&&t.constraints.minNbAssets&&(t.constraints.maxNbAssets=n.length);var r,e,a,i,s=t.eps,u=t.maxIter,y=t.constraints.minNbAssets,g=t.constraints.maxNbAssets,f=y||g,h=t.constraints.minWeights,l=t.constraints.maxWeights;if(f&&(void 0===(r=t.optimizationMethod)&&(r="combinatorial"),"combinatorial"!=r&&"thresholdAccepting"!=r))throw new Error("unsupported optimisation method");"thresholdAccepting"==r&&(void 0===(e=t.optimizationMethodParams.nRounds)&&(e=3),void 0===(a=t.optimizationMethodParams.nSteps)&&(a=5e3),void 0===(i=t.optimizationMethodParams.nDeltas)&&(i=a));var m,c=n.length,d=n[0].length;o=new et(o);function w(t,r,n,o){var e=t.nbColumns,a=t,i=r;return W(function(t){var r=et.xmy(et.xy(a,t),i).vectorNorm("two");return.5*r*r},function(t){return et.txy(a,et.xmy(et.xy(a,t),i))},function(t){return B(t.data,n,o)},function(t){return new et(L(t.data,n,o))},new et(L(et.ones(e,1).data,n,o)),{eps:s,maxIter:u,maxLine:u})}if(f)if("thresholdAccepting"==r){n=et.fill(d,c,function(t,r){return n[r-1][t-1]});if(!h){h="function"==typeof Float64Array?new Float64Array(c):new Array(c);for(var v=0;v<c;++v)h[v]=0}if(!l){l="function"==typeof Float64Array?new Float64Array(c):new Array(c);for(v=0;v<c;++v)l[v]=1}m=new et(m=P(function(t){t=new et(t);var r=et.xmy(et.xy(n,t),o).vectorNorm("two");return.5*r*r},N.randomWeights(c,{constraints:{minNbAssets:y,maxNbAssets:g,minWeights:h,maxWeights:l}}),{nSteps:a,nRounds:e,nDeltas:i,neighbourGenerator:function(t,r){function n(t,r){return Math.floor(Math.random()*(r-t))+t}for(var o=r.lowerBounds,e=r.upperBounds,a=.05,i=1e-12,s=t.length,u=t,f=0,h=0;h<s;++h)u[h]>i&&++f;var l=new Array(0);if(f==g){for(h=0;h<s;++h)u[h]>i&&u[h]<e[h]-i&&l.push([h,-1]);for(h=0;h<s;++h){var m=new Array(0);if(u[h]<=i&&u[h]<e[h]-i)for(var c=Math.max(o[h],Math.min(e[h]-u[h],a)),d=0;d<s;++d)u[d]>i&&u[d]-c<=i&&m.push([d,u[d]]);0!=m.length&&l.push([h,m])}}else{if(!(f<g))throw new Error("internal error: number of assets strictly greater than the allowed maximum number of assets");for(h=0;h<s;++h)u[h]<e[h]-i&&l.push([h,-1])}var w=l[n(0,l.length)],v=w[0];if(a=Math.min(e[v]-u[v],a),u[v]<=i&&(a=Math.max(o[v],a)),-1==w[1])if(m=new Array(0),f==y){for(h=0;h<s;++h)if(u[h]>i&&u[h]>i+o[h]){var b=Math.min(a,u[h]-o[h]-2*i);u[v]<=i?b>=o[v]&&m.push([h,b]):m.push([h,b])}}else{if(!(y<f))throw new Error("internal error: number of assets strictly lower than the allowed minimum number of assets");for(h=0;h<s;++h)u[h]>i&&u[h]-a<=i?m.push([h,u[h]]):u[h]>i&&u[h]>i+o[h]&&m.push([h,Math.min(a,u[h]-o[h])])}else m=w[1];var p=m[n(0,m.length)];return a=p[1],u[p[0]]-=a,u[v]+=a,u},neighbourGeneratorParameters:{lowerBounds:h,upperBounds:l}})[0])}else{if("combinatorial"!=r)throw new Error("internal error: unsupported optimisation method");for(var b=1/0,p=[],x=[],C=y;C<=g;++C)for(var A=new k(c,C,!1),R=A.next();-1!=R;){var M=R.length,E="function"==typeof UInt32Array?new UInt32Array(M):new Array(M);for(v=0;v<R.length;++v)E[v]=R[v];var V,z,_,F=et.fill(d,M,function(t,r){return n[E[r-1]-1][t-1]});if(h){V="function"==typeof Float64Array?new Float64Array(M):new Array(M);for(v=0;v<M;++v)V[v]=h[E[v]-1]}if(l){z="function"==typeof Float64Array?new Float64Array(M):new Array(M);for(v=0;v<M;++v)z[v]=l[E[v]-1]}var O=1/0;try{var I=w(F,o,V,z);_=I[0],O=I[1]}catch(t){if("infeasible problem detected: the restricted simplex is empty"!==t.message)throw t}O<b&&(b=O,p=E,x=_);R=A.next()}if(b==1/0)throw new Error("infeasible problem detected");m=et.zeros(c,1);for(v=0;v<p.length;++v)m.data[p[v]-1]=x.data[v]}else m=w(n=et.fill(d,c,function(t,r){return n[r-1][t-1]}),o,h,l)[0];return m.toArray()},N.mostDiversifiedWeights=function(t,r){void 0===r&&(r={});var n=r.eps||1e-4,o=r.maxIter||1e4,e=(t=new et(t)).nbRows,a=et.zeros(e,1),i=et.fill(e,1,function(t,r){return Number.MAX_VALUE});return A(t,a,t.diagonal().elemMap(function(t,r,n){return Math.sqrt(n)}),1,a,i,{eps:n,maxIter:o})[0].normalize().toArray()},N.numericalOptimizationWeights=function(t,r,n){void 0===n&&(n={}),void 0===n.constraints&&(n.constraints={}),void 0===n.optimizationMethodParams&&(n.optimizationMethodParams={});var o=n.optimizationMethod;if(void 0===o&&(o="grid-search"),"grid-search"===o&&void 0===n.optimizationMethodParams.k&&(n.optimizationMethodParams.k=t),"grid-search"===o)return function(t,r,n,o,e){var a=null,i=null;if(o&&(a=o,!e)){i="function"==typeof Float64Array?new Float64Array(r):new Array(r);for(var s=0;s<r;++s)i[s]=1}if(e&&(i=e,!o)){a="function"==typeof Float64Array?new Float64Array(r):new Array(r);for(s=0;s<r;++s)a[s]=0}if(a||i)rt(r,a,i);for(var u=Number.POSITIVE_INFINITY,f=[],h=new R(r,n,!0),l=h.sample();-1!==l;){var m=!0;if(a)for(s=0;s<r;++s)if(a[s]>l[s]){m=!1;break}if(i)for(s=0;s<r;++s)if(l[s]>i[s]){m=!1;break}if(m){var c=t(l);c<u?(u=c,f=[l.slice(0)]):c==u&&f.push(l.slice(0)),l=h.sample()}else l=h.sample()}return f}(r,t,n.optimizationMethodParams.k,n.constraints.minWeights,n.constraints.maxWeights);throw new Error("unsupported optimisation method")},N.postOptimizationWeights=function(w,t){void 0===t&&(t={roundingMethodParams:{},roundingOptimizationMethodParams:{}}),void 0===t.roundingOptimizationMethodParams&&(t.roundingOptimizationMethodParams={}),void 0===t.roundingMethodParams&&(t.roundingMethodParams={}),void 0===t.roundingMethod&&(t.roundingMethod="rationalizing"),"rationalizing"==t.roundingMethod&&null==t.roundingMethodParams.k&&(t.roundingMethodParams.k=20);var r,n=t.roundingMethod;if("rationalizing"!=n&&"roundlotting"!=n)throw new Error("unsupported rounding method");"rationalizing"==n&&(r=t.roundingMethodParams.k);var o,e,a,i=t.roundingMethodParams.portfolioValue,v=t.roundingMethodParams.assetsPrices,b=t.roundingMethodParams.sizeLots;if("roundlotting"==n){if(null==i||0==i)throw new Error("missing portfolio value");if(null==v)throw new Error("missing assets prices");if(void 0===b){b="function"==typeof Float64Array?new Float64Array(w.length):new Array(w.length);for(var s=0;s<b.length;++s)b[s]=1}}if("roundlotting"==n&&(void 0===(o=t.roundingOptimizationMethodParams.nRounds)&&(o=3),void 0===(e=t.roundingOptimizationMethodParams.nSteps)&&(e=5e3),void 0===(a=t.roundingOptimizationMethodParams.nDeltas)&&(a=e)),"rationalizing"==n)return x=function(t,r){for(var n=r,o=new Array(t.length),e=0;e<t.length;++e){var a=r*t[e],i=Math.floor(a),s=a-i;n-=i,o[e]=[i,s,e]}o.sort(function(t,r){return r[1]<t[1]?-1:r[1]>t[1]?1:r[0]-t[0]});var u=new Array(t.length);for(e=0;e<n;++e){u[o[e][2]]=(o[e][0]+1)/r}for(e=n;e<o.length;++e){u[o[e][2]]=o[e][0]/r}return u}(w,r);if("roundlotting"!=n)throw new Error("internal error: unsupported rounding method");var p=w.length;w=new et.fill(p+1,1,function(t,r){return t<=p?w[t-1]:0});function u(n){var t=new et.fill(p+1,1,function(t,r){return t<=p?n[t-1]*b[t-1]*v[t-1]/i:n[p]/i});return et.xmy(w,t).vectorNorm("two")}var f="function"==typeof Float64Array?new Float64Array(p+1):new Array(p+1),h=0;for(s=0;s<p;++s){var l=v[s]*b[s];f[s]=Math.floor(w.getValue(s+1,1)*i/l),h+=f[s]*l}if((y=i-h)<0)throw new Error("internal error: negative cash during intitial feasible point generation");for(f[p]=y;;){var m=-1,c=u(f);for(s=0;s<p;++s){if((l=v[s]*b[s])<y){f[s]+=1,f[p]=y-l;var d=u(f);d<=c&&(m=s,c=d),f[s]-=1,f[p]=y}}if(-1==m)break;f[m]+=1,y-=v[m]*b[m]}if(y<0)throw new Error("internal error: negative cash during intitial feasible point generation");f[p]=y;var y,g=P(u,f,{nSteps:e,nRounds:o,nDeltas:a,neighbourGenerator:function(t,r){function n(t,r){return Math.floor(Math.random()*(r-t))+t}for(var o=0,e=0;e<p;++e)0<t[e]&&++o;for(var a="function"==typeof UInt32Array?new UInt32Array(o):new Array(o),i=e=0;e<p;++e)0<t[e]&&(a[i]=e,++i);if(0!=a.length){var s=a[n(0,o)],u=n(1,t[s]+1);t[s]-=u;var f=v[s]*b[s]*u;t[p]+=f}var h=1;for(e=0;e<p;++e)1e-12<w.getValue(e+1,1)&&++h;var l="function"==typeof UInt32Array?new UInt32Array(h):new Array(h);for(i=e=0;e<p;++e)1e-12<w.getValue(e+1,1)&&(l[i]=e,++i);l[h-1]=p;var m=l[n(0,h)];if(m!=p){var c=n(0,Math.floor(t[p]/(v[m]*b[m]))+1);t[m]+=c;var d=v[m]*b[m]*c;t[p]-=d}return t}})[0],x=new et.fill(p,1,function(t,r){return g[t-1]*b[t-1]*v[t-1]/i}).toArray();return[new et.fill(p,1,function(t,r){return g[t-1]}).toArray(),x,y=g[p]]},N.proportionalMinimumVarianceWeights=function(t,r){for(var n=(t=new et(t)).nbRows,o=t.toRowArray(),e=new Array(n),a=0;a<n;++a)e[a]=F(o[a]);var i=F(e),s=d(e),u=new et(e,1).elemMap(function(t,r,n){return 1-w((n-i)/s)});u=u.normalize(u);var f=t.diagonal().elemMap(function(t,r,n){return 1/n}).normalize();return(u=et.vectorHadamardProduct(u,f).normalize()).toArray()},N.randomSubspaceOptimizationWeights=function(t,r,n){if(void 0===n&&(n={}),void 0===n.constraints&&(n.constraints={}),void 0===n.subsetOptimizationFctOpt&&(n.subsetOptimizationFctOpt={}),void 0===n.subsetOptimizationFctOpt.constraints&&(n.subsetOptimizationFctOpt.constraints={}),t<=1)return[1];var o=n.sizeSubsets;if(void 0===o&&(o=Math.max(2,Math.floor(Math.sqrt(t)))),o<=1||t+1<=o)throw new Error("the size of the subsets of assets must be between 2 and "+t.toString());var e=n.subsetsGenerationMethod;void 0===e&&(e="random");var a,i=n.nbRandomSubsets;if(void 0===i&&(i=128),o===t&&(i=1),"random"===e)a=i;else{if("deterministic"!==e)throw new Error("unsupported subsets of assets generation method");a=function(t,r){if(t<0)throw new Error("n must be a positive integer");if(r<0)throw new Error("k must be a positive integer");if(t<r)throw new Error("k must be less than or equal to n");for(var n=1,o=1;o<=r;++o)n*=t+1-o,n/=o;return n}(t,o)}var s=n.subsetsAggregationMethod;if(void 0===s&&(s="average"),"average"!==s&&"median"!==s)throw new Error("unsupported aggregation method");var u,f=n.maxInfeasibleSubsetsRatio;if(void 0===f&&(f=0),"random"===e)u=new x(t,o,!1);else{if("deterministic"!==e)throw new Error("unsupported subsets generation method");u=new k(t,o,!1)}var h=n.subsetOptimizationFctOpt,l=0,m=new Array(a);n.constraints.minWeights&&(h.constraints.minWeights="function"==typeof Float64Array?new Float64Array(o):new Array(o)),n.constraints.maxWeights&&(h.constraints.maxWeights="function"==typeof Float64Array?new Float64Array(o):new Array(o));for(var c=0;c<a;++c){var d=u.next();if(n.constraints.minWeights)for(var w=0;w<o;++w)h.constraints.minWeights[w]=n.constraints.minWeights[d[w]-1];if(n.constraints.maxWeights)for(w=0;w<o;++w)h.constraints.maxWeights[w]=n.constraints.maxWeights[d[w]-1];try{var v=r(d,h);if(v.length!=o)throw new Error("internal error: the portfolio optimization method did not return the expected number of weights")}catch(t){if("infeasible portfolio optimization problem"===t.message)continue;throw t}var b=et.zeros(t,1);for(w=0;w<o;++w)b.setValueAt(d[w],1,v[w]);m[l++]=b}if(0===(m.length=l))throw new Error("no feasible portfolio generated");var p=a-l;if(1<=p&&f<=p/a)throw new Error("too many infeasible portfolios generated");b=null;if("average"==s)b=y(m);else{if("median"!=s)throw new Error("internal error");b=function(a){function t(t){for(var r=0,n=0;n<i;++n){r+=C(et.xmy(t,a[n],u).vectorNorm("two"),f)}return r}function r(t){for(var r=et.zeros(s,1),n=0;n<i;++n){var o=et.xmy(t,a[n],u),e=o.vectorNorm("two");r=et.axpby(1,r,1/C(e,f),o,r)}return r}function n(t){return 0}function o(t,r){return t}var i=a.length,s=a[0].nbRows,u=et.zeros(s,1),e=y(a),f=1/i,h=W(t,r,n,o,e,{eps:1e-4,maxIter:-1,maxLine:-1});return f=.1/i,h=W(t,r,n,o,h[0],{eps:1e-4,maxIter:-1,maxLine:-1}),f=.01/i,(h=W(t,r,n,o,h[0],{eps:1e-4,maxIter:-1,maxLine:-1}))[0]}(m)}return b.toArray()},N.randomSubspaceMeanVarianceOptimizationWeights=function(e,a,t){void 0===t&&(t={}),void 0===t.constraints&&(t.constraints={}),void 0===t.subsetsMeanVarianceOptimizationOpt&&(t.subsetsMeanVarianceOptimizationOpt={}),void 0===t.subsetsMeanVarianceOptimizationOpt.constraints&&(t.subsetsMeanVarianceOptimizationOpt.constraints={});e=new et(e);var r=(a=new et(a)).nbColumns;if(void 0===t.sizeSubsets){var n=-Math.sqrt(2*r*(r+3)),o=2.25-1*n,i=n/-(1.5+Math.sqrt(o));t.sizeSubsets=Math.max(2,Math.floor(i))}return t.subsetOptimizationFctOpt=t.subsetsMeanVarianceOptimizationOpt,t.subsetsMeanVarianceOptimizationOpt.subsetMu=et.zeros(t.sizeSubsets,1),t.subsetsMeanVarianceOptimizationOpt.subsetSigma=et.zeros(t.sizeSubsets,t.sizeSubsets),N.randomSubspaceOptimizationWeights(r,function(t,r){var n=e.submatrix(t,[1],r.subsetMu),o=a.submatrix(t,t,r.subsetSigma);try{return N.meanVarianceOptimizationWeights(n,o,r)}catch(t){throw t.message.includes("no matching efficient portfolio")||"infeasible problem detected: the restricted simplex is empty"===t.message?new Error("infeasible portfolio optimization problem"):t}},t)},N.randomWeights=function(t,r){void 0===r&&(r={}),void 0===r.constraints&&(r.constraints={});var n=r.constraints.minNbAssets||r.constraints.maxNbAssets,o=r.constraints.minNbAssets;void 0===o&&(o=1);var e=r.constraints.maxNbAssets;void 0===e&&(e=t);var a=r.constraints.minExposure;void 0===a&&(a=1);var i=r.constraints.maxExposure;void 0===i&&(i=1);var s=r.maxIter;void 0===s&&(s=1e4);for(var u=-1;;){if(s<++u)throw new Error("maximum number of iterations reached");var f=Math.floor(Math.random()*(e-o+1))+o,h=new x(t,f,!1).next(),l=Math.random()*(i-a)+a,m=0;if(1!==l){m=1;for(var c="function"==typeof Float64Array?new Float64Array(f+m):new Array(f+m),d="function"==typeof Float64Array?new Float64Array(f+m):new Array(f+m),w=0;w<f;++w)c[w]=0,d[w]=1;var v=1-l;c[f]=v,d[f]=v}if(r.constraints.minWeights){if(1===l)c="function"==typeof Float64Array?new Float64Array(f):new Array(f);for(w=0;w<f;++w)c[w]=r.constraints.minWeights[h[w]-1]}if(r.constraints.maxWeights){if(1===l)d="function"==typeof Float64Array?new Float64Array(f):new Array(f);for(w=0;w<f;++w)d[w]=r.constraints.maxWeights[h[w]-1]}try{rt(f+m,c,d)}catch(t){continue}var b=new M(f+m,c,d).sample();try{if(n)for(w=0;w<f;++w)if(0==b[w])throw new Error("generated weights not compatible with cardinality constraints")}catch(t){continue}break}var p=et.zeros(t,1);for(w=0;w<f;++w){var y=h[w],g=b[w];p.setValueAt(y,1,g)}return p.toArray()},N.riskBudgetingWeights=function(z,_,F){function O(t,r){var n=et.vectorDotProduct(r,t);if(Math.abs(n)<=o)n=0;else if(n<0&&n<-o)throw new Error("negative volatility during iteration "+iter+", covariance matrix might not be semi-definite positive");return Math.sqrt(n)}function r(t,r,n){for(var o=et.fill(W,1,function(t,r){return 1/W}),e=o.elemMap(function(t,r,n){return Math.log(n)}),a=(et.copy(o),et.xy(z,o)),i=O(o,a),s=et.vectorDotProduct(_,e),u=.5*i-s,f=new I(W),h=0;-1==P||h!=P;){if(-1==P&&k<=h)throw new Error("maximum number of cycles reached: "+k);var l;for(++h,f.generateCoordinates();;){var m=f.sampleCoordinate();if(-1==m)break;"acf"===F.coordinatesSampler&&(l=.5*i-s);var c=o.data[m-1],d=e.data[m-1],w=z.data[(m-1)*z.nbColumns+(m-1)],v=a.data[m-1]-o.data[m-1]*w,b=-t*_.data[m-1]*i,p=v/2,y=0<=p?1:-1,g=p*p-w*b;if(g<0)throw new Error("internal error: negative discriminant detected, the covariance matrix might not be semi-definite positive");var x,C=-(p+y*Math.sqrt(g)),A=C/w,R=b/C;if(0<A)x=A;else{if(!(0<R))throw new Error("internal error: no strictly positive root detected, the covariance matrix might not be semi-definite positive");x=R}r&&x<r[m-1]&&(x=r[m-1]),n&&x>n[m-1]&&(x=n[m-1]),o.data[m-1]=x,e.data[m-1]=Math.log(x),s-=d*_.data[m-1],s+=e.data[m-1]*_.data[m-1];for(var M=1;M<=W;++M)a.data[M-1]+=z.data[(M-1)*z.nbColumns+(m-1)]*x,a.data[M-1]-=z.data[(M-1)*z.nbColumns+(m-1)]*c;if(i=O(o,a),"acf"===F.coordinatesSampler){var E=l-(.5*i-s);1==h?f.updateAverageGain(E):f.updateSchedulingPreference(m,E)}}var V=.5*i-s;if(-1==P&&Math.abs(V-u)<=N)break;u=V}return o}void 0===F&&(F={}),void 0===F.constraints&&(F.constraints={}),void 0===F.eps&&(F.eps=1e-10),void 0===F.epsSdp&&(F.epsSdp=1e-12),void 0===F.maxCycles&&(F.maxCycles=1e4),void 0===F.nbCycles&&(F.nbCycles=-1),void 0===F.outputPortfolioVolatility&&(F.outputPortfolioVolatility=!1),void 0===F.coordinatesSampler&&(F.coordinatesSampler="cyclic");var I,N=F.eps,o=F.epsSdp,k=F.maxCycles,P=F.nbCycles,t=F.outputPortfolioVolatility;if("cyclic"===F.coordinatesSampler)I=function(t){this.n=t,this.k=t,this.sampleCoordinate=function(){return this.k==this.n?-1:++this.k},this.generateCoordinates=function(){this.k=0}};else if("shuffledCyclic"===F.coordinatesSampler)I=function(t){this.n=t,this.k=t,this.r="function"==typeof Uint32Array?new Uint32Array(t):new Array(t);for(var r=0;r<t;++r)this.r[r]=r+1;this.sampleCoordinate=function(){return this.k==this.n?-1:this.r[this.k++]},this.generateCoordinates=function(){this.r=new f(void 0,this.r,!0).next(),this.k=0}};else if("randomized"===F.coordinatesSampler)I=function(t){this.n=t,this.k=t;for(var r="function"==typeof Float64Array?new Float64Array(t):new Array(t),n=0;n<t;++n)r[n]=1/t;this.s=new S(r),this.sampleCoordinate=function(){return this.k==this.n?-1:(++this.k,this.s.sample()+1)},this.generateCoordinates=function(){this.k=0}};else{if("acf"!==F.coordinatesSampler)throw new Error("unsupported coordinates sampler");I=function(t){this.n=t,this.k=0,this.change_rate=.2,this.p_min=.05,this.p_max=20,this.idx_set_tmp="function"==typeof Uint32Array?new Uint32Array(2*t):new Array(2*t),this.idx_set=null,this.idx_set_len=0,this.pref="function"==typeof Float64Array?new Float64Array(t):new Array(t);for(var r=0;r<t;++r)this.pref[r]=1;for(this.prefsum=t,this.acc="function"==typeof Float64Array?new Float64Array(t):new Array(t),r=0;r<t;++r)this.acc[r]=.5;this.gain_learning_rate=1/t,this.average_gain=0,this.sampleCoordinate=function(){return this.k==this.idx_set_len?-1:this.idx_set[this.k++]},this.generateCoordinates=function(){this.k=0,this.idx_set_len=0;for(var t=this.n/this.prefsum,r=0;r<this.n;++r){for(var n=this.acc[r]+t*this.pref[r],o=Math.floor(n),e=0;e<o;++e)this.idx_set_tmp[this.idx_set_len]=r+1,this.idx_set_len++;this.acc[r]=n-o}this.idx_set=new f(void 0,this.idx_set_tmp.slice(0,this.idx_set_len),!0).next()},this.updateSchedulingPreference=function(t,r){var n=this.pref[t-1]*Math.exp(this.change_rate*(r/this.average_gain-1));n<this.p_min?n=this.p_min:n>this.p_max&&(n=this.p_max),this.prefsum=this.prefsum+n-this.pref[t-1],this.pref[t-1]=n,this.average_gain=(1-this.gain_learning_rate)*this.average_gain+this.gain_learning_rate*r},this.updateAverageGain=function(t){this.average_gain+=t/this.n}}}var n=null,e=null;if(F.constraints.minWeights&&(n=F.constraints.minWeights,!F.constraints.maxWeights)){e="function"==typeof Float64Array?new Float64Array(F.constraints.minWeights.length):new Array(F.constraints.minWeights.length);for(var a=0;a<e.length;++a)e[a]=1}if(F.constraints.maxWeights&&(e=F.constraints.maxWeights,!F.constraints.minWeights)){n="function"==typeof Float64Array?new Float64Array(F.constraints.maxWeights.length):new Array(F.constraints.maxWeights.length);for(a=0;a<n.length;++a)n[a]=0}z=new et(z),_=new et(_);var i,W=z.nbRows,s=r(1);if(s=s.normalize(),n||e){rt(W,n,e);var u=O(s,et.xy(z,s));i=r(function(t,r,n,o){void 0===o&&(o={});var e=o.maxIter;void 0===e&&(e=45);var a=o.eps;void 0===a&&(a=1e-6);var i,s,u=t(r),f=t(n);if(s=u<=0?n-(i=r):r-(i=n),n<=r)throw new Error("bracketing interval lower bound "+r+" greater than bracketing interval upper bound "+n);if(0==u)return r;if(0==f)return n;if(0<u*f)throw new Error("interval ["+r+","+n+"] is not a bracketing interval");for(var h=0;;){if(-1!==e&&e<h)throw new Error("maximum number of iterations reached: "+e);++h;var l=i+(s/=2),m=t(l);if(m<=0&&(i=l),0==m)return i;if(Math.abs(s)<=a)return i}}(function(t){return r(t,n,e).sum()-1},.5*u,2*u),n,e)}else i=s;return!0===t?[i.toArray(),O(i,et.xy(z,i))]:i.toArray()},N}(PortfolioAllocation||{}),"undefined"!=typeof module&&(module.exports=PortfolioAllocation);